{% extends "base.html" %}

{% block title %}Shipments Received{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">
            <svg class="inline w-7 h-7 mr-2 align-[-4px]" aria-hidden="true"><use href="#icon-box" /></svg> 
            Shipments Received
        </h1>
        <p class="text-gray-600 mt-2">Record shipments that arrive</p>
    </div>

    <!-- Action Button -->
    <div class="mb-4 flex justify-end">
        <button onclick="openAddReceivesModal()" 
                class="btn-primary px-4 py-2 flex items-center">
            <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-plus" /></svg>
            Add Receives
        </button>
    </div>

    <!-- Main Content -->
    {% if shipments %}
    <div class="space-y-4">
        {% for shipment in shipments %}
        <div class="card">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">
                            {% if shipment.receiving.po_number %}
                                {% if shipment.receiving.shipment_number %}
                                    {{ shipment.receiving.po_number }}-{{ shipment.receiving.shipment_number }}
                                {% else %}
                                    {{ shipment.receiving.po_number }}
                                {% endif %}
                            {% else %}
                                Shipment Received
                            {% endif %}
                        </h3>
                        <p class="text-sm text-gray-600">
                            Received on {{ shipment.receiving.received_date[:10] if shipment.receiving.received_date else 'Unknown' }} at {{ shipment.receiving.received_date[11:19] if shipment.receiving.received_date and shipment.receiving.received_date|length > 10 else '' }} EST
                            {% if shipment.receiving.received_by %}
                            by {{ shipment.receiving.received_by }}
                            {% endif %}
                        </p>
                        {% if not shipment.receiving.po_number and user_role in ['manager', 'admin'] %}
                        <p class="text-sm text-gray-500 italic mt-1">No PO assigned</p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.box_count or 0 }} Box{{ 'es' if (shipment.receiving.box_count or 0) != 1 else '' }}
                        </div>
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.total_bags or 0 }} Bag{{ 's' if (shipment.receiving.total_bags or 0) != 1 else '' }}
                        </div>
                        {% if user_role in ['manager', 'admin'] %}
                        <div class="mt-2 space-x-2">
                            <button onclick="openAssignPOModal({{ shipment.receiving.id }}, {{ shipment.receiving.po_id or 'null' }})" 
                                    class="text-xs text-blue-600 hover:text-blue-800 underline">
                                {% if shipment.receiving.po_number %}Change PO{% else %}Assign PO{% endif %}
                            </button>
                            <button onclick="openDeleteShipmentModal({{ shipment.receiving.id }}, '{{ shipment.receiving.received_date[:10] if shipment.receiving.received_date else 'Unknown' }}', '{{ shipment.receiving.po_number or 'No PO' }}')" 
                                    class="text-xs text-red-600 hover:text-red-800 underline">
                                Delete
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Boxes -->
                <div class="space-y-3 mt-4">
                    {% for box_data in shipment.boxes %}
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium text-gray-900">Box {{ box_data.box.box_number }}</h4>
                            <span class="text-sm text-gray-600">{{ box_data.box.bag_count }} bag{{ 's' if box_data.box.bag_count != 1 else '' }}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mt-2">
                            {% for bag in box_data.bags %}
                            <div class="bg-white border border-gray-200 rounded p-2 text-sm">
                                <div class="font-medium text-gray-700">Bag {{ bag.bag_number }}</div>
                                <div class="text-gray-600">
                                    {% if bag.tablet_type_name %}
                                    {{ bag.tablet_type_name }}
                                    {% else %}
                                    Unknown Type
                                    {% endif %}
                                </div>
                                <div class="text-gray-600">Count: {{ bag.bag_label_count or 0 }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="p-6">
            <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" aria-hidden="true"><use href="#icon-box" /></svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No shipments recorded yet</h3>
                <p class="text-gray-600 mb-6">Click "Add Receives" to record a new shipment</p>
                <button onclick="openAddReceivesModal()" 
                        class="btn-primary px-6 py-3 text-lg">
                    <svg class="w-5 h-5 mr-2 inline" aria-hidden="true"><use href="#icon-plus" /></svg>
                    Add Receives
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Receives Modal -->
<div id="add-receives-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" onclick="closeAddReceivesModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold">üì¶ Record Shipment Received</h3>
                    <p class="text-sm text-blue-100 mt-1">Enter box and bag details for the received shipment</p>
                </div>
                <button onclick="closeAddReceivesModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        
        <!-- Form Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <form id="receives-form" onsubmit="submitReceives(event)">
                {% if user_role in ['manager', 'admin'] %}
                <!-- PO Assignment Field (Managers/Admin only) -->
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Purchase Order <span class="text-red-600">*</span>
                    </label>
                    <select id="po-select" name="po_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select a PO...</option>
                        {% for po in purchase_orders %}
                        <option value="{{ po.id }}">{{ po.po_number }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-red-600 mt-1 font-medium">‚ö†Ô∏è Required: All receives must be linked to a PO (source of truth for submissions)</p>
                </div>
                {% endif %}
                
                <div id="boxes-container">
                    <!-- Box 1 will be added automatically -->
                </div>
                
                <!-- Add Box Button -->
                <div class="mt-4 flex justify-center">
                    <button type="button" onclick="addBox()" 
                            class="btn-secondary px-4 py-2 flex items-center">
                        <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-plus" /></svg>
                        Add Another Box
                    </button>
                </div>
                
                <!-- Submit Button -->
                <div class="mt-6 flex justify-end gap-3 border-t pt-4">
                    <button type="button" onclick="closeAddReceivesModal()" 
                            class="btn-secondary px-6 py-2">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="btn-primary px-6 py-2">
                        Save Receives
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Shipment Modal -->
<div id="delete-shipment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeDeleteShipmentModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Delete Shipment</h3>
                <button onclick="closeDeleteShipmentModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <p class="text-gray-700 mb-2"><strong>Are you sure you want to delete this shipment?</strong></p>
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-red-800"><strong>This action cannot be undone.</strong></p>
                    <p class="text-sm text-gray-700 mt-2">This will permanently delete:</p>
                    <ul class="text-sm text-gray-700 mt-1 ml-4 list-disc">
                        <li>The shipment record</li>
                        <li>All associated boxes</li>
                        <li>All associated bags</li>
                    </ul>
                </div>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <p class="text-sm text-gray-700"><strong>Shipment Details:</strong></p>
                    <p class="text-sm text-gray-600 mt-1">Received Date: <span id="delete-shipment-date"></span></p>
                    <p class="text-sm text-gray-600">PO: <span id="delete-shipment-po"></span></p>
                </div>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="delete-confirm-checkbox" class="mr-2">
                    <span class="text-sm text-gray-700">I understand this action cannot be undone</span>
                </label>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeDeleteShipmentModal()" 
                        class="btn-secondary px-4 py-2">
                    Cancel
                </button>
                <button onclick="confirmDeleteShipment()" 
                        id="confirm-delete-btn"
                        class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    Delete Shipment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign PO Modal -->
<div id="assign-po-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeAssignPOModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Assign Purchase Order</h3>
                <button onclick="closeAssignPOModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        <div class="p-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Purchase Order
            </label>
            <select id="assign-po-select" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">No PO assigned</option>
                {% for po in purchase_orders %}
                <option value="{{ po.id }}">{{ po.po_number }}</option>
                {% endfor %}
            </select>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="closeAssignPOModal()" 
                        class="btn-secondary px-4 py-2">
                    Cancel
                </button>
                <button type="button" onclick="savePOAssignment()" 
                        class="btn-primary px-4 py-2">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let boxCounter = 0;
let bagCounter = {};
let currentReceivingId = null;

// Initialize with Box 1 and Bag 1
document.addEventListener('DOMContentLoaded', function() {
    addBox();
});

function openAddReceivesModal() {
    // Reset form
    boxCounter = 0;
    bagCounter = {};
    document.getElementById('boxes-container').innerHTML = '';
    
    // Add first box
    addBox();
    
    // Show modal
    document.getElementById('add-receives-modal').classList.remove('hidden');
}

function closeAddReceivesModal(event) {
    if (!event || event.target === event.currentTarget || event.target.closest('button')) {
        document.getElementById('add-receives-modal').classList.add('hidden');
    }
}

function addBox() {
    boxCounter++;
    const boxNumber = boxCounter;
    bagCounter[boxNumber] = 0;
    
    const boxesContainer = document.getElementById('boxes-container');
    
    const boxDiv = document.createElement('div');
    boxDiv.className = 'mb-6 p-4 border-2 border-gray-300 rounded-lg bg-gray-50';
    boxDiv.id = `box-${boxNumber}`;
    boxDiv.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-gray-900">Box ${boxNumber}</h4>
            ${boxNumber > 1 ? `
                <button type="button" onclick="removeBox(${boxNumber})" 
                        class="text-red-600 hover:text-red-800 text-sm">
                    Remove Box
                </button>
            ` : ''}
        </div>
        <div id="box-${boxNumber}-bags" class="space-y-4">
            <!-- Bags will be added here -->
        </div>
        <div class="mt-4">
            <button type="button" onclick="addBag(${boxNumber})" 
                    class="btn-secondary text-sm px-3 py-1.5 flex items-center">
                <svg class="w-4 h-4 mr-1" aria-hidden="true"><use href="#icon-plus" /></svg>
                Add Another Bag
            </button>
        </div>
    `;
    
    boxesContainer.appendChild(boxDiv);
    
    // Automatically add Bag 1 to this box
    addBag(boxNumber);
}

function removeBox(boxNumber) {
    const boxDiv = document.getElementById(`box-${boxNumber}`);
    if (boxDiv) {
        boxDiv.remove();
        delete bagCounter[boxNumber];
    }
}

function addBag(boxNumber) {
    if (!bagCounter[boxNumber]) {
        bagCounter[boxNumber] = 0;
    }
    bagCounter[boxNumber]++;
    const bagNumber = bagCounter[boxNumber];
    
    const bagsContainer = document.getElementById(`box-${boxNumber}-bags`);
    
    const bagDiv = document.createElement('div');
    bagDiv.className = 'p-4 bg-white border border-gray-200 rounded-lg';
    bagDiv.id = `box-${boxNumber}-bag-${bagNumber}`;
    bagDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
            <h5 class="font-medium text-gray-700">Bag ${bagNumber}</h5>
            ${bagNumber > 1 ? `
                <button type="button" onclick="removeBag(${boxNumber}, ${bagNumber})" 
                        class="text-red-600 hover:text-red-800 text-xs">
                    Remove Bag
                </button>
            ` : ''}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tablet Type</label>
                <select name="box_${boxNumber}_bag_${bagNumber}_tablet_type" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    <option value="">Select tablet type...</option>
                    {% for tablet_type in tablet_types %}
                    <option value="{{ tablet_type.id }}">{{ tablet_type.tablet_type_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Bag Count</label>
                <input type="number" 
                       name="box_${boxNumber}_bag_${bagNumber}_bag_count" 
                       min="0" 
                       step="1"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                       placeholder="Enter bag count"
                       required>
            </div>
        </div>
    `;
    
    bagsContainer.appendChild(bagDiv);
    
    // Convert to two-level dropdown
    const select = bagDiv.querySelector('select[name="box_' + boxNumber + '_bag_' + bagNumber + '_tablet_type"]');
    if (select && typeof convertToTwoLevelDropdown === 'function') {
        convertToTwoLevelDropdown(select);
    }
}

function removeBag(boxNumber, bagNumber) {
    const bagDiv = document.getElementById(`box-${boxNumber}-bag-${bagNumber}`);
    if (bagDiv) {
        bagDiv.remove();
    }
}

async function submitReceives(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Parse form data into structured format
    const boxes = {};
    
    // Collect all form fields
    for (const [key, value] of formData.entries()) {
        // Match pattern: box_{boxNum}_bag_{bagNum}_tablet_type or box_{boxNum}_bag_{bagNum}_bag_count
        const match = key.match(/^box_(\d+)_bag_(\d+)_(tablet_type|bag_count)$/);
        if (match) {
            const boxNum = match[1];
            const bagNum = match[2];
            const fieldType = match[3]; // 'tablet_type' or 'bag_count'
            
            if (!boxes[boxNum]) {
                boxes[boxNum] = {};
            }
            if (!boxes[boxNum][bagNum]) {
                boxes[boxNum][bagNum] = {};
            }
            
            boxes[boxNum][bagNum][fieldType] = value;
        }
    }
    
    // Convert to array format
    const boxesArray = [];
    for (const boxNum in boxes) {
        const bagsArray = [];
        for (const bagNum in boxes[boxNum]) {
            const bag = boxes[boxNum][bagNum];
            if (bag.tablet_type && bag.bag_count) {
                bagsArray.push({
                    tablet_type_id: parseInt(bag.tablet_type),
                    bag_count: parseInt(bag.bag_count)
                });
            }
        }
        if (bagsArray.length > 0) {
            boxesArray.push({
                box_number: parseInt(boxNum),
                bags: bagsArray
            });
        }
    }
    
    if (boxesArray.length === 0) {
        alert('Please add at least one bag with tablet type and bag count.');
        return;
    }
    
    // Validate PO selection (now required)
    const poSelect = document.getElementById('po-select');
    const poId = poSelect ? poSelect.value || null : null;
    if (!poId) {
        alert('‚ö†Ô∏è Purchase Order is required. Please select a PO before submitting.');
        if (poSelect) {
            poSelect.focus();
            poSelect.classList.add('border-red-500', 'ring-2', 'ring-red-500');
            setTimeout(() => {
                poSelect.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
            }, 2000);
        }
        return;
    }
    
    try {
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';
        
        const response = await fetch('/api/save_receives', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                boxes: boxesArray,
                po_id: poId ? parseInt(poId) : null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Shipment received recorded successfully!');
            closeAddReceivesModal();
            location.reload();
        } else {
            alert('‚ùå Error: ' + (result.error || 'Failed to save receives'));
        }
        
        submitButton.disabled = false;
        submitButton.textContent = originalText;
    } catch (error) {
        alert('Error saving receives: ' + error.message);
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = false;
        submitButton.textContent = 'Save Receives';
    }
}

function openAssignPOModal(receivingId, currentPoId) {
    currentReceivingId = receivingId;
    const select = document.getElementById('assign-po-select');
    if (select) {
        select.value = currentPoId || '';
        document.getElementById('assign-po-modal').classList.remove('hidden');
    }
}

function closeAssignPOModal(event) {
    if (!event || event.target === event.currentTarget || event.target.closest('button')) {
        document.getElementById('assign-po-modal').classList.add('hidden');
        currentReceivingId = null;
    }
}

function openDeleteShipmentModal(receivingId, receivedDate, poNumber) {
    deleteShipmentId = receivingId;
    document.getElementById('delete-shipment-date').textContent = receivedDate;
    document.getElementById('delete-shipment-po').textContent = poNumber;
    document.getElementById('delete-confirm-checkbox').checked = false;
    document.getElementById('confirm-delete-btn').disabled = true;
    document.getElementById('delete-shipment-modal').classList.remove('hidden');
}

function closeDeleteShipmentModal(event) {
    if (!event || event.target === event.currentTarget || event.target.closest('button') && !event.target.closest('#confirm-delete-btn')) {
        document.getElementById('delete-shipment-modal').classList.add('hidden');
        deleteShipmentId = null;
        document.getElementById('delete-confirm-checkbox').checked = false;
        document.getElementById('confirm-delete-btn').disabled = true;
    }
}

// Enable delete button when checkbox is checked
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('delete-confirm-checkbox');
    const deleteBtn = document.getElementById('confirm-delete-btn');
    if (checkbox && deleteBtn) {
        checkbox.addEventListener('change', function() {
            deleteBtn.disabled = !this.checked;
        });
    }
});

async function confirmDeleteShipment() {
    if (!deleteShipmentId) {
        alert('Error: No shipment selected');
        return;
    }
    
    const checkbox = document.getElementById('delete-confirm-checkbox');
    if (!checkbox.checked) {
        alert('Please confirm that you understand this action cannot be undone');
        return;
    }
    
    const deleteBtn = document.getElementById('confirm-delete-btn');
    const originalText = deleteBtn.textContent;
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Deleting...';
    
    try {
        const response = await fetch(`/api/receiving/${deleteShipmentId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('‚úÖ Shipment deleted successfully!');
            closeDeleteShipmentModal();
            location.reload();
        } else {
            alert('‚ùå Error: ' + (result.error || 'Failed to delete shipment'));
            deleteBtn.disabled = false;
            deleteBtn.textContent = originalText;
        }
    } catch (error) {
        alert('Error deleting shipment: ' + error.message);
        deleteBtn.disabled = false;
        deleteBtn.textContent = originalText;
    }
}

async function savePOAssignment() {
    if (!currentReceivingId) {
        alert('Error: No receiving record selected');
        return;
    }
    
    const select = document.getElementById('assign-po-select');
    const poId = select.value || null;
    
    try {
        const response = await fetch(`/api/receiving/${currentReceivingId}/assign_po`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                po_id: poId ? parseInt(poId) : null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ PO assignment updated successfully!');
            closeAssignPOModal();
            location.reload();
        } else {
            alert('‚ùå Error: ' + (result.error || 'Failed to update PO assignment'));
        }
    } catch (error) {
        alert('Error updating PO assignment: ' + error.message);
    }
}
</script>
{% endblock %}
