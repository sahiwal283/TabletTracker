<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Tablet Counter{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style type="text/tailwindcss">
        :root {
            /* Winter Chill Palette */
            --wc-light: #B8E3E9;  /* Light ice */
            --wc-mid:   #93B1B5;  /* Mist */
            --wc-primary:#4F7C82;  /* Deep teal */
            --wc-dark:  #0B2E33;  /* Midnight teal */

            /* Derived neutrals */
            --bg-start: #f8fbfc;
            --bg-end:   #eef7f8;
            --neutral-border: #e2edf0;
            --neutral-shadow: 11, 46, 51; /* wc-dark RGB */
        }

        /* Inputs */
        .form-input {
            @apply w-full px-5 py-4 border-2 bg-white transition-all duration-300;
            font-size: 16px !important; /* Prevents zoom on iOS */
            border-radius: 20px !important;
            border-color: var(--neutral-border) !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--bg-end) 100%);
            box-shadow: 0 4px 12px rgba(var(--neutral-shadow), 0.06), inset 0 1px 0 rgba(255,255,255,0.6) !important;
            min-height: 56px !important;
            padding: 16px 20px !important;
        }
        .form-input:focus {
            border-color: var(--wc-primary) !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--bg-end) 100%);
            box-shadow: 0 0 0 4px rgba(79, 124, 130, 0.2), 0 12px 20px rgba(79, 124, 130, 0.15) !important;
            transform: translateY(-2px);
            outline: none;
        }
        
        /* Remove spinner arrows from number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Select dropdowns */
        select.form-input {
            border-color: var(--neutral-border) !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--bg-end) 100%);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%234F7C82' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 3.5rem;
            border-radius: 20px !important;
        }
        
        /* Button system */
        .btn-primary {
            @apply px-8 py-4 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-opacity-30 disabled:opacity-50 transition-all duration-300;
            color: #ffffff !important;
            border-radius: 24px !important;
            background: linear-gradient(135deg, var(--wc-primary) 0%, #5e8f95 50%, var(--wc-mid) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 6px 20px rgba(var(--neutral-shadow), 0.18);
            transform: translateY(0) scale(1);
            min-height: 56px;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--wc-dark) 0%, var(--wc-primary) 50%, var(--wc-mid) 100%);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 25px rgba(var(--neutral-shadow), 0.25);
            border-color: rgba(255,255,255,0.3);
        }
        .btn-primary:active {
            transform: translateY(-1px) scale(1.0);
            box-shadow: 0 6px 15px rgba(var(--neutral-shadow), 0.2);
        }
        
        .btn-secondary {
            @apply bg-white px-6 py-3 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-cyan-200 focus:ring-opacity-30 transition-all duration-300;
            color: var(--wc-dark) !important;
            border-radius: 20px !important;
            border: 2px solid var(--neutral-border);
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(var(--neutral-shadow), 0.06);
        }
        .btn-secondary:hover {
            @apply bg-slate-50 text-slate-900;
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(var(--neutral-shadow), 0.1);
            border-color: #cbd5e1; /* slate-300 */
        }
        
        /* Success button */
        .btn-success {
            @apply px-6 py-3 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-opacity-30 transition-all duration-300;
            color: #ffffff !important;
            border-radius: 20px !important;
            background: linear-gradient(135deg, var(--wc-primary) 0%, #5e8f95 50%, var(--wc-mid) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 6px 20px rgba(var(--neutral-shadow), 0.18);
            transform: translateY(0);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, var(--wc-dark) 0%, var(--wc-primary) 50%, var(--wc-mid) 100%);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 25px rgba(var(--neutral-shadow), 0.24);
            border-color: rgba(255,255,255,0.3);
        }
        
        .btn-warning {
            @apply bg-white px-6 py-3 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-cyan-200 focus:ring-opacity-30 transition-all duration-300;
            color: var(--wc-dark) !important;
            border-radius: 20px !important;
            border: 2px solid var(--neutral-border);
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(var(--neutral-shadow), 0.08);
        }
        .btn-warning:hover {
            @apply bg-slate-50 text-slate-900;
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(var(--neutral-shadow), 0.12);
            border-color: #cbd5e1; /* slate-300 */
        }

        /* Cards */
        .card {
            @apply bg-white shadow-xl border border-gray-100;
            border-radius: 28px !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--wc-light) 100%);
            border-color: rgba(var(--neutral-shadow), 0.08) !important;
        }

        /* Improve contrast for descriptive text inside light cards */
        .card .text-gray-600 { color: #334155 !important; } /* slate-700 */
        .card .text-gray-500 { color: #1f2937 !important; } /* gray-800 */

        /* Nav link default contrast */
        .nav-link { color: #ffffff !important; }
        .nav-link svg { color: inherit; }

        /* Semantic helpers mapped to Winter Chill */
        .text-primary { color: var(--wc-primary) !important; }
        .text-secondary { color: var(--wc-mid) !important; }
        .bg-accent { background-color: var(--wc-light) !important; }
        .border-accent { border-color: var(--wc-mid) !important; }

        /* Override common Tailwind color utilities used across templates */
        .text-blue-600, .text-indigo-600, .text-green-600, .text-emerald-600, .text-teal-600 { color: var(--wc-primary) !important; }
        .text-yellow-600, .text-orange-600 { color: var(--wc-mid) !important; }
        .text-red-600 { color: var(--wc-dark) !important; }

        .bg-blue-600, .bg-indigo-600, .bg-emerald-500, .bg-teal-600, .bg-green-500 { background-color: var(--wc-primary) !important; }
        .bg-green-50, .bg-blue-50, .bg-indigo-50 { background-color: rgba(184, 227, 233, 0.25) !important; }

        .from-indigo-600, .from-purple-600, .from-blue-600, .from-green-600, .from-emerald-400, .from-teal-400, .from-amber-400, .from-orange-400 { --tw-gradient-from: var(--wc-primary) !important; }
        .to-purple-600, .to-indigo-600, .to-blue-600, .to-emerald-600, .to-green-500, .to-cyan-500, .to-yellow-500, .to-orange-600 { --tw-gradient-to: var(--wc-mid) !important; }
        .from-green-100, .to-emerald-100, .via-purple-50, .to-pink-50, .from-indigo-50 { --tw-gradient-from: rgba(184, 227, 233, 0.35) !important; --tw-gradient-to: rgba(147, 177, 181, 0.35) !important; }
        
        /* Status badge enhancements - Winter Chill */
        .status-complete { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-primary), var(--wc-mid)); }
        .status-processing { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-mid), var(--wc-primary)); }
        .status-shipped { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-dark), var(--wc-primary)); }
        .status-draft { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-light), var(--wc-mid)); }
        
        /* Animated gradient background */
        .gradient-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Hover animations */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-lift:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
    
    <!-- Shared JavaScript utilities -->
    <script src="{{ url_for('static', filename='js/api-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modal-manager.js') }}"></script>
</head>
<body class="min-h-screen flex flex-col" style="background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);">
<script>
// CSRF Token Helper Functions - Defined early so they're available in all child templates
function getCSRFToken() {
    // Try to get CSRF token from meta tag first
    let token = document.querySelector('meta[name="csrf-token"]');
    if (token) {
        return token.getAttribute('content');
    }
    
    // Try to get from hidden input in any form
    token = document.querySelector('input[name="csrf_token"]');
    if (token) {
        return token.value;
    }
    
    // Try to get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') {
            return value;
        }
    }
    
    return null;
}

// Helper to add CSRF token to fetch headers
function getCSRFHeaders(additionalHeaders = {}) {
    const token = getCSRFToken();
    if (token) {
        return {
            'X-CSRFToken': token,
            'X-CSRF-Token': token, // Alternative header name
            ...additionalHeaders
        };
    }
    return additionalHeaders;
}

// Wrapper for fetch with CSRF token
async function csrfFetch(url, options = {}) {
    const method = (options.method || 'GET').toUpperCase();
    
    // Add CSRF token for state-changing methods
    if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
        options.headers = getCSRFHeaders(options.headers || {});
    }
    
    return fetch(url, options);
}

// Toggle bag reservation for bottles - defined early so it's available in modals
async function toggleBagReservation(bagId, currentlyReserved, productName, bagNumber, boxNumber) {
    const action = currentlyReserved ? 'unreserve' : 'reserve for bottles';
    
    try {
        const response = await csrfFetch(`/api/bag/${bagId}/reserve-bottles`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update button in modal
            const btn = document.getElementById(`reserve-btn-${bagId}`);
            if (btn) {
                if (data.reserved_for_bottles) {
                    btn.textContent = 'ðŸ¾ Unreserve';
                    btn.classList.remove('text-gray-600', 'hover:text-gray-800');
                    btn.classList.add('text-purple-600', 'hover:text-purple-800');
                } else {
                    btn.textContent = 'ðŸ“¦ Reserve';
                    btn.classList.remove('text-purple-600', 'hover:text-purple-800');
                    btn.classList.add('text-gray-600', 'hover:text-gray-800');
                }
            }
            
            // Show success message briefly
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-purple-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.textContent = data.message;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 2000);
        } else {
            alert('Error: ' + (data.error || 'Failed to update reservation'));
        }
    } catch (error) {
        console.error('Error toggling reservation:', error);
        alert('Failed to update reservation');
    }
}

// Toggle bag closed status - defined early so it's available in modals
async function toggleBagClosed(bagId, currentlyClosed, productName, bagNumber, boxNumber, receiveId, receiveName) {
    const action = currentlyClosed ? 'reopen' : 'close';
    const confirmMsg = currentlyClosed 
        ? `Are you sure you want to REOPEN ${productName} Bag ${bagNumber} (Box ${boxNumber})? It will become available for new submissions again.` 
        : `Are you sure you want to CLOSE ${productName} Bag ${bagNumber} (Box ${boxNumber})? It will no longer accept new submissions.`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await csrfFetch(`/api/bag/${bagId}/close`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Close the modal
            if (typeof closeReceiveDetailsModal === 'function') {
                closeReceiveDetailsModal();
            }
            
            // Show success message briefly
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.textContent = data.message;
            document.body.appendChild(successMsg);
            
            // Remove success message after 2 seconds
            setTimeout(() => successMsg.remove(), 2000);
            
            // Reopen the modal with updated data after a brief delay
            setTimeout(() => {
                if (typeof viewReceiveDetails === 'function') {
                    viewReceiveDetails(receiveId, receiveName);
                }
            }, 300);
        } else {
            alert('Error: ' + (data.error || 'Failed to update bag status'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update bag status');
    }
}

// Show admin notes - defined early
function showAdminNotes(adminNotes) {
    const modal = document.getElementById('admin-notes-view-modal');
    const content = document.getElementById('admin-notes-content');
    
    if (modal && content) {
        // Decode HTML entities and preserve newlines
        const decodedNotes = adminNotes 
            ? adminNotes.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"')
            : 'No notes available.';
        content.textContent = decodedNotes;
        modal.classList.remove('hidden');
    }
}

// Close admin notes modal - defined early
function closeAdminNotesModal(event) {
    const modal = document.getElementById('admin-notes-view-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
    if (event) {
        event.stopPropagation();
    }
}

// Close edit submission modal - defined early
function closeEditSubmissionModal(event) {
    // Always close the modal when called (whether from button click or backdrop click)
    const modal = document.getElementById('edit-submission-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
    // Prevent event propagation if event exists
    if (event) {
        event.stopPropagation();
    }
}

// Save submission edit - defined early
async function saveSubmissionEdit() {
    const submissionId = document.getElementById('edit-submission-id').value;
    const poId = document.getElementById('edit-po-context-po-id')?.value || '';
    const inventoryItemId = document.getElementById('edit-po-context-item-id')?.value || '';
    
    // Check if machine fields are visible (machine submission)
    const machineFields = document.getElementById('machine-fields');
    const isMachineSubmission = machineFields && !machineFields.classList.contains('hidden');
    
    const formData = {
        box_number: parseInt(document.getElementById('edit-box-number').value) || null,
        bag_number: parseInt(document.getElementById('edit-bag-number').value) || null,
        bag_label_count: parseInt(document.getElementById('edit-bag-label-count').value) || null,
        receipt_number: document.getElementById('edit-receipt-number')?.value?.trim() || null,
        submission_date: document.getElementById('edit-submission-date')?.value || null,
        admin_notes: document.getElementById('edit-admin-notes')?.value?.trim() || null,
        product_name: (document.getElementById('edit-product-name')?.value || document.getElementById('edit-product-name_item')?.value) || null
    };
    
    // Add type-specific fields
    if (isMachineSubmission) {
        // Machine count: displays_made stores machine_count, tablets_pressed_into_cards stores calculated total
        formData.displays_made = parseInt(document.getElementById('edit-machine-count').value) || 0;
        formData.tablets_pressed_into_cards = parseInt(document.getElementById('edit-tablets-pressed').value) || 0;
        formData.packs_remaining = 0;  // Not used for machine
        formData.loose_tablets = 0;    // Not used for machine
        formData.damaged_tablets = 0;  // Not used for machine
    } else {
        // Packaging/bag count fields
        formData.displays_made = parseInt(document.getElementById('edit-displays').value) || 0;
        formData.packs_remaining = parseInt(document.getElementById('edit-packs').value) || 0;
        formData.loose_tablets = parseInt(document.getElementById('edit-loose').value) || 0;
        formData.damaged_tablets = parseInt(document.getElementById('edit-damaged').value) || 0;
        formData.tablets_pressed_into_cards = 0;  // Not used for packaging
    }
    
    try {
        const response = await csrfFetch(`/api/submission/${submissionId}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Use showSuccess if available, otherwise alert
            if (typeof showSuccess === 'function') {
                showSuccess('Submission updated successfully!');
            } else {
                alert('Submission updated successfully!');
            }
            closeEditSubmissionModal();
            
            // If we're in a PO modal context, refresh it instead of reloading the page
            if (poId && poId !== '') {
                // Refresh the PO submissions modal
                const poNumber = document.querySelector('#submissions-modal h3')?.textContent.match(/PO-[^\s]+/)?.[0] || '';
                if (poNumber && typeof viewPOSubmissions === 'function') {
                    viewPOSubmissions(parseInt(poId), poNumber, inventoryItemId || null);
                } else {
                    location.reload();
                }
            } else {
                location.reload();
            }
        } else {
            const errorMsg = result.error || 'Failed to update submission';
            if (typeof showError === 'function') {
                showError(errorMsg);
            } else {
                alert('Error: ' + errorMsg);
            }
        }
    } catch (error) {
        console.error('Error saving submission:', error);
        const errorMsg = 'Failed to save submission: ' + error.message;
        if (typeof showError === 'function') {
            showError(errorMsg);
        } else {
            alert('Error: ' + errorMsg);
        }
    }
}

// Edit submission modal - defined early
async function openEditSubmissionModal(submissionId, poId = null, inventoryItemId = null) {
    try {
        const response = await fetch(`/api/submission/${submissionId}/details`);
        const data = await response.json();
        
        if (!data.success) {
            alert(data.error || 'Failed to load submission');
            return;
        }
        
        const sub = data.submission;
        const submissionType = sub.submission_type || 'packaged';
        
        // Show/hide appropriate fields based on submission type
        const machineFields = document.getElementById('machine-fields');
        const packagingFields = document.getElementById('packaging-fields');
        
        if (submissionType === 'machine') {
            if (machineFields) machineFields.classList.remove('hidden');
            if (packagingFields) packagingFields.classList.add('hidden');
        } else {
            if (machineFields) machineFields.classList.add('hidden');
            if (packagingFields) packagingFields.classList.remove('hidden');
        }
        
        // Populate the form
        const editSubIdInput = document.getElementById('edit-submission-id');
        if (editSubIdInput) editSubIdInput.value = sub.id;
        
        const poContextInput = document.getElementById('edit-po-context-po-id');
        const itemContextInput = document.getElementById('edit-po-context-item-id');
        if (poContextInput && poId !== null) poContextInput.value = poId || '';
        if (itemContextInput && inventoryItemId !== null) itemContextInput.value = inventoryItemId || '';
        
        // Populate fields based on submission type
        if (submissionType === 'machine') {
            // Machine submission fields - use correct field IDs
            const editMachineCount = document.getElementById('edit-machine-count');
            const editTablets = document.getElementById('edit-tablets-pressed');
            const editBox = document.getElementById('edit-box-number');
            const editBag = document.getElementById('edit-bag-number');
            const editBagLabel = document.getElementById('edit-bag-label-count');
            const editReceipt = document.getElementById('edit-receipt-number');
            const editDate = document.getElementById('edit-submission-date');
            
            if (editMachineCount) editMachineCount.value = sub.displays_made || 0;
            if (editTablets) editTablets.value = sub.tablets_pressed_into_cards || 0;
            if (editBox) editBox.value = sub.box_number || '';
            if (editBag) editBag.value = sub.bag_number || '';
            if (editBagLabel) editBagLabel.value = sub.bag_label_count || '';
            if (editReceipt) editReceipt.value = sub.receipt_number || '';
            if (editDate) {
                // Format date properly for date input
                const submissionDate = sub.submission_date || (sub.created_at ? sub.created_at.split(' ')[0] : '');
                editDate.value = submissionDate;
            }
        } else {
            // Packaging fields - use correct field IDs
            const editDisplays = document.getElementById('edit-displays');
            const editPacks = document.getElementById('edit-packs');
            const editLoose = document.getElementById('edit-loose');
            const editDamaged = document.getElementById('edit-damaged');
            const editBox = document.getElementById('edit-box-number');
            const editBag = document.getElementById('edit-bag-number');
            const editBagLabel = document.getElementById('edit-bag-label-count');
            const editReceipt = document.getElementById('edit-receipt-number');
            const editDate = document.getElementById('edit-submission-date');
            
            if (editDisplays) editDisplays.value = sub.displays_made || 0;
            if (editPacks) editPacks.value = sub.packs_remaining || 0;
            if (editLoose) editLoose.value = sub.loose_tablets || 0;
            if (editDamaged) editDamaged.value = sub.damaged_tablets || 0;
            if (editBox) editBox.value = sub.box_number || '';
            if (editBag) editBag.value = sub.bag_number || '';
            if (editBagLabel) editBagLabel.value = sub.bag_label_count || '';
            if (editReceipt) editReceipt.value = sub.receipt_number || '';
            if (editDate) {
                // Format date properly for date input
                const submissionDate = sub.submission_date || (sub.created_at ? sub.created_at.split(' ')[0] : '');
                editDate.value = submissionDate;
            }
        }
        
        // Populate admin notes if exists
        const adminNotesTextarea = document.getElementById('edit-admin-notes');
        if (adminNotesTextarea) {
            adminNotesTextarea.value = sub.admin_notes || '';
        }
        
        // Show current product and load product list
        const currentProductEl = document.getElementById('edit-current-product');
        if (currentProductEl) {
            currentProductEl.textContent = sub.product_name || 'Unknown';
        }
        
        // Load all products from product_details for dropdown
        // We need product_name, not tablet_type_name
        const productSelect = document.getElementById('edit-product-name');
        if (productSelect) {
            // First, clear and show loading
            productSelect.innerHTML = '<option value="">Loading products...</option>';
            
            // Fetch products - we'll need to get product_names from product_details
            // Since there's no API endpoint for products, we'll fetch tablet_types and map them
            // But actually, we can use the production page's data structure
            fetch('/api/tablet_types')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.tablet_types) {
                        throw new Error('Failed to load products');
                    }
                    
                    // Clear and populate with tablet types (which will be converted to 2-tier)
                    productSelect.innerHTML = '<option value="">Select product...</option>';
                    
                    // Add all tablet types as options
                    // Note: The backend edit endpoint accepts product_name, so we need to map
                    // tablet_type_name to product_name. For now, we'll use tablet_type_name
                    // and the backend will handle the lookup
                    data.tablet_types.forEach(tabletType => {
                        const option = document.createElement('option');
                        option.value = tabletType.tablet_type_name;
                        option.textContent = tabletType.tablet_type_name;
                        productSelect.appendChild(option);
                    });
                    
                    // Convert to two-level dropdown
                    return convertToTwoLevelDropdown(productSelect);
                })
                .then(() => {
                    // After conversion, try to set the current product
                    // IMPORTANT: Don't auto-select if there's no exact match to prevent auto-changing the product
                    if (sub.product_name) {
                        const itemSelect = document.getElementById('edit-product-name_item');
                        const originalSelect = document.getElementById('edit-product-name');
                        const groupSelect = document.getElementById('edit-product-name_group');
                        
                        if (itemSelect && originalSelect) {
                            // Find option that exactly matches product_name
                            const matchingOption = Array.from(itemSelect.options).find(
                                opt => opt.value === sub.product_name || opt.textContent.trim() === sub.product_name.trim()
                            );
                            
                            if (matchingOption) {
                                // Only set if we have an exact match
                                itemSelect.value = matchingOption.value;
                                originalSelect.value = matchingOption.value;
                                // Trigger change to update the hidden original select
                                itemSelect.dispatchEvent(new Event('change'));
                            } else {
                                // No match found - don't auto-select anything
                                // This prevents the product from changing automatically
                                console.log('No exact match found for product:', sub.product_name, '- dropdown will remain unselected');
                                // Keep the dropdown showing "Select product..." to indicate no selection
                                // The user can manually select the correct product if needed
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    if (productSelect) {
                        productSelect.innerHTML = '<option value="">Error loading products</option>';
                    }
                });
        }
        
        // Show modal
        const modal = document.getElementById('edit-submission-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading submission:', error);
        alert('Failed to load submission: ' + error.message);
    }
}

// Convert tablet type dropdown to two-level dropdown system
// Moved here to be available for openEditSubmissionModal
async function convertToTwoLevelDropdown(selectElement) {
    if (!selectElement || selectElement.tagName !== 'SELECT') return;
    
    // Check if already converted
    if (selectElement.dataset.twoLevelConverted === 'true') return;
    selectElement.dataset.twoLevelConverted = 'true';
    
    const options = Array.from(selectElement.options);
    const placeholder = options.find(opt => opt.value === '' || opt.value === null);
    const originalValue = selectElement.value;
    
    // Try to fetch configured categories from API
    let groups = {};
    let groupOrder = []; // Will be populated from API, no hardcoded fallback
    
    try {
        const response = await fetch('/api/tablet_types/categories');
        const data = await response.json();
        
        if (data.success && data.categories) {
            // Use configured categories
            groups = {};
            groupOrder = data.category_order || groupOrder;
            
            // Initialize groups
            groupOrder.forEach(cat => {
                groups[cat] = [];
            });
            
            // Map options to categories based on configured categories
            options.forEach(option => {
                if (!option.value || option.value === '') return;
                
                // Find which category this tablet type belongs to
                let found = false;
                for (const [category, items] of Object.entries(data.categories)) {
                    const matchingItem = items.find(item => item.id == option.value || item.name === option.text.trim());
                    if (matchingItem) {
                        if (!groups[category]) {
                            groups[category] = [];
                        }
                        groups[category].push(option);
                        found = true;
                        break;
                    }
                }
                
                // If not found in configured categories, use fallback logic
                if (!found) {
                    const name = option.text.trim();
                    let categorized = false;
                    
                    // FIX Energy variants
                    if (name.match(/^\d+ct\s+FIX\s+Energy/i) || name.match(/^FIX\s+Energy\s+\d+ct/i)) {
                        if (!groups['FIX Energy']) groups['FIX Energy'] = [];
                        groups['FIX Energy'].push(option);
                        categorized = true;
                    }
                    // FIX Focus variants
                    else if (name.match(/^\d+ct\s+FIX\s+Focus/i) || name.match(/^FIX\s+Focus\s+\d+ct/i)) {
                        if (!groups['FIX Focus']) groups['FIX Focus'] = [];
                        groups['FIX Focus'].push(option);
                        categorized = true;
                    }
                    // FIX Relax variants
                    else if (name.match(/^\d+ct\s+FIX\s+Relax/i) || name.match(/^FIX\s+Relax\s+\d+ct/i)) {
                        if (!groups['FIX Relax']) groups['FIX Relax'] = [];
                        groups['FIX Relax'].push(option);
                        categorized = true;
                    }
                    // FIX MAX variants
                    else if (name.match(/^FIX\s+MAX/i)) {
                        if (!groups['FIX MAX']) groups['FIX MAX'] = [];
                        groups['FIX MAX'].push(option);
                        categorized = true;
                    }
                    // 18mg variants
                    else if (name.match(/^18mg/i)) {
                        if (!groups['18mg']) groups['18mg'] = [];
                        groups['18mg'].push(option);
                        categorized = true;
                    }
                    // XL variants
                    else if (name.match(/^XL\s+/i)) {
                        if (!groups['XL']) groups['XL'] = [];
                        groups['XL'].push(option);
                        categorized = true;
                    }
                    // Hyroxi variants
                    else if (name.match(/^Hyroxi/i)) {
                        if (!groups['Hyroxi']) groups['Hyroxi'] = [];
                        groups['Hyroxi'].push(option);
                        categorized = true;
                    }
                    
                    if (!categorized) {
                        if (!groups['Other']) groups['Other'] = [];
                        groups['Other'].push(option);
                    }
                }
            });
        } else {
            throw new Error('Failed to load categories');
        }
    } catch (error) {
        // Fallback to hardcoded logic if API fails
        console.warn('Failed to load configured categories, using fallback:', error);
        groups = {
            'FIX Energy': [],
            'FIX Focus': [],
            'FIX Relax': [],
            'FIX MAX': [],
            '18mg': [],
            'XL': [],
            'Hyroxi': [],
            'Other': []
        };
        
        // Categorize each option using fallback logic
        options.forEach(option => {
            if (!option.value || option.value === '') return;
            
            const name = option.text.trim();
            let categorized = false;
            
            // FIX Energy variants
            if (name.match(/^\d+ct\s+FIX\s+Energy/i) || name.match(/^FIX\s+Energy\s+\d+ct/i)) {
                groups['FIX Energy'].push(option);
                categorized = true;
            }
            // FIX Focus variants
            else if (name.match(/^\d+ct\s+FIX\s+Focus/i) || name.match(/^FIX\s+Focus\s+\d+ct/i)) {
                groups['FIX Focus'].push(option);
                categorized = true;
            }
            // FIX Relax variants
            else if (name.match(/^\d+ct\s+FIX\s+Relax/i) || name.match(/^FIX\s+Relax\s+\d+ct/i)) {
                groups['FIX Relax'].push(option);
                categorized = true;
            }
            // FIX MAX variants
            else if (name.match(/^FIX\s+MAX/i)) {
                groups['FIX MAX'].push(option);
                categorized = true;
            }
            // 18mg variants
            else if (name.match(/^18mg/i)) {
                groups['18mg'].push(option);
                categorized = true;
            }
            // XL variants
            else if (name.match(/^XL\s+/i)) {
                groups['XL'].push(option);
                categorized = true;
            }
            // Hyroxi variants
            else if (name.match(/^Hyroxi/i)) {
                groups['Hyroxi'].push(option);
                categorized = true;
            }
            
            if (!categorized) {
                groups['Other'].push(option);
            }
        });
    }
    
    // Sort within groups (by count if numeric, then alphabetically)
    Object.keys(groups).forEach(groupName => {
        groups[groupName].sort((a, b) => {
            const aText = a.text.trim();
            const bText = b.text.trim();
            // Extract count if present (e.g., "12ct" -> 12)
            const aMatch = aText.match(/(\d+)ct/i);
            const bMatch = bText.match(/(\d+)ct/i);
            if (aMatch && bMatch) {
                return parseInt(aMatch[1]) - parseInt(bMatch[1]);
            }
            return aText.localeCompare(bText);
        });
    });
    
    // Hide original select and remove required attribute (prevents "not focusable" error)
    selectElement.style.display = 'none';
    selectElement.removeAttribute('required');
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'space-y-2';
    
    // Create group dropdown
    const groupSelect = document.createElement('select');
    groupSelect.className = selectElement.className;
    groupSelect.id = selectElement.id + '_group';
    groupSelect.name = selectElement.name + '_group';
    groupSelect.innerHTML = '<option value="">Select category...</option>';
    
    // Create item dropdown
    const itemSelect = document.createElement('select');
    itemSelect.className = selectElement.className;
    itemSelect.id = selectElement.id + '_item';
    itemSelect.name = selectElement.name;
    itemSelect.required = true; // Always required - this is the actual selection field
    itemSelect.innerHTML = '<option value="">Select tablet type...</option>';
    itemSelect.style.display = 'none';
    
    // Add groups to group dropdown
    groupOrder.forEach(groupName => {
        if (!groups[groupName] || groups[groupName].length === 0) return;
        const option = document.createElement('option');
        option.value = groupName;
        option.textContent = groupName;
        groupSelect.appendChild(option);
    });
    
    // Store groups data
    groupSelect.dataset.groups = JSON.stringify(groups);
    
    // Handle group selection
    groupSelect.addEventListener('change', function() {
        const selectedGroup = this.value;
        itemSelect.innerHTML = '<option value="">Select tablet type...</option>';
        itemSelect.style.display = 'none';
        selectElement.value = '';
        
        if (selectedGroup && groups[selectedGroup]) {
            // Populate item dropdown with case-insensitive alphabetical sorting
            const sortedOptions = groups[selectedGroup].slice().sort((a, b) => 
                a.text.localeCompare(b.text, undefined, { sensitivity: 'base' })
            );
            sortedOptions.forEach(option => {
                const itemOption = document.createElement('option');
                itemOption.value = option.value;
                itemOption.textContent = option.text;
                itemSelect.appendChild(itemOption);
            });
            itemSelect.style.display = '';
        }
    });
    
    // Handle item selection
    itemSelect.addEventListener('change', function() {
        selectElement.value = this.value;
        // Trigger change event on original select for form validation
        selectElement.dispatchEvent(new Event('change', { bubbles: true }));
    });
    
    // Restore original value if set
    if (originalValue) {
        // Find which group contains this value
        for (const [groupName, groupOptions] of Object.entries(groups)) {
            const found = groupOptions.find(opt => opt.value === originalValue);
            if (found) {
                groupSelect.value = groupName;
                groupSelect.dispatchEvent(new Event('change'));
                setTimeout(() => {
                    itemSelect.value = originalValue;
                    selectElement.value = originalValue;
                }, 0);
                break;
            }
        }
    }
    
    // Insert wrapper before select
    const parent = selectElement.parentNode;
    parent.insertBefore(wrapper, selectElement);
    wrapper.appendChild(groupSelect);
    wrapper.appendChild(itemSelect);
    wrapper.appendChild(selectElement); // Keep original for form submission
}
</script>
<body class="min-h-screen flex flex-col" style="background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);">
    <!-- SVG Sprite -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <symbol id="icon-chart" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v18h14a1 1 0 1 1 0 2H4a1 1 0 0 1-1-1V3Z"/>
            <path d="M8 17a1 1 0 0 0 1-1v-6a1 1 0 1 0-2 0v6a1 1 0 0 0 1 1Zm5 0a1 1 0 0 0 1-1V7a1 1 0 1 0-2 0v9a1 1 0 0 0 1 1Zm5 0a1 1 0 0 0 1-1v-4a1 1 0 1 0-2 0v4a1 1 0 0 0 1 1Z"/>
        </symbol>
        <symbol id="icon-box" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 8.5V17a2 2 0 0 1-1.106 1.789l-7 3.5a2 2 0 0 1-1.788 0l-7-3.5A2 2 0 0 1 3 17V8.5l8.106 4.053a2 2 0 0 0 1.788 0L21 8.5ZM20.553 6.894 12.447 3.34a2 2 0 0 0-1.894 0L2.447 6.894A1 1 0 0 0 2 7.776V8l9 4.5a1 1 0 0 0 .894 0L21 8V7.776a1 1 0 0 0-.447-.882Z"/>
        </symbol>
        <symbol id="icon-calc" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm2 4v4h8V6H8Zm0 6v6h2v-6H8Zm4 0v6h2v-6h-2Zm4 0v6h2v-6h-2Z"/>
        </symbol>
        <symbol id="icon-gear" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm9.4 4a7.4 7.4 0 0 0-.132-1.3l2.044-1.582-2-3.464-2.4.6a7.47 7.47 0 0 0-2.252-1.302L14.4 1h-4.8l-.96 2.952a7.47 7.47 0 0 0-2.252 1.302l-2.4-.6-2 3.464L3.032 10.7A7.402 7.402 0 0 0 2.9 12c0 .44.044.867.132 1.3L.988 14.882l2 3.464 2.4-.6a7.47 7.47 0 0 0 2.252 1.302L9.6 23h4.8l.96-2.952a7.47 7.47 0 0 0 2.252-1.302l2.4.6 2-3.464-2.044-1.582c.088-.433.132-.86.132-1.3Z"/>
        </symbol>
        <symbol id="icon-eye" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 5c6 0 10 7 10 7s-4 7-10 7S2 12 2 12s4-7 10-7Zm0 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/>
        </symbol>
        <symbol id="icon-bolt" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 2 3 14h7l-1 8 11-12h-7l0-8Z"/>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 11h5v-2h-4V7h-2v6Z"/>
        </symbol>
        <symbol id="icon-exclamation" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z"/>
        </symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.285 6.708 9 18l-5.285-5.292 1.415-1.416L9 15.172l9.87-9.88 1.415 1.416Z"/>
        </symbol>
        <symbol id="icon-users" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4ZM6 13a3 3 0 1 0-3-3 3 3 0 0 0 3 3Zm10 2a6 6 0 0 0-6 6h12a6 6 0 0 0-6-6Zm-10 1a5 5 0 0 0-5 5h6a5 5 0 0 0-5-5Z"/>
        </symbol>
        <symbol id="icon-user" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 1 1-5 5 5 5 0 0 1 5-5Zm0 9a7 7 0 0 0-7 7h14a7 7 0 0 0-7-7Z"/>
        </symbol>
        <symbol id="icon-user-helmet" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 0 0-5 5v1h10V7a5 5 0 0 0-5-5Zm-7 12a7 7 0 0 1 14 0v3H5v-3Z"/>
        </symbol>
        <symbol id="icon-lock" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 8h-1V6a4 4 0 1 0-8 0v2H7a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2Zm-5 8a2 2 0 1 1 2-2 2 2 0 0 1-2 2Z"/>
        </symbol>
        <symbol id="icon-login" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 17 15 12 10 7v3H3v4h7v3Zm2-15h7a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2h-7v-2h7V4h-7V2Z"/>
        </symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 7V4h7v16h-7v-3h-2v5h11V2H12v5h2Zm-2 5-5-5v3H2v4h5v3l5-5Z"/>
        </symbol>
        <symbol id="icon-lab" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 2h8v2l-3 5v6l5 5H6l5-5V9L8 4V2Z"/>
        </symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm18-11.5a1 1 0 0 0 0-1.41L18.66 1a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75L21 5.75Z"/>
        </symbol>
        <symbol id="icon-truck" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3h12v8h4l2 3v6h-2a3 3 0 0 1-6 0H9a3 3 0 0 1-6 0H1V5a2 2 0 0 1 2-2Zm3 16a1 1 0 1 0 1 1 1 1 0 0 0-1-1Zm10 0a1 1 0 1 0 1 1 1 1 0 0 0-1-1Z"/>
        </symbol>
        <symbol id="icon-cart" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4ZM5.656 4.172A1 1 0 0 1 6.586 4h14.828a1 1 0 0 1 .97 1.243l-2.5 10A1 1 0 0 1 19.914 16H7.5l-.258 1.03A1 1 0 0 1 6.273 18H3v-2h2.273l2.313-9.253a1 1 0 0 1 .07-.575ZM8.414 6l-1.8 7.2h11.471l1.875-7.5H8.414Z"/>
        </symbol>
        <symbol id="icon-plug" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 2h2v6h6V2h2v6h3v2H4V8h3V2Z"/>
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 11V4h2v7h7v2h-7v7h-2v-7H4v-2h7Z"/>
        </symbol>
        <symbol id="icon-x" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.3 5.71 12 12l6.3 6.29-1.42 1.42L10.59 13.41 4.29 19.71 2.87 18.29 9.17 12 2.87 5.71 4.29 4.29l6.3 6.3 6.29-6.3 1.42 1.42Z"/>
        </symbol>
        <symbol id="icon-list" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16v2H4V6Zm0 5h16v2H4v-2Zm0 5h16v2H4v-2Z"/>
        </symbol>
        <symbol id="icon-mobile" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm5 18a1.5 1.5 0 1 0-1.5-1.5A1.5 1.5 0 0 0 12 20Z"/>
        </symbol>
        <symbol id="icon-laptop" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8H4V6Zm-2 10h20v2H2v-2Z"/>
        </symbol>
        <symbol id="icon-send" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2 21 23 12 2 3v7l15 2-15 2v7Z"/>
        </symbol>
        <symbol id="icon-document" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Zm4 18H6V4h7v5h5v11Z"/>
        </symbol>
        <symbol id="icon-clipboard" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 2a1 1 0 0 0-1 1v1H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2V3a1 1 0 0 0-1-1H9Zm0 2h6v1H9V4Zm-3 3h12v12H6V7Z"/>
        </symbol>
        <symbol id="icon-bottle" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 2a1 1 0 0 0-1 1v2.17A3 3 0 0 0 7 8v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V8a3 3 0 0 0-2-2.83V3a1 1 0 0 0-1-1h-4Zm1 2h2v1.5h-2V4ZM9 8a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v12H9V8Z"/>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2v10l3-3 1.5 1.5L12 15l-4.5-4.5L9 9l3 3V2h2Zm-7 18h14v2H5v-2Z"/>
        </symbol>
        <symbol id="icon-spinner" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a10 10 0 0 1 10 10h-2a8 8 0 0 0-8-8V2Z"/>
        </symbol>
        <symbol id="icon-language" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            <path d="M3.9 12c0-4.42 3.58-8 8-8s8 3.58 8 8h-2c0-3.31-2.69-6-6-6s-6 2.69-6 6H3.9z"/>
            <path d="M12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
        </symbol>
    </svg>
    <!-- Enhanced navigation with earthy green gradient -->
    <nav class="bg-gradient-to-r" style="background-image: linear-gradient(90deg, var(--wc-dark), #082025, var(--wc-primary));" class="text-white shadow-2xl">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">
                    <a href="{{ url_for('auth.index') }}" class="hover:text-primary transition-colors duration-300 flex items-center">
                        <svg class="w-7 h-7 mr-2" aria-hidden="true"><use href="#icon-chart" /></svg>
                        <span class="bg-gradient-to-r from-white to-[#B8E3E9] bg-clip-text text-transparent">TabletTracker</span>
                        <span class="ml-2 text-xs text-gray-300 font-normal">v{{ version() }}</span>
                    </a>
            </h1>
                <div class="hidden md:flex space-x-6">
                    <!-- Dashboard - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('dashboard.dashboard_view') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-chart" /></svg> Dashboard
                    </a>
                    {% endif %}
                    
                    <!-- Shipments Received - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('receiving.receiving_list') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-box" /></svg> Shipments Received
                    </a>
                    {% endif %}
                    
                    <!-- Production - Always visible for employees -->
                    <a href="{{ url_for('production.production_form') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-box" /></svg> Production
                    </a>
                    
                    <!-- Submissions - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('submissions.submissions_list') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-list" /></svg> Submissions
                    </a>
                    {% endif %}
                    
                    <!-- Purchase Orders - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('purchase_orders.purchase_orders_list') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-cart" /></svg> Purchase Orders
                    </a>
                    {% endif %}
                    
                    <!-- Admin - Admin only -->
                    {% if session.employee_role == 'admin' %}
                    <a href="{{ url_for('admin.admin_panel') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-gear" /></svg> Admin
                    </a>
                    {% endif %}
                    <!-- Logout Button -->
                    {% if session.employee_authenticated or session.admin_authenticated %}
                    <a href="{{ url_for('auth.logout') }}" class="nav-link hover:text-red-300 transition-all duration-300 px-3 py-2 rounded-lg hover:bg-red-500 hover:bg-opacity-20 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-logout" /></svg>
                        <span class="hidden sm:inline">Logout</span>
                    </a>
                    {% endif %}
                    
                    <!-- Language Toggle -->
                    <div class="relative ml-4">
                        <button onclick="toggleLanguageMenu()" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                            <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-language" /></svg>
                            <span class="hidden sm:inline">{{ (current_language.language if current_language is not string else current_language) | upper }}</span>
                        </button>
                        <div id="language-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-50">
                            {% for code, name in languages.items() %}
                            <a href="?lang={{ code }}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 {% if current_language == code %}bg-blue-50 text-blue-600 font-medium{% endif %}">
                                <span class="mr-2">{% if code == 'en' %}ðŸ‡ºðŸ‡¸{% else %}ðŸ‡ªðŸ‡¸{% endif %}</span>
                                {{ name }}
                                {% if current_language == code %}<span class="float-right">âœ“</span>{% endif %}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-white hover:text-primary transition-colors duration-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Mobile menu -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-3">
                {% if session.employee_role in ['manager', 'admin'] %}
                <a href="{{ url_for('dashboard.dashboard_view') }}" class="nav-link block text-base font-medium hover:text-primary transition-colors duration-300 px-4 py-4 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center"><svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-chart" /></svg> Dashboard</a>
                <a href="{{ url_for('receiving.receiving_list') }}" class="nav-link block text-base font-medium hover:text-primary transition-colors duration-300 px-4 py-4 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center"><svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-box" /></svg> Shipments Received</a>
                {% endif %}
                <a href="{{ url_for('production.production_form') }}" class="nav-link block text-base font-medium hover:text-primary transition-colors duration-300 px-4 py-4 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center"><svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-box" /></svg> Production</a>
                {% if session.employee_role in ['manager', 'admin'] %}
                <a href="{{ url_for('submissions.submissions_list') }}" class="nav-link block text-base font-medium hover:text-primary transition-colors duration-300 px-4 py-4 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center"><svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-list" /></svg> Submissions</a>
                <a href="{{ url_for('purchase_orders.purchase_orders_list') }}" class="nav-link block text-base font-medium hover:text-primary transition-colors duration-300 px-4 py-4 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center"><svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-cart" /></svg> Purchase Orders</a>
                {% endif %}
                {% if session.employee_role == 'admin' %}
                <a href="{{ url_for('admin.admin_panel') }}" class="nav-link block text-base font-medium hover:text-primary transition-colors duration-300 px-4 py-4 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center"><svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-gear" /></svg> Admin</a>
                {% endif %}
                {% if session.employee_authenticated or session.admin_authenticated %}
                <a href="{{ url_for('auth.logout') }}" class="nav-link block text-base font-medium hover:text-red-300 transition-colors duration-300 px-4 py-4 rounded-lg hover:bg-red-500 hover:bg-opacity-20 flex items-center"><svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-logout" /></svg> Logout</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Enhanced main content area -->
    <main class="flex-1 container mx-auto px-4 py-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-6 p-4 rounded-xl shadow-lg transform transition-all duration-500 hover:scale-105 {% if category == 'error' %}bg-gradient-to-r from-[#0B2E33] to-[#4F7C82] text-white border border-[#93B1B5]{% else %}bg-gradient-to-r from-[#4F7C82] to-[#93B1B5] text-white border border-[#B8E3E9]{% endif %}">
                        <div class="flex items-center">
                            {% if category == 'error' %}
                                <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-exclamation" /></svg>
                            {% else %}
                                <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-check" /></svg>
                            {% endif %}
                            <span class="font-medium">{{ message }}</span>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Footer with version info -->
    <footer class="mt-auto py-4 text-center text-gray-500 text-sm">
        <div class="container mx-auto px-4">
            <p>{{ app_title }} v{{ version() }} - {{ app_description }}</p>
        </div>
    </footer>

    <script>
        // Enhanced JavaScript utilities with better styling
        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-6 right-6 bg-gradient-to-r from-emerald-500 to-green-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-500 scale-0';
            
            // Create structure safely to prevent XSS
            const container = document.createElement('div');
            container.className = 'flex items-center';
            
            const icon = document.createElement('span');
            icon.className = 'text-2xl mr-3';
            icon.textContent = 'âœ…';
            
            const text = document.createElement('span');
            text.className = 'font-semibold';
            text.textContent = message; // textContent automatically escapes HTML
            
            container.appendChild(icon);
            container.appendChild(text);
            alert.appendChild(container);
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => alert.classList.add('scale-100'), 100);
            
            // Animate out and remove
            setTimeout(() => {
                alert.classList.add('scale-0', 'opacity-0');
                setTimeout(() => alert.remove(), 300);
            }, 3500);
        }

        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-6 right-6 bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-500 scale-0';
            
            // Create structure safely to prevent XSS
            const container = document.createElement('div');
            container.className = 'flex items-center';
            
            const icon = document.createElement('span');
            icon.className = 'text-2xl mr-3';
            icon.textContent = 'âš ï¸';
            
            const text = document.createElement('span');
            text.className = 'font-semibold';
            text.textContent = message; // textContent automatically escapes HTML
            
            container.appendChild(icon);
            container.appendChild(text);
            alert.appendChild(container);
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => alert.classList.add('scale-100'), 100);
            
            // Animate out and remove
            setTimeout(() => {
                alert.classList.add('scale-0', 'opacity-0');
                setTimeout(() => alert.remove(), 300);
            }, 5500);
        }

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        // Language menu toggle function
        function toggleLanguageMenu() {
            const menu = document.getElementById('language-menu');
            menu.classList.toggle('hidden');
        }

        // Close language menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('language-menu');
            const button = event.target.closest('button[onclick="toggleLanguageMenu()"]');
            
            if (!button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Add some sparkle effect on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add subtle animation to cards and buttons
            const cards = document.querySelectorAll('.card');
            const buttons = document.querySelectorAll('.btn-primary, .btn-success, .btn-warning');
            
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>

<!-- Shared Edit Submission Modal (Available on all pages) -->
<div id="edit-submission-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-[60]" onclick="closeEditSubmissionModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <!-- Fixed Header -->
        <div class="flex-shrink-0 p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">Edit Submission</h3>
                <button onclick="event.stopPropagation(); closeEditSubmissionModal(event)" class="text-gray-400 hover:text-gray-600 z-10 relative">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
        </div>
        
        <input type="hidden" id="edit-submission-id">
        <input type="hidden" id="edit-po-context-po-id">
        <input type="hidden" id="edit-po-context-item-id">
        
        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="space-y-4">
                <!-- Machine Count Fields (only for machine submissions) -->
                <div id="machine-fields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Machine Counter Reading</label>
                        <input type="number" id="edit-machine-count" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">The counter number from the machine</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Tablets Pressed</label>
                        <input type="number" id="edit-tablets-pressed" min="0" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">Read-only: Calculated from machine count</p>
                    </div>
                </div>
                
                <!-- Packaging Fields (for packaged and bag count submissions) -->
                <div id="packaging-fields" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Displays Made</label>
                        <input type="number" id="edit-displays" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cards Remaining</label>
                        <input type="number" id="edit-packs" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loose Tablets</label>
                        <input type="number" id="edit-loose" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Damaged Tablets</label>
                        <input type="number" id="edit-damaged" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Box Number</label>
                        <input type="number" id="edit-box-number" min="1" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bag Number</label>
                        <input type="number" id="edit-bag-number" min="1" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bag Label Count</label>
                        <input type="number" id="edit-bag-label-count" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- Receipt Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Receipt #</label>
                    <input type="text" id="edit-receipt-number" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter receipt number">
                </div>
                
                <!-- Submission Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Submission Date</label>
                    <input type="date" id="edit-submission-date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Change this if submitting for a different date</p>
                </div>
                
                <!-- Product/Flavor Selector -->
                <div id="product-selector-section" class="border-t pt-4 mt-4">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded mb-3">
                        <p class="text-sm text-yellow-800 font-semibold">âš ï¸ Change Product/Flavor (Admin Only)</p>
                        <p class="text-xs text-yellow-700 mt-1">Current: <span id="edit-current-product" class="font-semibold"></span></p>
                        <p class="text-xs text-yellow-700 mt-1">Only change this if the submission was entered with the wrong flavor.</p>
                    </div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Correct Product/Flavor:</label>
                    <select id="edit-product-name" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Loading products...</option>
                    </select>
                </div>
                
                <!-- Admin Notes (Editable) -->
                <div id="admin-notes-section" class="mt-4">
                    <label class="block text-sm font-medium text-purple-800 mb-1">ðŸ”’ Admin Notes (Optional)</label>
                    <textarea id="edit-admin-notes" rows="3"
                              class="w-full px-3 py-2 border border-purple-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 bg-purple-50 text-sm text-gray-700"
                              placeholder="Add internal notes visible to admins and managers..."></textarea>
                    <p class="text-xs text-purple-600 mt-1">These notes are visible to administrators and managers</p>
                </div>
                
                <!-- Admin Change PO Section (Only for verified submissions) -->
                <div id="admin-change-po-section" class="mt-4 hidden border-t pt-4">
                    <div class="mb-3 bg-red-50 border-l-4 border-red-400 p-3 rounded">
                        <p class="text-sm text-red-800 font-semibold mb-1">âš ï¸ ADMIN OVERRIDE - Change PO</p>
                        <p class="text-sm text-red-700">This submission is verified and locked. Changing the PO requires admin override.</p>
                        <p class="text-sm text-red-700 mt-1"><strong>Current PO:</strong> <span id="edit-current-po-display"></span></p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="edit-admin-confirm-checkbox" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">I understand this is an admin override and want to change the PO</span>
                        </label>
                    </div>
                    
                    <div id="edit-admin-pos-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select New PO:</label>
                        <div id="edit-admin-pos-list" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <!-- PO list will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fixed Footer -->
        <div class="flex-shrink-0 p-6 border-t border-gray-200 bg-white">
            <div class="flex justify-end gap-3">
                <button onclick="event.stopPropagation(); closeEditSubmissionModal(event)" 
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                    Cancel
                </button>
                <button onclick="saveSubmissionEdit()" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Notes View Modal (Read-only) -->
<div id="admin-notes-view-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-[70]" onclick="closeAdminNotesModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Admin Notes</h3>
                <button onclick="event.stopPropagation(); closeAdminNotesModal(event)" class="text-gray-400 hover:text-gray-600">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            
            <div class="mb-4">
                <div class="bg-purple-50 border border-purple-200 rounded-md p-4">
                    <div id="admin-notes-content" class="text-sm text-gray-700 whitespace-pre-wrap"></div>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button onclick="event.stopPropagation(); closeAdminNotesModal(event)" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Shared Edit Submission Modal JavaScript (Available on all pages) -->
<script>
// showAdminNotes, closeAdminNotesModal, openEditSubmissionModal, closeEditSubmissionModal, and saveSubmissionEdit moved to early script section at top of body
// Note: openEditSubmissionModal is now in early script block above

// Admin Change PO functions for edit modal
async function loadEditAdminPOs(submissionId, productName) {
    try {
        const response = await fetch(`/api/submission/${submissionId}/available_pos`);
        const data = await response.json();
        
        if (!data.success) {
            if (typeof showError === 'function') {
                showError(data.error || 'Failed to load available POs');
            } else {
                alert('Error: ' + (data.error || 'Failed to load available POs'));
            }
            return;
        }
        
        const posSection = document.getElementById('edit-admin-pos-section');
        if (posSection) {
            posSection.classList.remove('hidden');
        }
        
        const posList = document.getElementById('edit-admin-pos-list');
        if (!posList) return;
        
        posList.innerHTML = '';
        
        if (data.available_pos.length === 0) {
            posList.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No POs found for this product</p>
                </div>
            `;
            return;
        }
        
        data.available_pos.forEach(po => {
            const isCurrent = po.id === data.current_po_id;
            const statusColor = po.closed ? 'bg-gray-100 text-gray-700' : 'bg-green-100 text-green-700';
            const statusLabel = po.closed ? 'ðŸ”’ Closed' : 'âœ“ Open';
            
            const poDiv = document.createElement('div');
            poDiv.className = `border rounded-lg p-4 hover:bg-orange-50 cursor-pointer transition-colors ${isCurrent ? 'border-orange-500 bg-orange-50' : 'border-gray-300'}`;
            poDiv.onclick = () => adminReassignFromEditModal(submissionId, po.id, po.po_number);
            
            poDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-bold text-lg text-gray-900">${po.po_number}</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusColor}">
                                ${statusLabel}
                            </span>
                            ${isCurrent ? '<span class="text-xs text-orange-600 font-bold">CURRENT</span>' : ''}
                        </div>
                        <div class="grid grid-cols-4 gap-3 text-sm">
                            <div>
                                <div class="text-xs text-gray-500">Ordered</div>
                                <div class="font-medium">${(po.ordered || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-green-600">Good</div>
                                <div class="font-medium text-green-600">${(po.good || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-red-600">Damaged</div>
                                <div class="font-medium text-red-600">${(po.damaged || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-blue-600">Remaining</div>
                                <div class="font-medium text-blue-600">${(po.remaining || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    ${!isCurrent ? '<div class="text-2xl text-orange-600">â†’</div>' : ''}
                </div>
            `;
            
            posList.appendChild(poDiv);
        });
        
    } catch (error) {
        console.error('Error loading available POs:', error);
        if (typeof showError === 'function') {
            showError('Failed to load available POs: ' + error.message);
        } else {
            alert('Failed to load available POs: ' + error.message);
        }
    }
}

async function adminReassignFromEditModal(submissionId, newPoId, newPoNumber) {
    if (!confirm(`âš ï¸ ADMIN OVERRIDE CONFIRMATION\n\nAre you sure you want to change this VERIFIED submission from its current PO to ${newPoNumber}?\n\nThis will:\n- Update counts on both POs\n- Keep the submission verified\n- Require admin override confirmation\n\nThis action cannot be easily undone.`)) {
        return;
    }
    
    try {
        const response = await csrfFetch(`/api/submission/${submissionId}/admin_reassign`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                new_po_id: newPoId,
                confirm_override: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showSuccess === 'function') {
                showSuccess(data.message || 'PO assignment changed successfully!');
            } else {
                alert('Success: ' + (data.message || 'PO assignment changed successfully!'));
            }
            closeEditSubmissionModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            if (typeof showError === 'function') {
                showError(data.error || 'Failed to change PO assignment');
            } else {
                alert('Error: ' + (data.error || 'Failed to change PO assignment'));
            }
        }
    } catch (error) {
        console.error('Error changing PO assignment:', error);
        if (typeof showError === 'function') {
            showError('Failed to change PO assignment: ' + error.message);
        } else {
            alert('Failed to change PO assignment: ' + error.message);
        }
    }
}

// closeEditSubmissionModal and saveSubmissionEdit moved to early script section at top of body

// Open reassign modal from details modal (to fix incorrect assignments)
function openReassignFromDetails(submissionId, poNumber, productName) {
    // Close details modal
    closeSubmissionDetailsModal();
    
    // Open reassign modal (needs_review=1 to show receives)
    if (typeof openReassignModal === 'function') {
        openReassignModal(parseInt(submissionId), poNumber || null, productName || '', 1);
    } else {
        alert('Reassign function not available on this page. Please use the Submissions page to reassign.');
    }
}

// Note: saveSubmissionEdit moved to early script section
// Note: convertToTwoLevelDropdown moved to early script section above

// Convert tablet type dropdown to two-level dropdown system (duplicate - kept for backward compatibility)
async function convertToTwoLevelDropdown(selectElement) {
    if (!selectElement || selectElement.tagName !== 'SELECT') return;
    
    // Check if already converted
    if (selectElement.dataset.twoLevelConverted === 'true') return;
    selectElement.dataset.twoLevelConverted = 'true';
    
    const options = Array.from(selectElement.options);
    const placeholder = options.find(opt => opt.value === '' || opt.value === null);
    const originalValue = selectElement.value;
    
    // Try to fetch configured categories from API
    let groups = {};
    let groupOrder = []; // Will be populated from API, no hardcoded fallback
    
    try {
        const response = await fetch('/api/tablet_types/categories');
        const data = await response.json();
        
        if (data.success && data.categories) {
            // Use configured categories
            groups = {};
            groupOrder = data.category_order || groupOrder;
            
            // Initialize groups
            groupOrder.forEach(cat => {
                groups[cat] = [];
            });
            
            // Map options to categories based on configured categories
            options.forEach(option => {
                if (!option.value || option.value === '') return;
                
                // Find which category this tablet type belongs to
                let found = false;
                for (const [category, items] of Object.entries(data.categories)) {
                    const matchingItem = items.find(item => item.id == option.value || item.name === option.text.trim());
                    if (matchingItem) {
                        if (!groups[category]) {
                            groups[category] = [];
                        }
                        groups[category].push(option);
                        found = true;
                        break;
                    }
                }
                
                // If not found in configured categories, use fallback logic
                if (!found) {
                    const name = option.text.trim();
                    let categorized = false;
                    
                    // FIX Energy variants
                    if (name.match(/^\d+ct\s+FIX\s+Energy/i) || name.match(/^FIX\s+Energy\s+\d+ct/i)) {
                        if (!groups['FIX Energy']) groups['FIX Energy'] = [];
                        groups['FIX Energy'].push(option);
                        categorized = true;
                    }
                    // FIX Focus variants
                    else if (name.match(/^\d+ct\s+FIX\s+Focus/i) || name.match(/^FIX\s+Focus\s+\d+ct/i)) {
                        if (!groups['FIX Focus']) groups['FIX Focus'] = [];
                        groups['FIX Focus'].push(option);
                        categorized = true;
                    }
                    // FIX Relax variants
                    else if (name.match(/^\d+ct\s+FIX\s+Relax/i) || name.match(/^FIX\s+Relax\s+\d+ct/i)) {
                        if (!groups['FIX Relax']) groups['FIX Relax'] = [];
                        groups['FIX Relax'].push(option);
                        categorized = true;
                    }
                    // FIX MAX variants
                    else if (name.match(/^FIX\s+MAX/i)) {
                        if (!groups['FIX MAX']) groups['FIX MAX'] = [];
                        groups['FIX MAX'].push(option);
                        categorized = true;
                    }
                    // 18mg variants
                    else if (name.match(/^18mg/i)) {
                        if (!groups['18mg']) groups['18mg'] = [];
                        groups['18mg'].push(option);
                        categorized = true;
                    }
                    // XL variants
                    else if (name.match(/^XL\s+/i)) {
                        if (!groups['XL']) groups['XL'] = [];
                        groups['XL'].push(option);
                        categorized = true;
                    }
                    // Hyroxi variants
                    else if (name.match(/^Hyroxi/i)) {
                        if (!groups['Hyroxi']) groups['Hyroxi'] = [];
                        groups['Hyroxi'].push(option);
                        categorized = true;
                    }
                    
                    if (!categorized) {
                        if (!groups['Other']) groups['Other'] = [];
                        groups['Other'].push(option);
                    }
                }
            });
        } else {
            throw new Error('Failed to load categories');
        }
    } catch (error) {
        // Fallback to hardcoded logic if API fails
        console.warn('Failed to load configured categories, using fallback:', error);
        groups = {
            'FIX Energy': [],
            'FIX Focus': [],
            'FIX Relax': [],
            'FIX MAX': [],
            '18mg': [],
            'XL': [],
            'Hyroxi': [],
            'Other': []
        };
        
        // Categorize each option using fallback logic
        options.forEach(option => {
            if (!option.value || option.value === '') return;
            
            const name = option.text.trim();
            let categorized = false;
            
            // FIX Energy variants
            if (name.match(/^\d+ct\s+FIX\s+Energy/i) || name.match(/^FIX\s+Energy\s+\d+ct/i)) {
                groups['FIX Energy'].push(option);
                categorized = true;
            }
            // FIX Focus variants
            else if (name.match(/^\d+ct\s+FIX\s+Focus/i) || name.match(/^FIX\s+Focus\s+\d+ct/i)) {
                groups['FIX Focus'].push(option);
                categorized = true;
            }
            // FIX Relax variants
            else if (name.match(/^\d+ct\s+FIX\s+Relax/i) || name.match(/^FIX\s+Relax\s+\d+ct/i)) {
                groups['FIX Relax'].push(option);
                categorized = true;
            }
            // FIX MAX variants
            else if (name.match(/^FIX\s+MAX/i)) {
                groups['FIX MAX'].push(option);
                categorized = true;
            }
            // 18mg variants
            else if (name.match(/^18mg/i)) {
                groups['18mg'].push(option);
                categorized = true;
            }
            // XL variants
            else if (name.match(/^XL\s+/i)) {
                groups['XL'].push(option);
                categorized = true;
            }
            // Hyroxi variants
            else if (name.match(/^Hyroxi/i)) {
                groups['Hyroxi'].push(option);
                categorized = true;
            }
            
            if (!categorized) {
                groups['Other'].push(option);
            }
        });
    }
    
    // Sort within groups (by count if numeric, then alphabetically)
    Object.keys(groups).forEach(groupName => {
        groups[groupName].sort((a, b) => {
            const aText = a.text.trim();
            const bText = b.text.trim();
            // Extract count if present (e.g., "12ct" -> 12)
            const aMatch = aText.match(/(\d+)ct/i);
            const bMatch = bText.match(/(\d+)ct/i);
            if (aMatch && bMatch) {
                return parseInt(aMatch[1]) - parseInt(bMatch[1]);
            }
            return aText.localeCompare(bText);
        });
    });
    
    // Hide original select and remove required attribute (prevents "not focusable" error)
    selectElement.style.display = 'none';
    selectElement.removeAttribute('required');
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'space-y-2';
    
    // Create group dropdown
    const groupSelect = document.createElement('select');
    groupSelect.className = selectElement.className;
    groupSelect.id = selectElement.id + '_group';
    groupSelect.name = selectElement.name + '_group';
    groupSelect.innerHTML = '<option value="">Select category...</option>';
    
    // Create item dropdown
    const itemSelect = document.createElement('select');
    itemSelect.className = selectElement.className;
    itemSelect.id = selectElement.id + '_item';
    itemSelect.name = selectElement.name;
    itemSelect.required = true; // Always required - this is the actual selection field
    itemSelect.innerHTML = '<option value="">Select tablet type...</option>';
    itemSelect.style.display = 'none';
    
    // Add groups to group dropdown
    groupOrder.forEach(groupName => {
        if (!groups[groupName] || groups[groupName].length === 0) return;
        const option = document.createElement('option');
        option.value = groupName;
        option.textContent = groupName;
        groupSelect.appendChild(option);
    });
    
    // Store groups data
    groupSelect.dataset.groups = JSON.stringify(groups);
    
    // Handle group selection
    groupSelect.addEventListener('change', function() {
        const selectedGroup = this.value;
        itemSelect.innerHTML = '<option value="">Select tablet type...</option>';
        itemSelect.style.display = 'none';
        selectElement.value = '';
        
        if (selectedGroup && groups[selectedGroup]) {
            // Populate item dropdown with case-insensitive alphabetical sorting
            const sortedOptions = groups[selectedGroup].slice().sort((a, b) => 
                a.text.localeCompare(b.text, undefined, { sensitivity: 'base' })
            );
            sortedOptions.forEach(option => {
                const itemOption = document.createElement('option');
                itemOption.value = option.value;
                itemOption.textContent = option.text;
                itemSelect.appendChild(itemOption);
            });
            itemSelect.style.display = '';
        }
    });
    
    // Handle item selection
    itemSelect.addEventListener('change', function() {
        selectElement.value = this.value;
        // Trigger change event on original select for form validation
        selectElement.dispatchEvent(new Event('change', { bubbles: true }));
    });
    
    // Restore original value if set
    if (originalValue) {
        // Find which group contains this value
        for (const [groupName, groupOptions] of Object.entries(groups)) {
            const found = groupOptions.find(opt => opt.value === originalValue);
            if (found) {
                groupSelect.value = groupName;
                groupSelect.dispatchEvent(new Event('change'));
                setTimeout(() => {
                    itemSelect.value = originalValue;
                    selectElement.value = originalValue;
                }, 0);
                break;
            }
        }
    }
    
    // Insert wrapper before select
    const parent = selectElement.parentNode;
    parent.insertBefore(wrapper, selectElement);
    wrapper.appendChild(groupSelect);
    wrapper.appendChild(itemSelect);
    wrapper.appendChild(selectElement); // Keep original for form submission
}

// Add search functionality to tablet type dropdown
function addTabletTypeSearch(selectElement) {
    if (!selectElement || selectElement.tagName !== 'SELECT') return;
    
    // Check if search already added
    if (selectElement.dataset.searchAdded === 'true') return;
    selectElement.dataset.searchAdded = 'true';
    
    // Create search input wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'relative';
    wrapper.style.position = 'relative';
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search tablet types...';
    searchInput.className = 'form-input mb-2';
    searchInput.style.marginBottom = '0.5rem';
    searchInput.style.paddingRight = '2.5rem';
    
    // Add search icon
    const searchIcon = document.createElement('div');
    searchIcon.innerHTML = `
        <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    `;
    searchIcon.style.position = 'absolute';
    searchIcon.style.right = '0.75rem';
    searchIcon.style.top = '50%';
    searchIcon.style.transform = 'translateY(-50%)';
    searchIcon.style.pointerEvents = 'none';
    
    const searchWrapper = document.createElement('div');
    searchWrapper.style.position = 'relative';
    searchWrapper.appendChild(searchInput);
    searchWrapper.appendChild(searchIcon);
    
    // Wrap the select element
    const parent = selectElement.parentNode;
    parent.insertBefore(wrapper, selectElement);
    wrapper.appendChild(searchWrapper);
    wrapper.appendChild(selectElement);
    
    // Filter function
    function filterOptions(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        const optgroups = selectElement.querySelectorAll('optgroup');
        const options = selectElement.querySelectorAll('option');
        
        if (!term) {
            // Show all
            optgroups.forEach(optgroup => {
                optgroup.style.display = '';
                Array.from(optgroup.options).forEach(opt => {
                    opt.style.display = '';
                });
            });
            options.forEach(opt => {
                if (!opt.closest('optgroup')) {
                    opt.style.display = '';
                }
            });
            return;
        }
        
        // Filter optgroups and options
        optgroups.forEach(optgroup => {
            const groupOptions = Array.from(optgroup.options);
            const matchingOptions = groupOptions.filter(opt => 
                opt.textContent.toLowerCase().includes(term)
            );
            
            if (matchingOptions.length > 0) {
                optgroup.style.display = '';
                groupOptions.forEach(opt => {
                    opt.style.display = opt.textContent.toLowerCase().includes(term) ? '' : 'none';
                });
            } else {
                optgroup.style.display = 'none';
            }
        });
        
        // Filter standalone options
        options.forEach(opt => {
            if (!opt.closest('optgroup') && opt.value) {
                opt.style.display = opt.textContent.toLowerCase().includes(term) ? '' : 'none';
            }
        });
    }
    
    // Add event listener
    searchInput.addEventListener('input', function(e) {
        filterOptions(e.target.value);
    });
    
    // Clear search when select changes
    selectElement.addEventListener('change', function() {
        if (selectElement.value) {
            searchInput.value = '';
            filterOptions('');
        }
    });
    
    // Show search input only when dropdown is focused/opened (optional enhancement)
    // For now, keep it always visible for simplicity
}

// Global submission details modal functions (available on all pages)
async function viewSubmissionDetails(submissionId) {
    try {
        // Check if there's a parent modal (receive details or submissions modal)
        const receiveModal = document.getElementById('receive-details-modal');
        const submissionsModal = document.getElementById('submissions-modal');
        const hasParentModal = !!(receiveModal || submissionsModal);
        
        // Store parent modal info for back button
        let parentModalInfo = null;
        if (receiveModal) {
            // Extract receive info from the modal if possible
            const receiveTitle = receiveModal.querySelector('h3')?.textContent || '';
            const receiveIdMatch = receiveTitle.match(/Receive Details: (.+)/);
            if (receiveIdMatch) {
                parentModalInfo = { type: 'receive', name: receiveIdMatch[1] };
            }
        } else if (submissionsModal) {
            const submissionsTitle = submissionsModal.querySelector('h3')?.textContent || '';
            parentModalInfo = { type: 'submissions', name: submissionsTitle };
        }
        
        const response = await fetch(`/api/submission/${submissionId}/details`);
        const data = await response.json();
        
        if (!data.success) {
            alert(data.error || 'Failed to load submission details');
            return;
        }
        
        const sub = data.submission;
        // Check if user is admin/manager
        const isAdmin = {% if session.get('employee_role') in ['admin', 'manager'] or session.get('admin_authenticated') %}true{% else %}false{% endif %};
        
        // Format dates
        const submissionDate = sub.submission_date ? new Date(sub.submission_date).toLocaleString('en-US', { timeZone: 'America/New_York' }) : 'N/A';
        const createdDate = sub.created_at ? new Date(sub.created_at).toLocaleString('en-US', { timeZone: 'America/New_York' }) : 'N/A';
        
        // Get bag deductions for bottle submissions
        const bagDeductions = data.bag_deductions || [];
        
        // Auto-detect bottle submission
        const isBottleSubmission = sub.submission_type === 'bottle' || 
                                   bagDeductions.length > 0 || 
                                   (sub.bottles_made && sub.bottles_made > 0);
        
        // Determine submission type badge
        let typeBadge = '';
        if (sub.submission_type === 'machine') {
            typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">âš™ï¸ Machine</span>';
        } else if (sub.submission_type === 'bag') {
            typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">ðŸ“‹ Bag Count</span>';
        } else if (isBottleSubmission) {
            typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">ðŸ¾ Bottle</span>';
        } else {
            typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">ðŸ“¦ Packaged</span>';
        }
        
        // Build back button HTML if there's a parent modal
        const backButtonHTML = hasParentModal ? `
            <button onclick="goBackToParentModal()" 
                    class="text-white hover:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 mr-2"
                    title="Back to ${parentModalInfo?.name || 'previous view'}">
                â† Back
            </button>
        ` : '';
        
        // Build modal HTML
        let modalHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeSubmissionDetailsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 sticky top-0 z-10">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                ${backButtonHTML}
                                <div>
                                    <h3 class="text-xl font-bold">ðŸ“‹ Submission Details</h3>
                                    <p class="text-sm text-indigo-100 mt-1">ID: ${sub.id}</p>
                                </div>
                            </div>
                            <button onclick="closeSubmissionDetailsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6">
                        <!-- Basic Info -->
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Submission Type</label>
                                    <div class="mt-1">${typeBadge}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Employee</label>
                                    <div class="mt-1 text-gray-900 font-medium">${sub.employee_name || 'N/A'}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Product</label>
                                    <div class="mt-1 text-gray-900">${sub.product_name || 'N/A'}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Inventory Item ID</label>
                                    <div class="mt-1 text-gray-600 font-mono text-sm">${sub.inventory_item_id || 'N/A'}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Box Number</label>
                                    <div class="mt-1 text-gray-900">${sub.box_number || 'N/A'}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Bag Number</label>
                                    <div class="mt-1 text-gray-900">${sub.bag_number || 'N/A'}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Receipt #</label>
                                    <div class="mt-1 text-gray-900">${sub.receipt_number || 'N/A'}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Submission Date</label>
                                    <div class="mt-1 text-gray-900">${submissionDate}</div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase">Created At</label>
                                    <div class="mt-1 text-gray-900">${createdDate}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Counts -->
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Counts</h4>
                            ${sub.submission_type === 'machine' ? `
                            <!-- Machine Submission -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Turns</label>
                                    <div class="mt-1 text-2xl font-bold text-blue-600">${sub.displays_made || 0}</div>
                                    <div class="text-xs text-gray-400 mt-1">Machine count</div>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Cards Made</label>
                                    <div class="mt-1 text-2xl font-bold text-purple-600">${sub.cards_made || sub.packs_remaining || 0}</div>
                                    <div class="text-xs text-gray-400 mt-1">Turns Ã— Cards Per Turn</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Total Tablets</label>
                                    <div class="mt-1 text-2xl font-bold text-gray-900">${sub.loose_tablets || 0}</div>
                                    <div class="text-xs text-gray-400 mt-1">Total counted</div>
                                </div>
                            </div>
                            <div class="mt-4 bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <span class="font-medium">Machine:</span>
                                    <span>${sub.machine_name || 'Not specified'}</span>
                                    <span class="text-gray-400">â€¢</span>
                                    <span class="font-medium">Cards Per Turn:</span>
                                    <span>${sub.cards_per_turn || 'N/A'}</span>
                                </div>
                            </div>
                            ` : isBottleSubmission ? `
                            <!-- Bottle Submission -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="bg-amber-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Displays Made</label>
                                    <div class="mt-1 text-2xl font-bold text-amber-600">${sub.displays_made || 0}</div>
                                </div>
                                <div class="bg-amber-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Bottles Made</label>
                                    <div class="mt-1 text-2xl font-bold text-amber-600">${sub.bottles_made || 0}</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Total Tablets</label>
                                    <div class="mt-1 text-2xl font-bold text-gray-900">${(sub.individual_calc || sub.total_tablets || 0).toLocaleString()}</div>
                                </div>
                            </div>
                            ${bagDeductions.length > 0 ? `
                            <!-- Bag Deductions for Variety Pack -->
                            <div class="mt-6">
                                <h5 class="text-base font-semibold text-gray-700 mb-3">ðŸŽ¨ Bag Deductions (${bagDeductions.length} bags used)</h5>
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    ${bagDeductions.map(d => `
                                        <div class="flex justify-between items-center bg-pink-50 rounded-lg p-3 border border-pink-100">
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900">${d.tablet_type_name || 'Unknown Flavor'}</div>
                                                <div class="text-sm text-gray-500">
                                                    ${d.receive_name || d.po_number || 'N/A'} â€¢ Box ${d.box_number || '?'}, Bag ${d.bag_number || '?'}
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-lg font-bold text-pink-600">${(d.tablets_deducted || 0).toLocaleString()}</div>
                                                <div class="text-xs text-gray-400">tablets</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Total Deducted:</span>
                                    <span class="text-xl font-bold text-pink-600">${bagDeductions.reduce((sum, d) => sum + (d.tablets_deducted || 0), 0).toLocaleString()} tablets</span>
                                </div>
                            </div>
                            ` : ''}
                            ` : `
                            <!-- Packaged/Bag Submission -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Displays Made</label>
                                    <div class="mt-1 text-2xl font-bold text-blue-600">${sub.displays_made || 0}</div>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Cards Remaining</label>
                                    <div class="mt-1 text-2xl font-bold text-purple-600">${sub.packs_remaining || 0}</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Loose Tablets</label>
                                    <div class="mt-1 text-2xl font-bold text-blue-600">${sub.loose_tablets || 0}</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4">
                                    <label class="text-xs text-gray-500 uppercase">Damaged Tablets</label>
                                    <div class="mt-1 text-2xl font-bold text-yellow-600">${sub.damaged_tablets || 0}</div>
                                    <div class="text-xs text-gray-400 mt-1">Legacy field</div>
                                </div>
                            </div>
                            <div class="mt-4 bg-gray-50 rounded-lg p-4">
                                <label class="text-xs text-gray-500 uppercase">Total Tablets</label>
                                <div class="mt-1 text-3xl font-bold text-gray-900">${sub.individual_calc || sub.total_tablets || 0}</div>
                            </div>
                            `}
                        </div>
                        
                        <!-- Receive Information -->
                        <div class="mb-6">
                            <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');" 
                                    class="w-full flex items-center justify-between text-left">
                                <h4 class="text-lg font-semibold text-gray-900">Receive Information</h4>
                                <svg class="toggle-icon w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="hidden mt-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">Receive Name</label>
                                        <div class="mt-1 text-gray-900">${sub.receive_name || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">Receive Date</label>
                                        <div class="mt-1 text-gray-900">${sub.received_date ? new Date(sub.received_date + ' UTC').toLocaleDateString('en-US', {timeZone: 'America/New_York', year: 'numeric', month: '2-digit', day: '2-digit'}) : 'N/A'}</div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">Bag ID</label>
                                        <div class="mt-1 text-gray-900">${sub.bag_id || 'Not assigned'}</div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">Bag Label Count</label>
                                        <div class="mt-1 text-gray-900">${sub.bag_label_count != null ? sub.bag_label_count : 'N/A'}</div>
                                    </div>
                                </div>
                                
                                <!-- Bag Check Running Totals -->
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <h5 class="text-base font-semibold text-gray-700 mb-3">Bag Check Running Totals</h5>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-sm text-gray-500 uppercase">Bag</label>
                                            <div class="mt-1 text-base font-medium text-blue-600">${(sub.bag_running_total || 0).toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-500 uppercase">Machine</label>
                                            <div class="mt-1 text-base font-medium text-indigo-600">${(sub.machine_running_total || 0).toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-500 uppercase">Packaged</label>
                                            <div class="mt-1 text-base font-medium text-purple-600">${(sub.packaged_running_total || 0).toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-500 uppercase">Total</label>
                                            <div class="mt-1 text-base font-medium text-gray-900">${(sub.running_total || 0).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    ${sub.count_status && sub.count_status !== 'no_bag' ? `
                                    <div class="mt-3 pt-3 border-t border-gray-200">
                                        ${sub.count_status === 'match' ? `
                                            <span class="text-green-600 font-bold text-base">âœ“ Match</span>
                                        ` : sub.count_status === 'under' ? `
                                            <span class="text-yellow-600 font-bold text-base">âš ï¸ Under (${sub.tablet_difference || ''})</span>
                                        ` : sub.count_status === 'over' ? `
                                            <span class="text-red-600 font-bold text-base">âŒ Over (+${sub.tablet_difference || ''})</span>
                                        ` : ''}
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- PO Assignment -->
                        <div class="mb-6">
                            <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');" 
                                    class="w-full flex items-center justify-between text-left">
                                <h4 class="text-lg font-semibold text-gray-900">Purchase Order Assignment</h4>
                                <svg class="toggle-icon w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="hidden mt-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">Assigned PO ID</label>
                                        <div class="mt-1 text-gray-900">${sub.assigned_po_id || 'Not assigned'}</div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">PO Number</label>
                                        <div class="mt-1 text-gray-900">${sub.po_number || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">Zoho PO ID</label>
                                        <div class="mt-1 text-gray-900">${sub.zoho_po_id || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">PO Closed</label>
                                        <div class="mt-1">
                                            ${sub.po_closed ? '<span class="text-red-600 font-medium">Yes</span>' : '<span class="text-green-600 font-medium">No</span>'}
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase">Needs Review</label>
                                        <div class="mt-1">
                                            ${sub.needs_review ? '<span class="text-orange-600 font-medium">Yes</span>' : '<span class="text-gray-600">No</span>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Admin Notes -->
                        ${sub.admin_notes ? `
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Admin Notes</h4>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-gray-900 whitespace-pre-wrap">${sub.admin_notes}</p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer -->
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-between items-center">
                        <div>
                            ${isAdmin ? `
                            <button id="reassign-btn-${sub.id}" 
                                    class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
                                    title="Reassign to different receive">
                                ðŸ”„ Reassign to Receive
                            </button>
                            ` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="closeSubmissionDetailsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                Close
                            </button>
                            ${isAdmin && (!sub.assigned_po_id || !sub.po_closed) ? `
                            <button onclick="event.stopPropagation(); closeSubmissionDetailsModal(); openEditSubmissionModal(${sub.id})" 
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                âœï¸ Edit Submission
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Store parent modal info in window for back button
        if (hasParentModal) {
            window.submissionDetailsParentModal = parentModalInfo;
        }
        
        // Insert modal into page
        const modalContainer = document.createElement('div');
        modalContainer.id = 'submission-details-modal-container';
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
        
        // Attach event listener to reassign button to avoid quote escaping issues
        if (isAdmin) {
            const reassignBtn = document.getElementById('reassign-btn-' + sub.id);
            if (reassignBtn) {
                reassignBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openReassignFromDetails(sub.id, sub.po_number || '', sub.product_name || '');
                });
            }
        }
        
    } catch (error) {
        console.error('Error loading submission details:', error);
        alert('Failed to load submission details: ' + error.message);
    }
}

function goBackToParentModal() {
    // Close submission details modal
    closeSubmissionDetailsModal();
    
    // Check if we need to restore a parent modal
    const parentInfo = window.submissionDetailsParentModal;
    if (parentInfo && parentInfo.type === 'receive') {
        // Try to restore receive details modal
        // The receive modal should still be in the DOM, just hidden behind the submission modal
        // Since we're closing the submission modal, the receive modal should be visible again
        // But if it was removed, we'd need to reload it - for now, just close submission modal
    } else if (parentInfo && parentInfo.type === 'submissions') {
        // Try to restore submissions modal
        // Same as above - it should be visible once submission modal closes
    }
    
    // Clear parent modal info
    window.submissionDetailsParentModal = null;
}

function closeSubmissionDetailsModal(event) {
    if (event) {
        event.stopPropagation();
    }
    const container = document.getElementById('submission-details-modal-container');
    if (container) {
        container.remove();
    }
    // Clear parent modal info when closing
    window.submissionDetailsParentModal = null;
}

// Global receive details modal functions (available on all pages)
async function viewReceiveDetails(receiveId, receiveName) {
    try {
        // Check user role for showing close buttons
        const userRole = '{{ session.get("employee_role", "") }}' || '{{ "admin" if session.get("admin_authenticated") else "" }}';
        const isAdmin = userRole === 'admin';
        const isManager = userRole === 'manager' || isAdmin;
        
        const response = await fetch(`/api/receive/${receiveId}/details`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error loading receive details: ' + (data.error || 'Unknown error'));
            return;
        }
        
        const receive = data.receive;
        const products = data.products;
        
        // Check if we have PO info for the back button
        const hasPO = receive && receive.po_id && receive.po_number;
        const backButton = hasPO ? `
            <button onclick="event.stopPropagation(); closeReceiveDetailsModal(); viewPOReceives(${receive.po_id}, '${receive.po_number}');" 
                    class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-colors flex items-center gap-2">
                â† Back to Receives
            </button>
        ` : '<div></div>';
        
        // Build modal content
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeReceiveDetailsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-teal-600 to-blue-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            ${backButton}
                            <div class="flex-1 text-center">
                                <h3 class="text-xl font-bold">ðŸ“¦ Receive Details: ${receiveName}</h3>
                                <p class="text-sm text-blue-100 mt-1">
                                    Received on ${receive.received_date ? (() => {
                                        const date = new Date(receive.received_date + ' UTC');
                                        const estDate = new Date(date.toLocaleString('en-US', {timeZone: 'America/New_York'}));
                                        const dateStr = estDate.toLocaleDateString('en-US', {year: 'numeric', month: '2-digit', day: '2-digit'});
                                        const timeStr = estDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false});
                                        return dateStr + ' at ' + timeStr;
                                    })() : 'Unknown'} EST
                                    ${receive.received_by ? 'by ' + receive.received_by : ''}
                                </p>
                            </div>
                            <button onclick="closeReceiveDetailsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
        `;
        
        if (products.length === 0) {
            modalContent += `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">ðŸ“­</div>
                    <p class="text-lg">No products found in this receive</p>
                </div>
            `;
        } else {
            modalContent += '<div class="space-y-6">';
            
            products.forEach(product => {
                // Product header
                modalContent += `
                    <div class="border-2 border-gray-300 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2">
                            ðŸ§ª ${product.tablet_type_name}
                        </h3>
                `;
                
                // Loop through each box
                product.boxes.forEach(box => {
                    modalContent += `
                        <div class="mb-4 ml-4">
                            <div class="flex items-center gap-2 mb-3">
                                <h4 class="font-semibold text-gray-700">ðŸ“¦ Box ${box.box_number}</h4>
                                <div class="flex-1 border-t border-gray-300"></div>
                            </div>
                            <div class="space-y-3 ml-4">
                    `;
                    
                    // Loop through each bag in the box
                    box.bags.forEach(bag => {
                        const receivedCount = bag.received_count || 0;
                        const machineCount = bag.machine_count || 0;
                        const packagedCount = bag.packaged_count || 0;
                        const totalCounted = machineCount + packagedCount;
                        const remaining = receivedCount - packagedCount;
                        const percentComplete = receivedCount > 0 
                            ? Math.round((totalCounted / receivedCount) * 100) 
                            : 0;
                        
                        // Determine status colors
                        let bgColor = 'bg-gray-50';
                        let labelColor = 'text-gray-600';
                        
                        if (remaining <= 0) {
                            bgColor = 'bg-green-50';
                            labelColor = 'text-green-600';
                        } else if (percentComplete >= 75) {
                            bgColor = 'bg-yellow-50';
                            labelColor = 'text-yellow-600';
                        }
                        
                        const isClosed = bag.status === 'Closed';
                        const zohoReceivePushed = bag.zoho_receive_pushed || false;
                        const isReserved = bag.reserved_for_bottles === 1 || bag.reserved_for_bottles === true;
                        const closedBadge = isClosed ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-gray-200 text-gray-700 ml-2">ðŸ”’ CLOSED</span>' : '';
                        const zohoPushedBadge = zohoReceivePushed ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700 ml-2">âœ“ Zoho</span>' : '';
                        const reservedBadge = isReserved ? '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 ml-2">ðŸ¾ Reserved</span>' : '';
                        
                        modalContent += `
                            <div class="border border-gray-200 rounded-lg p-3 hover:bg-blue-50 hover:shadow-md transition-all ${isClosed ? 'opacity-60' : ''}" 
                                 title="${isClosed ? 'This bag is closed' : 'Click to view submissions for ' + product.tablet_type_name + ' Bag ' + bag.bag_number}"
                                 id="bag-card-${bag.bag_id}">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center gap-2 flex-1 cursor-pointer"
                                         onclick="event.stopPropagation(); closeReceiveDetailsModal(); viewPOSubmissions(${receive.po_id}, '${receive.po_number}', '${product.inventory_item_id}', ${receiveId}, '${receiveName}', ${bag.bag_id}, ${box.box_number}, ${bag.bag_number});">
                                        <span class="text-sm font-medium text-blue-600">ðŸŽ’ ${product.tablet_type_name} Bag ${bag.bag_number}</span>
                                        <span class="text-xs text-gray-500 font-normal">(Box ${box.box_number})</span>
                                        ${closedBadge}
                                        ${zohoPushedBadge}
                                        ${reservedBadge}
                                        <span class="text-xs text-gray-500">ðŸ’¡ Click for submissions</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                    <div class="text-xs font-medium ${labelColor}">${percentComplete}% Complete</div>
                                        ${!isClosed && remaining > 0 && (isAdmin || isManager) ? `
                                            <button onclick="event.stopPropagation(); toggleBagReservation(${bag.bag_id}, ${isReserved}, '${product.tablet_type_name}', ${bag.bag_number}, ${box.box_number});" 
                                                    id="reserve-btn-${bag.bag_id}"
                                                    class="text-xs ${isReserved ? 'text-purple-600 hover:text-purple-800' : 'text-gray-600 hover:text-gray-800'} underline whitespace-nowrap">
                                                ${isReserved ? 'ðŸ¾ Unreserve' : 'ðŸ“¦ Reserve'}
                                            </button>
                                        ` : ''}
                                        ${(isAdmin || isManager) && isClosed && !zohoReceivePushed ? `
                                            <button onclick="event.stopPropagation(); openPushToZohoModal(${bag.bag_id}, '${product.tablet_type_name}', ${bag.bag_number}, ${box.box_number}, ${bag.received_count || 0}, ${bag.packaged_count || 0}, ${receiveId}, '${receiveName}');" 
                                                    class="text-xs text-indigo-600 hover:text-indigo-800 underline whitespace-nowrap">
                                                ðŸ“¤ Push to Zoho
                                            </button>
                                        ` : ''}
                                        ${isAdmin || isManager ? `
                                            <button onclick="event.stopPropagation(); toggleBagClosed(${bag.bag_id}, ${isClosed}, '${product.tablet_type_name}', ${bag.bag_number}, ${box.box_number}, ${receiveId}, '${receiveName}');" 
                                                    class="text-xs ${isClosed ? 'text-green-600 hover:text-green-800' : 'text-orange-600 hover:text-orange-800'} underline whitespace-nowrap">
                                                ${isClosed ? 'ðŸ”“ Reopen' : 'ðŸ”’ Close'}
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="mb-2">
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all ${percentComplete >= 100 ? 'bg-green-500' : percentComplete >= 75 ? 'bg-yellow-500' : 'bg-blue-500'}"
                                             style="width: ${Math.min(percentComplete, 100)}%"></div>
                                    </div>
                                </div>
                                
                                <!-- Compact Stats -->
                                <div class="grid grid-cols-4 gap-2 text-center text-xs">
                                    <div class="bg-indigo-50 rounded px-2 py-1">
                                        <div class="text-indigo-600 font-semibold">${(bag.received_count || 0).toLocaleString()}</div>
                                        <div class="text-gray-500">Received</div>
                                    </div>
                                    <div class="bg-blue-50 rounded px-2 py-1">
                                        <div class="text-blue-600 font-semibold">${(bag.machine_count || 0).toLocaleString()}</div>
                                        <div class="text-gray-500">Machine</div>
                                    </div>
                                    <div class="bg-purple-50 rounded px-2 py-1">
                                        <div class="text-purple-600 font-semibold">${(bag.packaged_count || 0).toLocaleString()}</div>
                                        <div class="text-gray-500">Packaged</div>
                                    </div>
                                    <div class="${bgColor} rounded px-2 py-1">
                                        <div class="${labelColor} font-semibold">${(remaining || 0).toLocaleString()}</div>
                                        <div class="text-gray-500">Remaining</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    modalContent += `
                            </div>
                        </div>
                    `;
                });
                
                modalContent += '</div>';
            });
            
            modalContent += '</div>';
        }
        
        modalContent += `
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if present
        const existingModal = document.getElementById('receive-details-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.id = 'receive-details-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        console.error('Error loading receive details:', error);
        alert('Failed to load receive details: ' + error.message);
    }
}

function closeReceiveDetailsModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('receive-details-modal');
        if (modal) {
            modal.remove();
        }
    }
}

async function toggleBagClosed(bagId, currentlyClosed, productName, bagNumber, boxNumber, receiveId, receiveName) {
    const action = currentlyClosed ? 'reopen' : 'close';
    const confirmMsg = currentlyClosed 
        ? `Are you sure you want to REOPEN ${productName} Bag ${bagNumber} (Box ${boxNumber})? It will become available for new submissions again.` 
        : `Are you sure you want to CLOSE ${productName} Bag ${bagNumber} (Box ${boxNumber})? It will no longer accept new submissions.`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await csrfFetch(`/api/bag/${bagId}/close`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Close the modal
            closeReceiveDetailsModal();
            
            // Show success message briefly
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.textContent = data.message;
            document.body.appendChild(successMsg);
            
            // Remove success message after 2 seconds
            setTimeout(() => successMsg.remove(), 2000);
            
            // Reopen the modal with updated data after a brief delay
            setTimeout(() => {
                viewReceiveDetails(receiveId, receiveName);
            }, 300);
        } else {
            alert('Error: ' + (data.error || 'Failed to update bag status'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update bag status');
    }
}

// Push to Zoho Modal and Functions
function openPushToZohoModal(bagId, productName, bagNumber, boxNumber, receivedCount, packagedCount, receiveId, receiveName) {
    // Remove existing modal if present
    const existingModal = document.getElementById('push-to-zoho-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHtml = `
        <div id="push-to-zoho-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closePushToZohoModal(event)">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">ðŸ“¤ Push to Zoho Receives</h3>
                        <button onclick="closePushToZohoModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Bag Info -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="text-sm text-gray-600 mb-2">
                            <strong>${productName}</strong> - Box ${boxNumber}, Bag ${bagNumber}
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-indigo-100 rounded p-2">
                                <div class="text-indigo-700 font-semibold">${receivedCount.toLocaleString()}</div>
                                <div class="text-xs text-gray-500">Bag Label</div>
                            </div>
                            <div class="bg-purple-100 rounded p-2">
                                <div class="text-purple-700 font-semibold">${packagedCount.toLocaleString()}</div>
                                <div class="text-xs text-gray-500">Packaged</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Notes -->
                    <div class="mb-4">
                        <label for="zoho-custom-notes" class="block text-sm font-medium text-gray-700 mb-1">
                            Additional Notes (optional)
                        </label>
                        <textarea id="zoho-custom-notes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                  placeholder="Enter any additional notes for this receive..."></textarea>
                    </div>
                    
                    <!-- Info -->
                    <div class="text-xs text-gray-500 mb-4">
                        This will create a purchase receive in Zoho with the packaged count (${packagedCount.toLocaleString()}) and attach a chart image.
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button onclick="closePushToZohoModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button id="push-to-zoho-btn" onclick="executePushToZoho(${bagId}, ${receiveId}, '${receiveName}')" 
                                class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2">
                            <span>ðŸ“¤</span>
                            <span>Push to Zoho</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closePushToZohoModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('push-to-zoho-modal');
        if (modal) {
            modal.remove();
        }
    }
}

async function executePushToZoho(bagId, receiveId, receiveName) {
    const btn = document.getElementById('push-to-zoho-btn');
    const customNotes = document.getElementById('zoho-custom-notes')?.value || '';
    
    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin">â³</span> <span>Pushing...</span>';
    
    try {
        const response = await csrfFetch(`/api/bag/${bagId}/push_to_zoho`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ custom_notes: customNotes })
        });
        
        // Check if response is JSON before parsing
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Server returned non-JSON response (${response.status}): ${text.substring(0, 200)}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Close the push modal
            closePushToZohoModal();
            
            // Close the receive details modal
            closeReceiveDetailsModal();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.innerHTML = `<div class="font-semibold">âœ“ ${data.message}</div>`;
            if (data.zoho_receive_id) {
                successMsg.innerHTML += `<div class="text-sm opacity-90">Zoho Receive ID: ${data.zoho_receive_id}</div>`;
            }
            document.body.appendChild(successMsg);
            
            // Remove success message after 3 seconds
            setTimeout(() => successMsg.remove(), 3000);
            
            // Reopen the receive modal with updated data
            setTimeout(() => {
                viewReceiveDetails(receiveId, receiveName);
            }, 300);
        } else {
            // Show error message
            alert('Error: ' + (data.error || 'Failed to push to Zoho'));
            
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<span>ðŸ“¤</span> <span>Push to Zoho</span>';
        }
    } catch (error) {
        console.error('Error pushing to Zoho:', error);
        alert('Failed to push to Zoho: ' + error.message);
        
        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = '<span>ðŸ“¤</span> <span>Push to Zoho</span>';
    }
}

// CSRF Token Helper Functions
function getCSRFToken() {
    // Try to get CSRF token from meta tag first
    let token = document.querySelector('meta[name="csrf-token"]');
    if (token) {
        return token.getAttribute('content');
    }
    
    // Try to get from hidden input in any form
    token = document.querySelector('input[name="csrf_token"]');
    if (token) {
        return token.value;
    }
    
    // Try to get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') {
            return value;
        }
    }
    
    return null;
}

// Helper to add CSRF token to fetch headers
function getCSRFHeaders(additionalHeaders = {}) {
    const token = getCSRFToken();
    if (token) {
        return {
            'X-CSRFToken': token,
            'X-CSRF-Token': token, // Alternative header name
            ...additionalHeaders
        };
    }
    return additionalHeaders;
}

// Wrapper for fetch with CSRF token
async function csrfFetch(url, options = {}) {
    const method = (options.method || 'GET').toUpperCase();
    
    // Add CSRF token for state-changing methods
    if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
        options.headers = getCSRFHeaders(options.headers || {});
    }
    
    return fetch(url, options);
}
</script>
</body>
</html>
