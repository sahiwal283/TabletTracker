<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Tablet Counter{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style type="text/tailwindcss">
        :root {
            /* Winter Chill Palette */
            --wc-light: #B8E3E9;  /* Light ice */
            --wc-mid:   #93B1B5;  /* Mist */
            --wc-primary:#4F7C82;  /* Deep teal */
            --wc-dark:  #0B2E33;  /* Midnight teal */

            /* Derived neutrals */
            --bg-start: #f8fbfc;
            --bg-end:   #eef7f8;
            --neutral-border: #e2edf0;
            --neutral-shadow: 11, 46, 51; /* wc-dark RGB */
        }

        /* Inputs */
        .form-input {
            @apply w-full px-5 py-4 border-2 bg-white transition-all duration-300;
            font-size: 16px !important; /* Prevents zoom on iOS */
            border-radius: 20px !important;
            border-color: var(--neutral-border) !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--bg-end) 100%);
            box-shadow: 0 4px 12px rgba(var(--neutral-shadow), 0.06), inset 0 1px 0 rgba(255,255,255,0.6) !important;
            min-height: 56px !important;
            padding: 16px 20px !important;
        }
        .form-input:focus {
            border-color: var(--wc-primary) !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--bg-end) 100%);
            box-shadow: 0 0 0 4px rgba(79, 124, 130, 0.2), 0 12px 20px rgba(79, 124, 130, 0.15) !important;
            transform: translateY(-2px);
            outline: none;
        }
        
        /* Remove spinner arrows from number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Select dropdowns */
        select.form-input {
            border-color: var(--neutral-border) !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--bg-end) 100%);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%234F7C82' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 3.5rem;
            border-radius: 20px !important;
        }
        
        /* Button system */
        .btn-primary {
            @apply px-8 py-4 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-opacity-30 disabled:opacity-50 transition-all duration-300;
            color: #ffffff !important;
            border-radius: 24px !important;
            background: linear-gradient(135deg, var(--wc-primary) 0%, #5e8f95 50%, var(--wc-mid) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 6px 20px rgba(var(--neutral-shadow), 0.18);
            transform: translateY(0) scale(1);
            min-height: 56px;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--wc-dark) 0%, var(--wc-primary) 50%, var(--wc-mid) 100%);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 25px rgba(var(--neutral-shadow), 0.25);
            border-color: rgba(255,255,255,0.3);
        }
        .btn-primary:active {
            transform: translateY(-1px) scale(1.0);
            box-shadow: 0 6px 15px rgba(var(--neutral-shadow), 0.2);
        }
        
        .btn-secondary {
            @apply bg-white px-6 py-3 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-cyan-200 focus:ring-opacity-30 transition-all duration-300;
            color: var(--wc-dark) !important;
            border-radius: 20px !important;
            border: 2px solid var(--neutral-border);
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(var(--neutral-shadow), 0.06);
        }
        .btn-secondary:hover {
            @apply bg-slate-50 text-slate-900;
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(var(--neutral-shadow), 0.1);
            border-color: #cbd5e1; /* slate-300 */
        }
        
        /* Success button */
        .btn-success {
            @apply px-6 py-3 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-opacity-30 transition-all duration-300;
            color: #ffffff !important;
            border-radius: 20px !important;
            background: linear-gradient(135deg, var(--wc-primary) 0%, #5e8f95 50%, var(--wc-mid) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 6px 20px rgba(var(--neutral-shadow), 0.18);
            transform: translateY(0);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, var(--wc-dark) 0%, var(--wc-primary) 50%, var(--wc-mid) 100%);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 25px rgba(var(--neutral-shadow), 0.24);
            border-color: rgba(255,255,255,0.3);
        }
        
        .btn-warning {
            @apply bg-white px-6 py-3 font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-cyan-200 focus:ring-opacity-30 transition-all duration-300;
            color: var(--wc-dark) !important;
            border-radius: 20px !important;
            border: 2px solid var(--neutral-border);
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(var(--neutral-shadow), 0.08);
        }
        .btn-warning:hover {
            @apply bg-slate-50 text-slate-900;
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(var(--neutral-shadow), 0.12);
            border-color: #cbd5e1; /* slate-300 */
        }

        /* Cards */
        .card {
            @apply bg-white shadow-xl border border-gray-100;
            border-radius: 28px !important;
            background: linear-gradient(135deg, #ffffff 0%, var(--wc-light) 100%);
            border-color: rgba(var(--neutral-shadow), 0.08) !important;
        }

        /* Improve contrast for descriptive text inside light cards */
        .card .text-gray-600 { color: #334155 !important; } /* slate-700 */
        .card .text-gray-500 { color: #1f2937 !important; } /* gray-800 */

        /* Nav link default contrast */
        .nav-link { color: #ffffff !important; }
        .nav-link svg { color: inherit; }

        /* Semantic helpers mapped to Winter Chill */
        .text-primary { color: var(--wc-primary) !important; }
        .text-secondary { color: var(--wc-mid) !important; }
        .bg-accent { background-color: var(--wc-light) !important; }
        .border-accent { border-color: var(--wc-mid) !important; }

        /* Override common Tailwind color utilities used across templates */
        .text-blue-600, .text-indigo-600, .text-green-600, .text-emerald-600, .text-teal-600 { color: var(--wc-primary) !important; }
        .text-yellow-600, .text-orange-600 { color: var(--wc-mid) !important; }
        .text-red-600 { color: var(--wc-dark) !important; }

        .bg-blue-600, .bg-indigo-600, .bg-emerald-500, .bg-teal-600, .bg-green-500 { background-color: var(--wc-primary) !important; }
        .bg-green-50, .bg-blue-50, .bg-indigo-50 { background-color: rgba(184, 227, 233, 0.25) !important; }

        .from-indigo-600, .from-purple-600, .from-blue-600, .from-green-600, .from-emerald-400, .from-teal-400, .from-amber-400, .from-orange-400 { --tw-gradient-from: var(--wc-primary) !important; }
        .to-purple-600, .to-indigo-600, .to-blue-600, .to-emerald-600, .to-green-500, .to-cyan-500, .to-yellow-500, .to-orange-600 { --tw-gradient-to: var(--wc-mid) !important; }
        .from-green-100, .to-emerald-100, .via-purple-50, .to-pink-50, .from-indigo-50 { --tw-gradient-from: rgba(184, 227, 233, 0.35) !important; --tw-gradient-to: rgba(147, 177, 181, 0.35) !important; }
        
        /* Status badge enhancements - Winter Chill */
        .status-complete { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-primary), var(--wc-mid)); }
        .status-processing { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-mid), var(--wc-primary)); }
        .status-shipped { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-dark), var(--wc-primary)); }
        .status-draft { @apply bg-gradient-to-r text-white; background-image: linear-gradient(90deg, var(--wc-light), var(--wc-mid)); }
        
        /* Animated gradient background */
        .gradient-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Hover animations */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-lift:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);">    
    <!-- SVG Sprite -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <symbol id="icon-chart" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v18h14a1 1 0 1 1 0 2H4a1 1 0 0 1-1-1V3Z"/>
            <path d="M8 17a1 1 0 0 0 1-1v-6a1 1 0 1 0-2 0v6a1 1 0 0 0 1 1Zm5 0a1 1 0 0 0 1-1V7a1 1 0 1 0-2 0v9a1 1 0 0 0 1 1Zm5 0a1 1 0 0 0 1-1v-4a1 1 0 1 0-2 0v4a1 1 0 0 0 1 1Z"/>
        </symbol>
        <symbol id="icon-box" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 8.5V17a2 2 0 0 1-1.106 1.789l-7 3.5a2 2 0 0 1-1.788 0l-7-3.5A2 2 0 0 1 3 17V8.5l8.106 4.053a2 2 0 0 0 1.788 0L21 8.5ZM20.553 6.894 12.447 3.34a2 2 0 0 0-1.894 0L2.447 6.894A1 1 0 0 0 2 7.776V8l9 4.5a1 1 0 0 0 .894 0L21 8V7.776a1 1 0 0 0-.447-.882Z"/>
        </symbol>
        <symbol id="icon-calc" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm2 4v4h8V6H8Zm0 6v6h2v-6H8Zm4 0v6h2v-6h-2Zm4 0v6h2v-6h-2Z"/>
        </symbol>
        <symbol id="icon-gear" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm9.4 4a7.4 7.4 0 0 0-.132-1.3l2.044-1.582-2-3.464-2.4.6a7.47 7.47 0 0 0-2.252-1.302L14.4 1h-4.8l-.96 2.952a7.47 7.47 0 0 0-2.252 1.302l-2.4-.6-2 3.464L3.032 10.7A7.402 7.402 0 0 0 2.9 12c0 .44.044.867.132 1.3L.988 14.882l2 3.464 2.4-.6a7.47 7.47 0 0 0 2.252 1.302L9.6 23h4.8l.96-2.952a7.47 7.47 0 0 0 2.252-1.302l2.4.6 2-3.464-2.044-1.582c.088-.433.132-.86.132-1.3Z"/>
        </symbol>
        <symbol id="icon-eye" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 5c6 0 10 7 10 7s-4 7-10 7S2 12 2 12s4-7 10-7Zm0 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/>
        </symbol>
        <symbol id="icon-bolt" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 2 3 14h7l-1 8 11-12h-7l0-8Z"/>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 11h5v-2h-4V7h-2v6Z"/>
        </symbol>
        <symbol id="icon-exclamation" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z"/>
        </symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.285 6.708 9 18l-5.285-5.292 1.415-1.416L9 15.172l9.87-9.88 1.415 1.416Z"/>
        </symbol>
        <symbol id="icon-users" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4ZM6 13a3 3 0 1 0-3-3 3 3 0 0 0 3 3Zm10 2a6 6 0 0 0-6 6h12a6 6 0 0 0-6-6Zm-10 1a5 5 0 0 0-5 5h6a5 5 0 0 0-5-5Z"/>
        </symbol>
        <symbol id="icon-user" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 1 1-5 5 5 5 0 0 1 5-5Zm0 9a7 7 0 0 0-7 7h14a7 7 0 0 0-7-7Z"/>
        </symbol>
        <symbol id="icon-user-helmet" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 0 0-5 5v1h10V7a5 5 0 0 0-5-5Zm-7 12a7 7 0 0 1 14 0v3H5v-3Z"/>
        </symbol>
        <symbol id="icon-lock" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 8h-1V6a4 4 0 1 0-8 0v2H7a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2Zm-5 8a2 2 0 1 1 2-2 2 2 0 0 1-2 2Z"/>
        </symbol>
        <symbol id="icon-login" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 17 15 12 10 7v3H3v4h7v3Zm2-15h7a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2h-7v-2h7V4h-7V2Z"/>
        </symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 7V4h7v16h-7v-3h-2v5h11V2H12v5h2Zm-2 5-5-5v3H2v4h5v3l5-5Z"/>
        </symbol>
        <symbol id="icon-lab" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 2h8v2l-3 5v6l5 5H6l5-5V9L8 4V2Z"/>
        </symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm18-11.5a1 1 0 0 0 0-1.41L18.66 1a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75L21 5.75Z"/>
        </symbol>
        <symbol id="icon-truck" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3h12v8h4l2 3v6h-2a3 3 0 0 1-6 0H9a3 3 0 0 1-6 0H1V5a2 2 0 0 1 2-2Zm3 16a1 1 0 1 0 1 1 1 1 0 0 0-1-1Zm10 0a1 1 0 1 0 1 1 1 1 0 0 0-1-1Z"/>
        </symbol>
        <symbol id="icon-cart" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4ZM5.656 4.172A1 1 0 0 1 6.586 4h14.828a1 1 0 0 1 .97 1.243l-2.5 10A1 1 0 0 1 19.914 16H7.5l-.258 1.03A1 1 0 0 1 6.273 18H3v-2h2.273l2.313-9.253a1 1 0 0 1 .07-.575ZM8.414 6l-1.8 7.2h11.471l1.875-7.5H8.414Z"/>
        </symbol>
        <symbol id="icon-plug" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 2h2v6h6V2h2v6h3v2H4V8h3V2Z"/>
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 11V4h2v7h7v2h-7v7h-2v-7H4v-2h7Z"/>
        </symbol>
        <symbol id="icon-x" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.3 5.71 12 12l6.3 6.29-1.42 1.42L10.59 13.41 4.29 19.71 2.87 18.29 9.17 12 2.87 5.71 4.29 4.29l6.3 6.3 6.29-6.3 1.42 1.42Z"/>
        </symbol>
        <symbol id="icon-list" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16v2H4V6Zm0 5h16v2H4v-2Zm0 5h16v2H4v-2Z"/>
        </symbol>
        <symbol id="icon-mobile" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm5 18a1.5 1.5 0 1 0-1.5-1.5A1.5 1.5 0 0 0 12 20Z"/>
        </symbol>
        <symbol id="icon-laptop" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8H4V6Zm-2 10h20v2H2v-2Z"/>
        </symbol>
        <symbol id="icon-send" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2 21 23 12 2 3v7l15 2-15 2v7Z"/>
        </symbol>
        <symbol id="icon-document" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Zm4 18H6V4h7v5h5v11Z"/>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2v10l3-3 1.5 1.5L12 15l-4.5-4.5L9 9l3 3V2h2Zm-7 18h14v2H5v-2Z"/>
        </symbol>
        <symbol id="icon-spinner" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a10 10 0 0 1 10 10h-2a8 8 0 0 0-8-8V2Z"/>
        </symbol>
        <symbol id="icon-language" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            <path d="M3.9 12c0-4.42 3.58-8 8-8s8 3.58 8 8h-2c0-3.31-2.69-6-6-6s-6 2.69-6 6H3.9z"/>
            <path d="M12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
        </symbol>
    </svg>
    <!-- Enhanced navigation with earthy green gradient -->
    <nav class="bg-gradient-to-r" style="background-image: linear-gradient(90deg, var(--wc-dark), #082025, var(--wc-primary));" class="text-white shadow-2xl">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">
                    <a href="{{ url_for('auth.index') }}" class="hover:text-primary transition-colors duration-300 flex items-center">
                        <svg class="w-7 h-7 mr-2" aria-hidden="true"><use href="#icon-chart" /></svg>
                        <span class="bg-gradient-to-r from-white to-[#B8E3E9] bg-clip-text text-transparent">TabletTracker</span>
                        <span class="ml-2 text-xs text-gray-300 font-normal">v{{ version() }}</span>
                    </a>
            </h1>
                <div class="hidden md:flex space-x-6">
                    <!-- Dashboard - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('dashboard.admin_dashboard') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-chart" /></svg> Dashboard
                    </a>
                    {% endif %}
                    
                    <!-- Shipments Received - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('shipping_unified') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-box" /></svg> Shipments Received
                    </a>
                    {% endif %}
                    
                    <!-- Production - Always visible for employees -->
                    <a href="{{ url_for('production.production_form') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-box" /></svg> Production
                    </a>
                    
                    <!-- Submissions - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('all_submissions') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-list" /></svg> Submissions
                    </a>
                    {% endif %}
                    
                    <!-- Purchase Orders - Manager+ -->
                    {% if session.employee_role in ['manager', 'admin'] %}
                    <a href="{{ url_for('all_purchase_orders') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-cart" /></svg> Purchase Orders
                    </a>
                    {% endif %}
                    
                    <!-- Admin - Admin only -->
                    {% if session.employee_role == 'admin' %}
                    <a href="{{ url_for('admin.admin_panel') }}" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-gear" /></svg> Admin
                    </a>
                    {% endif %}
                    <!-- Logout Button -->
                    {% if session.employee_authenticated or session.admin_authenticated %}
                    <a href="{{ url_for('logout') }}" class="nav-link hover:text-red-300 transition-all duration-300 px-3 py-2 rounded-lg hover:bg-red-500 hover:bg-opacity-20 flex items-center">
                        <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-logout" /></svg>
                        <span class="hidden sm:inline">Logout</span>
                    </a>
                    {% endif %}
                    
                    <!-- Language Toggle -->
                    <div class="relative ml-4">
                        <button onclick="toggleLanguageMenu()" class="nav-link hover:text-primary transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 flex items-center">
                            <svg class="w-5 h-5 mr-1" aria-hidden="true"><use href="#icon-language" /></svg>
                            <span class="hidden sm:inline">{{ current_language.upper() }}</span>
                        </button>
                        <div id="language-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-50">
                            {% for code, name in languages.items() %}
                            <a href="?lang={{ code }}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 {% if current_language == code %}bg-blue-50 text-blue-600 font-medium{% endif %}">
                                <span class="mr-2">{% if code == 'en' %}üá∫üá∏{% else %}üá™üá∏{% endif %}</span>
                                {{ name }}
                                {% if current_language == code %}<span class="float-right">‚úì</span>{% endif %}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-white hover:text-primary transition-colors duration-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Mobile menu -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
                {% if session.employee_role in ['manager', 'admin'] %}
                <a href="{{ url_for('dashboard.admin_dashboard') }}" class="block hover:text-primary transition-colors duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"><svg class="inline w-5 h-5 mr-1 align-[-2px]" aria-hidden="true"><use href="#icon-chart" /></svg> Dashboard</a>
                <a href="{{ url_for('shipping_unified') }}" class="block hover:text-primary transition-colors duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"><svg class="inline w-5 h-5 mr-1 align-[-2px]" aria-hidden="true"><use href="#icon-box" /></svg> Shipments Received</a>
                {% endif %}
                <a href="{{ url_for('production.production_form') }}" class="block hover:text-primary transition-colors duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"><svg class="inline w-5 h-5 mr-1 align-[-2px]" aria-hidden="true"><use href="#icon-box" /></svg> Production</a>
                {% if session.employee_role in ['manager', 'admin'] %}
                <a href="{{ url_for('all_submissions') }}" class="block hover:text-primary transition-colors duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"><svg class="inline w-5 h-5 mr-1 align-[-2px]" aria-hidden="true"><use href="#icon-list" /></svg> Submissions</a>
                <a href="{{ url_for('all_purchase_orders') }}" class="block hover:text-primary transition-colors duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"><svg class="inline w-5 h-5 mr-1 align-[-2px]" aria-hidden="true"><use href="#icon-cart" /></svg> Purchase Orders</a>
                {% endif %}
                {% if session.employee_role == 'admin' %}
                <a href="{{ url_for('admin.admin_panel') }}" class="block hover:text-primary transition-colors duration-300 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10"><svg class="inline w-5 h-5 mr-1 align-[-2px]" aria-hidden="true"><use href="#icon-gear" /></svg> Admin</a>
                {% endif %}
                {% if session.employee_authenticated or session.admin_authenticated %}
                <a href="{{ url_for('logout') }}" class="block hover:text-red-300 transition-colors duration-300 px-3 py-2 rounded-lg hover:bg-red-500 hover:bg-opacity-20"><svg class="inline w-5 h-5 mr-1 align-[-2px]" aria-hidden="true"><use href="#icon-logout" /></svg> Logout</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Enhanced main content area -->
    <main class="flex-1 container mx-auto px-4 py-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-6 p-4 rounded-xl shadow-lg transform transition-all duration-500 hover:scale-105 {% if category == 'error' %}bg-gradient-to-r from-[#0B2E33] to-[#4F7C82] text-white border border-[#93B1B5]{% else %}bg-gradient-to-r from-[#4F7C82] to-[#93B1B5] text-white border border-[#B8E3E9]{% endif %}">
                        <div class="flex items-center">
                            {% if category == 'error' %}
                                <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-exclamation" /></svg>
                            {% else %}
                                <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-check" /></svg>
                            {% endif %}
                            <span class="font-medium">{{ message }}</span>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Footer with version info -->
    <footer class="mt-auto py-4 text-center text-gray-500 text-sm">
        <div class="container mx-auto px-4">
            <p>{{ app_title }} v{{ version() }} - {{ app_description }}</p>
        </div>
    </footer>

    <script>
        // Enhanced JavaScript utilities with better styling
        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-6 right-6 bg-gradient-to-r from-emerald-500 to-green-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-500 scale-0';
            alert.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-3">‚úÖ</span>
                    <span class="font-semibold">${message}</span>
                </div>
            `;
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => alert.classList.add('scale-100'), 100);
            
            // Animate out and remove
            setTimeout(() => {
                alert.classList.add('scale-0', 'opacity-0');
                setTimeout(() => alert.remove(), 300);
            }, 3500);
        }

        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-6 right-6 bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-500 scale-0';
            alert.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                    <span class="font-semibold">${message}</span>
                </div>
            `;
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => alert.classList.add('scale-100'), 100);
            
            // Animate out and remove
            setTimeout(() => {
                alert.classList.add('scale-0', 'opacity-0');
                setTimeout(() => alert.remove(), 300);
            }, 5500);
        }

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        // Language menu toggle function
        function toggleLanguageMenu() {
            const menu = document.getElementById('language-menu');
            menu.classList.toggle('hidden');
        }

        // Close language menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('language-menu');
            const button = event.target.closest('button[onclick="toggleLanguageMenu()"]');
            
            if (!button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Add some sparkle effect on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add subtle animation to cards and buttons
            const cards = document.querySelectorAll('.card');
            const buttons = document.querySelectorAll('.btn-primary, .btn-success, .btn-warning');
            
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>

<!-- Shared Edit Submission Modal (Available on all pages) -->
<div id="edit-submission-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-[60]" onclick="closeEditSubmissionModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <!-- Fixed Header -->
        <div class="flex-shrink-0 p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">Edit Submission</h3>
                <button onclick="event.stopPropagation(); closeEditSubmissionModal(event)" class="text-gray-400 hover:text-gray-600 z-10 relative">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
        </div>
        
        <input type="hidden" id="edit-submission-id">
        <input type="hidden" id="edit-po-context-po-id">
        <input type="hidden" id="edit-po-context-item-id">
        
        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Displays Made</label>
                        <input type="number" id="edit-displays" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cards Remaining</label>
                        <input type="number" id="edit-packs" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loose Tablets</label>
                        <input type="number" id="edit-loose" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Damaged Tablets</label>
                        <input type="number" id="edit-damaged" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Box Number</label>
                        <input type="number" id="edit-box-number" min="1" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bag Number</label>
                        <input type="number" id="edit-bag-number" min="1" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bag Label Count</label>
                        <input type="number" id="edit-bag-label-count" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- Submission Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Submission Date</label>
                    <input type="date" id="edit-submission-date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Change this if submitting for a different date</p>
                </div>
                
                <!-- Admin Notes (Editable) -->
                <div id="admin-notes-section" class="mt-4">
                    <label class="block text-sm font-medium text-purple-800 mb-1">üîí Admin Notes (Optional)</label>
                    <textarea id="edit-admin-notes" rows="3"
                              class="w-full px-3 py-2 border border-purple-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 bg-purple-50 text-sm text-gray-700"
                              placeholder="Add internal notes visible to admins and managers..."></textarea>
                    <p class="text-xs text-purple-600 mt-1">These notes are visible to administrators and managers</p>
                </div>
                
                <!-- Admin Change PO Section (Only for verified submissions) -->
                <div id="admin-change-po-section" class="mt-4 hidden border-t pt-4">
                    <div class="mb-3 bg-red-50 border-l-4 border-red-400 p-3 rounded">
                        <p class="text-sm text-red-800 font-semibold mb-1">‚ö†Ô∏è ADMIN OVERRIDE - Change PO</p>
                        <p class="text-sm text-red-700">This submission is verified and locked. Changing the PO requires admin override.</p>
                        <p class="text-sm text-red-700 mt-1"><strong>Current PO:</strong> <span id="edit-current-po-display"></span></p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="edit-admin-confirm-checkbox" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">I understand this is an admin override and want to change the PO</span>
                        </label>
                    </div>
                    
                    <div id="edit-admin-pos-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select New PO:</label>
                        <div id="edit-admin-pos-list" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <!-- PO list will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fixed Footer -->
        <div class="flex-shrink-0 p-6 border-t border-gray-200 bg-white">
            <div class="flex justify-end gap-3">
                <button onclick="event.stopPropagation(); closeEditSubmissionModal(event)" 
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                    Cancel
                </button>
                <button onclick="saveSubmissionEdit()" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Notes View Modal (Read-only) -->
<div id="admin-notes-view-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-[70]" onclick="closeAdminNotesModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Admin Notes</h3>
                <button onclick="event.stopPropagation(); closeAdminNotesModal(event)" class="text-gray-400 hover:text-gray-600">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            
            <div class="mb-4">
                <div class="bg-purple-50 border border-purple-200 rounded-md p-4">
                    <div id="admin-notes-content" class="text-sm text-gray-700 whitespace-pre-wrap"></div>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button onclick="event.stopPropagation(); closeAdminNotesModal(event)" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Shared Edit Submission Modal JavaScript (Available on all pages) -->
<script>
// Admin Notes View Modal Functions (shared across all pages)
function showAdminNotes(adminNotes) {
    const modal = document.getElementById('admin-notes-view-modal');
    const content = document.getElementById('admin-notes-content');
    
    if (modal && content) {
        // Decode HTML entities and preserve newlines
        const decodedNotes = adminNotes 
            ? adminNotes.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"')
            : 'No notes available.';
        content.textContent = decodedNotes;
        modal.classList.remove('hidden');
    }
}

function closeAdminNotesModal(event) {
    const modal = document.getElementById('admin-notes-view-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
    if (event) {
        event.stopPropagation();
    }
}

// Edit Submission Modal Functions (shared across all pages)
async function openEditSubmissionModal(submissionId, poId = null, inventoryItemId = null) {
    try {
        const response = await fetch(`/api/submission/${submissionId}/details`);
        const data = await response.json();
        
        if (!data.success) {
            alert(data.error || 'Failed to load submission');
            return;
        }
        
        const sub = data.submission;
        
        // Populate the form
        document.getElementById('edit-submission-id').value = sub.id;
        const poContextInput = document.getElementById('edit-po-context-po-id');
        const itemContextInput = document.getElementById('edit-po-context-item-id');
        if (poContextInput && poId !== null) poContextInput.value = poId || '';
        if (itemContextInput && inventoryItemId !== null) itemContextInput.value = inventoryItemId || '';
        document.getElementById('edit-displays').value = sub.displays_made || 0;
        document.getElementById('edit-packs').value = sub.packs_remaining || 0;
        document.getElementById('edit-loose').value = sub.loose_tablets || 0;
        document.getElementById('edit-damaged').value = sub.damaged_tablets || 0;
        document.getElementById('edit-box-number').value = sub.box_number || '';
        document.getElementById('edit-bag-number').value = sub.bag_number || '';
        document.getElementById('edit-bag-label-count').value = sub.bag_label_count || '';
        
        // Populate submission date
        const submissionDateInput = document.getElementById('edit-submission-date');
        if (submissionDateInput) {
            // Use submission_date if available, otherwise use date from created_at
            const submissionDate = sub.submission_date || (sub.created_at ? sub.created_at.split(' ')[0] : '');
            submissionDateInput.value = submissionDate;
        }
        
        // Populate admin notes textarea
        const adminNotesTextarea = document.getElementById('edit-admin-notes');
        if (adminNotesTextarea) {
            adminNotesTextarea.value = sub.admin_notes || '';
        }
        
        // Show admin change PO section for all submissions (verification workflow removed)
        // Note: This modal is only accessible to admins/managers (API enforces this)
        const adminChangePoSection = document.getElementById('admin-change-po-section');
        
        if (adminChangePoSection) {
            adminChangePoSection.classList.remove('hidden');
            const currentPoDisplay = document.getElementById('edit-current-po-display');
            if (currentPoDisplay) {
                currentPoDisplay.textContent = sub.po_number || 'Unassigned';
            }
            
            // Setup checkbox handler
            const confirmCheckbox = document.getElementById('edit-admin-confirm-checkbox');
            const posSection = document.getElementById('edit-admin-pos-section');
            if (confirmCheckbox && posSection) {
                confirmCheckbox.checked = false;
                posSection.classList.add('hidden');
                confirmCheckbox.onchange = function() {
                    if (this.checked) {
                        loadEditAdminPOs(submissionId, sub.product_name);
                    } else {
                        posSection.classList.add('hidden');
                    }
                };
            }
        } else if (adminChangePoSection) {
            adminChangePoSection.classList.add('hidden');
        }
        
        // Show modal
        document.getElementById('edit-submission-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading submission:', error);
        alert('Failed to load submission: ' + error.message);
    }
}

// Admin Change PO functions for edit modal
async function loadEditAdminPOs(submissionId, productName) {
    try {
        const response = await fetch(`/api/submission/${submissionId}/available_pos`);
        const data = await response.json();
        
        if (!data.success) {
            if (typeof showError === 'function') {
                showError(data.error || 'Failed to load available POs');
            } else {
                alert('Error: ' + (data.error || 'Failed to load available POs'));
            }
            return;
        }
        
        const posSection = document.getElementById('edit-admin-pos-section');
        if (posSection) {
            posSection.classList.remove('hidden');
        }
        
        const posList = document.getElementById('edit-admin-pos-list');
        if (!posList) return;
        
        posList.innerHTML = '';
        
        if (data.available_pos.length === 0) {
            posList.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No POs found for this product</p>
                </div>
            `;
            return;
        }
        
        data.available_pos.forEach(po => {
            const isCurrent = po.id === data.current_po_id;
            const statusColor = po.closed ? 'bg-gray-100 text-gray-700' : 'bg-green-100 text-green-700';
            const statusLabel = po.closed ? 'üîí Closed' : '‚úì Open';
            
            const poDiv = document.createElement('div');
            poDiv.className = `border rounded-lg p-4 hover:bg-orange-50 cursor-pointer transition-colors ${isCurrent ? 'border-orange-500 bg-orange-50' : 'border-gray-300'}`;
            poDiv.onclick = () => adminReassignFromEditModal(submissionId, po.id, po.po_number);
            
            poDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-bold text-lg text-gray-900">${po.po_number}</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusColor}">
                                ${statusLabel}
                            </span>
                            ${isCurrent ? '<span class="text-xs text-orange-600 font-bold">CURRENT</span>' : ''}
                        </div>
                        <div class="grid grid-cols-4 gap-3 text-sm">
                            <div>
                                <div class="text-xs text-gray-500">Ordered</div>
                                <div class="font-medium">${po.ordered.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-green-600">Good</div>
                                <div class="font-medium text-green-600">${po.good.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-red-600">Damaged</div>
                                <div class="font-medium text-red-600">${po.damaged.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-blue-600">Remaining</div>
                                <div class="font-medium text-blue-600">${po.remaining.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    ${!isCurrent ? '<div class="text-2xl text-orange-600">‚Üí</div>' : ''}
                </div>
            `;
            
            posList.appendChild(poDiv);
        });
        
    } catch (error) {
        console.error('Error loading available POs:', error);
        if (typeof showError === 'function') {
            showError('Failed to load available POs: ' + error.message);
        } else {
            alert('Failed to load available POs: ' + error.message);
        }
    }
}

async function adminReassignFromEditModal(submissionId, newPoId, newPoNumber) {
    if (!confirm(`‚ö†Ô∏è ADMIN OVERRIDE CONFIRMATION\n\nAre you sure you want to change this VERIFIED submission from its current PO to ${newPoNumber}?\n\nThis will:\n- Update counts on both POs\n- Keep the submission verified\n- Require admin override confirmation\n\nThis action cannot be easily undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/submission/${submissionId}/admin_reassign`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                new_po_id: newPoId,
                confirm_override: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showSuccess === 'function') {
                showSuccess(data.message || 'PO assignment changed successfully!');
            } else {
                alert('Success: ' + (data.message || 'PO assignment changed successfully!'));
            }
            closeEditSubmissionModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            if (typeof showError === 'function') {
                showError(data.error || 'Failed to change PO assignment');
            } else {
                alert('Error: ' + (data.error || 'Failed to change PO assignment'));
            }
        }
    } catch (error) {
        console.error('Error changing PO assignment:', error);
        if (typeof showError === 'function') {
            showError('Failed to change PO assignment: ' + error.message);
        } else {
            alert('Failed to change PO assignment: ' + error.message);
        }
    }
}

function closeEditSubmissionModal(event) {
    // Always close the modal when called (whether from button click or backdrop click)
    const modal = document.getElementById('edit-submission-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
    // Prevent event propagation if event exists
    if (event) {
        event.stopPropagation();
    }
}

async function saveSubmissionEdit() {
    const submissionId = document.getElementById('edit-submission-id').value;
    const poId = document.getElementById('edit-po-context-po-id')?.value || '';
    const inventoryItemId = document.getElementById('edit-po-context-item-id')?.value || '';
    
    const formData = {
        displays_made: parseInt(document.getElementById('edit-displays').value) || 0,
        packs_remaining: parseInt(document.getElementById('edit-packs').value) || 0,
        loose_tablets: parseInt(document.getElementById('edit-loose').value) || 0,
        damaged_tablets: parseInt(document.getElementById('edit-damaged').value) || 0,
        box_number: parseInt(document.getElementById('edit-box-number').value) || null,
        bag_number: parseInt(document.getElementById('edit-bag-number').value) || null,
        bag_label_count: parseInt(document.getElementById('edit-bag-label-count').value) || null,
        submission_date: document.getElementById('edit-submission-date')?.value || null,
        admin_notes: document.getElementById('edit-admin-notes')?.value?.trim() || null
    };
    
    try {
        const response = await fetch(`/api/submission/${submissionId}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Use showSuccess if available, otherwise alert
            if (typeof showSuccess === 'function') {
                showSuccess('Submission updated successfully!');
            } else {
                alert('Submission updated successfully!');
            }
            closeEditSubmissionModal();
            
            // If we're in a PO modal context, refresh it instead of reloading the page
            if (poId && poId !== '') {
                // Refresh the PO submissions modal
                const poNumber = document.querySelector('#submissions-modal h3')?.textContent.match(/PO-[^\s]+/)?.[0] || '';
                if (poNumber && typeof viewPOSubmissions === 'function') {
                    viewPOSubmissions(parseInt(poId), poNumber, inventoryItemId || null);
                } else {
                    location.reload();
                }
            } else {
                location.reload();
            }
        } else {
            const errorMsg = result.error || 'Failed to update submission';
            if (typeof showError === 'function') {
                showError(errorMsg);
            } else {
                alert('Error: ' + errorMsg);
            }
        }
    } catch (error) {
        console.error('Error updating submission:', error);
        const errorMsg = 'Failed to update submission: ' + error.message;
        if (typeof showError === 'function') {
            showError(errorMsg);
        } else {
            alert(errorMsg);
        }
    }
}

// Convert tablet type dropdown to two-level dropdown system
async function convertToTwoLevelDropdown(selectElement) {
    if (!selectElement || selectElement.tagName !== 'SELECT') return;
    
    // Check if already converted
    if (selectElement.dataset.twoLevelConverted === 'true') return;
    selectElement.dataset.twoLevelConverted = 'true';
    
    const options = Array.from(selectElement.options);
    const placeholder = options.find(opt => opt.value === '' || opt.value === null);
    const originalValue = selectElement.value;
    
    // Try to fetch configured categories from API
    let groups = {};
    let groupOrder = []; // Will be populated from API, no hardcoded fallback
    
    try {
        const response = await fetch('/api/tablet_types/categories');
        const data = await response.json();
        
        if (data.success && data.categories) {
            // Use configured categories
            groups = {};
            groupOrder = data.category_order || groupOrder;
            
            // Initialize groups
            groupOrder.forEach(cat => {
                groups[cat] = [];
            });
            
            // Map options to categories based on configured categories
            options.forEach(option => {
                if (!option.value || option.value === '') return;
                
                // Find which category this tablet type belongs to
                let found = false;
                for (const [category, items] of Object.entries(data.categories)) {
                    const matchingItem = items.find(item => item.id == option.value || item.name === option.text.trim());
                    if (matchingItem) {
                        if (!groups[category]) {
                            groups[category] = [];
                        }
                        groups[category].push(option);
                        found = true;
                        break;
                    }
                }
                
                // If not found in configured categories, use fallback logic
                if (!found) {
                    const name = option.text.trim();
                    let categorized = false;
                    
                    // FIX Energy variants
                    if (name.match(/^\d+ct\s+FIX\s+Energy/i) || name.match(/^FIX\s+Energy\s+\d+ct/i)) {
                        if (!groups['FIX Energy']) groups['FIX Energy'] = [];
                        groups['FIX Energy'].push(option);
                        categorized = true;
                    }
                    // FIX Focus variants
                    else if (name.match(/^\d+ct\s+FIX\s+Focus/i) || name.match(/^FIX\s+Focus\s+\d+ct/i)) {
                        if (!groups['FIX Focus']) groups['FIX Focus'] = [];
                        groups['FIX Focus'].push(option);
                        categorized = true;
                    }
                    // FIX Relax variants
                    else if (name.match(/^\d+ct\s+FIX\s+Relax/i) || name.match(/^FIX\s+Relax\s+\d+ct/i)) {
                        if (!groups['FIX Relax']) groups['FIX Relax'] = [];
                        groups['FIX Relax'].push(option);
                        categorized = true;
                    }
                    // FIX MAX variants
                    else if (name.match(/^FIX\s+MAX/i)) {
                        if (!groups['FIX MAX']) groups['FIX MAX'] = [];
                        groups['FIX MAX'].push(option);
                        categorized = true;
                    }
                    // 18mg variants
                    else if (name.match(/^18mg/i)) {
                        if (!groups['18mg']) groups['18mg'] = [];
                        groups['18mg'].push(option);
                        categorized = true;
                    }
                    // XL variants
                    else if (name.match(/^XL\s+/i)) {
                        if (!groups['XL']) groups['XL'] = [];
                        groups['XL'].push(option);
                        categorized = true;
                    }
                    // Hyroxi variants
                    else if (name.match(/^Hyroxi/i)) {
                        if (!groups['Hyroxi']) groups['Hyroxi'] = [];
                        groups['Hyroxi'].push(option);
                        categorized = true;
                    }
                    
                    if (!categorized) {
                        if (!groups['Other']) groups['Other'] = [];
                        groups['Other'].push(option);
                    }
                }
            });
        } else {
            throw new Error('Failed to load categories');
        }
    } catch (error) {
        // Fallback to hardcoded logic if API fails
        console.warn('Failed to load configured categories, using fallback:', error);
        groups = {
            'FIX Energy': [],
            'FIX Focus': [],
            'FIX Relax': [],
            'FIX MAX': [],
            '18mg': [],
            'XL': [],
            'Hyroxi': [],
            'Other': []
        };
        
        // Categorize each option using fallback logic
        options.forEach(option => {
            if (!option.value || option.value === '') return;
            
            const name = option.text.trim();
            let categorized = false;
            
            // FIX Energy variants
            if (name.match(/^\d+ct\s+FIX\s+Energy/i) || name.match(/^FIX\s+Energy\s+\d+ct/i)) {
                groups['FIX Energy'].push(option);
                categorized = true;
            }
            // FIX Focus variants
            else if (name.match(/^\d+ct\s+FIX\s+Focus/i) || name.match(/^FIX\s+Focus\s+\d+ct/i)) {
                groups['FIX Focus'].push(option);
                categorized = true;
            }
            // FIX Relax variants
            else if (name.match(/^\d+ct\s+FIX\s+Relax/i) || name.match(/^FIX\s+Relax\s+\d+ct/i)) {
                groups['FIX Relax'].push(option);
                categorized = true;
            }
            // FIX MAX variants
            else if (name.match(/^FIX\s+MAX/i)) {
                groups['FIX MAX'].push(option);
                categorized = true;
            }
            // 18mg variants
            else if (name.match(/^18mg/i)) {
                groups['18mg'].push(option);
                categorized = true;
            }
            // XL variants
            else if (name.match(/^XL\s+/i)) {
                groups['XL'].push(option);
                categorized = true;
            }
            // Hyroxi variants
            else if (name.match(/^Hyroxi/i)) {
                groups['Hyroxi'].push(option);
                categorized = true;
            }
            
            if (!categorized) {
                groups['Other'].push(option);
            }
        });
    }
    
    // Sort within groups (by count if numeric, then alphabetically)
    Object.keys(groups).forEach(groupName => {
        groups[groupName].sort((a, b) => {
            const aText = a.text.trim();
            const bText = b.text.trim();
            // Extract count if present (e.g., "12ct" -> 12)
            const aMatch = aText.match(/(\d+)ct/i);
            const bMatch = bText.match(/(\d+)ct/i);
            if (aMatch && bMatch) {
                return parseInt(aMatch[1]) - parseInt(bMatch[1]);
            }
            return aText.localeCompare(bText);
        });
    });
    
    // Hide original select and remove required attribute (prevents "not focusable" error)
    selectElement.style.display = 'none';
    selectElement.removeAttribute('required');
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'space-y-2';
    
    // Create group dropdown
    const groupSelect = document.createElement('select');
    groupSelect.className = selectElement.className;
    groupSelect.id = selectElement.id + '_group';
    groupSelect.name = selectElement.name + '_group';
    groupSelect.innerHTML = '<option value="">Select category...</option>';
    
    // Create item dropdown
    const itemSelect = document.createElement('select');
    itemSelect.className = selectElement.className;
    itemSelect.id = selectElement.id + '_item';
    itemSelect.name = selectElement.name;
    itemSelect.required = true; // Always required - this is the actual selection field
    itemSelect.innerHTML = '<option value="">Select tablet type...</option>';
    itemSelect.style.display = 'none';
    
    // Add groups to group dropdown
    groupOrder.forEach(groupName => {
        if (!groups[groupName] || groups[groupName].length === 0) return;
        const option = document.createElement('option');
        option.value = groupName;
        option.textContent = groupName;
        groupSelect.appendChild(option);
    });
    
    // Store groups data
    groupSelect.dataset.groups = JSON.stringify(groups);
    
    // Handle group selection
    groupSelect.addEventListener('change', function() {
        const selectedGroup = this.value;
        itemSelect.innerHTML = '<option value="">Select tablet type...</option>';
        itemSelect.style.display = 'none';
        selectElement.value = '';
        
        if (selectedGroup && groups[selectedGroup]) {
            // Populate item dropdown
            groups[selectedGroup].forEach(option => {
                const itemOption = document.createElement('option');
                itemOption.value = option.value;
                itemOption.textContent = option.text;
                itemSelect.appendChild(itemOption);
            });
            itemSelect.style.display = '';
        }
    });
    
    // Handle item selection
    itemSelect.addEventListener('change', function() {
        selectElement.value = this.value;
        // Trigger change event on original select for form validation
        selectElement.dispatchEvent(new Event('change', { bubbles: true }));
    });
    
    // Restore original value if set
    if (originalValue) {
        // Find which group contains this value
        for (const [groupName, groupOptions] of Object.entries(groups)) {
            const found = groupOptions.find(opt => opt.value === originalValue);
            if (found) {
                groupSelect.value = groupName;
                groupSelect.dispatchEvent(new Event('change'));
                setTimeout(() => {
                    itemSelect.value = originalValue;
                    selectElement.value = originalValue;
                }, 0);
                break;
            }
        }
    }
    
    // Insert wrapper before select
    const parent = selectElement.parentNode;
    parent.insertBefore(wrapper, selectElement);
    wrapper.appendChild(groupSelect);
    wrapper.appendChild(itemSelect);
    wrapper.appendChild(selectElement); // Keep original for form submission
}

// Add search functionality to tablet type dropdown
function addTabletTypeSearch(selectElement) {
    if (!selectElement || selectElement.tagName !== 'SELECT') return;
    
    // Check if search already added
    if (selectElement.dataset.searchAdded === 'true') return;
    selectElement.dataset.searchAdded = 'true';
    
    // Create search input wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'relative';
    wrapper.style.position = 'relative';
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search tablet types...';
    searchInput.className = 'form-input mb-2';
    searchInput.style.marginBottom = '0.5rem';
    searchInput.style.paddingRight = '2.5rem';
    
    // Add search icon
    const searchIcon = document.createElement('div');
    searchIcon.innerHTML = `
        <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    `;
    searchIcon.style.position = 'absolute';
    searchIcon.style.right = '0.75rem';
    searchIcon.style.top = '50%';
    searchIcon.style.transform = 'translateY(-50%)';
    searchIcon.style.pointerEvents = 'none';
    
    const searchWrapper = document.createElement('div');
    searchWrapper.style.position = 'relative';
    searchWrapper.appendChild(searchInput);
    searchWrapper.appendChild(searchIcon);
    
    // Wrap the select element
    const parent = selectElement.parentNode;
    parent.insertBefore(wrapper, selectElement);
    wrapper.appendChild(searchWrapper);
    wrapper.appendChild(selectElement);
    
    // Filter function
    function filterOptions(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        const optgroups = selectElement.querySelectorAll('optgroup');
        const options = selectElement.querySelectorAll('option');
        
        if (!term) {
            // Show all
            optgroups.forEach(optgroup => {
                optgroup.style.display = '';
                Array.from(optgroup.options).forEach(opt => {
                    opt.style.display = '';
                });
            });
            options.forEach(opt => {
                if (!opt.closest('optgroup')) {
                    opt.style.display = '';
                }
            });
            return;
        }
        
        // Filter optgroups and options
        optgroups.forEach(optgroup => {
            const groupOptions = Array.from(optgroup.options);
            const matchingOptions = groupOptions.filter(opt => 
                opt.textContent.toLowerCase().includes(term)
            );
            
            if (matchingOptions.length > 0) {
                optgroup.style.display = '';
                groupOptions.forEach(opt => {
                    opt.style.display = opt.textContent.toLowerCase().includes(term) ? '' : 'none';
                });
            } else {
                optgroup.style.display = 'none';
            }
        });
        
        // Filter standalone options
        options.forEach(opt => {
            if (!opt.closest('optgroup') && opt.value) {
                opt.style.display = opt.textContent.toLowerCase().includes(term) ? '' : 'none';
            }
        });
    }
    
    // Add event listener
    searchInput.addEventListener('input', function(e) {
        filterOptions(e.target.value);
    });
    
    // Clear search when select changes
    selectElement.addEventListener('change', function() {
        if (selectElement.value) {
            searchInput.value = '';
            filterOptions('');
        }
    });
    
    // Show search input only when dropdown is focused/opened (optional enhancement)
    // For now, keep it always visible for simplicity
}
</script>
</body>
</html>
