{% extends "base.html" %}

{% block title %}All Purchase Orders{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                üì¶ All Purchase Orders
            </h1>
            <p class="text-gray-600 mt-2">Complete list of all purchase orders with filtering</p>
        </div>
        <a href="/dashboard" class="btn-secondary px-6 py-3">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>

<!-- Filter Tabs -->
<div class="mb-6 flex gap-4">
    <button onclick="filterPOs('all')" id="btn-all" class="px-6 py-3 rounded-lg font-medium transition-all bg-blue-600 text-white shadow-lg">
        All POs (<span id="count-all">{{ purchase_orders|length }}</span>)
    </button>
    <button onclick="filterPOs('open')" id="btn-open" class="px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300">
        Open (<span id="count-open">0</span>)
    </button>
    <button onclick="filterPOs('closed')" id="btn-closed" class="px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300">
        Closed (<span id="count-closed">0</span>)
    </button>
    <button onclick="filterPOs('draft')" id="btn-draft" class="px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300">
        Draft (<span id="count-draft">0</span>)
    </button>
</div>

<!-- Purchase Orders Table -->
<div class="card hover-lift">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        PO Number
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Tablet Type
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Ordered
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Good
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Damaged
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Remaining/Overs
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Progress
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Submissions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for po in purchase_orders %}
                <tr class="hover:bg-gray-100 po-row" 
                    data-po-status="{{ 'draft' if po.internal_status == 'Draft' else ('closed' if po.closed else 'open') }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ po.po_number }}
                        {% if session.get('employee_role') == 'admin' %}
                            <button onclick="event.stopPropagation(); deletePO({{ po.id }}, '{{ po.po_number }}')" 
                                    class="ml-2 text-xs text-red-600 hover:text-red-800"
                                    title="Delete PO (Admin only)">
                                üóëÔ∏è
                            </button>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ po.tablet_type or 'Multiple' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ "{:,}".format(po.ordered_quantity) if po.ordered_quantity else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ "{:,}".format(po.current_good_count) if po.current_good_count else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ "{:,}".format(po.current_damaged_count) if po.current_damaged_count else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if po.remaining_quantity < 0 %}text-purple-600{% else %}text-gray-900{% endif %} cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {% if po.remaining_quantity < 0 %}
                            +{{ "{:,}".format(po.remaining_quantity|abs) }} over
                        {% else %}
                            {{ "{:,}".format(po.remaining_quantity) if po.remaining_quantity else '0' }}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {% set received = (po.current_good_count or 0) + (po.current_damaged_count or 0) %}
                        {% set total = po.ordered_quantity or 1 %}
                        {% set progress = ((received / total * 100)|int) if total > 0 else 0 %}
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ [progress, 100]|min }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">{{ progress }}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {% if po.internal_status == 'Draft' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-yellow-400 to-yellow-500 text-white shadow-lg">
                                üìù Draft
                            </span>
                        {% elif po.closed %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-gray-400 to-gray-500 text-white shadow-lg">
                                üîí Closed
                            </span>
                        {% elif po.remaining_quantity <= 0 %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-green-400 to-green-500 text-white shadow-lg">
                                ‚úì Complete
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-blue-400 to-blue-500 text-white shadow-lg">
                                üîÑ {{ po.status_display }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            {{ po.submission_count or 0 }} submission(s)
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- PO Details Modal (reuse from dashboard) -->
<div id="po-details-modal-container"></div>

<script>
// Filter POs by status
function filterPOs(status) {
    const rows = document.querySelectorAll('.po-row');
    let counts = {all: 0, open: 0, closed: 0, draft: 0};
    
    rows.forEach(row => {
        const poStatus = row.getAttribute('data-po-status');
        counts.all++;
        counts[poStatus]++;
        
        if (status === 'all' || poStatus === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update counts
    document.getElementById('count-all').textContent = counts.all;
    document.getElementById('count-open').textContent = counts.open;
    document.getElementById('count-closed').textContent = counts.closed;
    document.getElementById('count-draft').textContent = counts.draft;
    
    // Update button styles
    ['all', 'open', 'closed', 'draft'].forEach(btn => {
        const button = document.getElementById(`btn-${btn}`);
        if (btn === status) {
            button.className = 'px-6 py-3 rounded-lg font-medium transition-all bg-blue-600 text-white shadow-lg';
        } else {
            button.className = 'px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300';
        }
    });
}

// Initialize counts on page load
document.addEventListener('DOMContentLoaded', function() {
    filterPOs('all');
});

// Modal functions (from dashboard)
async function viewPODetailsModal(poId, poNumber) {
    try {
        const response = await fetch(`/api/po_lines/${poId}`);
        const data = await response.json();
        const lines = data.lines || data; // Handle both new format and legacy format
        const hasUnverified = data.has_unverified_submissions || false;
        const unverifiedCount = data.unverified_count || 0;
        
        // Build modal content
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closePODetailsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold">üì¶ Purchase Order: ${poNumber}</h3>
                                <p class="text-sm text-blue-100 mt-1">${lines.length} line item(s)</p>
                            </div>
                            <button onclick="closePODetailsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
        `;
        
        // Add warning if there are unverified submissions
        if (hasUnverified) {
            modalContent += `
                <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-yellow-800">‚ö†Ô∏è Warning: This PO summary contains unverified submissions</p>
                            <p class="text-xs text-yellow-700 mt-1">${unverifiedCount} submission${unverifiedCount !== 1 ? 's' : ''} need${unverifiedCount !== 1 ? '' : 's'} verification. Please verify and approve assignments before finalizing counts.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (lines.length === 0) {
            modalContent += `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p class="text-lg">No line items found for this PO</p>
                </div>
            `;
        } else {
            modalContent += '<div class="grid grid-cols-1 gap-4">';
            
            lines.forEach(line => {
                const remaining = line.quantity_ordered - line.good_count - line.damaged_count;
                const received = line.good_count + line.damaged_count;
                const progressPercent = line.quantity_ordered > 0 ? ((received / line.quantity_ordered) * 100).toFixed(1) : 0;
                const isOver = remaining < 0;
                const displayValue = Math.abs(remaining);
                const labelText = isOver ? 'Overs' : 'Remaining';
                const labelColor = isOver ? 'text-purple-600' : 'text-blue-600';
                const bgColor = isOver ? 'bg-purple-50' : 'bg-blue-50';
                
                modalContent += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50 cursor-pointer transition-colors duration-200" 
                         onclick="event.stopPropagation(); closePODetailsModal(); viewPOSubmissions(${poId}, '${poNumber}', '${line.inventory_item_id}');"
                         title="Click to view submissions for this product">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
                            <div class="flex-1">
                                <div class="font-bold text-lg text-gray-900">${line.line_item_name}</div>
                                <div class="text-sm text-gray-500 font-mono mt-1">ID: ${line.inventory_item_id}</div>
                                
                                <!-- Progress bar -->
                                <div class="mt-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Progress</span>
                                        <span class="font-semibold">${progressPercent}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stats Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1">Ordered</div>
                                    <div class="text-lg font-bold text-gray-900">${line.quantity_ordered.toLocaleString()}</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3">
                                    <div class="text-xs text-green-600 mb-1">Good</div>
                                    <div class="text-lg font-bold text-green-600">${line.good_count.toLocaleString()}</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-3">
                                    <div class="text-xs text-red-600 mb-1">Damaged</div>
                                    <div class="text-lg font-bold text-red-600">${line.damaged_count.toLocaleString()}</div>
                                </div>
                                <div class="${bgColor} rounded-lg p-3">
                                    <div class="text-xs ${labelColor} mb-1">${labelText}</div>
                                    <div class="text-lg font-bold ${labelColor}">${displayValue.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalContent += '</div>';
        }
        
        // Add "View All Submissions" button at the bottom
        modalContent += `
            <div class="mt-6 flex justify-center border-t pt-4">
                <button onclick="event.stopPropagation(); closePODetailsModal(); viewPOSubmissions(${poId}, '${poNumber}', null);" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-colors">
                    üìã View All Submissions for this PO
                </button>
            </div>
        `;
        
        modalContent += `
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.id = 'po-details-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        console.error('Error loading PO details:', error);
        alert('Failed to load PO details: ' + error.message);
    }
}

function closePODetailsModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('po-details-modal');
        if (modal) {
            modal.remove();
        }
    }
}

async function viewPOSubmissions(poId, poName, inventoryItemId = null) {
    window.location.href = `/submissions?po_id=${poId}` + (inventoryItemId ? `&item_id=${inventoryItemId}` : '');
}

async function deletePO(poId, poNumber) {
    if (!confirm(`‚ö†Ô∏è WARNING: Delete ${poNumber}?\n\nThis will:\n- Delete the PO and all its line items\n- Unassign all submissions (submissions won't be deleted)\n- Delete related shipments\n\nThis action cannot be undone. Continue?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/po/${poId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message + '\n\nRefreshing page...');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Failed to delete PO'));
        }
    } catch (error) {
        console.error('Error deleting PO:', error);
        alert('Failed to delete PO: ' + error.message);
    }
}
</script>
{% endblock %}

