{% extends "base.html" %}

{% block title %}All Purchase Orders{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                üì¶ All Purchase Orders
            </h1>
            <p class="text-gray-600 mt-2">Complete list of all purchase orders with filtering</p>
        </div>
        <a href="/dashboard" class="btn-secondary px-6 py-3">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>

<!-- Filter Tabs -->
<div class="mb-6 flex gap-4">
    <button onclick="filterPOs('all')" id="btn-all" class="px-6 py-3 rounded-lg font-medium transition-all bg-blue-600 text-white shadow-lg">
        All POs (<span id="count-all">{{ purchase_orders|length }}</span>)
    </button>
    <button onclick="filterPOs('open')" id="btn-open" class="px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300">
        Open (<span id="count-open">0</span>)
    </button>
    <button onclick="filterPOs('closed')" id="btn-closed" class="px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300">
        Closed (<span id="count-closed">0</span>)
    </button>
    <button onclick="filterPOs('draft')" id="btn-draft" class="px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300">
        Draft (<span id="count-draft">0</span>)
    </button>
</div>

<!-- Purchase Orders Table -->
<div class="card hover-lift">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        PO Number
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Tablet Type
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Ordered
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Good
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Damaged
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Remaining/Overs
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Progress
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Submissions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for po in purchase_orders %}
                <tr class="hover:bg-gray-100 po-row {% if po.is_overs %}bg-blue-50{% endif %}" 
                    data-po-status="{{ 'draft' if po.internal_status == 'Draft' else ('closed' if po.closed else 'open') }}">
                    <td class="py-4 whitespace-nowrap text-sm font-medium text-gray-900 cursor-pointer {% if po.is_overs %}pl-16 pr-6{% else %}px-6{% endif %}" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {% if po.is_overs %}
                            <span class="text-blue-600 mr-2">‚Ü≥</span>
                        {% endif %}
                        {{ po.po_number }}
                        {% if session.get('employee_role') == 'admin' %}
                            <button onclick="event.stopPropagation(); deletePO({{ po.id }}, '{{ po.po_number }}')" 
                                    class="ml-2 text-xs text-red-600 hover:text-red-800"
                                    title="Delete PO (Admin only)">
                                üóëÔ∏è
                            </button>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ po.tablet_type or 'Multiple' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ "{:,}".format(po.ordered_quantity) if po.ordered_quantity else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ "{:,}".format(po.current_good_count) if po.current_good_count else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {{ "{:,}".format(po.current_damaged_count) if po.current_damaged_count else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if po.remaining_quantity < 0 %}text-purple-600{% else %}text-gray-900{% endif %} cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {% if po.remaining_quantity < 0 %}
                            +{{ "{:,}".format(po.remaining_quantity|abs) }} over
                        {% else %}
                            {{ "{:,}".format(po.remaining_quantity) if po.remaining_quantity else '0' }}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {% set received = (po.current_good_count or 0) + (po.current_damaged_count or 0) %}
                        {% set total = po.ordered_quantity or 1 %}
                        {% set progress = ((received / total * 100)|int) if total > 0 else 0 %}
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ [progress, 100]|min }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">{{ progress }}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap cursor-pointer" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                        {% if po.internal_status == 'Draft' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-yellow-400 to-yellow-500 text-white shadow-lg">
                                üìù Draft
                            </span>
                        {% elif po.internal_status == 'Cancelled' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-red-400 to-red-500 text-white shadow-lg">
                                ‚ùå Cancelled
                            </span>
                        {% elif po.closed %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-gray-400 to-gray-500 text-white shadow-lg">
                                üîí Closed
                            </span>
                        {% elif po.ordered_quantity and po.ordered_quantity > 0 and po.remaining_quantity <= 0 and (po.current_good_count or 0) + (po.current_damaged_count or 0) > 0 %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-green-400 to-green-500 text-white shadow-lg">
                                ‚úì Complete
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-blue-400 to-blue-500 text-white shadow-lg">
                                üîÑ {{ po.status_display }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            {{ po.submission_count or 0 }} submission(s)
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- PO Details Modal (reuse from dashboard) -->
<div id="po-details-modal-container"></div>

<script>
// Filter POs by status
function filterPOs(status) {
    const rows = document.querySelectorAll('.po-row');
    let counts = {all: 0, open: 0, closed: 0, draft: 0};
    
    rows.forEach(row => {
        const poStatus = row.getAttribute('data-po-status');
        counts.all++;
        counts[poStatus]++;
        
        if (status === 'all' || poStatus === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update counts
    document.getElementById('count-all').textContent = counts.all;
    document.getElementById('count-open').textContent = counts.open;
    document.getElementById('count-closed').textContent = counts.closed;
    document.getElementById('count-draft').textContent = counts.draft;
    
    // Update button styles
    ['all', 'open', 'closed', 'draft'].forEach(btn => {
        const button = document.getElementById(`btn-${btn}`);
        if (btn === status) {
            button.className = 'px-6 py-3 rounded-lg font-medium transition-all bg-blue-600 text-white shadow-lg';
        } else {
            button.className = 'px-6 py-3 rounded-lg font-medium transition-all bg-white text-gray-700 hover:bg-gray-50 border border-gray-300';
        }
    });
}

// Initialize counts on page load
document.addEventListener('DOMContentLoaded', function() {
    filterPOs('all');
});

// Modal functions (from dashboard)
async function viewPODetailsModal(poId, poNumber) {
    try {
        const response = await fetch(`/api/po_lines/${poId}`);
        const data = await response.json();
        const lines = data.lines || data; // Handle both new format and legacy format
        const hasUnverified = data.has_unverified_submissions || false;
        const unverifiedCount = data.unverified_count || 0;
        const poStatus = data.po_status || 'Open';
        
        // Determine status badge color
        let statusBadgeClass = 'bg-blue-100 text-blue-800 border-blue-300';
        if (poStatus === 'Closed') {
            statusBadgeClass = 'bg-gray-100 text-gray-800 border-gray-300';
        } else if (poStatus === 'Draft') {
            statusBadgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
        } else if (poStatus === 'Open' || poStatus === 'Active') {
            statusBadgeClass = 'bg-green-100 text-green-800 border-green-300';
        }
        
        // Build modal content
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closePODetailsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-xl font-bold">üì¶ Purchase Order: ${poNumber}</h3>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-semibold ${statusBadgeClass} border">
                                        ${poStatus}
                                    </span>
                                </div>
                                <p class="text-sm text-blue-100 mt-1">${lines.length} line item(s)</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${data.parent_po ? `
                                    <button onclick="closePODetailsModal(); setTimeout(() => viewPODetailsModal(${data.parent_po.id}, '${data.parent_po.po_number}'), 100);" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
                                            title="Back to parent PO">
                                        ‚Üê Back to Parent PO
                                    </button>
                                ` : ''}
                                ${data.overs_po ? `
                                    <button onclick="closePODetailsModal(); setTimeout(() => viewPODetailsModal(${data.overs_po.id}, '${data.overs_po.po_number}'), 100);" 
                                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
                                            title="View linked overs PO">
                                        üì¶ View Overs PO
                                    </button>
                                ` : ''}
                                <button onclick="showOversPOCreationInfo(${poId}, '${poNumber}')" 
                                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
                                        title="Get info to create overs PO">
                                    üìã Create Overs PO
                                </button>
                                <button onclick="closePODetailsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
        `;
        
        // Add warning if there are unverified submissions
        if (hasUnverified) {
            modalContent += `
                <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-yellow-800">‚ö†Ô∏è Warning: This PO summary contains unverified submissions</p>
                            <p class="text-xs text-yellow-700 mt-1">${unverifiedCount} submission${unverifiedCount !== 1 ? 's' : ''} need${unverifiedCount !== 1 ? '' : 's'} verification. Please verify and approve assignments before finalizing counts.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (lines.length === 0) {
            modalContent += `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p class="text-lg">No line items found for this PO</p>
                </div>
            `;
        } else {
            modalContent += '<div class="grid grid-cols-1 gap-4">';
            
            lines.forEach(line => {
                const remaining = line.quantity_ordered - line.good_count - line.damaged_count;
                const received = line.good_count + line.damaged_count;
                const progressPercent = line.quantity_ordered > 0 ? ((received / line.quantity_ordered) * 100).toFixed(1) : 0;
                const isOver = remaining < 0;
                const displayValue = Math.abs(remaining);
                const labelText = isOver ? 'Overs' : 'Remaining';
                const labelColor = isOver ? 'text-purple-600' : 'text-blue-600';
                const bgColor = isOver ? 'bg-purple-50' : 'bg-blue-50';
                
                modalContent += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50 cursor-pointer transition-colors duration-200" 
                         onclick="event.stopPropagation(); closePODetailsModal(); viewPOSubmissions(${poId}, '${poNumber}', '${line.inventory_item_id}');"
                         title="Click to view submissions for this product">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="font-bold text-lg text-gray-900">${line.line_item_name}</div>
                                    ${line.round_number ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800">Round ${line.round_number}</span>` : ''}
                                </div>
                                <div class="text-sm text-gray-500 font-mono mt-1">ID: ${line.inventory_item_id}</div>
                                
                                <!-- Progress bar -->
                                <div class="mt-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Progress</span>
                                        <span class="font-semibold">${progressPercent}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stats Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1">Ordered</div>
                                    <div class="text-lg font-bold text-gray-900">${line.quantity_ordered.toLocaleString()}</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3">
                                    <div class="text-xs text-green-600 mb-1">Good</div>
                                    <div class="text-lg font-bold text-green-600">${line.good_count.toLocaleString()}</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-3">
                                    <div class="text-xs text-red-600 mb-1">Damaged</div>
                                    <div class="text-lg font-bold text-red-600">${line.damaged_count.toLocaleString()}</div>
                                </div>
                                <div class="${bgColor} rounded-lg p-3">
                                    <div class="text-xs ${labelColor} mb-1">${labelText}</div>
                                    <div class="text-lg font-bold ${labelColor}">${displayValue.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalContent += '</div>';
        }
        
        // Add "View All Submissions" and "View Receives" buttons at the bottom
        modalContent += `
            <div class="mt-6 flex justify-center gap-3 border-t pt-4">
                <button onclick="event.stopPropagation(); closePODetailsModal(); viewPOSubmissions(${poId}, '${poNumber}', null);" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-colors">
                    üìã View All Submissions
                </button>
                <button onclick="event.stopPropagation(); viewPOReceives(${poId}, '${poNumber}');" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-colors">
                    üì¶ View Receives
                </button>
            </div>
        `;
        
        modalContent += `
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.id = 'po-details-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        console.error('Error loading PO details:', error);
        alert('Failed to load PO details: ' + error.message);
    }
}

function closePODetailsModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('po-details-modal');
        if (modal) {
            modal.remove();
        }
    }
}

async function viewPOSubmissions(poId, poName, inventoryItemId = null, typeFilter = null) {
    try {
        const response = await fetch(`/api/po/${poId}/submissions`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error: ' + (data.error || 'Failed to load submissions'));
            return;
        }
        
        // Filter submissions by inventory_item_id if specified
        // This is more reliable than product name matching since names can differ between Zoho and submissions
        let filteredSubmissions = inventoryItemId 
            ? data.submissions.filter(sub => sub.inventory_item_id === inventoryItemId)
            : data.submissions;
        
        // Store original submissions for filtering
        const allSubmissions = [...filteredSubmissions];
        
        // Apply type filter if specified
        if (typeFilter === 'machine') {
            filteredSubmissions = filteredSubmissions.filter(sub => (sub.submission_type || 'packaged') === 'machine');
        } else if (typeFilter === 'packaged_bag') {
            filteredSubmissions = filteredSubmissions.filter(sub => {
                const subType = sub.submission_type || 'packaged';
                return subType === 'packaged' || subType === 'bag';
            });
        }
        // typeFilter === 'all' or null shows all submissions
        
        
        // Get product name for display from first submission or from filtered list
        const displayProductName = filteredSubmissions.length > 0 ? filteredSubmissions[0].product_name : '';
        
        // Calculate totals for the filtered submissions (when viewing a specific product)
        // Use data.totals from API if available, otherwise calculate from filtered submissions
        let totals = null;
        if (data.totals) {
            totals = data.totals;
        } else if (inventoryItemId && filteredSubmissions.length > 0) {
            totals = {
                displays_made: 0,
                packs_remaining: 0,
                loose_tablets: 0,
                damaged_tablets: 0,
                total_tablets: 0
            };
            
            filteredSubmissions.forEach(sub => {
                totals.displays_made += sub.displays_made || 0;
                totals.packs_remaining += sub.packs_remaining || 0;
                totals.loose_tablets += sub.loose_tablets || 0;
                totals.damaged_tablets += sub.damaged_tablets || 0;
                totals.total_tablets += sub.total_tablets || 0;
            });
        }
        
        // Build modal content
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeSubmissionsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            ${inventoryItemId ? `
                                <button onclick="closeSubmissionsModal(); viewPODetailsModal(${poId}, '${data.po.po_number}');" 
                                        class="text-white hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                                        title="Back to PO details">
                                    ‚Üê Back
                                </button>
                            ` : '<div></div>'}
                            <div class="flex-1 text-center">
                                <h3 class="text-xl font-bold">üìã Submissions for ${data.po.po_number}</h3>
                                ${displayProductName ? `<p class="text-sm text-blue-100 mt-1">üì¶ Product: ${displayProductName}</p>` : ''}
                                <p class="text-sm text-blue-100 mt-1">
                                    ${filteredSubmissions.length} submission(s) total
                                </p>
                                ${data.totals ? `
                                    <div class="mt-2 flex justify-center gap-4 flex-wrap">
                                        <button onclick="filterSubmissionsInModal('machine')" 
                                                class="bg-blue-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ${typeFilter === 'machine' ? 'ring-2 ring-blue-300' : ''}">
                                            <span class="text-xs text-blue-200">‚öôÔ∏è Machine:</span>
                                            <span class="text-sm font-semibold text-white ml-1">${data.totals.machine.toLocaleString()}</span>
                                        </button>
                                        <button onclick="filterSubmissionsInModal('packaged_bag')" 
                                                class="bg-purple-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ${typeFilter === 'packaged_bag' ? 'ring-2 ring-purple-300' : ''}">
                                            <span class="text-xs text-purple-200">üì¶ Packaged+Bag:</span>
                                            <span class="text-sm font-semibold text-white ml-1">${data.totals.packaged_bag.toLocaleString()}</span>
                                        </button>
                                        <button onclick="filterSubmissionsInModal('all')" 
                                                class="bg-green-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ${!typeFilter || typeFilter === 'all' ? 'ring-2 ring-green-300' : ''}">
                                            <span class="text-xs text-green-200">üìä Total:</span>
                                            <span class="text-sm font-semibold text-white ml-1">${data.totals.total.toLocaleString()}</span>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="closeSubmissionsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
        `;
        
        if (filteredSubmissions.length === 0) {
            modalContent += `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p class="text-lg">No submissions found${inventoryItemId ? ' for this product' : ''}</p>
                </div>
            `;
        } else {
            modalContent += '<div class="space-y-4">';
            
            filteredSubmissions.forEach(sub => {
                // Parse dates - if they're date-only strings (YYYY-MM-DD), treat as local date
                // If they're datetime strings, parse them properly
                let submissionDateStr = sub.submission_date || sub.created_at;
                let createdDateStr = sub.created_at;
                
                // Format dates in EST/EDT timezone
                const formatDateEST = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    // If it's just a date (YYYY-MM-DD), format it directly without timezone conversion
                    // This avoids timezone issues since it's a date-only field
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateStr.split('-');
                        return `${month}/${day}/${year}`;
                    }
                    // If it's a datetime string, parse it and convert to EST
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return 'N/A';
                    return date.toLocaleDateString('en-US', { timeZone: 'America/New_York', month: '2-digit', day: '2-digit', year: 'numeric' });
                };
                
                const formatDateTimeEST = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    // Parse datetime and convert to EST/EDT timezone
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return 'N/A';
                    return date.toLocaleString('en-US', { timeZone: 'America/New_York', month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                };
                
                // Check if user is admin for edit functionality
                const isAdmin = {% if session.get('employee_role') == 'admin' or session.get('admin_authenticated') %}true{% else %}false{% endif %};
                const clickHandler = isAdmin ? `onclick="openEditSubmissionFromPO(${sub.id}, ${poId}, '${inventoryItemId || ''}')"` : '';
                const cursorClass = isAdmin ? 'cursor-pointer' : '';
                const editHint = isAdmin ? '<div class="text-xs text-purple-600 mt-2 flex items-center gap-1"><span>‚úèÔ∏è</span> <span>Click to edit (Admin)</span></div>' : '';
                
                // Determine submission type badge
                const submissionType = sub.submission_type || 'packaged';
                let typeBadge = '';
                if (submissionType === 'machine') {
                    typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">‚öôÔ∏è Machine</span>';
                } else if (submissionType === 'bag') {
                    typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">üìã Bag Count</span>';
                } else {
                    typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">üì¶ Packaged</span>';
                }
                
                modalContent += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors ${cursorClass}" ${clickHandler}>
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-medium text-gray-900">${sub.product_name}</h4>
                                    ${typeBadge}
                                </div>
                                <p class="text-sm text-gray-600">üë§ ${sub.employee_name || 'Unknown'} ‚Ä¢ üì¶ Bag: ${sub.box_number || ''}/${sub.bag_number || ''}</p>
                            </div>
                            <div class="text-right text-sm">
                                <div class="text-gray-600">üìÖ ${formatDateEST(submissionDateStr)}</div>
                                <div class="text-xs text-gray-400">Created: ${formatDateTimeEST(createdDateStr)}</div>
                            </div>
                        </div>
                        
                        <!-- Running Total and Bag Check (only for packaged/bag submissions) -->
                        ${submissionType !== 'machine' ? `
                        <div class="mb-3 flex gap-2 items-center flex-wrap">
                            <div class="inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
                                <span class="font-semibold text-sm">Running: ${(sub.running_total || 0).toLocaleString()}</span>
                            </div>
                            ${sub.bag_label_count ? `
                                <div class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full">
                                    <span class="font-semibold text-sm">Bag: ${(sub.bag_label_count || 0).toLocaleString()}</span>
                                </div>
                                ${sub.count_status === 'match' ? '<span class="text-green-600 font-bold text-sm">‚úì Match</span>' : ''}
                                ${sub.count_status === 'under' ? '<span class="text-yellow-600 font-bold text-sm">‚ö†Ô∏è Under</span>' : ''}
                                ${sub.count_status === 'over' ? '<span class="text-red-600 font-bold text-sm">‚ùå Over</span>' : ''}
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-3 rounded">
                            <div>
                                <div class="text-xs text-gray-500">Displays Made</div>
                                <div class="font-medium text-blue-600">${sub.displays_made || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Cards Remaining</div>
                                <div class="font-medium text-blue-600">${sub.packs_remaining || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Loose Tablets</div>
                                <div class="font-medium text-blue-600">${sub.loose_tablets || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Damaged Tablets</div>
                                <div class="font-medium text-red-600">${sub.damaged_tablets || 0}</div>
                            </div>
                        </div>
                        
                        <!-- Submission Total -->
                        <div class="mt-3 flex justify-center">
                            <div class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full">
                                <span class="font-semibold text-base">Total: ${(sub.total_tablets || 0).toLocaleString()} tablets</span>
                            </div>
                        </div>
                        
                        <!-- PO Assignment Info -->
                        ${sub.assigned_po_id ? `
                        <div class="mt-3 flex items-center justify-center gap-2 flex-wrap">
                            <span class="text-xs text-gray-600">PO: ${sub.po_number || 'N/A'}</span>
                                ${sub.po_verified ? `
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-600 text-white">‚úì Verified</span>
                                ${isAdmin ? `
                                    <button onclick="event.stopPropagation(); event.preventDefault(); openAdminReassignModal(${sub.id}, '${(sub.po_number || 'N/A').replace(/'/g, "\\'")}', '${(sub.product_name || '').replace(/'/g, "\\'")}')" 
                                            class="text-xs text-orange-600 hover:text-orange-800 underline cursor-pointer"
                                            title="Change PO assignment (Admin override - verified submissions)">
                                        üîß Change PO (Admin)
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        ${sub.admin_notes ? `
                        <!-- Admin Notes -->
                        <div class="mt-3 bg-purple-50 border border-purple-200 rounded-md p-3">
                            <div class="text-xs font-medium text-purple-800 mb-1">üîí Admin Notes</div>
                            <div class="text-sm text-gray-700 whitespace-pre-wrap">${sub.admin_notes}</div>
                        </div>
                        ` : ''}
                        ${editHint}
                    </div>
                `;
            });
            
            modalContent += '</div>';
        }
        
        // Add "View All Submissions" button if viewing filtered results
        if (inventoryItemId && data.submissions.length > filteredSubmissions.length) {
            modalContent += `
                <div class="mt-6 flex justify-center border-t pt-4">
                    <button onclick="closeSubmissionsModal(); viewPOSubmissions(${poId}, '${poName}', null);" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow-lg transition-colors">
                        üìã View All Submissions for this PO (${data.submissions.length} total)
                    </button>
                </div>
            `;
        }
        
        modalContent += `
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.id = 'submissions-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
        // Store data for filtering
        window.currentSubmissionsData = {
            allSubmissions: allSubmissions,
            filteredSubmissions: filteredSubmissions,
            poId: poId,
            poName: data.po.po_number,
            inventoryItemId: inventoryItemId,
            totals: data.totals,
            displayProductName: displayProductName
        };
        
    } catch (error) {
        console.error('Error loading submissions:', error);
        alert('Failed to load submissions: ' + error.message);
    }
}

function closeSubmissionsModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('submissions-modal');
        if (modal) {
            modal.remove();
        }
        window.currentSubmissionsData = null;
    }
}

function filterSubmissionsInModal(filterType) {
    if (!window.currentSubmissionsData) {
        return;
    }
    
    const data = window.currentSubmissionsData;
    let filtered = [...data.allSubmissions];
    
    // Apply filter
    if (filterType === 'machine') {
        filtered = filtered.filter(sub => (sub.submission_type || 'packaged') === 'machine');
    } else if (filterType === 'packaged_bag') {
        filtered = filtered.filter(sub => {
            const subType = sub.submission_type || 'packaged';
            return subType === 'packaged' || subType === 'bag';
        });
    }
    // 'all' shows all submissions
    
    // Update submission count
    const countElement = document.querySelector('#submissions-modal .text-blue-100');
    if (countElement && countElement.textContent.includes('submission(s) total')) {
        countElement.textContent = `${filtered.length} submission(s) total`;
    }
    
    // Rebuild submission cards
    const contentArea = document.querySelector('#submissions-modal .overflow-y-auto');
    if (!contentArea) return;
    
    if (filtered.length === 0) {
        contentArea.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4">üì≠</div>
                <p class="text-lg">No submissions found for this filter</p>
            </div>
        `;
        return;
    }
    
    let submissionsHTML = '<div class="space-y-4">';
    
    filtered.forEach(sub => {
        const submissionDateStr = sub.submission_date || sub.created_at;
        const createdDateStr = sub.created_at;
        
        const formatDateEST = (dateStr) => {
            if (!dateStr) return 'N/A';
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [year, month, day] = dateStr.split('-');
                return `${month}/${day}/${year}`;
            }
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleDateString('en-US', { timeZone: 'America/New_York', month: '2-digit', day: '2-digit', year: 'numeric' });
        };
        
        const formatDateTimeEST = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleString('en-US', { timeZone: 'America/New_York', month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
        };
        
        const isAdmin = {% if session.get('employee_role') == 'admin' or session.get('admin_authenticated') %}true{% else %}false{% endif %};
        const clickHandler = isAdmin ? `onclick="openEditSubmissionFromPO(${sub.id}, ${data.poId}, '${data.inventoryItemId || ''}')"` : '';
        const cursorClass = isAdmin ? 'cursor-pointer' : '';
        const editHint = isAdmin ? '<div class="text-xs text-purple-600 mt-2 flex items-center gap-1"><span>‚úèÔ∏è</span> <span>Click to edit (Admin)</span></div>' : '';
        
        const submissionType = sub.submission_type || 'packaged';
        let typeBadge = '';
        if (submissionType === 'machine') {
            typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">‚öôÔ∏è Machine</span>';
        } else if (submissionType === 'bag') {
            typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">üìã Bag Count</span>';
        } else {
            typeBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">üì¶ Packaged</span>';
        }
        
        submissionsHTML += `
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors ${cursorClass}" ${clickHandler}>
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h4 class="font-medium text-gray-900">${sub.product_name}</h4>
                            ${typeBadge}
                        </div>
                        <p class="text-sm text-gray-600">üë§ ${sub.employee_name || 'Unknown'} ‚Ä¢ üì¶ Bag: ${sub.box_number || ''}/${sub.bag_number || ''}</p>
                    </div>
                    <div class="text-right text-sm">
                        <div class="text-gray-600">üìÖ ${formatDateEST(submissionDateStr)}</div>
                        <div class="text-xs text-gray-400">Created: ${formatDateTimeEST(createdDateStr)}</div>
                    </div>
                </div>
                
                ${submissionType !== 'machine' ? `
                <div class="mb-3 flex gap-2 items-center flex-wrap">
                    <div class="inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
                        <span class="font-semibold text-sm">Running: ${(sub.running_total || 0).toLocaleString()}</span>
                    </div>
                    ${sub.bag_label_count ? `
                        <div class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full">
                            <span class="font-semibold text-sm">Bag: ${(sub.bag_label_count || 0).toLocaleString()}</span>
                        </div>
                        ${sub.count_status === 'match' ? '<span class="text-green-600 font-bold text-sm">‚úì Match</span>' : ''}
                        ${sub.count_status === 'under' ? '<span class="text-yellow-600 font-bold text-sm">‚ö†Ô∏è Under</span>' : ''}
                        ${sub.count_status === 'over' ? '<span class="text-red-600 font-bold text-sm">‚ùå Over</span>' : ''}
                    ` : ''}
                </div>
                ` : ''}
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-3 rounded">
                    <div>
                        <div class="text-xs text-gray-500">Displays Made</div>
                        <div class="font-medium text-blue-600">${sub.displays_made || 0}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Cards Remaining</div>
                        <div class="font-medium text-blue-600">${sub.packs_remaining || 0}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Loose Tablets</div>
                        <div class="font-medium text-blue-600">${sub.loose_tablets || 0}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Damaged Tablets</div>
                        <div class="font-medium text-red-600">${sub.damaged_tablets || 0}</div>
                    </div>
                </div>
                
                <div class="mt-3 flex justify-center">
                    <div class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full">
                        <span class="font-semibold text-base">Total: ${(sub.total_tablets || 0).toLocaleString()} tablets</span>
                    </div>
                </div>
                
                ${sub.assigned_po_id ? `
                <div class="mt-3 flex items-center justify-center gap-2 flex-wrap">
                    <span class="text-xs text-gray-600">PO: ${sub.po_number || 'N/A'}</span>
                    ${sub.po_verified ? `
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-600 text-white">‚úì Verified</span>
                        ${isAdmin ? `
                            <button onclick="event.stopPropagation(); event.preventDefault(); openAdminReassignModal(${sub.id}, '${(sub.po_number || 'N/A').replace(/'/g, "\\'")}', '${(sub.product_name || '').replace(/'/g, "\\'")}')" 
                                    class="text-xs text-orange-600 hover:text-orange-800 underline cursor-pointer"
                                    title="Change PO assignment (Admin override - verified submissions)">
                                üîß Change PO (Admin)
                            </button>
                        ` : ''}
                    ` : ''}
                </div>
                ` : ''}
                
                ${sub.admin_notes ? `
                <div class="mt-3 bg-purple-50 border border-purple-200 rounded-md p-3">
                    <div class="text-xs font-medium text-purple-800 mb-1">üîí Admin Notes</div>
                    <div class="text-sm text-gray-700 whitespace-pre-wrap">${sub.admin_notes}</div>
                </div>
                ` : ''}
                ${editHint}
            </div>
        `;
    });
    
    submissionsHTML += '</div>';
    contentArea.innerHTML = submissionsHTML;
    
    // Update filter button states
    const buttons = document.querySelectorAll('#submissions-modal button[onclick^="filterSubmissionsInModal"]');
    buttons.forEach(btn => {
        const onclick = btn.getAttribute('onclick');
        if (onclick.includes("'machine'")) {
            btn.className = filterType === 'machine' 
                ? 'bg-blue-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ring-2 ring-blue-300'
                : 'bg-blue-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all';
        } else if (onclick.includes("'packaged_bag'")) {
            btn.className = filterType === 'packaged_bag'
                ? 'bg-purple-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ring-2 ring-purple-300'
                : 'bg-purple-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all';
        } else if (onclick.includes("'all'")) {
            btn.className = filterType === 'all' || !filterType
                ? 'bg-green-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ring-2 ring-green-300'
                : 'bg-green-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all';
        }
    });
}

async function deletePO(poId, poNumber) {
    if (!confirm(`‚ö†Ô∏è WARNING: Delete ${poNumber}?\n\nThis will:\n- Delete the PO and all its line items\n- Unassign all submissions (submissions won't be deleted)\n- Delete related shipments\n\nThis action cannot be undone. Continue?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/po/${poId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message + '\n\nRefreshing page...');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Failed to delete PO'));
        }
    } catch (error) {
        console.error('Error deleting PO:', error);
        alert('Failed to delete PO: ' + error.message);
    }
}

async function showOversPOCreationInfo(poId, poNumber) {
    try {
        const response = await fetch(`/api/create_overs_po_info/${poId}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error: ' + (data.error || 'Failed to get overs PO info'));
            return;
        }
        
        // Create modal with overs PO creation info
        const modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeOversPOModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold">üìã Create Overs PO for ${data.parent_po_number}</h3>
                                <p class="text-sm text-purple-100 mt-1">Total Overs: ${data.total_overs.toLocaleString()} tablets</p>
                            </div>
                            <button onclick="closeOversPOModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
                            <h4 class="font-semibold text-blue-900 mb-2">üìù Instructions:</h4>
                            <p class="text-sm text-blue-800">${data.instructions}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-900 mb-3">Overs PO Details:</h4>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-700">Overs PO Number:</span>
                                    <span class="font-bold text-purple-600">${data.overs_po_number}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-700">Tablet Type:</span>
                                    <span class="text-gray-900">${data.tablet_type || 'Same as parent'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-700">Total Overs Quantity:</span>
                                    <span class="font-bold text-purple-600">${data.total_overs.toLocaleString()} tablets</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-900 mb-3">Line Items for Overs PO:</h4>
                            <div class="space-y-2">
                                ${data.line_items.map(item => `
                                    <div class="border border-gray-200 rounded-lg p-3 bg-purple-50">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-medium text-gray-900">${item.line_item_name}</div>
                                                <div class="text-xs text-gray-500 mt-1">Inventory ID: ${item.inventory_item_id}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm text-gray-600">Overs: <span class="font-bold text-purple-600">${item.overs_quantity.toLocaleString()}</span></div>
                                                <div class="text-xs text-gray-500">Original: ${item.original_ordered.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-4">
                            <p class="text-sm text-yellow-800">
                                <strong>Note:</strong> After creating the overs PO in Zoho, click "SYNC ZOHO POs" in the Admin Panel > System Tools to import it into the app.
                            </p>
                        </div>
                        
                        <div class="flex justify-end gap-2">
                            <button onclick="closeOversPOModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                Close
                            </button>
                            <button onclick="copyOversPOInfo('${data.overs_po_number}', '${JSON.stringify(data).replace(/'/g, "\\'")}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                üìã Copy Details (Manual)
                            </button>
                            <button onclick="createOversPOInZoho(${poId}, '${data.overs_po_number}')" 
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                                ‚ú® Create in Zoho
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add to modal container
        const modalContainer = document.getElementById('po-details-modal-container') || document.body;
        const oversModal = document.createElement('div');
        oversModal.id = 'overs-po-modal';
        oversModal.innerHTML = modalContent;
        modalContainer.appendChild(oversModal);
        
    } catch (error) {
        console.error('Error getting overs PO info:', error);
        alert('Failed to get overs PO information: ' + error.message);
    }
}

function closeOversPOModal(event) {
    if (event && event.target !== event.currentTarget) {
        return;
    }
    const modal = document.getElementById('overs-po-modal');
    if (modal) {
        modal.remove();
    }
}

function copyOversPOInfo(oversPONumber, dataJson) {
    try {
        const data = JSON.parse(dataJson);
        const textToCopy = `Overs PO Number: ${oversPONumber}
Tablet Type: ${data.tablet_type}
Total Overs: ${data.total_overs.toLocaleString()} tablets

Line Items:
${data.line_items.map(item => `- ${item.line_item_name} (ID: ${item.inventory_item_id}): ${item.overs_quantity.toLocaleString()} tablets`).join('\\n')}

Instructions: Create this PO in Zoho and mark it with the tablets custom field, then sync POs.`;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            alert('Overs PO details copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        });
    } catch (error) {
        console.error('Error parsing data:', error);
        alert('Failed to copy details');
    }
}

async function createOversPOInZoho(poId, oversPONumber) {
    if (!confirm(`Create overs PO "${oversPONumber}" in Zoho?\n\nThis will create a draft PO in Zoho with the overs quantities. You can review and issue it from Zoho.`)) {
        return;
    }
    
    try {
        alert('Creating overs PO in Zoho...');
        
        const response = await fetch(`/api/create_overs_po/${poId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message + ' You can now sync POs to import it into the app.');
            closeOversPOModal();
            // Optionally reload or refresh
            setTimeout(() => {
                if (confirm('Would you like to sync POs now to import the newly created overs PO?')) {
                    location.reload(); // Refresh to show sync option
                }
            }, 2000);
        } else {
            alert('Error: ' + (result.error || 'Failed to create overs PO in Zoho'));
        }
    } catch (error) {
        console.error('Error creating overs PO:', error);
        alert('Failed to create overs PO: ' + error.message);
    }
}

// Use shared edit modal from submissions.html - just provide wrapper function
async function openEditSubmissionFromPO(submissionId, poId, inventoryItemId) {
    // Check if user is admin or manager (admins and managers can edit)
    const canEdit = {% if session.get('employee_role') in ['admin', 'manager'] or session.get('admin_authenticated') %}true{% else %}false{% endif %};
    
    if (!canEdit) {
        alert('Only administrators and managers can edit submissions.');
        return;
    }
    
    // Use the shared modal function from submissions.html
    if (typeof openEditSubmissionModal === 'function') {
        await openEditSubmissionModal(submissionId, poId, inventoryItemId);
    } else {
        alert('Edit functionality not available. Please refresh the page.');
    }
}

async function viewPOReceives(poId, poNumber) {
    try {
        const response = await fetch(`/api/po/${poId}/receives`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error: ' + (data.error || 'Failed to load receives'));
            return;
        }
        
        const receives = data.receives || [];
        
        // Calculate totals
        let totalReceived = 0;
        const totalsByTablet = {};
        
        receives.forEach(receiveData => {
            receiveData.boxes.forEach(boxData => {
                boxData.bags.forEach(bag => {
                    const count = parseInt(bag.bag_label_count || 0);
                    totalReceived += count;
                    
                    const tabletName = bag.tablet_type_name || 'Unknown Type';
                    if (!totalsByTablet[tabletName]) {
                        totalsByTablet[tabletName] = 0;
                    }
                    totalsByTablet[tabletName] += count;
                });
            });
        });
        
        // Build modal content
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeReceivesModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div class="flex-1 text-center">
                                <h3 class="text-xl font-bold">üì¶ Receives for ${poNumber}</h3>
                                <p class="text-sm text-green-100 mt-1">
                                    ${receives.length} shipment${receives.length !== 1 ? 's' : ''} received
                                </p>
                            </div>
                            <button onclick="closeReceivesModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
        `;
        
        // Add totals section if there are receives
        if (receives.length > 0) {
            modalContent += `
                <!-- Totals Section -->
                <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <span class="mr-2">üìä</span>
                        Total Received Counts
                    </h4>
                    
                    <!-- Overall Total -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-blue-200">
                            <span class="font-medium text-gray-700">Total Received:</span>
                            <span class="text-2xl font-bold text-blue-600">${totalReceived.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <!-- Totals by Tablet Type -->
                    <div>
                        <h5 class="text-sm font-semibold text-gray-700 mb-2">By Tablet Type:</h5>
                        <div class="space-y-2">
            `;
            
            // Sort tablet types by count (descending)
            const sortedTablets = Object.entries(totalsByTablet).sort((a, b) => b[1] - a[1]);
            
            sortedTablets.forEach(([tabletName, count]) => {
                modalContent += `
                    <div class="flex items-center justify-between bg-white rounded-lg p-2 border border-gray-200">
                        <span class="text-sm text-gray-600">${tabletName}:</span>
                        <span class="font-semibold text-gray-900">${count.toLocaleString()}</span>
                    </div>
                `;
            });
            
            modalContent += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (receives.length === 0) {
            modalContent += `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p class="text-lg">No receives found for this PO</p>
                </div>
            `;
        } else {
            modalContent += '<div class="space-y-4">';
            
            receives.forEach((receiveData, idx) => {
                const rec = receiveData.receiving;
                const receivedDate = rec.received_date ? new Date(rec.received_date).toLocaleString('en-US', { 
                    timeZone: 'America/New_York', 
                    month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                }) + ' EST' : 'Unknown';
                
                modalContent += `
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 mb-1">
                                    Shipment ${idx + 1}
                                </h4>
                                <p class="text-sm text-gray-600">
                                    Received on ${receivedDate}
                                    ${rec.received_by ? ` by ${rec.received_by}` : ''}
                                </p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">
                                    ${rec.box_count || 0} Box${(rec.box_count || 0) !== 1 ? 'es' : ''}
                                </div>
                                <div class="text-sm text-gray-600">
                                    ${rec.total_bags || 0} Bag${(rec.total_bags || 0) !== 1 ? 's' : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Boxes -->
                        <div class="space-y-3 mt-4">
                `;
                
                receiveData.boxes.forEach(boxData => {
                    const box = boxData.box;
                    modalContent += `
                        <div class="border border-gray-200 rounded-lg p-3 bg-white">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-gray-900">Box ${box.box_number}</h5>
                                <span class="text-sm text-gray-600">${box.bag_count} bag${box.bag_count !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mt-2">
                    `;
                    
                    boxData.bags.forEach(bag => {
                        modalContent += `
                            <div class="bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                                <div class="font-medium text-gray-700">Bag ${bag.bag_number}</div>
                                <div class="text-gray-600">
                                    ${bag.tablet_type_name || 'Unknown Type'}
                                </div>
                                <div class="text-gray-600">Count: ${bag.bag_label_count || 0}</div>
                            </div>
                        `;
                    });
                    
                    modalContent += `
                            </div>
                        </div>
                    `;
                });
                
                modalContent += `
                        </div>
                    </div>
                `;
            });
            
            modalContent += '</div>';
        }
        
        modalContent += `
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.id = 'receives-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        console.error('Error loading receives:', error);
        alert('Failed to load receives: ' + error.message);
    }
}

function closeReceivesModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('receives-modal');
        if (modal) {
            modal.remove();
        }
    }
}

// Admin reassign functions for verified submissions
let adminReassignSubmissionId = null;

async function openAdminReassignModal(submissionId, currentPO, productName) {
    adminReassignSubmissionId = submissionId;
    
    // Check if modal exists, if not create it
    let modal = document.getElementById('admin-reassign-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'admin-reassign-modal';
        modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.onclick = closeAdminReassignModal;
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold">‚ö†Ô∏è Admin Override: Reassign Verified Submission</h3>
                            <p class="text-sm text-orange-100 mt-1" id="admin-reassign-modal-subtitle"></p>
                        </div>
                        <button onclick="closeAdminReassignModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                            ‚úï
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="admin-reassign-confirm-section" class="mb-4 bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <p class="text-sm text-red-800 mb-3">
                            <strong>‚ö†Ô∏è ADMIN OVERRIDE WARNING:</strong> This submission has been verified and locked. 
                            Changing the PO assignment requires admin override confirmation.
                        </p>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="admin-reassign-confirm-checkbox" class="w-4 h-4">
                            <label for="admin-reassign-confirm-checkbox" class="text-sm text-red-800 font-medium">
                                I understand this is an admin override and will update counts on both POs
                            </label>
                        </div>
                    </div>
                    <div id="admin-reassign-pos-section" class="hidden">
                        <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                            <p class="text-sm text-yellow-800">
                                <strong>Current PO:</strong> <span id="admin-reassign-current-po"></span>
                            </p>
                        </div>
                        <div id="admin-reassign-pos-list" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- PO list will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Wait for DOM to be ready, then access elements
    setTimeout(() => {
        const subtitleEl = document.getElementById('admin-reassign-modal-subtitle');
        const currentPOEl = document.getElementById('admin-reassign-current-po');
        const checkboxEl = document.getElementById('admin-reassign-confirm-checkbox');
        const confirmSectionEl = document.getElementById('admin-reassign-confirm-section');
        const posSectionEl = document.getElementById('admin-reassign-pos-section');
        
        if (!subtitleEl || !currentPOEl || !checkboxEl || !confirmSectionEl || !posSectionEl) {
            console.error('Admin reassign modal elements not found');
            alert('Error: Could not initialize admin reassign modal. Please refresh the page.');
            return;
        }
        
        const currentText = currentPO ? `Current: ${currentPO}` : 'Currently Unassigned';
        subtitleEl.textContent = `Product: ${productName} | ${currentText}`;
        currentPOEl.textContent = currentPO || 'Unassigned';
        checkboxEl.checked = false;
        confirmSectionEl.classList.remove('hidden');
        posSectionEl.classList.add('hidden');
        modal.classList.remove('hidden');
        
        // Watch for checkbox change
        checkboxEl.onchange = function() {
            if (this.checked) {
                loadAdminReassignPOs(submissionId, productName);
            } else {
                posSectionEl.classList.add('hidden');
            }
        };
    }, 10);
}

async function loadAdminReassignPOs(submissionId, productName) {
    try {
        const response = await fetch(`/api/submission/${submissionId}/available_pos`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error: ' + (data.error || 'Failed to load available POs'));
            return;
        }
        
        document.getElementById('admin-reassign-pos-section').classList.remove('hidden');
        const posList = document.getElementById('admin-reassign-pos-list');
        posList.innerHTML = '';
        
        if (data.available_pos.length === 0) {
            posList.innerHTML = '<div class="text-center py-8 text-gray-500"><p>No POs found for this product</p></div>';
            return;
        }
        
        data.available_pos.forEach(po => {
            const isCurrent = po.id === data.current_po_id;
            const statusColor = po.closed ? 'bg-gray-100 text-gray-700' : 'bg-green-100 text-green-700';
            const statusLabel = po.closed ? 'üîí Closed' : '‚úì Open';
            
            const poDiv = document.createElement('div');
            poDiv.className = `border rounded-lg p-4 hover:bg-orange-50 cursor-pointer transition-colors ${isCurrent ? 'border-orange-500 bg-orange-50' : 'border-gray-300'}`;
            poDiv.onclick = () => adminReassignSubmission(submissionId, po.id, po.po_number);
            
            poDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-bold text-lg text-gray-900">${po.po_number}</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusColor}">
                                ${statusLabel}
                            </span>
                            ${isCurrent ? '<span class="text-xs text-orange-600 font-bold">CURRENT</span>' : ''}
                        </div>
                        <div class="grid grid-cols-4 gap-3 text-sm">
                            <div>
                                <div class="text-xs text-gray-500">Ordered</div>
                                <div class="font-medium">${po.ordered.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-green-600">Good</div>
                                <div class="font-medium text-green-600">${po.good.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-red-600">Damaged</div>
                                <div class="font-medium text-red-600">${po.damaged.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-blue-600">Remaining</div>
                                <div class="font-medium text-blue-600">${po.remaining.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    ${!isCurrent ? '<div class="text-2xl text-orange-600">‚Üí</div>' : ''}
                </div>
            `;
            posList.appendChild(poDiv);
        });
    } catch (error) {
        console.error('Error loading available POs:', error);
        alert('Failed to load available POs: ' + error.message);
    }
}

function closeAdminReassignModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('admin-reassign-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        adminReassignSubmissionId = null;
    }
}

async function adminReassignSubmission(submissionId, newPoId, newPoNumber) {
    if (!confirm(`‚ö†Ô∏è ADMIN OVERRIDE CONFIRMATION\n\nAre you sure you want to change this VERIFIED submission from its current PO to ${newPoNumber}?\n\nThis will:\n- Update counts on both POs\n- Keep the submission verified\n- Require admin override confirmation\n\nThis action cannot be easily undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/submission/${submissionId}/admin_reassign`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                new_po_id: newPoId,
                confirm_override: true
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message || 'Submission reassigned successfully!');
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Error: ' + (data.error || 'Failed to reassign submission'));
        }
    } catch (error) {
        console.error('Error reassigning submission:', error);
        alert('Failed to reassign submission: ' + error.message);
    }
}
</script>
{% endblock %}

