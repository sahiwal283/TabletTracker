{% extends "base.html" %}

{% block title %}Shipments Received{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">
            <svg class="inline w-7 h-7 mr-2 align-[-4px]" aria-hidden="true"><use href="#icon-box" /></svg> 
            Shipments Received
        </h1>
        <p class="text-gray-600 mt-2">Record shipments that arrive</p>
    </div>

    <!-- Action Button -->
    <div class="mb-4 flex justify-end">
        <button onclick="openAddReceivesModal()" 
                class="btn-primary px-4 py-2 flex items-center">
            <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-plus" /></svg>
            Add Receives
        </button>
    </div>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button onclick="switchReceivingTab('active')" 
                    id="tab-active"
                    class="tab-btn border-b-2 border-blue-500 text-blue-600 py-4 px-1 text-sm font-medium">
                Active POs
            </button>
            <button onclick="switchReceivingTab('closed')" 
                    id="tab-closed"
                    class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                Closed POs
            </button>
        </nav>
    </div>

    <!-- Main Content -->
    {% if grouped_shipments or shipments_without_po %}
    <!-- Active POs Tab Content -->
    <div id="content-active" class="tab-content space-y-6">
        {% for po_group in grouped_shipments %}
        {% if not po_group.po_closed %}
        <!-- PO Group Header -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 px-4 py-3 mb-2">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">
                    üìã {{ po_group.po_number }}
                    <span class="text-sm font-normal text-gray-600 ml-2">({{ po_group.receives|length }} receive{{ 's' if po_group.receives|length != 1 else '' }})</span>
                </h2>
                <button onclick="togglePOCollapse('po-{{ po_group.po_number }}')" 
                        class="text-gray-600 hover:text-gray-900 transition-colors"
                        aria-label="Toggle collapse">
                    <svg id="icon-po-{{ po_group.po_number }}" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Receives for this PO (oldest at bottom) -->
        <div id="po-{{ po_group.po_number }}" class="space-y-4 ml-4 hidden">
        {% for shipment in po_group.receives %}
        <div class="card cursor-pointer hover:shadow-lg transition-shadow" onclick="viewReceiveDetails({{ shipment.receiving.id }}, '{{ shipment.receiving.po_number }}-{{ shipment.receiving.shipment_number if shipment.receiving.shipment_number else '' }}')">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <button onclick="event.stopPropagation(); toggleShipmentCollapse('shipment-{{ shipment.receiving.id }}')" 
                                    class="text-gray-600 hover:text-gray-900 transition-colors mr-2"
                                    aria-label="Toggle shipment collapse">
                                <svg id="icon-shipment-{{ shipment.receiving.id }}" class="w-5 h-5 transform transition-transform {% if shipment.receiving.closed %}rotate-0{% else %}rotate-180{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <h3 class="text-lg font-semibold text-gray-900">
                                {% if shipment.receiving.po_number %}
                                    {% if shipment.receiving.shipment_number %}
                                        {{ shipment.receiving.po_number }}-{{ shipment.receiving.shipment_number }}
                                    {% else %}
                                        {{ shipment.receiving.po_number }}
                                    {% endif %}
                                {% else %}
                                    Shipment Received
                                {% endif %}
                            </h3>
                            {% if shipment.receiving.status == 'draft' %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-yellow-200 text-yellow-800">
                                üìù DRAFT
                            </span>
                            {% elif shipment.receiving.closed %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-gray-200 text-gray-700">
                                üîí CLOSED
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-green-200 text-green-800">
                                ‚úì LIVE
                            </span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-600">
                            Received on {{ (shipment.receiving.received_date|to_est)[:10] if shipment.receiving.received_date else 'Unknown' }} at {{ (shipment.receiving.received_date|to_est)[11:19] if shipment.receiving.received_date else '' }} EST
                            {% if shipment.receiving.received_by %}
                            by {{ shipment.receiving.received_by }}
                            {% endif %}
                        </p>
                        {% if not shipment.receiving.po_number and user_role in ['manager', 'admin'] %}
                        <p class="text-sm text-gray-500 italic mt-1">No PO assigned</p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.box_count or 0 }} Box{{ 'es' if (shipment.receiving.box_count or 0) != 1 else '' }}
                        </div>
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.total_bags or 0 }} Bag{{ 's' if (shipment.receiving.total_bags or 0) != 1 else '' }}
                        </div>
                        {% if user_role in ['manager', 'admin'] %}
                        <div class="mt-2 space-x-2">
                            {% if shipment.receiving.status == 'draft' %}
                            <button onclick="event.stopPropagation(); editReceive({{ shipment.receiving.id }})" 
                                    class="text-xs text-blue-600 hover:text-blue-800 underline font-semibold">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="event.stopPropagation(); publishReceive({{ shipment.receiving.id }})" 
                                    class="text-xs text-green-600 hover:text-green-800 underline font-semibold">
                                ‚úì Publish (Make Live)
                            </button>
                            {% elif shipment.receiving.status == 'published' and not shipment.receiving.closed %}
                            <button onclick="event.stopPropagation(); unpublishReceive({{ shipment.receiving.id }})" 
                                    class="text-xs text-yellow-600 hover:text-yellow-800 underline">
                                üìù Move to Draft
                            </button>
                            {% endif %}
                            <button onclick="event.stopPropagation(); openAssignPOModal({{ shipment.receiving.id }}, {{ shipment.receiving.po_id or 'null' }})" 
                                    class="text-xs text-blue-600 hover:text-blue-800 underline">
                                {% if shipment.receiving.po_number %}Change PO{% else %}Assign PO{% endif %}
                            </button>
                            <button onclick="event.stopPropagation(); toggleReceiveClosed({{ shipment.receiving.id }}, {{ 'true' if shipment.receiving.closed else 'false' }})" 
                                    class="text-xs {% if shipment.receiving.closed %}text-green-600 hover:text-green-800{% else %}text-orange-600 hover:text-orange-800{% endif %} underline">
                                {% if shipment.receiving.closed %}üîì Reopen{% else %}üîí Close{% endif %}
                            </button>
                            <button onclick="event.stopPropagation(); openDeleteShipmentModal({{ shipment.receiving.id }}, '{{ shipment.receiving.received_date[:10] if shipment.receiving.received_date else 'Unknown' }}', '{{ shipment.receiving.po_number or 'No PO' }}')" 
                                    class="text-xs text-red-600 hover:text-red-800 underline">
                                Delete
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Boxes (collapsible) -->
                <div id="shipment-{{ shipment.receiving.id }}" class="space-y-3 mt-4 {% if shipment.receiving.closed %}hidden{% endif %}">
                    {% for box_data in shipment.boxes %}
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium text-gray-900">Box {{ box_data.box.box_number }}</h4>
                            <span class="text-sm text-gray-600">{{ box_data.box.bag_count }} bag{{ 's' if box_data.box.bag_count != 1 else '' }}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mt-2">
                            {% for bag in box_data.bags %}
                            <div class="bg-white border border-gray-200 rounded p-2 text-sm cursor-pointer hover:bg-blue-50 hover:border-blue-300 hover:shadow transition-all"
                                 onclick="event.stopPropagation(); viewReceiveDetails({{ shipment.receiving.id }}, '{{ shipment.receiving.po_number }}-{{ shipment.receiving.shipment_number if shipment.receiving.shipment_number else 1 }}', {{ box_data.box.box_number }}, {{ bag.id }})"
                                 title="Click to view details for this bag">
                                <div class="font-medium text-blue-600">
                                    {% if bag.tablet_type_name %}
                                    {{ bag.tablet_type_name }} Bag {{ bag.bag_number }}
                                    {% else %}
                                    Bag {{ bag.bag_number }}
                                    {% endif %}
                                    <span class="text-gray-500 font-normal">(Box {{ box_data.box.box_number }})</span>
                                </div>
                                <div class="text-gray-600">Label Count: {{ bag.bag_label_count or 0 }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
        
        <!-- Receives Without PO -->
        {% if shipments_without_po %}
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-gray-400 px-4 py-3 mb-2">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">
                    üì¶ Unassigned Receives
                    <span class="text-sm font-normal text-gray-600 ml-2">({{ shipments_without_po|length }} receive{{ 's' if shipments_without_po|length != 1 else '' }})</span>
                </h2>
                <button onclick="togglePOCollapse('unassigned-receives')" 
                        class="text-gray-600 hover:text-gray-900 transition-colors"
                        aria-label="Toggle collapse">
                    <svg id="icon-unassigned-receives" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="unassigned-receives" class="space-y-4 ml-4 hidden">
        {% for shipment in shipments_without_po %}
        <div class="card cursor-pointer hover:shadow-lg transition-shadow" onclick="viewReceiveDetails({{ shipment.receiving.id }}, 'Unassigned-{{ shipment.receiving.id }}')">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <button onclick="event.stopPropagation(); toggleShipmentCollapse('shipment-{{ shipment.receiving.id }}')" 
                                    class="text-gray-600 hover:text-gray-900 transition-colors mr-2"
                                    aria-label="Toggle shipment collapse">
                                <svg id="icon-shipment-{{ shipment.receiving.id }}" class="w-5 h-5 transform transition-transform {% if shipment.receiving.closed %}rotate-0{% else %}rotate-180{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <h3 class="text-lg font-semibold text-gray-900">
                                Shipment Received
                            </h3>
                            {% if shipment.receiving.status == 'draft' %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-yellow-200 text-yellow-800">
                                üìù DRAFT
                            </span>
                            {% elif shipment.receiving.closed %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-gray-200 text-gray-700">
                                üîí CLOSED
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-green-200 text-green-800">
                                ‚úì LIVE
                            </span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-600">
                            Received on {{ (shipment.receiving.received_date|to_est)[:10] if shipment.receiving.received_date else 'Unknown' }} at {{ (shipment.receiving.received_date|to_est)[11:19] if shipment.receiving.received_date else '' }} EST
                            {% if shipment.receiving.received_by %}
                            by {{ shipment.receiving.received_by }}
                            {% endif %}
                        </p>
                        <p class="text-sm text-gray-500 italic mt-1">No PO assigned</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.box_count or 0 }} Box{{ 'es' if (shipment.receiving.box_count or 0) != 1 else '' }}
                        </div>
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.total_bags or 0 }} Bag{{ 's' if (shipment.receiving.total_bags or 0) != 1 else '' }}
                        </div>
                        {% if user_role in ['manager', 'admin'] %}
                        <div class="mt-2 space-x-2">
                            <button onclick="event.stopPropagation(); openAssignPOModal({{ shipment.receiving.id }}, {{ shipment.receiving.po_id or 'null' }})" 
                                    class="text-xs text-blue-600 hover:text-blue-800 underline">
                                Assign PO
                            </button>
                            <button onclick="event.stopPropagation(); toggleReceiveClosed({{ shipment.receiving.id }}, {{ 'true' if shipment.receiving.closed else 'false' }})" 
                                    class="text-xs {% if shipment.receiving.closed %}text-green-600 hover:text-green-800{% else %}text-orange-600 hover:text-orange-800{% endif %} underline">
                                {% if shipment.receiving.closed %}üîì Reopen{% else %}üîí Close{% endif %}
                            </button>
                            <button onclick="event.stopPropagation(); openDeleteShipmentModal({{ shipment.receiving.id }}, '{{ shipment.receiving.received_date[:10] if shipment.receiving.received_date else 'Unknown' }}', 'No PO')" 
                                    class="text-xs text-red-600 hover:text-red-800 underline">
                                Delete
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Boxes (collapsible) -->
                <div id="shipment-{{ shipment.receiving.id }}" class="space-y-3 mt-4 {% if shipment.receiving.closed %}hidden{% endif %}">
                    {% for box_data in shipment.boxes %}
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium text-gray-900">Box {{ box_data.box.box_number }}</h4>
                            <span class="text-sm text-gray-600">{{ box_data.box.bag_count }} bag{{ 's' if box_data.box.bag_count != 1 else '' }}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mt-2">
                            {% for bag in box_data.bags %}
                            <div class="bg-white border border-gray-200 rounded p-2 text-sm cursor-pointer hover:bg-blue-50 hover:border-blue-300 hover:shadow transition-all"
                                 onclick="event.stopPropagation(); viewReceiveDetails({{ shipment.receiving.id }}, 'Unassigned-{{ shipment.receiving.id }}', {{ box_data.box.box_number }}, {{ bag.id }})"
                                 title="Click to view details for this bag">
                                <div class="font-medium text-blue-600">
                                    {% if bag.tablet_type_name %}
                                    {{ bag.tablet_type_name }} Bag {{ bag.bag_number }}
                                    {% else %}
                                    Bag {{ bag.bag_number }}
                                    {% endif %}
                                    <span class="text-gray-500 font-normal">(Box {{ box_data.box.box_number }})</span>
                                </div>
                                <div class="text-gray-600">Label Count: {{ bag.bag_label_count or 0 }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Closed POs Tab Content -->
    <div id="content-closed" class="tab-content space-y-6 hidden">
        {% for po_group in grouped_shipments %}
        {% if po_group.po_closed %}
        <!-- PO Group Header -->
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-gray-500 px-4 py-3 mb-2">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">
                    üìã {{ po_group.po_number }}
                    <span class="ml-2 text-xs bg-gray-500 text-white px-2 py-1 rounded">Closed</span>
                    <span class="text-sm font-normal text-gray-600 ml-2">({{ po_group.receives|length }} receive{{ 's' if po_group.receives|length != 1 else '' }})</span>
                </h2>
                <button onclick="togglePOCollapse('po-closed-{{ po_group.po_number }}')" 
                        class="text-gray-600 hover:text-gray-900 transition-colors"
                        aria-label="Toggle collapse">
                    <svg id="icon-po-closed-{{ po_group.po_number }}" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Receives for this PO (oldest at bottom) -->
        <div id="po-closed-{{ po_group.po_number }}" class="space-y-4 ml-4 hidden">
        {% for shipment in po_group.receives %}
        <div class="card cursor-pointer hover:shadow-lg transition-shadow" onclick="viewReceiveDetails({{ shipment.receiving.id }}, '{{ shipment.receiving.po_number }}-{{ shipment.receiving.shipment_number if shipment.receiving.shipment_number else '' }}')">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <button onclick="event.stopPropagation(); toggleShipmentCollapse('shipment-{{ shipment.receiving.id }}')" 
                                    class="text-gray-600 hover:text-gray-900 transition-colors mr-2"
                                    aria-label="Toggle shipment collapse">
                                <svg id="icon-shipment-{{ shipment.receiving.id }}" class="w-5 h-5 transform transition-transform rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <h3 class="text-lg font-semibold text-gray-900">
                                {% if shipment.receiving.po_number %}
                                    {% if shipment.receiving.shipment_number %}
                                        {{ shipment.receiving.po_number }}-{{ shipment.receiving.shipment_number }}
                                    {% else %}
                                        {{ shipment.receiving.po_number }}
                                    {% endif %}
                                    <span class="ml-2 text-xs bg-gray-500 text-white px-2 py-1 rounded">Closed PO</span>
                                {% else %}
                                    Shipment Received
                                {% endif %}
                            </h3>
                        </div>
                        <p class="text-sm text-gray-600">
                            Received on {{ (shipment.receiving.received_date|to_est)[:10] if shipment.receiving.received_date else 'Unknown' }} at {{ (shipment.receiving.received_date|to_est)[11:19] if shipment.receiving.received_date else '' }} EST
                            {% if shipment.receiving.received_by %}
                            by {{ shipment.receiving.received_by }}
                            {% endif %}
                        </p>
                        {% if not shipment.receiving.po_number and user_role in ['manager', 'admin'] %}
                        <p class="text-sm text-gray-500 italic mt-1">No PO assigned</p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.box_count or 0 }} Box{{ 'es' if (shipment.receiving.box_count or 0) != 1 else '' }}
                        </div>
                        <div class="text-sm text-gray-600">
                            {{ shipment.receiving.total_bags or 0 }} Bag{{ 's' if (shipment.receiving.total_bags or 0) != 1 else '' }}
                        </div>
                        {% if user_role in ['manager', 'admin'] %}
                        <div class="mt-2 space-x-2">
                            <button onclick="event.stopPropagation(); openDeleteShipmentModal({{ shipment.receiving.id }}, '{{ shipment.receiving.received_date[:10] if shipment.receiving.received_date else 'Unknown' }}', '{{ shipment.receiving.po_number or 'No PO' }}')" 
                                    class="text-xs text-red-600 hover:text-red-800 underline">
                                Delete
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Boxes (collapsible) -->
                <div id="shipment-{{ shipment.receiving.id }}" class="space-y-3 mt-4 hidden">
                    {% for box_data in shipment.boxes %}
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium text-gray-900">Box {{ box_data.box.box_number }}</h4>
                            <span class="text-sm text-gray-600">{{ box_data.box.bag_count }} bag{{ 's' if box_data.box.bag_count != 1 else '' }}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mt-2">
                            {% for bag in box_data.bags %}
                            <div class="bg-white border border-gray-200 rounded p-2 text-sm cursor-pointer hover:bg-blue-50 hover:border-blue-300 hover:shadow transition-all"
                                 onclick="event.stopPropagation(); viewReceiveDetails({{ shipment.receiving.id }}, '{{ shipment.receiving.po_number }}-{{ shipment.receiving.shipment_number if shipment.receiving.shipment_number else 1 }}', {{ box_data.box.box_number }}, {{ bag.id }})"
                                 title="Click to view details for this bag">
                                <div class="font-medium text-blue-600">
                                    {% if bag.tablet_type_name %}
                                    {{ bag.tablet_type_name }} Bag {{ bag.bag_number }}
                                    {% else %}
                                    Bag {{ bag.bag_number }}
                                    {% endif %}
                                    <span class="text-gray-500 font-normal">(Box {{ box_data.box.box_number }})</span>
                                </div>
                                <div class="text-gray-600">Label Count: {{ bag.bag_label_count or 0 }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="p-6">
            <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" aria-hidden="true"><use href="#icon-box" /></svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No shipments recorded yet</h3>
                <p class="text-gray-600 mb-6">Click "Add Receives" to record a new shipment</p>
                <button onclick="openAddReceivesModal()" 
                        class="btn-primary px-6 py-3 text-lg">
                    <svg class="w-5 h-5 mr-2 inline" aria-hidden="true"><use href="#icon-plus" /></svg>
                    Add Receives
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Receives Modal -->
<div id="add-receives-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" onclick="closeAddReceivesModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold">üì¶ Record Shipment Received</h3>
                    <p class="text-sm text-blue-100 mt-1">Enter box and bag details for the received shipment</p>
                </div>
                <button onclick="closeAddReceivesModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        
        <!-- Form Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <form id="receives-form" onsubmit="submitReceives(event)">
                {% if user_role in ['manager', 'admin'] %}
                <!-- PO Assignment Field (Managers/Admin only) -->
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Purchase Order <span class="text-red-600">*</span>
                    </label>
                    <select id="po-select" name="po_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select a PO...</option>
                        {% for po in purchase_orders %}
                        <option value="{{ po.id }}">{{ po.po_number }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-red-600 mt-1 font-medium">‚ö†Ô∏è Required: All receives must be linked to a PO (source of truth for submissions)</p>
                </div>
                {% endif %}
                
                <div id="boxes-container">
                    <!-- Box 1 will be added automatically -->
                </div>
                
                <!-- Add Box Button -->
                <div class="mt-4 flex justify-center">
                    <button type="button" onclick="addBox()" 
                            class="btn-secondary px-4 py-2 flex items-center">
                        <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-plus" /></svg>
                        Add Another Box
                    </button>
                </div>
                
                <!-- Submit Buttons -->
                <div class="mt-6 border-t pt-4">
                    <div class="flex justify-between items-center gap-3 mb-3">
                        <div class="text-sm text-gray-600">
                            <span class="font-medium">üí° Tip:</span> Save as Draft to continue editing later
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeAddReceivesModal()" 
                                class="btn-secondary px-4 py-2">
                            Cancel
                        </button>
                        <button type="button" onclick="saveReceivesDraft()" 
                                class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors">
                            üìù Save as Draft
                        </button>
                        <button type="submit" 
                                class="btn-primary px-6 py-2">
                            ‚úì Save & Publish
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Shipment Modal -->
<div id="delete-shipment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeDeleteShipmentModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Delete Shipment</h3>
                <button onclick="closeDeleteShipmentModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <p class="text-gray-700 mb-2"><strong>Are you sure you want to delete this shipment?</strong></p>
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-red-800"><strong>This action cannot be undone.</strong></p>
                    <p class="text-sm text-gray-700 mt-2">This will permanently delete:</p>
                    <ul class="text-sm text-gray-700 mt-1 ml-4 list-disc">
                        <li>The shipment record</li>
                        <li>All associated boxes</li>
                        <li>All associated bags</li>
                    </ul>
                </div>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <p class="text-sm text-gray-700"><strong>Shipment Details:</strong></p>
                    <p class="text-sm text-gray-600 mt-1">Received Date: <span id="delete-shipment-date"></span></p>
                    <p class="text-sm text-gray-600">PO: <span id="delete-shipment-po"></span></p>
                </div>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="delete-confirm-checkbox" class="mr-2">
                    <span class="text-sm text-gray-700">I understand this action cannot be undone</span>
                </label>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeDeleteShipmentModal()" 
                        class="btn-secondary px-4 py-2">
                    Cancel
                </button>
                <button onclick="confirmDeleteShipment()" 
                        id="confirm-delete-btn"
                        class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    Delete Shipment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign PO Modal -->
<div id="assign-po-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeAssignPOModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Assign Purchase Order</h3>
                <button onclick="closeAssignPOModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        <div class="p-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Purchase Order
            </label>
            <select id="assign-po-select" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">No PO assigned</option>
                {% for po in purchase_orders %}
                <option value="{{ po.id }}">{{ po.po_number }}</option>
                {% endfor %}
            </select>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="closeAssignPOModal()" 
                        class="btn-secondary px-4 py-2">
                    Cancel
                </button>
                <button type="button" onclick="savePOAssignment()" 
                        class="btn-primary px-4 py-2">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let boxCounter = 0;
let bagCounter = {}; // Still track per-box for UI structure
let flavorBagCounter = {}; // Track bag numbers globally per flavor
let bagFlavorAssignments = {}; // Track which flavor is assigned to which bag
let currentReceivingId = null;
let currentPoId = null;
let poSelectListenerAdded = false; // Track if PO select listener has been added

// Store categories and tablet types from server (converted from Jinja2 to JavaScript)
const categories = {{ categories | tojson }};
const tabletTypes = {{ tablet_types | tojson }};

// Function to build tablet type dropdown HTML dynamically
function buildTabletTypeDropdown(boxNumber, bagNumber) {
    let html = `<option value="">Select tablet type...</option>`;
    
    // Add categorized options
    categories.forEach(category => {
        const categoryTypes = tabletTypes.filter(tt => tt.category === category);
        if (categoryTypes.length > 0) {
            html += `<optgroup label="${category}">`;
            categoryTypes.forEach(tt => {
                html += `<option value="${tt.id}">${tt.tablet_type_name}</option>`;
            });
            html += `</optgroup>`;
        }
    });
    
    // Add uncategorized options
    const uncategorized = tabletTypes.filter(tt => !tt.category || tt.category === '');
    if (uncategorized.length > 0) {
        html += `<optgroup label="‚ö†Ô∏è Uncategorized">`;
        uncategorized.forEach(tt => {
            html += `<option value="${tt.id}">${tt.tablet_type_name}</option>`;
        });
        html += `</optgroup>`;
    }
    
    return html;
}

// Load max bag numbers for selected PO (for new entries only - doesn't affect existing data)
async function loadMaxBagNumbersForPO() {
    const poSelect = document.getElementById('po-select');
    if (!poSelect || !poSelect.value) {
        // No PO selected, reset counters
        flavorBagCounter = {};
        return;
    }
    
    const poId = parseInt(poSelect.value);
    if (!poId) {
        flavorBagCounter = {};
        return;
    }
    
    try {
        const response = await fetch(`/api/po/${poId}/max_bag_numbers`);
        const data = await response.json();
        
        if (data.success && data.max_bag_numbers) {
            // Initialize counters with max values from existing bags
            // This ensures new bags continue numbering from where existing bags left off
            flavorBagCounter = {};
            for (const [tabletTypeId, maxBagNumber] of Object.entries(data.max_bag_numbers)) {
                flavorBagCounter[tabletTypeId] = parseInt(maxBagNumber) || 0;
            }
            console.log('Loaded max bag numbers for PO:', flavorBagCounter);
        } else {
            // No existing bags, start from 0
            flavorBagCounter = {};
        }
    } catch (error) {
        console.error('Error loading max bag numbers:', error);
        // On error, start from 0
        flavorBagCounter = {};
    }
}

// Get next bag number for a flavor (global across all boxes)
// For new entries: starts from max existing bag number + 1 for that flavor in the PO
function getNextFlavorBagNumber(tabletTypeId) {
    if (!flavorBagCounter[tabletTypeId]) {
        flavorBagCounter[tabletTypeId] = 0;
    }
    flavorBagCounter[tabletTypeId]++;
    return flavorBagCounter[tabletTypeId];
}

// Decrement bag number for a flavor (when removing or changing)
function decrementFlavorBagNumber(tabletTypeId) {
    if (flavorBagCounter[tabletTypeId] && flavorBagCounter[tabletTypeId] > 0) {
        flavorBagCounter[tabletTypeId]--;
    }
}

// Get tablet type name by ID
function getTabletTypeName(tabletTypeId) {
    const type = tabletTypes.find(tt => tt.id == tabletTypeId);
    return type ? type.tablet_type_name : 'Unknown';
}

// Update bag label when flavor is selected
function updateBagLabel(boxNumber, bagSequence, tabletTypeId, flavorBagNumber) {
    const bagDiv = document.getElementById(`box-${boxNumber}-bag-${bagSequence}`);
    if (bagDiv) {
        const labelElement = bagDiv.querySelector('.bag-label');
        if (labelElement && tabletTypeId) {
            const flavorName = getTabletTypeName(tabletTypeId);
            labelElement.textContent = `${flavorName} Bag ${flavorBagNumber} (Box ${boxNumber})`;
            labelElement.classList.add('text-blue-600', 'font-semibold');
        } else if (labelElement) {
            labelElement.textContent = `Bag ${bagSequence}`;
            labelElement.classList.remove('text-blue-600', 'font-semibold');
        }
    }
}

// ==================== AUTO-SAVE FUNCTIONALITY ====================
// Saves form data to localStorage every 30 seconds to prevent data loss
const AUTOSAVE_KEY = 'tabletTracker_receiveFormDraft';
const AUTOSAVE_INTERVAL = 30000; // 30 seconds
let autosaveTimer = null;

function getFormDataForAutosave() {
    // Sync all two-level dropdowns first
    const allItemSelects = document.querySelectorAll('select[id$="_item"]');
    allItemSelects.forEach(itemSelect => {
        if (itemSelect.value && itemSelect.value !== '') {
            const originalId = itemSelect.id.replace('_item', '');
            const originalSelect = document.getElementById(originalId);
            if (originalSelect) {
                originalSelect.value = itemSelect.value;
            }
        }
    });
    
    const form = document.getElementById('receives-form');
    const formData = new FormData(form);
    const data = {
        timestamp: new Date().toISOString(),
        po_id: document.getElementById('po-select')?.value || null,
        editing_receive_id: window.editingReceiveId || null,
        fields: {}
    };
    
    for (const [key, value] of formData.entries()) {
        data.fields[key] = value;
    }
    
    // Also save box/bag counter states
    data.boxCounter = boxCounter;
    data.bagCounter = { ...bagCounter };
    data.flavorBagCounter = { ...flavorBagCounter };
    data.bagFlavorAssignments = { ...bagFlavorAssignments };
    
    return data;
}

function autosaveToLocalStorage() {
    try {
        const data = getFormDataForAutosave();
        const boxCount = Object.keys(data.fields).filter(k => k.match(/^box_\d+_bag_\d+_tablet_type$/)).length;
        
        // Only save if there's actual data
        if (boxCount > 0) {
            localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
            console.log(`[Autosave] Saved ${boxCount} bags at ${new Date().toLocaleTimeString()}`);
        }
    } catch (e) {
        console.error('[Autosave] Error saving:', e);
    }
}

function clearAutosave() {
    localStorage.removeItem(AUTOSAVE_KEY);
    console.log('[Autosave] Cleared saved draft');
}

function getSavedDraft() {
    try {
        const saved = localStorage.getItem(AUTOSAVE_KEY);
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (e) {
        console.error('[Autosave] Error reading saved draft:', e);
    }
    return null;
}

function startAutosave() {
    if (autosaveTimer) {
        clearInterval(autosaveTimer);
    }
    autosaveTimer = setInterval(autosaveToLocalStorage, AUTOSAVE_INTERVAL);
    console.log('[Autosave] Started - saving every 30 seconds');
}

function stopAutosave() {
    if (autosaveTimer) {
        clearInterval(autosaveTimer);
        autosaveTimer = null;
    }
}

// Refresh CSRF token before submission to prevent token expiration errors
async function refreshCSRFToken() {
    try {
        const response = await fetch('/api/csrf-token');
        const data = await response.json();
        if (data.csrf_token) {
            // Update meta tag
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) {
                meta.setAttribute('content', data.csrf_token);
            }
            console.log('[CSRF] Token refreshed');
            return data.csrf_token;
        }
    } catch (e) {
        console.error('[CSRF] Failed to refresh token:', e);
    }
    return null;
}

// ==================== END AUTO-SAVE FUNCTIONALITY ====================

// Initialize with Box 1 and Bag 1
document.addEventListener('DOMContentLoaded', function() {
    // Check for saved draft BEFORE adding default box
    const savedDraft = getSavedDraft();
    if (savedDraft) {
        const savedTime = new Date(savedDraft.timestamp);
        const timeDiff = (Date.now() - savedTime.getTime()) / 1000 / 60; // minutes
        const bagCount = Object.keys(savedDraft.fields).filter(k => k.match(/^box_\d+_bag_\d+_tablet_type$/)).length;
        
        if (bagCount > 0 && timeDiff < 480) { // Less than 8 hours old
            const restore = confirm(
                `üì¶ Found saved draft from ${savedTime.toLocaleString()}\n\n` +
                `Contains ${bagCount} bags\n` +
                `PO: ${savedDraft.po_id || 'Not selected'}\n` +
                `${savedDraft.editing_receive_id ? '(Editing existing receive)' : '(New receive)'}\n\n` +
                `Would you like to restore this draft?\n\n` +
                `Click OK to restore, or Cancel to start fresh.`
            );
            
            if (restore) {
                restoreSavedDraft(savedDraft);
                startAutosave();
                return; // Don't add default box
            } else {
                clearAutosave();
            }
        } else {
            // Draft is too old, clear it
            clearAutosave();
        }
    }
    
    addBox();
    startAutosave();
    
    // Check if we should auto-open a specific receive from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const openReceiveId = urlParams.get('open_receive');
    if (openReceiveId) {
        // Get receive name from the page (find the receive card with this ID)
        const receiveCard = document.querySelector(`[onclick*="viewReceiveDetails(${openReceiveId}"]`);
        let receiveName = 'Receive Details';
        if (receiveCard) {
            // Try to extract the receive name from the card
            const titleElement = receiveCard.querySelector('h3');
            if (titleElement) {
                receiveName = titleElement.textContent.trim();
            }
        }
        // Open the receive details modal
        setTimeout(() => {
            viewReceiveDetails(parseInt(openReceiveId), receiveName);
            // Clean up URL to remove the parameter
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
        }, 100);
    }
});

async function restoreSavedDraft(savedDraft) {
    console.log('[Restore] Starting draft restoration...');
    
    // Clear existing form
    boxCounter = 0;
    bagCounter = {};
    flavorBagCounter = {};
    bagFlavorAssignments = {};
    document.getElementById('boxes-container').innerHTML = '';
    
    // Restore counters
    if (savedDraft.boxCounter) boxCounter = savedDraft.boxCounter;
    if (savedDraft.bagCounter) bagCounter = { ...savedDraft.bagCounter };
    if (savedDraft.flavorBagCounter) flavorBagCounter = { ...savedDraft.flavorBagCounter };
    if (savedDraft.bagFlavorAssignments) bagFlavorAssignments = { ...savedDraft.bagFlavorAssignments };
    
    // Restore editing state
    if (savedDraft.editing_receive_id) {
        window.editingReceiveId = savedDraft.editing_receive_id;
    }
    
    // Set PO
    if (savedDraft.po_id) {
        const poSelect = document.getElementById('po-select');
        if (poSelect) {
            poSelect.value = savedDraft.po_id;
        }
    }
    
    // Parse saved fields to reconstruct boxes
    const boxData = {};
    for (const [key, value] of Object.entries(savedDraft.fields)) {
        const match = key.match(/^box_(\d+)_bag_(\d+)_(tablet_type|bag_count|flavor_bag_number)$/);
        if (match) {
            const boxNum = parseInt(match[1]);
            const bagNum = parseInt(match[2]);
            const field = match[3];
            
            if (!boxData[boxNum]) boxData[boxNum] = {};
            if (!boxData[boxNum][bagNum]) boxData[boxNum][bagNum] = {};
            boxData[boxNum][bagNum][field] = value;
        }
    }
    
    // Rebuild boxes and bags
    const sortedBoxes = Object.keys(boxData).map(n => parseInt(n)).sort((a, b) => a - b);
    
    for (const boxNum of sortedBoxes) {
        addBox();
        const currentBoxNum = boxCounter;
        
        const sortedBags = Object.keys(boxData[boxNum]).map(n => parseInt(n)).sort((a, b) => a - b);
        
        for (let i = 0; i < sortedBags.length; i++) {
            const bagNum = sortedBags[i];
            const bagData = boxData[boxNum][bagNum];
            
            // First bag is already added with the box
            if (i > 0) {
                addBag(currentBoxNum);
            }
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Get the current bag sequence
            const currentBagSeq = bagCounter[currentBoxNum] || 1;
            const bagSelectId = `box_${currentBoxNum}_bag_${currentBagSeq}_tablet_type`;
            
            // Set tablet type
            if (bagData.tablet_type) {
                const originalSelect = document.getElementById(bagSelectId);
                const itemSelect = document.getElementById(bagSelectId + '_item');
                
                if (originalSelect) originalSelect.value = bagData.tablet_type;
                if (itemSelect) {
                    itemSelect.value = bagData.tablet_type;
                    itemSelect.dispatchEvent(new Event('change'));
                }
            }
            
            // Set bag count
            if (bagData.bag_count) {
                const countInput = document.querySelector(`input[name="box_${currentBoxNum}_bag_${currentBagSeq}_bag_count"]`);
                if (countInput) countInput.value = bagData.bag_count;
            }
            
            // Set flavor bag number
            if (bagData.flavor_bag_number) {
                const flavorInput = document.getElementById(`box_${currentBoxNum}_bag_${currentBagSeq}_flavor_bag_number`);
                if (flavorInput) flavorInput.value = bagData.flavor_bag_number;
            }
        }
    }
    
    console.log('[Restore] Draft restoration complete');
    alert(`‚úÖ Restored ${sortedBoxes.length} boxes from saved draft`);
}

async function openAddReceivesModal() {
    // Reset form
    boxCounter = 0;
    bagCounter = {};
    flavorBagCounter = {}; // Reset flavor-based counters
    bagFlavorAssignments = {}; // Reset flavor assignments
    document.getElementById('boxes-container').innerHTML = '';
    
    // Add first box
    addBox();
    
    // Show modal
    document.getElementById('add-receives-modal').classList.remove('hidden');
    
    // Load max bag numbers when PO is selected (if PO select exists)
    const poSelect = document.getElementById('po-select');
    if (poSelect) {
        // Add event listener only once
        if (!poSelectListenerAdded) {
            poSelect.addEventListener('change', loadMaxBagNumbersForPO);
            poSelectListenerAdded = true;
        }
        
        // Load max bag numbers if PO is already selected
        if (poSelect.value) {
            await loadMaxBagNumbersForPO();
        }
    }
}

function closeAddReceivesModal(event) {
    if (!event || event.target === event.currentTarget || event.target.closest('button')) {
        document.getElementById('add-receives-modal').classList.add('hidden');
        
        // DON'T clear editing state on close - only clear after successful save
        // window.editingReceiveId = null;  // REMOVED - was causing ID loss
        
        const modalTitle = document.querySelector('#add-receives-modal h3');
        if (modalTitle) {
            modalTitle.textContent = 'üì¶ Record Shipment Received';
        }
    }
}

function addBox() {
    boxCounter++;
    const boxNumber = boxCounter;
    bagCounter[boxNumber] = 0;
    
    const boxesContainer = document.getElementById('boxes-container');
    
    const boxDiv = document.createElement('div');
    boxDiv.className = 'mb-6 p-4 border-2 border-gray-300 rounded-lg bg-gray-50';
    boxDiv.id = `box-${boxNumber}`;
    boxDiv.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-semibold text-gray-900">Box ${boxNumber}</h4>
            <div class="flex gap-2">
                <button type="button" onclick="copyBox(${boxNumber})" 
                        class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1"
                        title="Copy this box with all its bags">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Copy Box
                </button>
                ${boxNumber > 1 ? `
                    <button type="button" onclick="removeBox(${boxNumber})" 
                            class="text-red-600 hover:text-red-800 text-sm">
                        Remove Box
                    </button>
                ` : ''}
            </div>
        </div>
        <div id="box-${boxNumber}-bags" class="space-y-4">
            <!-- Bags will be added here -->
        </div>
        <div class="mt-4">
            <button type="button" onclick="addBag(${boxNumber})" 
                    class="btn-secondary text-sm px-3 py-1.5 flex items-center">
                <svg class="w-4 h-4 mr-1" aria-hidden="true"><use href="#icon-plus" /></svg>
                Add Another Bag
            </button>
        </div>
    `;
    
    boxesContainer.appendChild(boxDiv);
    
    // Automatically add Bag 1 to this box
    addBag(boxNumber);
}

function removeBox(boxNumber) {
    const boxDiv = document.getElementById(`box-${boxNumber}`);
    if (boxDiv) {
        // Get all bags in this box and decrement their flavor counters
        const bagsContainer = document.getElementById(`box-${boxNumber}-bags`);
        if (bagsContainer) {
            const bagDivs = bagsContainer.querySelectorAll('[id^="box-' + boxNumber + '-bag-"]');
            bagDivs.forEach(bagDiv => {
                const bagId = bagDiv.id.match(/box-(\d+)-bag-(\d+)/);
                if (bagId) {
                    const bagIdentifier = `${bagId[1]}-${bagId[2]}`;
                    const assignedFlavor = bagFlavorAssignments[bagIdentifier];
                    if (assignedFlavor) {
                        decrementFlavorBagNumber(assignedFlavor);
                        delete bagFlavorAssignments[bagIdentifier];
                    }
                }
            });
        }
        
        boxDiv.remove();
        delete bagCounter[boxNumber];
    }
}

function addBag(boxNumber) {
    if (!bagCounter[boxNumber]) {
        bagCounter[boxNumber] = 0;
    }
    bagCounter[boxNumber]++;
    const bagSequence = bagCounter[boxNumber]; // Sequence within box (for UI only)
    
    const bagsContainer = document.getElementById(`box-${boxNumber}-bags`);
    
    const bagDiv = document.createElement('div');
    bagDiv.className = 'p-4 bg-white border border-gray-200 rounded-lg';
    bagDiv.id = `box-${boxNumber}-bag-${bagSequence}`;
    bagDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
            <h5 class="font-medium text-gray-700 bag-label">Bag ${bagSequence}</h5>
            <div class="flex gap-2">
                <button type="button" onclick="copyBag(${boxNumber}, ${bagSequence})" 
                        class="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1"
                        title="Copy this bag's information">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Copy
                </button>
                ${bagSequence > 1 ? `
                    <button type="button" onclick="removeBag(${boxNumber}, ${bagSequence})" 
                            class="text-red-600 hover:text-red-800 text-xs">
                        Remove Bag
                    </button>
                ` : ''}
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tablet Type <span class="text-xs text-gray-500">(determines bag number)</span></label>
                <select id="box_${boxNumber}_bag_${bagSequence}_tablet_type"
                        name="box_${boxNumber}_bag_${bagSequence}_tablet_type" 
                        data-box="${boxNumber}" 
                        data-seq="${bagSequence}"
                        class="flavor-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    ${buildTabletTypeDropdown(boxNumber, bagSequence)}
                </select>
                <input type="hidden" name="box_${boxNumber}_bag_${bagSequence}_flavor_bag_number" value="" class="flavor-bag-number-field">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Bag Count</label>
                <input type="number" 
                       name="box_${boxNumber}_bag_${bagSequence}_bag_count" 
                       min="0" 
                       step="1"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                       placeholder="Enter bag count"
                       required>
            </div>
        </div>
    `;
    
    bagsContainer.appendChild(bagDiv);
    
    // Convert to two-level dropdown
    const select = bagDiv.querySelector('select[name="box_' + boxNumber + '_bag_' + bagSequence + '_tablet_type"]');
    if (select && typeof convertToTwoLevelDropdown === 'function') {
        convertToTwoLevelDropdown(select);
    }
    
    // Add listener to update bag number when flavor is selected
    select.addEventListener('change', function() {
        const tabletTypeId = this.value;
        const hiddenField = bagDiv.querySelector('.flavor-bag-number-field');
        const bagId = `${boxNumber}-${bagSequence}`;
        
        // Get previously assigned flavor for this bag
        const previousFlavor = bagFlavorAssignments[bagId];
        
        // Skip if this is a programmatic change to the same value (e.g., from copy function)
        // Only process if flavor actually changed or is newly selected
        if (previousFlavor === tabletTypeId) {
            return; // Same flavor, no need to increment/decrement
        }
        
        // If flavor changed from a previous selection, decrement old counter
        if (previousFlavor && previousFlavor !== tabletTypeId) {
            decrementFlavorBagNumber(previousFlavor);
        }
        
        if (tabletTypeId) {
            const flavorBagNumber = getNextFlavorBagNumber(tabletTypeId);
            hiddenField.value = flavorBagNumber;
            bagFlavorAssignments[bagId] = tabletTypeId; // Track this assignment
            updateBagLabel(boxNumber, bagSequence, tabletTypeId, flavorBagNumber);
        } else {
            // Flavor cleared - decrement if there was a previous assignment
            if (previousFlavor) {
                decrementFlavorBagNumber(previousFlavor);
                delete bagFlavorAssignments[bagId];
            }
            hiddenField.value = '';
            updateBagLabel(boxNumber, bagSequence, null, null);
        }
    });
}

function removeBag(boxNumber, bagNumber) {
    const bagDiv = document.getElementById(`box-${boxNumber}-bag-${bagNumber}`);
    if (bagDiv) {
        // Get the assigned flavor for this bag
        const bagId = `${boxNumber}-${bagNumber}`;
        const assignedFlavor = bagFlavorAssignments[bagId];
        
        // Decrement the flavor counter if a flavor was assigned
        if (assignedFlavor) {
            decrementFlavorBagNumber(assignedFlavor);
            delete bagFlavorAssignments[bagId];
        }
        
        bagDiv.remove();
    }
}

async function copyBag(boxNumber, bagNumber) {
    // Get the source bag's values
    const sourceTabletTypeSelect = document.querySelector(`select[name="box_${boxNumber}_bag_${bagNumber}_tablet_type"]`);
    const sourceBagCountInput = document.querySelector(`input[name="box_${boxNumber}_bag_${bagNumber}_bag_count"]`);
    
    if (!sourceTabletTypeSelect || !sourceBagCountInput) {
        alert('Error: Could not find source bag data');
        return;
    }
    
    const tabletTypeValue = sourceTabletTypeSelect.value;
    const bagCountValue = sourceBagCountInput.value;
    
    // Validate that there's data to copy
    if (!tabletTypeValue) {
        alert('Please select a tablet type before copying');
        sourceTabletTypeSelect.focus();
        return;
    }
    
    if (!bagCountValue) {
        alert('Please enter a bag count before copying');
        sourceBagCountInput.focus();
        return;
    }
    
    // Create a new bag
    addBag(boxNumber);
    
    // Get the newly created bag number
    const newBagNumber = bagCounter[boxNumber];
    
    // Wait for the dropdown to be added to the DOM AND converted to two-level
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Find the ORIGINAL hidden select (not the item select created by two-level conversion)
    const baseSelectId = `box_${boxNumber}_bag_${newBagNumber}_tablet_type`;
    const newTabletTypeSelect = document.getElementById(baseSelectId);
    const newBagCountInput = document.querySelector(`input[name="box_${boxNumber}_bag_${newBagNumber}_bag_count"]`);
    
    if (newTabletTypeSelect && newBagCountInput) {
        console.log('[Copy Bag] Found new bag elements');
        console.log('[Copy Bag] Copying tablet type:', tabletTypeValue);
        console.log('[Copy Bag] Copying bag count:', bagCountValue);
        
        // Set bag count immediately
        newBagCountInput.value = bagCountValue;
        
        // Set tablet type on hidden select
        newTabletTypeSelect.value = tabletTypeValue;
        
        // Wait a bit longer for two-level dropdown conversion to complete
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Check if dropdown was converted to two-level
        const isConverted = newTabletTypeSelect.style.display === 'none';
        console.log('[Copy Bag] Dropdown converted to two-level?', isConverted);
        console.log('[Copy Bag] Original select ID:', newTabletTypeSelect.id);
        
        if (isConverted) {
            // Find the category and item dropdowns using the ORIGINAL select's ID
            const groupSelect = document.getElementById(baseSelectId + '_group');
            const itemSelect = document.getElementById(baseSelectId + '_item');
            
            console.log('[Copy Bag] Group select found?', !!groupSelect);
            console.log('[Copy Bag] Item select found?', !!itemSelect);
            
            if (groupSelect && itemSelect) {
                // Find the option in the original select to get its category
                const selectedOption = newTabletTypeSelect.querySelector(`option[value="${tabletTypeValue}"]`);
                console.log('[Copy Bag] Selected option found?', !!selectedOption);
                
                if (selectedOption) {
                    const optgroup = selectedOption.parentElement;
                    if (optgroup && optgroup.tagName === 'OPTGROUP') {
                        const categoryLabel = optgroup.label;
                        console.log('[Copy Bag] Category to select:', categoryLabel);
                        
                        // Set category dropdown
                        groupSelect.value = categoryLabel;
                        
                        // Trigger category change to populate items
                        groupSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        // Wait for items to populate
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        // Set item value
                        itemSelect.value = tabletTypeValue;
                        itemSelect.style.display = '';
                        
                        console.log('[Copy Bag] Set item select value to:', tabletTypeValue);
                        console.log('[Copy Bag] Item select current value:', itemSelect.value);
                        
                        // Trigger change on item to sync back
                        itemSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }
        }
        
        // DON'T trigger final change event - that causes flavor counter increment
        // The itemSelect change event above already syncs to the original select
        console.log('[Copy Bag] Final select value:', newTabletTypeSelect.value);
        
        // Visual feedback
        const newBagDiv = document.getElementById(`box-${boxNumber}-bag-${newBagNumber}`);
        if (newBagDiv) {
            newBagDiv.classList.add('ring-2', 'ring-green-500', 'ring-opacity-50');
            setTimeout(() => {
                newBagDiv.classList.remove('ring-2', 'ring-green-500', 'ring-opacity-50');
            }, 1500);
        }
    }
}

async function copyBox(boxNumber) {
    // Get all bags in the source box
    const bagsContainer = document.getElementById(`box-${boxNumber}-bags`);
    if (!bagsContainer) {
        alert('Error: Could not find source box');
        return;
    }
    
    const bagDivs = bagsContainer.querySelectorAll('[id^="box-' + boxNumber + '-bag-"]');
    if (bagDivs.length === 0) {
        alert('No bags to copy in this box');
        return;
    }
    
    // Collect all bag data
    const bagsData = [];
    let hasEmptyData = false;
    
    for (const bagDiv of bagDivs) {
        const bagId = bagDiv.id;
        const bagNumMatch = bagId.match(/bag-(\d+)$/);
        if (!bagNumMatch) continue;
        
        const bagNum = bagNumMatch[1];
        const tabletTypeSelect = document.querySelector(`select[name="box_${boxNumber}_bag_${bagNum}_tablet_type"]`);
        const bagCountInput = document.querySelector(`input[name="box_${boxNumber}_bag_${bagNum}_bag_count"]`);
        
        if (tabletTypeSelect && bagCountInput) {
            const tabletType = tabletTypeSelect.value;
            const bagCount = bagCountInput.value;
            
            if (!tabletType || !bagCount) {
                hasEmptyData = true;
                continue;
            }
            
            bagsData.push({
                tabletType: tabletType,
                bagCount: bagCount
            });
        }
    }
    
    if (bagsData.length === 0) {
        alert('Please fill in at least one bag with tablet type and bag count before copying the box');
        return;
    }
    
    if (hasEmptyData) {
        if (!confirm('Some bags in this box are incomplete. Copy only the filled bags?')) {
            return;
        }
    }
    
    // Create a new box
    addBox();
    const newBoxNumber = boxCounter;
    
    // Remove the automatically added first bag
    const firstBagId = `box-${newBoxNumber}-bag-1`;
    const firstBagDiv = document.getElementById(firstBagId);
    if (firstBagDiv) {
        firstBagDiv.remove();
        bagCounter[newBoxNumber] = 0;
    }
    
    // Add all bags with their data
    for (let index = 0; index < bagsData.length; index++) {
        const bagData = bagsData[index];
        
        addBag(newBoxNumber);
        const newBagNumber = bagCounter[newBoxNumber];
        
        // Wait for the dropdown to be added and converted to two-level
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Find the ORIGINAL hidden select by ID (not the item select created by two-level conversion)
        const baseSelectId = `box_${newBoxNumber}_bag_${newBagNumber}_tablet_type`;
        const newTabletTypeSelect = document.getElementById(baseSelectId);
        const newBagCountInput = document.querySelector(`input[name="box_${newBoxNumber}_bag_${newBagNumber}_bag_count"]`);
        
        if (newTabletTypeSelect && newBagCountInput) {
            newTabletTypeSelect.value = bagData.tabletType;
            newBagCountInput.value = bagData.bagCount;
            
            // Handle two-level dropdown if present
            if (newTabletTypeSelect.style.display === 'none') {
                // Find the category and item dropdowns using base ID
                const groupSelect = document.getElementById(baseSelectId + '_group');
                const itemSelect = document.getElementById(baseSelectId + '_item');
                
                if (groupSelect && itemSelect) {
                    // Find the option in the new select element
                    const selectedOption = newTabletTypeSelect.querySelector(`option[value="${bagData.tabletType}"]`);
                    if (selectedOption) {
                        const optgroup = selectedOption.parentElement;
                        if (optgroup && optgroup.tagName === 'OPTGROUP') {
                            const categoryLabel = optgroup.label;
                            
                            // Set category dropdown
                            groupSelect.value = categoryLabel;
                            
                            // Trigger category change to populate items
                            const categoryEvent = new Event('change', { bubbles: true });
                            groupSelect.dispatchEvent(categoryEvent);
                            
                            // Wait for items to populate, then select the item
                            await new Promise(resolve => setTimeout(resolve, 100));
                            itemSelect.value = bagData.tabletType;
                            
                            // Trigger change event on item select to sync
                            const itemEvent = new Event('change', { bubbles: true });
                            itemSelect.dispatchEvent(itemEvent);
                        }
                    }
                }
            }
            
            // IMPORTANT: Trigger change event to assign flavor bag number
            const changeEvent = new Event('change', { bubbles: true });
            newTabletTypeSelect.dispatchEvent(changeEvent);
        }
    }
    
    // Visual feedback
    const newBoxDiv = document.getElementById(`box-${newBoxNumber}`);
    if (newBoxDiv) {
        newBoxDiv.classList.add('ring-2', 'ring-green-500', 'ring-opacity-50');
        newBoxDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        setTimeout(() => {
            newBoxDiv.classList.remove('ring-2', 'ring-green-500', 'ring-opacity-50');
        }, 1500);
    }
}

async function submitReceivesWithStatus(event, status = 'published') {
    if (event) event.preventDefault();
    
    // FIRST: Refresh CSRF token to prevent expiration errors on long forms
    console.log('[Submit] Refreshing CSRF token before submission...');
    await refreshCSRFToken();
    
    const form = document.getElementById('receives-form');
    
    // CRITICAL FIX: Sync all two-level dropdowns back to form before reading FormData
    // During edit, dropdown values may not be in FormData if they were pre-populated
    console.log('[Submit] Syncing all two-level dropdowns to form fields...');
    const allItemSelects = document.querySelectorAll('select[id$="_item"]');
    let syncedCount = 0;
    allItemSelects.forEach(itemSelect => {
        if (itemSelect.value && itemSelect.value !== '') {
            // Find corresponding original select
            const originalId = itemSelect.id.replace('_item', '');
            const originalSelect = document.getElementById(originalId);
            if (originalSelect) {
                originalSelect.value = itemSelect.value;
                console.log(`[Submit] Synced ${originalId}: ${itemSelect.value}`);
                syncedCount++;
            }
        }
    });
    console.log(`[Submit] Synced ${syncedCount} dropdown values`);
    
    const formData = new FormData(form);
    
    // Parse form data into structured format
    const boxes = {};
    
    // Collect all form fields
    for (const [key, value] of formData.entries()) {
        // Match pattern: box_{boxNum}_bag_{bagSeq}_{fieldType}
        const match = key.match(/^box_(\d+)_bag_(\d+)_(tablet_type|bag_count|flavor_bag_number)$/);
        if (match) {
            const boxNum = match[1];
            const bagSeq = match[2];
            const fieldType = match[3]; // 'tablet_type', 'bag_count', or 'flavor_bag_number'
            
            if (!boxes[boxNum]) {
                boxes[boxNum] = {};
            }
            if (!boxes[boxNum][bagSeq]) {
                boxes[boxNum][bagSeq] = {};
            }
            
            boxes[boxNum][bagSeq][fieldType] = value;
        }
    }
    
    // Convert to array format - NOW using flavor-based bag numbers
    const boxesArray = [];
    for (const boxNum in boxes) {
        const bagsArray = [];
        for (const bagSeq in boxes[boxNum]) {
            const bag = boxes[boxNum][bagSeq];
            
            // Log each bag to see what's missing
            console.log(`[Submit] Box ${boxNum} Bag ${bagSeq}:`, {
                tablet_type: bag.tablet_type || 'MISSING',
                bag_count: bag.bag_count || 'MISSING',
                flavor_bag_number: bag.flavor_bag_number || 'MISSING'
            });
            
            if (bag.tablet_type && bag.bag_count && bag.flavor_bag_number) {
                bagsArray.push({
                    tablet_type_id: parseInt(bag.tablet_type),
                    bag_count: parseInt(bag.bag_count),
                    bag_number: parseInt(bag.flavor_bag_number) // NEW: Use flavor-based bag number
                });
            } else {
                console.warn(`[Submit] SKIPPED Box ${boxNum} Bag ${bagSeq} - missing required data`);
            }
        }
        if (bagsArray.length > 0) {
            boxesArray.push({
                box_number: parseInt(boxNum),
                bags: bagsArray
            });
        }
    }
    
    // Debug logging
    console.log('[Submit] Form data collected:');
    console.log('[Submit] Total boxes found:', Object.keys(boxes).length);
    console.log('[Submit] Boxes object:', boxes);
    console.log('[Submit] BoxesArray (to be sent):', boxesArray);
    console.log('[Submit] Total boxes in array:', boxesArray.length);
    console.log('[Submit] Editing receive ID:', window.editingReceiveId || 'null (new receive)');
    
    if (boxesArray.length === 0) {
        alert('Please add at least one bag with tablet type and bag count.');
        return;
    }
    
    // Show warning if editing and box count seems wrong
    if (window.editingReceiveId) {
        const boxesInDOM = document.querySelectorAll('[id^="box-"]').length;
        console.log('[Submit] Boxes visible in DOM:', boxesInDOM);
        console.log('[Submit] Boxes being sent to server:', boxesArray.length);
        
        if (boxesArray.length < boxesInDOM) {
            if (!confirm(`‚ö†Ô∏è WARNING: Potential data loss!\n\nBoxes visible in form: ${boxesInDOM}\nBoxes being sent to server: ${boxesArray.length}\n\nSome boxes may be missing required data (tablet type, bag count, or flavor bag number).\n\nDo you want to continue anyway?`)) {
                return;
            }
        }
    }
    
    // Validate PO selection (now required)
    const poSelect = document.getElementById('po-select');
    const poId = poSelect ? poSelect.value || null : null;
    if (!poId) {
        alert('‚ö†Ô∏è Purchase Order is required. Please select a PO before submitting.');
        if (poSelect) {
            poSelect.focus();
            poSelect.classList.add('border-red-500', 'ring-2', 'ring-red-500');
            setTimeout(() => {
                poSelect.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
            }, 2000);
        }
        return;
    }
    
    try {
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';
        
        console.log('[Submit] Sending to server:', {
            boxes: boxesArray,
            po_id: poId,
            status: status,
            receiving_id: window.editingReceiveId || null
        });
        
        const response = await csrfFetch('/api/save_receives', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                boxes: boxesArray,
                po_id: poId ? parseInt(poId) : null,
                status: status,
                receiving_id: window.editingReceiveId || null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const isEditing = window.editingReceiveId;
            const action = isEditing ? 'Updated' : 'Saved';
            const statusMsg = status === 'draft' ? `üìù ${action} as DRAFT` : `‚úÖ ${action} & Published`;
            alert(`${statusMsg}\n\n${result.message}`);
            
            // Clear autosave after successful save
            clearAutosave();
            stopAutosave();
            console.log('[Submit] Autosave cleared after successful save');
            
            // Clear editing state AFTER successful save
            window.editingReceiveId = null;
            console.log('[Submit] CLEARED editingReceiveId after successful save');
            
            closeAddReceivesModal();
            location.reload();
        } else {
            alert('‚ùå Error: ' + (result.error || 'Failed to save receives'));
            // Don't clear editingReceiveId on error - user might retry
        }
        
        submitButton.disabled = false;
        submitButton.textContent = originalText;
    } catch (error) {
        alert('Error saving receives: ' + error.message);
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = false;
        submitButton.textContent = 'Save Receives';
    }
}

// Wrapper functions for different submit types
async function submitReceives(event) {
    return submitReceivesWithStatus(event, 'published');
}

async function saveReceivesDraft() {
    return submitReceivesWithStatus(null, 'draft');
}

function openAssignPOModal(receivingId, currentPoIdParam) {
    currentReceivingId = receivingId;
    currentPoId = currentPoIdParam;
    const select = document.getElementById('assign-po-select');
    if (select) {
        select.value = currentPoIdParam || '';
        document.getElementById('assign-po-modal').classList.remove('hidden');
    }
}

function closeAssignPOModal(event) {
    if (!event || event.target === event.currentTarget || event.target.closest('button')) {
        document.getElementById('assign-po-modal').classList.add('hidden');
        currentReceivingId = null;
        currentPoId = null;
    }
}

function openDeleteShipmentModal(receivingId, receivedDate, poNumber) {
    deleteShipmentId = receivingId;
    document.getElementById('delete-shipment-date').textContent = receivedDate;
    document.getElementById('delete-shipment-po').textContent = poNumber;
    document.getElementById('delete-confirm-checkbox').checked = false;
    document.getElementById('confirm-delete-btn').disabled = true;
    document.getElementById('delete-shipment-modal').classList.remove('hidden');
}

async function publishReceive(receivingId) {
    if (!confirm('‚úì Publish this receive?\n\nThis will make it LIVE and available for production submissions.')) {
        return;
    }
    
    try {
        const response = await csrfFetch(`/api/receiving/${receivingId}/publish`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ ' + result.message);
            location.reload();
        } else {
            alert('‚ùå Error: ' + result.error);
        }
    } catch (error) {
        alert('Error publishing receive: ' + error.message);
    }
}

async function unpublishReceive(receivingId) {
    if (!confirm('üìù Move this receive to DRAFT?\n\nIt will be hidden from production until published again.\n\nNote: This only works if no submissions exist for this receive yet.')) {
        return;
    }
    
    try {
        const response = await csrfFetch(`/api/receiving/${receivingId}/unpublish`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('üìù ' + result.message);
            location.reload();
        } else {
            alert('‚ùå Error: ' + result.error);
        }
    } catch (error) {
        alert('Error unpublishing receive: ' + error.message);
    }
}

async function editReceive(receivingId) {
    // Load receive data and populate form for editing
    try {
        // Show loading message
        if (!confirm(`üìù Edit Draft Receive\n\nLoading existing boxes and bags...\n\nThis will take a moment. Please wait for the form to fully load before making changes.\n\nClick OK to continue.`)) {
            return;
        }
        
        const response = await fetch(`/api/receiving/${receivingId}/editable`);
        const data = await response.json();
        
        if (!data.success) {
            alert('‚ùå Error loading receive: ' + data.error);
            return;
        }
        
        console.log(`[Edit Receive] Loading ${data.boxes.length} boxes with receive ID ${receivingId}`);
        
        // Open the modal
        document.getElementById('add-receives-modal').classList.remove('hidden');
        
        // Update modal title with box count
        const modalTitle = document.querySelector('#add-receives-modal h3');
        if (modalTitle) {
            modalTitle.textContent = `‚úèÔ∏è Edit Draft Receive - Loading ${data.boxes.length} Existing Boxes...`;
        }
        
        // Store editing ID globally
        window.editingReceiveId = receivingId;
        console.log('[Edit] SET editingReceiveId to:', receivingId);
        
        // Disable form during loading
        const form = document.getElementById('receives-form');
        const submitButtons = form.querySelectorAll('button[type="submit"], button[onclick*="saveReceivesDraft"]');
        submitButtons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        });
        
        // Clear existing boxes in form
        const boxesContainer = document.getElementById('boxes-container');
        boxesContainer.innerHTML = '';
        boxCounter = 0;
        flavorBagCounter = {};
        bagFlavorAssignments = {};
        
        // Set PO if assigned
        const poSelect = document.getElementById('po-select');
        if (poSelect && data.receive.po_id) {
            poSelect.value = data.receive.po_id;
            // Load max bag numbers for this PO
            await loadMaxBagNumbersForPO();
        }
        
        // Re-create each box with its bags
        let loadedBoxCount = 0;
        let loadedBagCount = 0;
        const totalBoxes = data.boxes.length;
        
        for (let i = 0; i < data.boxes.length; i++) {
            const boxData = data.boxes[i];
            console.log(`[Edit] Loading Box ${i + 1}/${totalBoxes} (Box #${boxData.box_number}) with ${boxData.bags.length} bags`);
            
            // Update progress in modal title
            if (modalTitle) {
                modalTitle.textContent = `‚úèÔ∏è Loading Box ${i + 1}/${totalBoxes}...`;
            }
            
            addBox();
            const currentBoxNumber = boxCounter;
            loadedBoxCount++;
            
            // Wait longer for box to be added to DOM
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Verify box was actually added
            const boxDiv = document.getElementById(`box-${currentBoxNumber}`);
            if (!boxDiv) {
                console.error(`[Edit] ERROR: Box ${currentBoxNumber} not added to DOM!`);
                alert(`‚ùå ERROR: Failed to create box ${currentBoxNumber}. Please refresh and try again.`);
                return;
            }
            
            // Clear auto-added first bag
            const bagsContainer = document.getElementById(`box-${currentBoxNumber}-bags`);
            if (bagsContainer) {
                bagsContainer.innerHTML = '';
                bagCounter[currentBoxNumber] = 0;
            } else {
                console.error(`[Edit] ERROR: Bags container for box ${currentBoxNumber} not found!`);
            }
            
            // Add each bag
            for (let j = 0; j < boxData.bags.length; j++) {
                const bagData = boxData.bags[j];
                console.log(`[Edit]   Loading Bag ${j + 1}/${boxData.bags.length} - Bag #${bagData.bag_number} (tablet_type: ${bagData.tablet_type_id}, count: ${bagData.bag_label_count})`);
                
                addBag(currentBoxNumber);
                const currentBagSequence = bagCounter[currentBoxNumber];
                loadedBagCount++;
                
                // Wait longer for bag to be added to DOM and converted
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // Verify bag was added
                const bagDiv = document.getElementById(`box-${currentBoxNumber}-bag-${currentBagSequence}`);
                if (!bagDiv) {
                    console.error(`[Edit] ERROR: Bag ${currentBagSequence} in Box ${currentBoxNumber} not added to DOM!`);
                    continue;
                }
                
                // Set values
                const tabletTypeSelect = document.getElementById(`box_${currentBoxNumber}_bag_${currentBagSequence}_tablet_type`);
                const bagCountInput = document.querySelector(`input[name="box_${currentBoxNumber}_bag_${currentBagSequence}_bag_count"]`);
                const flavorBagNumberInput = document.querySelector(`input[name="box_${currentBoxNumber}_bag_${currentBagSequence}_flavor_bag_number"]`);
                
                if (tabletTypeSelect && bagCountInput && flavorBagNumberInput) {
                    tabletTypeSelect.value = bagData.tablet_type_id;
                    bagCountInput.value = bagData.bag_label_count;
                    
                    // CRITICAL: Set the flavor bag number from database (required for form collection)
                    flavorBagNumberInput.value = bagData.bag_number;
                    console.log(`[Edit] Set flavor_bag_number for Box ${currentBoxNumber} Bag ${currentBagSequence}: ${bagData.bag_number}`);
                    
                    // Track this assignment to prevent re-incrementing
                    const bagId = `${currentBoxNumber}-${currentBagSequence}`;
                    bagFlavorAssignments[bagId] = bagData.tablet_type_id;
                    
                    // Update the flavor counter to match (so new bags continue correctly)
                    if (!flavorBagCounter[bagData.tablet_type_id] || flavorBagCounter[bagData.tablet_type_id] < bagData.bag_number) {
                        flavorBagCounter[bagData.tablet_type_id] = bagData.bag_number;
                    }
                    
                    // Update bag label to show correct number from database
                    updateBagLabel(currentBoxNumber, currentBagSequence, bagData.tablet_type_id, bagData.bag_number);
                    
                    // Wait then set dropdowns (after updating counters to prevent auto-increment)
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Wait for two-level conversion to complete
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // Find and set category/item dropdowns
                    const groupSelect = document.getElementById(tabletTypeSelect.id + '_group');
                    const itemSelect = document.getElementById(tabletTypeSelect.id + '_item');
                    
                    console.log(`[Edit] Setting dropdowns for Box ${currentBoxNumber} Bag ${currentBagSequence}`);
                    console.log(`[Edit]   Group select found:`, !!groupSelect);
                    console.log(`[Edit]   Item select found:`, !!itemSelect);
                    console.log(`[Edit]   Tablet type ID to set:`, bagData.tablet_type_id);
                    
                    if (groupSelect && itemSelect) {
                        const selectedOption = tabletTypeSelect.querySelector(`option[value="${bagData.tablet_type_id}"]`);
                        if (selectedOption) {
                            const optgroup = selectedOption.parentElement;
                            if (optgroup && optgroup.tagName === 'OPTGROUP') {
                                const categoryLabel = optgroup.label;
                                console.log(`[Edit]   Setting category:`, categoryLabel);
                                
                                groupSelect.value = categoryLabel;
                                groupSelect.dispatchEvent(new Event('change', { bubbles: true }));
                                
                                // Wait for items to populate
                                await new Promise(resolve => setTimeout(resolve, 200));
                                
                                console.log(`[Edit]   Setting item value:`, bagData.tablet_type_id);
                                itemSelect.value = bagData.tablet_type_id;
                                itemSelect.style.display = '';
                                
                                // CRITICAL: Ensure item select has the name attribute for FormData collection
                                // The convertToTwoLevelDropdown transfers name to itemSelect
                                // But verify it's there
                                console.log(`[Edit]   Item select name attribute:`, itemSelect.name);
                                if (!itemSelect.name || itemSelect.name === '') {
                                    console.warn(`[Edit]   WARNING: Item select has no name! Setting it now.`);
                                    itemSelect.name = tabletTypeSelect.name || `box_${currentBoxNumber}_bag_${currentBagSequence}_tablet_type`;
                                }
                                
                                // Verify item select has value
                                console.log(`[Edit]   Item select value after set:`, itemSelect.value);
                                
                                if (!itemSelect.value || itemSelect.value === '') {
                                    console.error(`[Edit]   ERROR: Item select value is empty after setting!`);
                                    // Force set it again
                                    itemSelect.value = bagData.tablet_type_id;
                                    console.log(`[Edit]   Forced item select value to:`, itemSelect.value);
                                }
                            }
                        } else {
                            console.error(`[Edit]   ERROR: Option with value ${bagData.tablet_type_id} not found in hidden select`);
                        }
                    } else {
                        console.error(`[Edit]   ERROR: Group or item select not found for bag`);
                    }
                }
            }
        }
        
        // Re-enable form after all boxes loaded
        submitButtons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
        
        // Verify all boxes are actually in the DOM
        const actualBoxCount = document.querySelectorAll('[id^="box-"]:not([id*="-bag-"])').length;
        const actualBagCount = document.querySelectorAll('[id*="-bag-"]').length;
        
        console.log(`[Edit] Expected to load: ${data.boxes.length} boxes`);
        console.log(`[Edit] Actually loaded: ${loadedBoxCount} boxes, ${loadedBagCount} bags`);
        console.log(`[Edit] In DOM: ${actualBoxCount} boxes`);
        
        // Update modal title to indicate ready
        if (modalTitle) {
            modalTitle.textContent = `‚úèÔ∏è Edit Draft Receive - ${loadedBoxCount} Boxes Loaded (${loadedBagCount} Bags)`;
        }
        
        // Verify data was loaded before allowing edits
        if (loadedBoxCount !== data.boxes.length) {
            alert(`‚ö†Ô∏è WARNING: Only loaded ${loadedBoxCount} of ${data.boxes.length} boxes!\n\nSomething went wrong during loading. Please close and try again.\n\nDO NOT SAVE or you will lose data!`);
            // Keep buttons disabled
            return;
        }
        
        console.log(`[Edit Receive] Successfully loaded ${loadedBoxCount} boxes with ${loadedBagCount} bags`);
        console.log(`[Edit Receive] Form is now ready for editing`);
        
        // Show success message with verification
        alert(`‚úÖ Successfully Loaded:\n‚Ä¢ ${loadedBoxCount} boxes\n‚Ä¢ ${loadedBagCount} bags\n\nYou can now add more boxes.\n\n‚ö†Ô∏è IMPORTANT: When you save, ALL ${loadedBoxCount} existing boxes + any new boxes will be saved.`);
        
    } catch (error) {
        alert('‚ùå Error loading receive for editing: ' + error.message);
        console.error(error);
        
        // Re-enable buttons on error
        const form = document.getElementById('receives-form');
        if (form) {
            const submitButtons = form.querySelectorAll('button[type="submit"], button[onclick*="saveReceivesDraft"]');
            submitButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }
    }
}

async function toggleReceiveClosed(receivingId, currentlyClosed) {
    const action = currentlyClosed ? 'reopen' : 'close';
    const confirmMsg = currentlyClosed 
        ? 'Are you sure you want to REOPEN this receive? It will become available for new submissions again.' 
        : 'Are you sure you want to CLOSE this receive? All bags in this receive will be marked as closed and will no longer accept new submissions.';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await csrfFetch(`/api/receiving/${receivingId}/close`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload(); // Reload to show updated status
        } else {
            alert('Error: ' + (data.error || 'Failed to update receive status'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update receive status');
    }
}

function closeDeleteShipmentModal(event) {
    if (!event || event.target === event.currentTarget || event.target.closest('button') && !event.target.closest('#confirm-delete-btn')) {
        document.getElementById('delete-shipment-modal').classList.add('hidden');
        deleteShipmentId = null;
        document.getElementById('delete-confirm-checkbox').checked = false;
        document.getElementById('confirm-delete-btn').disabled = true;
    }
}

// Enable delete button when checkbox is checked
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('delete-confirm-checkbox');
    const deleteBtn = document.getElementById('confirm-delete-btn');
    if (checkbox && deleteBtn) {
        checkbox.addEventListener('change', function() {
            deleteBtn.disabled = !this.checked;
        });
    }
});

async function confirmDeleteShipment() {
    if (!deleteShipmentId) {
        alert('Error: No shipment selected');
        return;
    }
    
    const checkbox = document.getElementById('delete-confirm-checkbox');
    if (!checkbox.checked) {
        alert('Please confirm that you understand this action cannot be undone');
        return;
    }
    
    const deleteBtn = document.getElementById('confirm-delete-btn');
    const originalText = deleteBtn.textContent;
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Deleting...';
    
    try {
        const response = await csrfFetch(`/api/receiving/${deleteShipmentId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('‚úÖ Shipment deleted successfully!');
            closeDeleteShipmentModal();
            location.reload();
        } else {
            alert('‚ùå Error: ' + (result.error || 'Failed to delete shipment'));
            deleteBtn.disabled = false;
            deleteBtn.textContent = originalText;
        }
    } catch (error) {
        alert('Error deleting shipment: ' + error.message);
        deleteBtn.disabled = false;
        deleteBtn.textContent = originalText;
    }
}

async function savePOAssignment() {
    if (!currentReceivingId) {
        alert('Error: No receiving record selected');
        return;
    }
    
    const select = document.getElementById('assign-po-select');
    const newPoId = select.value || null;
    
    // Validation: Check if PO is actually changing
    const currentPoIdStr = currentPoId ? String(currentPoId) : '';
    const newPoIdStr = newPoId ? String(newPoId) : '';
    
    if (currentPoIdStr === newPoIdStr) {
        alert('‚ö†Ô∏è No changes detected. The selected PO is already assigned to this receive.');
        return;
    }
    
    // Confirmation dialog
    const currentPoText = currentPoId ? `PO-${select.options[select.selectedIndex]?.text?.split('-')[1]?.trim() || currentPoId}` : 'No PO';
    const newPoText = newPoId ? select.options[select.selectedIndex]?.text || 'Unknown PO' : 'No PO';
    
    if (!confirm(`‚ö†Ô∏è Change PO Assignment?\n\nFrom: ${currentPoText === 'No PO' ? 'Unassigned' : currentPoText}\nTo: ${newPoText === 'No PO' ? 'Unassigned' : newPoText}\n\nThis may affect submission linking. Continue?`)) {
        return;
    }
    
    try {
        const response = await csrfFetch(`/api/receiving/${currentReceivingId}/assign_po`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                po_id: newPoId ? parseInt(newPoId) : null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ PO assignment updated successfully!');
            closeAssignPOModal();
            location.reload();
        } else {
            alert('‚ùå Error: ' + (result.error || 'Failed to update PO assignment'));
        }
    } catch (error) {
        alert('Error updating PO assignment: ' + error.message);
    }
}

// NOTE: viewReceiveDetails and closeReceiveDetailsModal are now defined globally in base.html
// with enhanced features: dual views (By Box / By Flavor), quick navigation, and deep-linking

// Submissions modal functions
let typeFilter = null;

async function viewPOSubmissions(poId, poName, inventoryItemId = null, receiveId = null, receiveName = null, bagId = null, boxNumber = null, bagNumber = null) {
    try {
        let data;
        let varietyPackDeductions = [];
        
        // If viewing a specific bag, use the bag-specific endpoint to include variety pack deductions
        if (bagId !== null) {
            const response = await fetch(`/api/bag/${bagId}/submissions`);
            data = await response.json();
            if (data.variety_pack_deductions) {
                varietyPackDeductions = data.variety_pack_deductions;
            }
        } else {
            const response = await fetch(`/api/po/${poId}/submissions`);
            data = await response.json();
        }
        
        if (!data.success) {
            alert('Error: ' + (data.error || 'Failed to load submissions'));
            return;
        }
        
        // Filter submissions by inventory_item_id if specified
        let filteredSubmissions = inventoryItemId 
            ? data.submissions.filter(sub => sub.inventory_item_id === inventoryItemId)
            : data.submissions;
        
        // For bag-specific view (using /api/bag endpoint), submissions are already filtered
        // For PO view, apply additional filtering if bag specified
        if (bagId === null && bagNumber !== null) {
            filteredSubmissions = filteredSubmissions.filter(sub => 
                sub.bag_id === bagId || 
                (sub.bag_id === null && sub.bag_number === bagNumber && 
                 (sub.box_number === boxNumber || sub.box_number === null || boxNumber === null))
            );
        }
        
        // Convert variety pack deductions to submission-like objects for display
        varietyPackDeductions.forEach(vpd => {
            filteredSubmissions.push({
                id: vpd.submission_id,
                product_name: vpd.product_name,
                employee_name: vpd.employee_name,
                submission_type: 'bottle',
                submission_date: vpd.submission_date || vpd.created_at,
                created_at: vpd.created_at,
                bottles_made: vpd.bottles_made,
                displays_made: vpd.displays_made,
                total_tablets: vpd.tablets_deducted,
                is_variety_pack_deduction: true,
                bag_id: vpd.bag_id,
                box_number: boxNumber,
                bag_number: bagNumber
            });
        });
        
        const allSubmissions = [...filteredSubmissions];
        
        // Apply type filter if specified
        if (typeFilter === 'machine') {
            filteredSubmissions = filteredSubmissions.filter(sub => (sub.submission_type || 'packaged') === 'machine');
        } else if (typeFilter === 'packaged_bag') {
            filteredSubmissions = filteredSubmissions.filter(sub => {
                const subType = sub.submission_type || 'packaged';
                return subType === 'packaged' || subType === 'bag';
            });
        }
        
        const displayProductName = filteredSubmissions.length > 0 ? filteredSubmissions[0].product_name : '';
        
        // Calculate totals for filter buttons
        let machineTotal = 0;
        let packagedBagTotal = 0;
        let machineCount = 0;
        let packagedBagCount = 0;
        
        filteredSubmissions.forEach(sub => {
            const total = sub.total_tablets || 0;
            const subType = sub.submission_type || 'packaged';
            
            if (subType === 'machine') {
                machineTotal += total;
                machineCount++;
            } else if (subType === 'packaged' || subType === 'bag') {
                packagedBagTotal += total;
                packagedBagCount++;
            }
        });
        
        const totals = {
            machine: machineTotal,
            packaged_bag: packagedBagTotal,
            total_count: filteredSubmissions.length
        };
        
        // Build modal HTML (abbreviated version - just shows list)
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeSubmissionsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            ${receiveId ? `
                                <button onclick="closeSubmissionsModal(); viewReceiveDetails(${receiveId}, '${receiveName}');" 
                                        class="text-white hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                                        title="Back to receive details">
                                    ‚Üê Back
                                </button>
                            ` : ''}
                            <div class="flex-1 ${receiveId ? 'text-center' : ''}">
                                ${(() => {
                                    // If viewing a specific bag, construct the full receive name: PO-receive-box-bag
                                    if (bagId !== null && boxNumber !== null && bagNumber !== null && receiveName) {
                                        // receiveName format is already PO-receive, so add box-bag
                                        const bagReceiveName = `${receiveName}-${boxNumber}-${bagNumber}`;
                                        return `<h3 class="text-xl font-bold">üìã Submissions for ${bagReceiveName}</h3>`;
                                    }
                                    // Otherwise use receiveName or poName
                                    return `<h3 class="text-xl font-bold">üìã Submissions for ${receiveId ? receiveName : poName}</h3>`;
                                })()}
                                ${displayProductName ? `<p class="text-sm text-blue-100 mt-1">üì¶ Product: ${displayProductName}</p>` : ''}
                                ${bagId !== null && boxNumber !== null && bagNumber !== null ? `<p class="text-sm text-blue-100 mt-1">üì¶ Box ${boxNumber}, Bag ${bagNumber}</p>` : ''}
                                <p class="text-sm text-blue-100 mt-1">${filteredSubmissions.length} submission(s) total</p>
                                <div class="mt-2 flex justify-center gap-4 flex-wrap">
                                    <button onclick="filterSubmissionsInModal('machine')" 
                                            class="bg-blue-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ${typeFilter === 'machine' ? 'ring-2 ring-blue-300' : ''}">
                                        <span class="text-xs text-blue-200">‚öôÔ∏è Machine:</span>
                                        <span class="text-sm font-semibold text-white ml-1">${totals.machine.toLocaleString()}</span>
                                    </button>
                                    <button onclick="filterSubmissionsInModal('packaged_bag')" 
                                            class="bg-purple-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ${typeFilter === 'packaged_bag' ? 'ring-2 ring-purple-300' : ''}">
                                        <span class="text-xs text-purple-200">üì¶ Packaged+Bag:</span>
                                        <span class="text-sm font-semibold text-white ml-1">${totals.packaged_bag.toLocaleString()}</span>
                                    </button>
                                    <button onclick="filterSubmissionsInModal('all')" 
                                            class="bg-green-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ${typeFilter === 'all' || !typeFilter ? 'ring-2 ring-green-300' : ''}">
                                        <span class="text-xs text-green-200">üìä Total:</span>
                                        <span class="text-sm font-semibold text-white ml-1">${totals.total_count} submissions</span>
                                    </button>
                                </div>
                            </div>
                            <button onclick="closeSubmissionsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">‚úï</button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
        `;
        
        if (filteredSubmissions.length === 0) {
            modalContent += `<div class="text-center py-12 text-gray-500"><div class="text-6xl mb-4">üì≠</div><p class="text-lg">No submissions found</p></div>`;
        } else {
            modalContent += '<div class="space-y-4">';
            
            filteredSubmissions.forEach(sub => {
                const submissionType = sub.submission_type || 'packaged';
                let typeBadge = submissionType === 'machine' ? 
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">‚öôÔ∏è Machine</span>' :
                    submissionType === 'bag' ?
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">üìã Bag Count</span>' :
                    submissionType === 'bottle' ?
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">üçæ Bottle</span>' :
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">üì¶ Packaged</span>';
                
                // Add variety pack indicator if applicable
                if (sub.is_variety_pack_deduction) {
                    typeBadge += ' <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800">üé® Variety Pack</span>';
                }
                
                modalContent += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors" onclick="event.stopPropagation(); viewSubmissionDetails(${sub.id})">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-medium text-gray-900">${sub.product_name}</h4>
                                    ${typeBadge}
                                </div>
                                <p class="text-sm text-gray-600">üë§ ${sub.employee_name || 'Unknown'} ‚Ä¢ üì¶ Bag: ${sub.bag_number || ''}${sub.box_number ? ' (Box ' + sub.box_number + ')' : ''}</p>
                            </div>
                            <div class="text-right text-sm">
                                <div class="text-gray-600">üìÖ ${sub.submission_date || sub.created_at || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-3 rounded">
                            ${submissionType === 'machine' ? `
                                <div><div class="text-xs text-gray-500">Turns</div><div class="font-medium text-blue-600">${sub.displays_made || 0}</div></div>
                                <div><div class="text-xs text-gray-500">Cards Made</div><div class="font-medium text-blue-600">${sub.packs_remaining || 0}</div></div>
                            ` : submissionType === 'bottle' ? `
                                <div><div class="text-xs text-gray-500">Displays Made</div><div class="font-medium text-amber-600">${sub.displays_made || 0}</div></div>
                                <div><div class="text-xs text-gray-500">Bottles Made</div><div class="font-medium text-amber-600">${sub.bottles_made || 0}</div></div>
                            ` : `
                                <div><div class="text-xs text-gray-500">Displays Made</div><div class="font-medium text-blue-600">${sub.displays_made || 0}</div></div>
                                <div><div class="text-xs text-gray-500">Cards Remaining</div><div class="font-medium text-blue-600">${sub.packs_remaining || 0}</div></div>
                            `}
                        </div>
                        <div class="mt-3 flex justify-center">
                            <div class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full">
                                <span class="font-semibold text-base">Total: ${(sub.total_tablets || 0).toLocaleString()} tablets</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalContent += '</div>';
        }
        
        modalContent += `</div></div></div>`;
        
        const modalDiv = document.createElement('div');
        modalDiv.id = 'submissions-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
        // Store data for filtering
        window.currentSubmissionsData = {
            allSubmissions: allSubmissions,
            filteredSubmissions: filteredSubmissions,
            poId: poId,
            poName: poName,
            inventoryItemId: inventoryItemId,
            receiveId: receiveId,
            receiveName: receiveName,
            bagId: bagId,
            boxNumber: boxNumber,
            bagNumber: bagNumber,
            totals: totals,
            displayProductName: displayProductName
        };
        
    } catch (error) {
        console.error('Error loading submissions:', error);
        alert('Failed to load submissions: ' + error.message);
    }
}

function closeSubmissionsModal(event) {
    if (!event || event.target === event.currentTarget || !event) {
        const modal = document.getElementById('submissions-modal');
        if (modal) {
            modal.remove();
        }
        window.currentSubmissionsData = null;
    }
}

function filterSubmissionsInModal(filterType) {
    if (!window.currentSubmissionsData) {
        return;
    }
    
    const data = window.currentSubmissionsData;
    let filtered = [...data.allSubmissions];
    
    // Apply filter by bag_id first (if specified)
    // UPDATED: Handle flavor-based submissions where box_number might be NULL
    if (data.bagId !== null && data.bagNumber !== null) {
        filtered = filtered.filter(sub => 
            sub.bag_id === data.bagId || 
            (sub.bag_id === null && sub.bag_number === data.bagNumber && 
             (sub.box_number === data.boxNumber || sub.box_number === null || data.boxNumber === null))
        );
    }
    
    // Apply type filter
    if (filterType === 'machine') {
        filtered = filtered.filter(sub => (sub.submission_type || 'packaged') === 'machine');
    } else if (filterType === 'packaged_bag') {
        filtered = filtered.filter(sub => {
            const subType = sub.submission_type || 'packaged';
            return subType === 'packaged' || subType === 'bag';
        });
    }
    // 'all' shows all submissions (already filtered by bag if applicable)
    
    // Update submission count
    const countElement = document.querySelector('#submissions-modal .text-blue-100');
    if (countElement && countElement.textContent.includes('submission(s) total')) {
        countElement.textContent = `${filtered.length} submission(s) total`;
    }
    
    // Rebuild submission cards
    const contentArea = document.querySelector('#submissions-modal .p-6');
    if (!contentArea) return;
    
    if (filtered.length === 0) {
        contentArea.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4">üì≠</div>
                <p class="text-lg">No submissions found for this filter</p>
            </div>
        `;
        return;
    }
    
    let submissionsHTML = '<div class="space-y-4">';
    
    filtered.forEach(sub => {
        const submissionType = sub.submission_type || 'packaged';
        let typeBadge = submissionType === 'machine' ? 
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">‚öôÔ∏è Machine</span>' :
            submissionType === 'bag' ?
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">üìã Bag Count</span>' :
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">üì¶ Packaged</span>';
        
        submissionsHTML += `
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors" onclick="event.stopPropagation(); viewSubmissionDetails(${sub.id})">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h4 class="font-medium text-gray-900">${sub.product_name}</h4>
                            ${typeBadge}
                        </div>
                        <p class="text-sm text-gray-600">üë§ ${sub.employee_name || 'Unknown'} ‚Ä¢ üì¶ Bag: ${sub.box_number || ''}/${sub.bag_number || ''}</p>
                    </div>
                    <div class="text-right text-sm">
                        <div class="text-gray-600">üìÖ ${sub.submission_date || sub.created_at || 'N/A'}</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-3 rounded">
                    ${submissionType === 'machine' ? `
                        <div><div class="text-xs text-gray-500">Turns</div><div class="font-medium text-blue-600">${sub.displays_made || 0}</div></div>
                        <div><div class="text-xs text-gray-500">Cards Made</div><div class="font-medium text-blue-600">${sub.packs_remaining || 0}</div></div>
                    ` : `
                        <div><div class="text-xs text-gray-500">Displays Made</div><div class="font-medium text-blue-600">${sub.displays_made || 0}</div></div>
                        <div><div class="text-xs text-gray-500">Cards Remaining</div><div class="font-medium text-blue-600">${sub.packs_remaining || 0}</div></div>
                    `}
                </div>
                <div class="mt-3 flex justify-center">
                    <div class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full">
                        <span class="font-semibold text-base">Total: ${(sub.total_tablets || 0).toLocaleString()} tablets</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    submissionsHTML += '</div>';
    contentArea.innerHTML = submissionsHTML;
    
    // Update filter button states
    const buttons = document.querySelectorAll('#submissions-modal button[onclick^="filterSubmissionsInModal"]');
    buttons.forEach(btn => {
        const onclick = btn.getAttribute('onclick');
        if (onclick.includes("'machine'")) {
            btn.className = filterType === 'machine' 
                ? 'bg-blue-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ring-2 ring-blue-300'
                : 'bg-blue-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all';
        } else if (onclick.includes("'packaged_bag'")) {
            btn.className = filterType === 'packaged_bag'
                ? 'bg-purple-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ring-2 ring-purple-300'
                : 'bg-purple-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all';
        } else if (onclick.includes("'all'")) {
            btn.className = filterType === 'all' || !filterType
                ? 'bg-green-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all ring-2 ring-green-300'
                : 'bg-green-800 bg-opacity-50 hover:bg-opacity-70 px-3 py-1 rounded cursor-pointer transition-all';
        }
    });
}

// Tab switching function
function switchReceivingTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active styling from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    const selectedContent = document.getElementById(`content-${tabName}`);
    if (selectedContent) {
        selectedContent.classList.remove('hidden');
    }
    
    // Add active styling to selected tab
    const selectedTab = document.getElementById(`tab-${tabName}`);
    if (selectedTab) {
        selectedTab.classList.remove('border-transparent', 'text-gray-500');
        selectedTab.classList.add('border-blue-500', 'text-blue-600');
    }
}

// Toggle PO collapse/expand
function togglePOCollapse(poId) {
    const contentDiv = document.getElementById(poId);
    const iconSvg = document.getElementById(`icon-${poId}`);
    
    if (!contentDiv || !iconSvg) return;
    
    if (contentDiv.classList.contains('hidden')) {
        // Expand
        contentDiv.classList.remove('hidden');
        iconSvg.classList.remove('rotate-0');
        iconSvg.classList.add('rotate-180');
        
        // When expanding PO, keep closed shipments collapsed
        // Find all shipments within this PO that are closed
        const shipmentDivs = contentDiv.querySelectorAll('[id^="shipment-"]');
        shipmentDivs.forEach(shipmentDiv => {
            const shipmentId = shipmentDiv.id;
            const shipmentCard = shipmentDiv.closest('.card');
            if (shipmentCard) {
                // Check if shipment has CLOSED badge by looking for span with CLOSED text
                const hasClosedBadge = Array.from(shipmentCard.querySelectorAll('span')).some(span => 
                    span.textContent.includes('üîí CLOSED') || span.textContent.includes('CLOSED')
                );
                
                // If shipment is closed, ensure it stays collapsed
                if (hasClosedBadge) {
                    shipmentDiv.classList.add('hidden');
                    const shipmentIcon = document.getElementById(`icon-${shipmentId}`);
                    if (shipmentIcon) {
                        shipmentIcon.classList.remove('rotate-180');
                        shipmentIcon.classList.add('rotate-0');
                    }
                }
            }
        });
    } else {
        // Collapse
        contentDiv.classList.add('hidden');
        iconSvg.classList.remove('rotate-180');
        iconSvg.classList.add('rotate-0');
    }
}

// Toggle shipment collapse/expand
function toggleShipmentCollapse(shipmentId) {
    const contentDiv = document.getElementById(shipmentId);
    const iconSvg = document.getElementById(`icon-${shipmentId}`);
    
    if (!contentDiv || !iconSvg) return;
    
    if (contentDiv.classList.contains('hidden')) {
        // Expand
        contentDiv.classList.remove('hidden');
        iconSvg.classList.remove('rotate-0');
        iconSvg.classList.add('rotate-180');
    } else {
        // Collapse
        contentDiv.classList.add('hidden');
        iconSvg.classList.remove('rotate-180');
        iconSvg.classList.add('rotate-0');
    }
}
</script>
{% endblock %}
