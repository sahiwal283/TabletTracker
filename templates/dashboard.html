{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<!-- Overview Section (Full Width, Compact) -->
<div class="card hover-lift p-6 mb-8">
    <div class="flex items-center mb-5">
        <svg class="w-7 h-7 mr-3" aria-hidden="true"><use href="#icon-chart" /></svg>
        <h3 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Overview</h3>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: PO Stats (2x2 Grid) -->
        <div class="grid grid-cols-2 gap-3 content-start">
            <div class="bg-blue-50 rounded-lg p-3 text-center">
                <div class="text-xs text-gray-600 mb-1">üîÑ Active POs</div>
                <div class="text-2xl font-bold text-blue-600">{{ active_pos|length }}</div>
            </div>
            <div class="bg-yellow-50 rounded-lg p-3 text-center">
                <div class="text-xs text-gray-600 mb-1">üìù Draft POs</div>
                <div class="text-2xl font-bold text-yellow-600">{{ stats.draft_pos }}</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3 text-center">
                <div class="text-xs text-gray-600 mb-1">‚õî Closed POs</div>
                <div class="text-2xl font-bold text-gray-600">{{ stats.closed_pos }}</div>
            </div>
            <div class="bg-indigo-50 rounded-lg p-3 text-center">
                <div class="text-xs text-gray-600 mb-1">üìä Remaining</div>
                <div class="text-lg font-bold text-blue-600">{{ "{:,}".format(stats.total_remaining) }}</div>
            </div>
        </div>
        
        <!-- Middle: PO Verification -->
        <div class="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg p-4 border-l-4 border-orange-500">
            <div class="flex items-center mb-3">
                <span class="text-xl mr-2">‚ö†Ô∏è</span>
                <h4 class="text-sm font-bold text-orange-600">PO Verification</h4>
            </div>
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="text-3xl font-bold text-orange-600">{{ verification_count }}</div>
                    <div class="text-xs text-gray-600">need verification</div>
                </div>
                <a href="/submissions" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg font-medium hover:from-orange-600 hover:to-red-600 transition-all shadow-lg text-xs whitespace-nowrap">
                    üîç Review
                </a>
            </div>
            <p class="text-xs text-gray-600 text-center">
                Click "Change" to verify or reassign
            </p>
        </div>
        
        <!-- Right: Zoho Setup Notice -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h4 class="text-xs font-bold text-blue-900 mb-1">üìã Zoho PO Setup</h4>
                    <p class="text-xs text-blue-800">
                        POs must be marked as <strong>"Tablets"</strong> in Zoho Books. 
                        Check <strong class="bg-blue-100 px-1 py-0.5 rounded">‚òë Tablets?</strong> on each PO before syncing.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Production Report Section -->
<div class="card hover-lift p-5 mb-8 max-w-xl mx-auto">
    <div class="flex items-center mb-3">
        <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-document" /></svg>
        <h3 class="text-lg font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Production Reports</h3>
    </div>
    
    <div class="space-y-2">
        <div>
            <label for="report_type_selector" class="block text-xs font-medium text-gray-700 mb-1">Report Type</label>
            <select id="report_type_selector" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="vendor" selected>Vendor Report</option>
                <option value="production">Production Report</option>
            </select>
            <p class="text-xs text-gray-500 mt-0.5">Select report type</p>
        </div>
        
        <div>
            <label for="po_selector" class="block text-xs font-medium text-gray-700 mb-1">Select Purchase Order</label>
            <select id="po_selector" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select a PO...</option>
            </select>
            <p class="text-xs text-gray-500 mt-0.5">Select a PO to generate its detailed report (optional for vendor report)</p>
        </div>
        
        <button onclick="generatePOReport()" id="generate-report-btn"
                class="btn-primary w-full py-2 text-sm font-semibold transform transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
            <span class="flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-download" /></svg>
                <span id="generate-report-btn-text">Generate Vendor Report</span>
            </span>
        </button>
        
        <div class="text-center pt-1">
            <button onclick="generateAllPOsReport()" id="generate-all-btn"
                    class="btn-secondary text-xs px-3 py-1.5 transform transition-all duration-300 hover:scale-105">
                <span class="flex items-center justify-center">
                    <svg class="w-3.5 h-3.5 mr-1.5" aria-hidden="true"><use href="#icon-list" /></svg>
                    Generate All POs Report
                </span>
            </button>
        </div>
    </div>
</div>

<!-- Purchase Orders Table -->
<div class="card hover-lift">
    <div class="px-8 py-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <span class="text-3xl mr-4">üìã</span>
                <h3 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Active Purchase Orders</h3>
                <span class="ml-3 text-sm text-gray-500">(with submissions, last {{ active_pos|length }})</span>
            </div>
            <a href="/purchase_orders" class="btn-primary px-4 py-2 text-sm font-medium">
                üì¶ View All POs
            </a>
        </div>
    </div>
    <div class="max-h-96 overflow-y-auto">
        <table class="w-full divide-y divide-gray-200 text-xs">
            <thead class="bg-gray-50 sticky top-0 z-10">
                <tr>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        PO #
                    </th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Type
                    </th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                        Ord
                    </th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                        Good
                    </th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                        Dmg
                    </th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                        Rem/Over
                    </th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                        Progress
                    </th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                        Status
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for po in active_pos %}
                <tr class="hover:bg-gray-100 cursor-pointer po-row" data-po-index="{{ loop.index }}" data-po-id="{{ po.id }}" onclick="viewPODetailsModal({{ po.id }}, '{{ po.po_number }}')">
                    <td class="px-2 py-2 font-medium text-gray-900">
                        {{ po.po_number }}
                    </td>
                    <td class="px-2 py-2 text-gray-500 max-w-xs">
                        <div class="truncate" title="{{ po.tablet_type or 'N/A' }}">
                            {{ po.tablet_type or 'N/A' }}
                        </div>
                    </td>
                    <td class="px-2 py-2 text-center text-gray-500">
                        {{ "{:,}".format(po.ordered_quantity) if po.ordered_quantity else '0' }}
                    </td>
                    <td class="px-2 py-2 text-center text-green-600">
                        {{ "{:,}".format(po.current_good_count) if po.current_good_count else '0' }}
                    </td>
                    <td class="px-2 py-2 text-center text-red-600">
                        {{ "{:,}".format(po.current_damaged_count) if po.current_damaged_count else '0' }}
                    </td>
                    <td class="px-2 py-2 text-center {% if po.remaining_quantity < 0 %}text-purple-600{% else %}text-blue-600{% endif %}">
                        {% if po.remaining_quantity < 0 %}
                            +{{ "{:,}".format(po.remaining_quantity|abs) }}
                        {% else %}
                            {{ "{:,}".format(po.remaining_quantity) if po.remaining_quantity else '0' }}
                        {% endif %}
                    </td>
                    <td class="px-2 py-2">
                        {% set total_received = (po.current_good_count or 0) + (po.current_damaged_count or 0) %}
                        {% set ordered = po.ordered_quantity or 0 %}
                        {% if ordered > 0 %}
                            {% set progress_percent = ((total_received / ordered) * 100) | round(1) %}
                            <div class="flex items-center justify-center">
                                <div class="w-16 bg-gray-200 rounded-full h-1.5 mr-1">
                                    <div class="bg-blue-600 h-1.5 rounded-full" style="width: {{ [progress_percent, 100]|min }}%"></div>
                                </div>
                                <span class="text-xs font-medium text-gray-700 whitespace-nowrap">{{ progress_percent }}%</span>
                            </div>
                        {% else %}
                            <span class="text-xs text-gray-400">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-2 py-2 text-center">
                        {% if po.status_display == 'Complete' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-800">
                                ‚úÖ
                            </span>
                        {% elif po.status_display == 'Closed' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-gray-100 text-gray-800">
                                üîí
                            </span>
                        {% elif po.status_display == 'Reconciled' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-800">
                                üìã
                            </span>
                        {% elif po.status_display == 'Ready for Payment' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-orange-100 text-orange-800">
                                üí∞
                            </span>
                        {% elif po.status_display == 'Processing' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-800">
                                ‚öôÔ∏è
                            </span>
                        {% elif po.status_display == 'Received' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-teal-100 text-teal-800">
                                üì¶
                            </span>
                        {% elif po.status_display == 'Partially Received' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-yellow-100 text-yellow-800">
                                üì¶
                            </span>
                        {% elif po.status_display == 'Shipped' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-indigo-100 text-indigo-800">
                                üöö
                            </span>
                        {% elif po.status_display == 'Draft' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-gray-100 text-gray-600">
                                üìù
                            </span>
                        {% elif po.status_display == 'Issued' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-800">
                                üì§
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-gray-100 text-gray-800">
                                ‚Ä¢
                            </span>
                        {% endif %}
                    </td>
                </tr>
                <!-- Details row - will be shown in modal -->
                <tr id="details-{{ po.id }}" class="hidden" style="display: none;">
                    <td colspan="8"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Recent Submissions Table -->
<div class="card hover-lift mt-10">
    <div class="px-8 py-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <div class="flex items-center cursor-pointer hover:bg-gray-50" onclick="toggleRecentSubmissions()">
                <span class="text-3xl mr-4">üìù</span>
                <h3 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">Recent Submissions</h3>
                <span class="ml-3 text-sm text-gray-500">(last {{ submissions|length }})</span>
                <span id="submissions-toggle-icon" class="ml-3 text-gray-500 transform transition-transform rotate-90">‚ñ∂</span>
            </div>
            <a href="/submissions" class="btn-primary px-4 py-2 text-sm font-medium">
                üìã View All Submissions
            </a>
        </div>
    </div>
    <div id="recent-submissions-content" class="max-h-96 overflow-y-auto">
        <table class="w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50 sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Time
                    </th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Employee
                    </th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Product
                    </th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Box/Bag
                    </th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Disp
                    </th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Cards
                    </th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Loose
                    </th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Dmg
                    </th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Total
                    </th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        Bag Check
                    </th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        PO
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for sub in submissions %}
                <tr class="submissions-row {% if not sub.po_verified %}bg-orange-50 border-l-4 border-orange-400{% else %}hover:bg-gray-50{% endif %}" 
                    data-po-closed="{{ 'true' if sub.po_closed else 'false' }}">
                    <td class="px-3 py-2 text-xs text-gray-500">
                        {{ sub.created_at|to_est_time if sub.created_at else 'N/A' }}
                    </td>
                    <td class="px-3 py-2 text-xs text-gray-900">
                        <div class="flex items-center gap-1">
                            {{ sub.employee_name }}
                            {% if sub.admin_notes and (session.get('employee_role') in ['admin', 'manager'] or session.get('admin_authenticated')) %}
                            <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700 cursor-pointer hover:bg-purple-200 transition-colors" 
                                  title="Click to view admin notes"
                                  data-admin-notes="{{ sub.admin_notes|e }}"
                                  onclick="event.stopPropagation(); showAdminNotes(this.getAttribute('data-admin-notes'));">
                                üìù
                            </span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-3 py-2 text-xs text-gray-500">
                        {{ sub.product_name }}
                    </td>
                    <td class="px-2 py-2 text-xs text-gray-500 text-center">
                        {{ sub.box_number }}/{{ sub.bag_number }}
                    </td>
                    <td class="px-2 py-2 text-xs text-gray-500 text-center">
                        {{ sub.displays_made }}
                    </td>
                    <td class="px-2 py-2 text-xs text-gray-500 text-center">
                        {{ sub.packs_remaining }}
                    </td>
                    <td class="px-2 py-2 text-xs text-gray-500 text-center">
                        {{ sub.loose_tablets }}
                    </td>
                    <td class="px-2 py-2 text-xs text-red-600 text-center">
                        {{ sub.damaged_tablets }}
                    </td>
                    <td class="px-2 py-2 text-xs font-semibold text-gray-900 text-center">
                        {{ sub.individual_calc }}
                    </td>
                    <td class="px-3 py-2 text-xs">
                        {% if sub.count_status == 'no_bag' %}
                            <span class="text-gray-400">No Bag</span>
                        {% else %}
                            <div class="{% if sub.count_status == 'match' %}text-green-600{% elif sub.count_status == 'under' %}text-yellow-600{% else %}text-red-600{% endif %} font-medium">
                                <div>{{ sub.box_number }}/{{ sub.bag_number }}</div>
                                <div>Ct: {{ sub.bag_label_count }}</div>
                                <div class="font-semibold">Run: {{ sub.running_total }}</div>
                                {% if sub.count_status == 'match' %}
                                    <div class="font-bold">‚úì Match</div>
                                {% elif sub.count_status == 'under' %}
                                    <div class="font-bold">‚ö†Ô∏è Under</div>
                                {% else %}
                                    <div class="font-bold">‚ùå Over</div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-xs">
                        {% if sub.po_number %}
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-1">
                                    <span class="font-medium text-blue-600">{{ sub.po_number }}</span>
                                    {% if sub.po_closed %}
                                        <span class="text-xs text-gray-600">üîí</span>
                                    {% else %}
                                        <span class="text-xs text-green-600">‚úì</span>
                                    {% endif %}
                                </div>
                                {% if sub.po_verified %}
                                    <span class="text-xs text-green-600 font-semibold">‚úì Verified</span>
                                {% else %}
                                    <div class="flex items-center gap-1">
                                        <button onclick="approveSubmission({{ sub.id }})" 
                                                class="text-xs bg-green-600 hover:bg-green-700 text-white px-1.5 py-0.5 rounded"
                                                title="Approve">
                                            ‚úì
                                        </button>
                                        <button onclick="openReassignModal({{ sub.id }}, '{{ sub.po_number }}', '{{ sub.product_name }}')" 
                                                class="text-xs text-blue-600 hover:text-blue-800 underline"
                                                title="Change">
                                            Change
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="flex flex-col gap-1">
                                <span class="text-gray-400 italic text-xs">Unassigned</span>
                                <button onclick="openReassignModal({{ sub.id }}, null, '{{ sub.product_name }}')" 
                                        class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-1.5 py-0.5 rounded"
                                        title="Assign to PO">
                                    Assign
                                </button>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Closed POs removed - view all POs on dedicated page -->

<!-- Data Management (moved to bottom) -->
<div class="card hover-lift p-5 mt-8 max-w-3xl mx-auto">
    <div class="flex items-center mb-4">
        <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-bolt" /></svg>
        <h3 class="text-lg font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">Data Management</h3>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <button id="sync-pos-btn" 
                class="btn-success py-2.5 text-sm font-semibold transform transition-all duration-300 hover:scale-105">
            <span class="flex items-center justify-center">
                <span class="text-lg mr-2">üîÑ</span>
                SYNC ZOHO POs
            </span>
        </button>
        <button onclick="recalculatePOCounts()" 
                class="btn-primary py-2.5 text-sm font-semibold transform transition-all duration-300 hover:scale-105"
                title="Recalculate PO counts from current submissions WITHOUT changing any assignments. Safe to run anytime!">
            <span class="flex items-center justify-center">
                <span class="text-base mr-1">üî¢</span>
                Recalculate Counts
            </span>
        </button>
        <button onclick="reassignAllSubmissions()" 
                class="btn-warning py-2.5 text-sm font-semibold transform transition-all duration-300 hover:scale-105"
                title="‚ö†Ô∏è WARNING: Reassign ALL submissions to POs using correct order. This will clear all current assignments!">
            <span class="flex items-center justify-center">
                <span class="text-base mr-1">üîÑ</span>
                Reassign All
            </span>
        </button>
        <button onclick="clearPOData()" 
                class="btn-warning py-2.5 text-sm font-semibold transform transition-all duration-300 hover:scale-105"
                title="Deletes all synced PO data and resets counts to zero. Use this to start fresh or fix sync issues.">
            <span class="flex items-center justify-center">
                <span class="text-base mr-1">üóëÔ∏è</span>
                Clear PO Data
            </span>
        </button>
    </div>
    <p class="text-xs text-gray-500 mt-3 text-center">
        <strong>Clear PO Data:</strong> Start fresh testing ‚Ä¢ Fix corrupted sync data ‚Ä¢ Reset all counts to zero
    </p>
</div>

<!-- Small Shipments Link -->
<div class="mt-6 text-center">
    <a href="/admin/shipments" class="text-xs text-gray-500 hover:text-gray-700 underline">
        Manage All Shipments
    </a>
</div>

<script>
// Define syncZohoPOs function early to ensure it's available
async function syncZohoPOs() {
    const button = document.getElementById('sync-pos-btn');
    if (!button) {
        console.error('Sync button not found');
        return;
    }
    const originalText = button.textContent;
    try {
        button.disabled = true;
        button.style.opacity = '0.7';
        button.textContent = 'üîÑ SYNCING...';
        
        const response = await fetch('/api/sync_zoho_pos');
        
        if (!response.ok) {
            let errorMessage = `Sync failed with status ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
            } catch (e) {
                errorMessage = await response.text() || errorMessage;
            }
            if (typeof showError === 'function') {
                showError(errorMessage);
            } else {
                alert('Error: ' + errorMessage);
            }
            return;
        }
        
        const result = await response.json();
        
        if (result.success) {
            if (typeof showSuccess === 'function') {
                showSuccess(result.message);
            } else {
                alert('Success: ' + result.message);
            }
            setTimeout(() => location.reload(), 2000);
        } else {
            if (typeof showError === 'function') {
                showError(result.error || 'Sync failed - check terminal for details');
            } else {
                alert('Error: ' + (result.error || 'Sync failed'));
            }
        }
    } catch (error) {
        console.error('Sync error:', error);
        if (typeof showError === 'function') {
            showError('Sync failed: ' + (error.message || 'Unknown error'));
        } else {
            alert('Sync failed: ' + (error.message || 'Unknown error'));
        }
    } finally {
        if (button) {
            button.disabled = false;
            button.style.opacity = '1';
            button.textContent = originalText;
        }
    }
}

// Make it globally available
window.syncZohoPOs = syncZohoPOs;

async function findOrgId() {
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'üîç Searching...';
        
        const response = await fetch('/api/find_org_id');
        const result = await response.json();
        
        if (result.success) {
            let message = 'Found organizations:\n\n';
            result.organizations.forEach(org => {
                message += `Name: ${org.name}\n`;
                message += `ID: ${org.organization_id}\n`;
                message += `Currency: ${org.currency_code || 'N/A'}\n\n`;
            });
            message += 'Copy the organization_id you want to use into your .env file!';
            alert(message);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Org ID search failed: ' + error.message);
        event.target.disabled = false;
        event.target.textContent = 'üîç Find Correct Org ID';
    }
}

async function clearPOData() {
    if (!confirm('Are you sure you want to clear all PO data? This will remove all synced POs and line items.')) {
        return;
    }
    
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'üóëÔ∏è Clearing...';
        
        const response = await fetch('/api/clear_po_data', {method: 'POST'});
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Clear failed: ' + error.message);
        event.target.disabled = false;
        event.target.textContent = 'üóëÔ∏è Clear PO Data';
    }
}

async function testZohoConnection() {
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Testing...';
        
        const response = await fetch('/api/test_zoho_connection');
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Connection test failed: ' + error.message);
        event.target.disabled = false;
        event.target.textContent = 'Test Zoho Connection';
    }
}


async function togglePODetails(poId, button) {
    const detailsRow = document.getElementById(`details-${poId}`);
    const detailsContent = document.getElementById(`details-content-${poId}`);
    
    if (detailsRow.classList.contains('hidden') || detailsRow.style.display === 'none') {
        // Show details
        button.textContent = '‚ñ≤ Hide Details';
        detailsRow.classList.remove('hidden');
        detailsRow.style.display = '';
        
        try {
            const response = await fetch(`/api/po_lines/${poId}`);
            const lines = await response.json();
            
            if (lines.length === 0) {
                detailsContent.innerHTML = '<div class="text-gray-500 italic">No line items found</div>';
            } else {
                let html = '<div class="space-y-2">';
                html += '<h4 class="font-medium text-gray-900 mb-3">üì¶ Line Items:</h4>';
                
                lines.forEach(line => {
                    const remaining = line.quantity_ordered - line.good_count - line.damaged_count;
                    const received = line.good_count + line.damaged_count;
                    const progressPercent = line.quantity_ordered > 0 ? ((received / line.quantity_ordered) * 100).toFixed(1) : 0;
                    const isOver = remaining < 0;
                    const displayValue = Math.abs(remaining);
                    const labelText = isOver ? 'Overs:' : 'Remaining:';
                    const labelColor = isOver ? 'text-purple-600' : 'text-blue-600';
                    
                html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-3 hover:bg-blue-50 cursor-pointer transition-colors duration-200" 
                         onclick="viewPOSubmissions(${poId}, 'PO-${poId}', '${line.inventory_item_id}')"
                         title="Click to view submissions for this product">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${line.line_item_name}</div>
                                <div class="text-xs text-gray-500 font-mono">ID: ${line.inventory_item_id}</div>
                                
                                <!-- Progress bar for this line item -->
                                <div class="mt-2 flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">${progressPercent}%</span>
                                </div>
                            </div>
                            
                            <div class="text-right ml-4">
                                <div class="text-sm">
                                    <span class="text-gray-600">Ordered:</span> 
                                    <span class="font-medium">${line.quantity_ordered.toLocaleString()}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-green-600">Good:</span> ${line.good_count.toLocaleString()} | 
                                    <span class="text-red-600">Damaged:</span> ${line.damaged_count.toLocaleString()}
                                </div>
                                <div class="text-sm">
                                    <span class="${labelColor}">${labelText}</span> 
                                    <span class="font-medium">${displayValue.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
                                
                                                // Add inline tracking info section
                html += `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <button onclick="toggleShippingDetails(${poId})" class="font-medium text-gray-900 hover:text-blue-600 cursor-pointer">üöö Shipping</button>
                            <div id="tracking-header-${poId}" class="text-sm">Loading...</div>
                        </div>
                        
                        <!-- Detailed shipping info (hidden by default) -->
                        <div id="shipping-details-${poId}" class="hidden mt-3 bg-white rounded border p-3 space-y-2 text-sm">
                            <div id="shipping-details-content-${poId}">Loading detailed shipping info...</div>
                        </div>
                        
                        <!-- Tracking edit form (hidden by default) -->
                        <div id="tracking-edit-${poId}" class="hidden mt-3 bg-gray-50 rounded-lg p-3 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="tracking-num-${poId}" placeholder="Tracking Number" class="text-sm px-3 py-2 border border-gray-300 rounded">
                                <select id="carrier-${poId}" class="text-sm px-3 py-2 border border-gray-300 rounded">
                                    <option value="">Select Carrier</option>
                                    <option value="FedEx">FedEx</option>
                                    <option value="UPS">UPS</option>
                                    <option value="USPS">USPS</option>
                                    <option value="DHL">DHL</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="date" id="shipped-date-${poId}" placeholder="Ship Date" class="text-sm px-3 py-2 border border-gray-300 rounded">
                                <input type="date" id="delivery-date-${poId}" placeholder="Expected Delivery" class="text-sm px-3 py-2 border border-gray-300 rounded">
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button onclick="saveTrackingInline(${poId})" class="text-green-600 hover:text-green-800 text-sm font-medium">Save</button>
                                <button onclick="cancelTrackingEdit(${poId})" class="text-gray-600 hover:text-gray-800 text-sm">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                                
                                html += '</div>';
                                detailsContent.innerHTML = html;
                                
                                // Load tracking info
                                loadTrackingInfo(poId);
            }
        } catch (error) {
            detailsContent.innerHTML = '<div class="text-red-500">Failed to load line items</div>';
        }
    } else {
        // Hide details
        button.textContent = '‚ñº View Details';
        detailsRow.classList.add('hidden');
        detailsRow.style.display = 'none';
    }
}

function exportData() {
    // This would export CSV data - implement as needed
    showSuccess('Export feature coming soon');
}

async function clearPOData() {
    if (!confirm('This will delete all synced PO data. Are you sure?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/clear_po_data', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(result.error);
        }
    } catch (error) {
        showError('Failed to clear data: ' + error.message);
    }
}

async function recalculatePOCounts() {
    if (!confirm('This will recalculate all PO counts based on currently assigned submissions. No assignments will be changed. Continue?')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.textContent;
    
    try {
        button.disabled = true;
        button.style.opacity = '0.6';
        button.textContent = '‚è≥ Recalculating...';
        
        const response = await fetch('/api/recalculate_po_counts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            // Reload page to show updated counts
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error || 'Recalculation failed - check terminal for details');
        }
        
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    } catch (error) {
        showError('Failed to recalculate counts: ' + error.message);
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    }
}

async function reassignAllSubmissions() {
    if (!confirm('‚ö†Ô∏è WARNING: This will clear ALL current PO assignments and reassign all submissions using the correct PO order (by PO number). This cannot be undone. Continue?')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.textContent;
    
    try {
        button.disabled = true;
        button.style.opacity = '0.6';
        button.textContent = '‚è≥ Reassigning...';
        
        const response = await fetch('/api/reassign_all_submissions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            // Reload page to show updated data
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error || 'Reassignment failed - check terminal for details');
        }
        
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    } catch (error) {
        showError('Reassignment failed: ' + error.message);
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    }
}

async function resyncUnassignedSubmissions() {
    if (!confirm('This will re-match unassigned submissions to POs based on current item IDs. Continue?')) {
        return;
    }
    
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'üîó Resyncing...';
        
        const response = await fetch('/api/resync_unassigned_submissions', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Resync failed: ' + error.message);
        if (event.target) {
            event.target.disabled = false;
            event.target.textContent = 'üîó Resync Unassigned Submissions';
        }
    }
}

// Date editing functions removed - date editing is now in the edit modal
                display.textContent = `${newDate} ${currentTime}`;
            }
        } else {
            showError(result.error || 'Failed to update submission date');
        }
    } catch (error) {
        showError('Failed to update submission date: ' + error.message);
    }
}

async function refreshProducts() {
    if (!confirm('This will refresh all products with the updated configuration. Continue?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/refresh_products', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error);
        }
    } catch (error) {
        showError('Failed to refresh products: ' + error.message);
    }
}

// toggleAllPurchaseOrders function removed - Active Purchase Orders now uses scrolling instead of expand/collapse

function getTrackingUrl(trackingNumber, carrier) {
    const tracking = trackingNumber.trim();
    
    switch(carrier) {
        case 'FedEx':
            return `https://www.fedex.com/fedextrack/?trknbr=${tracking}`;
        case 'UPS':
            return `https://www.ups.com/track?loc=en_US&tracknum=${tracking}`;
        case 'USPS':
            return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${tracking}`;
        case 'DHL':
            return `https://www.dhl.com/en/express/tracking.html?AWB=${tracking}`;
        default:
            // Google search fallback
            return `https://www.google.com/search?q=track+package+${encodeURIComponent(tracking)}`;
    }
}

async function loadTrackingInfo(poId) {
    try {
        const response = await fetch(`/api/po_tracking/${poId}`);
        const data = await response.json();
        
        const trackingHeader = document.getElementById(`tracking-header-${poId}`);
        const shippingDetails = document.getElementById(`shipping-details-content-${poId}`);
        
        if (data.has_tracking && data.shipments.length > 0) {
            // Show primary tracking number in header (most recent)
            const primaryShipment = data.shipments[0];
            const trackingUrl = getTrackingUrl(primaryShipment.tracking_number, primaryShipment.carrier);
            
            if (data.shipments.length === 1) {
                // Single shipment - show tracking # and delivery
                trackingHeader.innerHTML = `
                    <a href="${trackingUrl}" target="_blank" 
                       class="font-mono text-blue-600 hover:text-blue-800 underline">
                        ${primaryShipment.tracking_number}
                    </a>
                    ${primaryShipment.estimated_delivery ? ` | <span class="text-green-600 font-medium">Due: ${primaryShipment.estimated_delivery}</span>` : ''}
                `;
            } else {
                // Multiple shipments - show count
                trackingHeader.innerHTML = `
                    <span class="text-blue-600 font-medium">${data.shipments.length} Shipments</span>
                    ${primaryShipment.estimated_delivery ? ` | <span class="text-green-600 font-medium">Next: ${primaryShipment.estimated_delivery}</span>` : ''}
                `;
            }
            
            // Populate detailed shipping info (all shipments)
            let detailsHtml = '';
            data.shipments.forEach((shipment, index) => {
                const url = getTrackingUrl(shipment.tracking_number, shipment.carrier);
                detailsHtml += `
                    <div class="border-b border-gray-200 pb-2 ${index < data.shipments.length - 1 ? 'mb-2' : ''}">
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">Tracking #:</span> 
                                <a href="${url}" target="_blank" class="font-mono text-blue-600 hover:text-blue-800 underline">${shipment.tracking_number}</a>
                            </div>
                            <div><span class="text-gray-600">Carrier:</span> ${shipment.carrier || 'Not Set'}</div>
                            <div><span class="text-gray-600">Shipped:</span> ${shipment.shipped_date || 'Not Set'}</div>
                            <div><span class="text-gray-600">Est. Delivery:</span> ${shipment.estimated_delivery || 'Not Set'}</div>
                            ${shipment.actual_delivery ? `<div><span class="text-gray-600">Actual Delivery:</span> ${shipment.actual_delivery}</div>` : ''}
                            ${shipment.notes ? `<div class="col-span-2"><span class="text-gray-600">Notes:</span> ${shipment.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            detailsHtml += `
                <div class="mt-3 text-center">
                    <button onclick="editTrackingInline(${poId})" class="text-blue-600 hover:text-blue-800 text-sm mr-3">Add Another Shipment</button>
                </div>
            `;
            
            shippingDetails.innerHTML = detailsHtml;
        } else {
            // No tracking yet
            trackingHeader.innerHTML = `
                <button onclick="editTrackingInline(${poId})" 
                        class="text-blue-600 hover:text-blue-800 text-sm">
                    Add Tracking
                </button>
            `;
            
            shippingDetails.innerHTML = `
                <div class="text-center text-gray-500">
                    <p>No shipping information yet</p>
                    <button onclick="editTrackingInline(${poId})" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">Add Tracking Info</button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load tracking info:', error);
        const trackingHeader = document.getElementById(`tracking-header-${poId}`);
        if (trackingHeader) {
            trackingHeader.innerHTML = '<span class="text-red-500 text-sm">Error loading tracking</span>';
        }
    }
}

function editTrackingInline(poId) {
    document.getElementById(`tracking-edit-${poId}`).classList.remove('hidden');
}

function cancelTrackingEdit(poId) {
    document.getElementById(`tracking-edit-${poId}`).classList.add('hidden');
}

async function saveTrackingInline(poId) {
    const data = {
        po_id: poId,
        tracking_number: document.getElementById(`tracking-num-${poId}`).value,
        carrier: document.getElementById(`carrier-${poId}`).value,
        shipped_date: document.getElementById(`shipped-date-${poId}`).value,
        estimated_delivery: document.getElementById(`delivery-date-${poId}`).value
    };
    
    try {
        const response = await fetch('/api/save_shipment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            showSuccess('Tracking info saved!');
            // Reload tracking info and hide edit form
            await loadTrackingInfo(poId);
            cancelTrackingEdit(poId);
            // Reload page to update status if it changed to "Shipped"
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(result.error);
        }
    } catch (error) {
        showError('Failed to save tracking: ' + error.message);
    }
}

function toggleClosedPOs() {
    const content = document.getElementById('closed-pos-content');
    const icon = document.getElementById('closed-po-toggle-icon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '‚ñº';
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.classList.add('hidden');
        icon.textContent = '‚ñ∂';
        icon.style.transform = 'rotate(-90deg)';
    }
}

function toggleRecentSubmissions() {
    const content = document.getElementById('recent-submissions-content');
    const icon = document.getElementById('submissions-toggle-icon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-90');
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-90');
    }
}

function toggleClosedSubmissions() {
    const checkbox = document.getElementById('show-closed-submissions');
    const rows = document.querySelectorAll('.submissions-row');
    
    rows.forEach(row => {
        const isClosed = row.getAttribute('data-po-closed') === 'true';
        
        if (isClosed && !checkbox.checked) {
            row.style.display = 'none';
        } else {
            row.style.display = '';
        }
    });
}

// Hide closed PO submissions by default on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleClosedSubmissions();
    
    // Auto-sync Zoho POs on page load to ensure closed status is up to date
    // This prevents submissions from being assigned to closed POs
    syncZohoPOsOnLoad();
});

// Auto-sync Zoho POs silently in the background (only once per session)
async function syncZohoPOsOnLoad() {
    // Check if we've already synced in this session
    const lastSync = sessionStorage.getItem('lastZohoSync');
    const now = Date.now();
    
    // Only sync if it's been more than 5 minutes since last sync
    if (lastSync && (now - parseInt(lastSync)) < 300000) {
        console.log('Skipping auto-sync - synced recently');
        return;
    }
    
    try {
        const response = await fetch('/api/sync_zoho_pos');
        const result = await response.json();
        
        if (result.success) {
            // Mark that we've synced
            sessionStorage.setItem('lastZohoSync', now.toString());
            
            // Only reload if there might be status changes (not on every page load)
            // Check if result message mentions status updates
            if (result.message && (result.message.includes('closed') || result.message.includes('Updated'))) {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            console.warn('Auto-sync failed:', result.error);
            // Don't show error to user - it's a background sync
        }
    } catch (error) {
        console.warn('Auto-sync error:', error);
        // Don't show error to user - it's a background sync
    }
}

// toggleAllSubmissions function removed - Recent Submissions now uses scrolling instead of expand/collapse

function toggleShippingDetails(poId) {
    const details = document.getElementById(`shipping-details-${poId}`);
    details.classList.toggle('hidden');
}

// Load available POs on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAvailablePOs();
});

async function loadAvailablePOs() {
    try {
        const selector = document.getElementById('po_selector');
        if (!selector) {
            console.error('PO selector element not found');
            return;
        }
        
        // Show loading state
        selector.innerHTML = '<option value="">Loading POs...</option>';
        selector.disabled = true;
        
        const response = await fetch('/api/reports/po-summary');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        selector.innerHTML = '<option value="">Select a PO...</option>';
        selector.disabled = false;
        
        if (data.success && data.pos && Array.isArray(data.pos)) {
            if (data.pos.length === 0) {
                selector.innerHTML = '<option value="">No POs found</option>';
                console.warn('No purchase orders returned from API');
                return;
            }
            
            data.pos.forEach(po => {
                if (!po || !po.po_number) {
                    console.warn('Invalid PO data:', po);
                    return;
                }
                
                try {
                    const option = document.createElement('option');
                    option.value = po.po_number;
                    option.textContent = `${po.po_number} - ${po.tablet_type || 'N/A'} (${po.ordered || 0} tablets)`;
                    option.dataset.poData = JSON.stringify(po);
                    selector.appendChild(option);
                } catch (e) {
                    console.error('Error adding PO option:', e, po);
                }
            });
            
            console.log(`Loaded ${data.pos.length} POs into dropdown`);
        } else {
            console.error('Invalid response from API:', data);
            selector.innerHTML = '<option value="">Error loading POs</option>';
            if (data.error) {
                alert('Error loading POs: ' + data.error);
            }
        }
        
    } catch (error) {
        console.error('Error loading POs:', error);
        const selector = document.getElementById('po_selector');
        if (selector) {
            selector.innerHTML = '<option value="">Error loading POs</option>';
            selector.disabled = false;
        }
        alert('Failed to load purchase orders: ' + error.message);
    }
}

// Setup change listeners (only once, on page load)
document.addEventListener('DOMContentLoaded', function() {
    // Setup report type selector listener
    const reportTypeSelector = document.getElementById('report_type_selector');
    const generateBtnText = document.getElementById('generate-report-btn-text');
    const poSelector = document.getElementById('po_selector');
    const generateBtn = document.getElementById('generate-report-btn');
    
    // Initialize button state based on default (vendor)
    if (generateBtn) {
        generateBtn.disabled = false; // Vendor report is default and doesn't require PO
    }
    
    if (reportTypeSelector && generateBtnText) {
        reportTypeSelector.addEventListener('change', function() {
            const reportType = this.value;
            if (reportType === 'vendor') {
                generateBtnText.textContent = 'Generate Vendor Report';
                // Vendor report doesn't require PO selection
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
            } else {
                generateBtnText.textContent = 'Generate PO Report';
                // Production report requires PO selection
                if (generateBtn && poSelector) {
                    generateBtn.disabled = !poSelector.value;
                }
            }
        });
    }
    
    // Setup PO selector listener
    const selector = document.getElementById('po_selector');
    if (selector) {
        selector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const button = document.getElementById('generate-report-btn');
            const preview = document.getElementById('po_preview');
            const previewContent = document.getElementById('po_preview_content');
            
            // Check report type - vendor report doesn't require PO selection
            const reportTypeSelector = document.getElementById('report_type_selector');
            const reportType = reportTypeSelector ? reportTypeSelector.value : 'vendor';
            
            // Button state logic:
            // - Vendor reports: always enabled (no PO selection required)
            // - Production reports: enabled only when a PO is selected
            if (reportType === 'vendor') {
                // Vendor report doesn't require PO selection
                if (button) button.disabled = false;
                if (preview) preview.classList.add('hidden');
            } else if (reportType === 'production') {
                // Production report requires PO selection
                if (this.value && selectedOption.dataset.poData) {
                    if (button) button.disabled = false;
                    if (preview) {
                        preview.classList.remove('hidden');
                        const poData = JSON.parse(selectedOption.dataset.poData);
                        if (previewContent) {
                            previewContent.innerHTML = `
                                <div><strong>PO Number:</strong> ${poData.po_number}</div>
                                <div><strong>Tablet Type:</strong> ${poData.tablet_type || 'N/A'}</div>
                                <div><strong>Status:</strong> ${poData.status || 'Unknown'}</div>
                                <div><strong>Ordered:</strong> ${poData.ordered || 0} tablets</div>
                                <div><strong>Produced:</strong> ${poData.produced || 0} tablets</div>
                                <div><strong>Damaged:</strong> ${poData.damaged || 0} tablets</div>
                                <div><strong>Submissions:</strong> ${poData.submissions || 0}</div>
                                ${poData.pack_time_days ? `<div><strong>Pack Time:</strong> ${poData.pack_time_days} days</div>` : ''}
                            `;
                        }
                    }
                } else {
                    // No PO selected for production report
                    if (button) button.disabled = true;
                    if (preview) preview.classList.add('hidden');
                }
            }
        });
    }
});

async function generatePOReport() {
    const selector = document.getElementById('po_selector');
    const reportTypeSelector = document.getElementById('report_type_selector');
    const button = document.getElementById('generate-report-btn');
    const originalText = button.innerHTML;
    
    const reportType = reportTypeSelector ? reportTypeSelector.value : 'vendor';
    
    // Vendor report doesn't require PO selection
    if (reportType !== 'vendor' && !selector.value) {
        showError('Please select a PO first');
        return;
    }
    
    try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = `
            <span class="flex items-center justify-center">
                <svg class="animate-spin w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-spinner" /></svg>
                Generating Report...
            </span>
        `;
        
        // Prepare request data
        const requestData = {
            report_type: reportType
        };
        
        // Add PO numbers if PO is selected (for production report) or if vendor report with PO
        if (selector.value) {
            requestData.po_numbers = [selector.value];
        }
        
        // Make API request
        const response = await fetch('/api/reports/production', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Generate filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        const reportName = reportType === 'vendor' ? 'vendor_report' : 'production_report';
        const poSuffix = selector.value ? `_${selector.value}` : '';
        a.download = `${poSuffix}${reportName}_${timestamp}.pdf`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        const reportTypeName = reportType === 'vendor' ? 'Vendor' : 'Production';
        const poText = selector.value ? ` for ${selector.value}` : '';
        showSuccess(`${reportTypeName} report${poText} generated successfully!`);
        
    } catch (error) {
        console.error('Report generation error:', error);
        showError('Failed to generate report: ' + error.message);
    } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

async function generateAllPOsReport() {
    const reportTypeSelector = document.getElementById('report_type_selector');
    const button = document.getElementById('generate-all-btn');
    const originalText = button.innerHTML;
    
    const reportType = reportTypeSelector ? reportTypeSelector.value : 'vendor';
    
    try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = `
            <span class="flex items-center justify-center">
                <svg class="animate-spin w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-spinner" /></svg>
                Generating...
            </span>
        `;
        
        // Generate report with no filters (all POs)
        const requestData = {
            report_type: reportType
        };
        
        // Make API request
        const response = await fetch('/api/reports/production', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Generate filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        const reportName = reportType === 'vendor' ? 'vendor_report' : 'production_report';
        a.download = `all_pos_${reportName}_${timestamp}.pdf`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        const reportTypeName = reportType === 'vendor' ? 'Vendor' : 'Production';
        showSuccess(`All POs ${reportTypeName} report generated successfully!`);
        
    } catch (error) {
        console.error('Report generation error:', error);
        showError('Failed to generate report: ' + error.message);
    } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// View submissions for a specific PO
async function viewPOSubmissions(poId, poName, inventoryItemId = null) {
    try {
        const response = await fetch(`/api/po/${poId}/submissions`);
        const data = await response.json();
        
        if (!data.success) {
            showError(data.error || 'Failed to load submissions');
            return;
        }
        
        // Filter submissions by inventory_item_id if specified
        // This is more reliable than product name matching since names can differ between Zoho and submissions
        const filteredSubmissions = inventoryItemId 
            ? data.submissions.filter(sub => sub.inventory_item_id === inventoryItemId)
            : data.submissions;
        
        // Get product name for display from first submission or from filtered list
        const displayProductName = filteredSubmissions.length > 0 ? filteredSubmissions[0].product_name : '';
        
        // Calculate totals for the filtered submissions (when viewing a specific product)
        let totals = null;
        if (inventoryItemId && filteredSubmissions.length > 0) {
            totals = {
                displays_made: 0,
                packs_remaining: 0,
                loose_tablets: 0,
                damaged_tablets: 0,
                total_tablets: 0
            };
            
            filteredSubmissions.forEach(sub => {
                totals.displays_made += sub.displays_made || 0;
                totals.packs_remaining += sub.packs_remaining || 0;
                totals.loose_tablets += sub.loose_tablets || 0;
                totals.damaged_tablets += sub.damaged_tablets || 0;
                totals.total_tablets += sub.total_tablets || 0;
            });
        }
        
        // Build modal content
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeSubmissionsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            ${inventoryItemId ? `
                                <button onclick="closeSubmissionsModal(); viewPODetailsModal(${poId}, '${data.po.po_number}');" 
                                        class="text-white hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                                        title="Back to PO details">
                                    ‚Üê Back
                                </button>
                            ` : '<div></div>'}
                            <div class="flex-1 text-center">
                                <h3 class="text-xl font-bold">üìã Submissions for ${data.po.po_number}</h3>
                                ${displayProductName ? `<p class="text-sm text-blue-100 mt-1">üì¶ Product: ${displayProductName}</p>` : ''}
                                <p class="text-sm text-blue-100 mt-1">${filteredSubmissions.length} submission(s) found</p>
                                ${totals ? `<p class="text-sm text-blue-100 mt-1 font-semibold">üìä Total Tablets: ${totals.total_tablets.toLocaleString()}</p>` : ''}
                            </div>
                            <button onclick="closeSubmissionsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
        `;
        
        if (filteredSubmissions.length === 0) {
            modalContent += `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                                <p class="text-lg">No submissions found${inventoryItemId ? ' for this product' : ''}</p>
                </div>
            `;
        } else {
            modalContent += '<div class="space-y-4">';
            
            filteredSubmissions.forEach(sub => {
                // Parse dates - if they're date-only strings (YYYY-MM-DD), treat as local date
                // If they're datetime strings, parse them properly
                let submissionDateStr = sub.submission_date || sub.created_at;
                let createdDateStr = sub.created_at;
                
                // Format dates in EST/EDT timezone
                const formatDateEST = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    // If it's just a date (YYYY-MM-DD), format it directly without timezone conversion
                    // This avoids timezone issues since it's a date-only field
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateStr.split('-');
                        return `${month}/${day}/${year}`;
                    }
                    // If it's a datetime string, parse it and convert to EST
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return 'N/A';
                    return date.toLocaleDateString('en-US', { timeZone: 'America/New_York', month: '2-digit', day: '2-digit', year: 'numeric' });
                };
                
                const formatDateTimeEST = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    // Parse datetime and convert to EST/EDT timezone
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return 'N/A';
                    return date.toLocaleString('en-US', { timeZone: 'America/New_York', month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                };
                
                // Check if user is admin for edit functionality
                const isAdmin = {% if session.get('employee_role') == 'admin' or session.get('admin_authenticated') %}true{% else %}false{% endif %};
                const clickHandler = isAdmin ? `onclick="openEditSubmissionFromPO(${sub.id}, ${poId}, '${inventoryItemId || ''}')"` : '';
                const cursorClass = isAdmin ? 'cursor-pointer' : '';
                const editHint = isAdmin ? '<div class="text-xs text-purple-600 mt-2 flex items-center gap-1"><span>‚úèÔ∏è</span> <span>Click to edit (Admin)</span></div>' : '';
                
                modalContent += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors ${cursorClass}" ${clickHandler}>
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-medium text-gray-900">${sub.product_name}</h4>
                                <p class="text-sm text-gray-600">üë§ ${sub.employee_name || 'Unknown'} ‚Ä¢ üì¶ Bag: ${sub.box_number || ''}/${sub.bag_number || ''}</p>
                            </div>
                            <div class="text-right text-sm">
                                <div class="text-gray-600">üìÖ ${formatDateEST(submissionDateStr)}</div>
                                <div class="text-xs text-gray-400">Created: ${formatDateTimeEST(createdDateStr)}</div>
                            </div>
                        </div>
                        
                        <!-- Running Total and Bag Check -->
                        <div class="mb-3 flex gap-2 items-center flex-wrap">
                            <div class="inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
                                <span class="font-semibold text-sm">Running: ${(sub.running_total || 0).toLocaleString()}</span>
                            </div>
                            ${sub.bag_label_count ? `
                                <div class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full">
                                    <span class="font-semibold text-sm">Bag: ${(sub.bag_label_count || 0).toLocaleString()}</span>
                                </div>
                                ${sub.count_status === 'match' ? '<span class="text-green-600 font-bold text-sm">‚úì Match</span>' : ''}
                                ${sub.count_status === 'under' ? '<span class="text-yellow-600 font-bold text-sm">‚ö†Ô∏è Under</span>' : ''}
                                ${sub.count_status === 'over' ? '<span class="text-red-600 font-bold text-sm">‚ùå Over</span>' : ''}
                            ` : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-3 rounded">
                            <div>
                                <div class="text-xs text-gray-500">Displays Made</div>
                                <div class="font-medium text-blue-600">${sub.displays_made || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Cards Remaining</div>
                                <div class="font-medium text-blue-600">${sub.packs_remaining || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Loose Tablets</div>
                                <div class="font-medium text-blue-600">${sub.loose_tablets || 0}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Damaged Tablets</div>
                                <div class="font-medium text-red-600">${sub.damaged_tablets || 0}</div>
                            </div>
                        </div>
                        
                        <!-- Submission Total -->
                        <div class="mt-3 flex justify-center">
                            <div class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full">
                                <span class="font-semibold text-base">Total: ${(sub.total_tablets || 0).toLocaleString()} tablets</span>
                            </div>
                        </div>
                        
                        ${sub.admin_notes ? `
                        <!-- Admin Notes -->
                        <div class="mt-3 bg-purple-50 border border-purple-200 rounded-md p-3">
                            <div class="text-xs font-medium text-purple-800 mb-1">üîí Admin Notes</div>
                            <div class="text-sm text-gray-700 whitespace-pre-wrap">${sub.admin_notes}</div>
                        </div>
                        ` : ''}
                        ${editHint}
                    </div>
                `;
            });
            
            modalContent += '</div>';
        }
        
        // Add "View All Submissions" button if viewing filtered results
        if (inventoryItemId && data.submissions.length > filteredSubmissions.length) {
            modalContent += `
                <div class="mt-6 flex justify-center border-t pt-4">
                    <button onclick="closeSubmissionsModal(); viewPOSubmissions(${poId}, '${poName}', null);" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow-lg transition-colors">
                        üìã View All Submissions for this PO (${data.submissions.length} total)
                    </button>
                </div>
            `;
        }
        
        modalContent += `
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.id = 'submissions-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        console.error('Error loading submissions:', error);
        showError('Failed to load submissions: ' + error.message);
    }
}

function closeSubmissionsModal(event) {
    // Close if clicked outside the modal or on close button
    if (!event || event.target === event.currentTarget || !event) {
        const modal = document.getElementById('submissions-modal');
        if (modal) {
            modal.remove();
        }
    }
}

async function viewPODetailsModal(poId, poNumber) {
    try {
        const response = await fetch(`/api/po_lines/${poId}`);
        const data = await response.json();
        const lines = data.lines || data; // Handle both new format and legacy format
        const hasUnverified = data.has_unverified_submissions || false;
        const unverifiedCount = data.unverified_count || 0;
        const poStatus = data.po_status || 'Open';
        
        // Determine status badge color
        let statusBadgeClass = 'bg-blue-100 text-blue-800 border-blue-300';
        if (poStatus === 'Closed') {
            statusBadgeClass = 'bg-gray-100 text-gray-800 border-gray-300';
        } else if (poStatus === 'Draft') {
            statusBadgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
        } else if (poStatus === 'Open' || poStatus === 'Active') {
            statusBadgeClass = 'bg-green-100 text-green-800 border-green-300';
        }
        
        // Build modal content
        let modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closePODetailsModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-xl font-bold">üì¶ Purchase Order: ${poNumber}</h3>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-semibold ${statusBadgeClass} border">
                                        ${poStatus}
                                    </span>
                                </div>
                                <p class="text-sm text-blue-100 mt-1">${lines.length} line item(s)</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${data.parent_po ? `
                                    <button onclick="closePODetailsModal(); setTimeout(() => viewPODetailsModal(${data.parent_po.id}, '${data.parent_po.po_number}'), 100);" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
                                            title="Back to parent PO">
                                        ‚Üê Back to Parent PO
                                    </button>
                                ` : ''}
                                ${data.overs_po ? `
                                    <button onclick="closePODetailsModal(); setTimeout(() => viewPODetailsModal(${data.overs_po.id}, '${data.overs_po.po_number}'), 100);" 
                                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
                                            title="View linked overs PO">
                                        üì¶ View Overs PO
                                    </button>
                                ` : ''}
                                <button onclick="showOversPOCreationInfo(${poId}, '${poNumber}')" 
                                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
                                        title="Get info to create overs PO">
                                    üìã Create Overs PO
                                </button>
                                <button onclick="closePODetailsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
        `;
        
        // Add warning if there are unverified submissions
        if (hasUnverified) {
            modalContent += `
                <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-yellow-800">‚ö†Ô∏è Warning: This PO summary contains unverified submissions</p>
                            <p class="text-xs text-yellow-700 mt-1">${unverifiedCount} submission${unverifiedCount !== 1 ? 's' : ''} need${unverifiedCount !== 1 ? '' : 's'} verification. Please verify and approve assignments before finalizing counts.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (lines.length === 0) {
            modalContent += `
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p class="text-lg">No line items found for this PO</p>
                </div>
            `;
        } else {
            modalContent += '<div class="grid grid-cols-1 gap-4">';
            
            lines.forEach(line => {
                const remaining = line.quantity_ordered - line.good_count - line.damaged_count;
                const received = line.good_count + line.damaged_count;
                const progressPercent = line.quantity_ordered > 0 ? ((received / line.quantity_ordered) * 100).toFixed(1) : 0;
                const isOver = remaining < 0;
                const displayValue = Math.abs(remaining);
                const labelText = isOver ? 'Overs' : 'Remaining';
                const labelColor = isOver ? 'text-purple-600' : 'text-blue-600';
                
                modalContent += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50 cursor-pointer transition-colors duration-200" 
                         onclick="event.stopPropagation(); closePODetailsModal(); viewPOSubmissions(${poId}, '${poNumber}', '${line.inventory_item_id}');"
                         title="Click to view submissions for this product">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="font-bold text-lg text-gray-900">${line.line_item_name}</div>
                                    ${line.round_number ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800">Round ${line.round_number}</span>` : ''}
                                </div>
                                <div class="text-sm text-gray-500 font-mono mt-1">ID: ${line.inventory_item_id}</div>
                                
                                <!-- Progress bar -->
                                <div class="mt-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Progress</span>
                                        <span class="font-semibold">${progressPercent}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 font-medium">Ordered</div>
                                    <div class="text-lg font-bold text-gray-900">${line.quantity_ordered.toLocaleString()}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-green-600 font-medium">Good</div>
                                    <div class="text-lg font-bold text-green-600">${line.good_count.toLocaleString()}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-red-600 font-medium">Damaged</div>
                                    <div class="text-lg font-bold text-red-600">${line.damaged_count.toLocaleString()}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs ${labelColor} font-medium">${labelText}</div>
                                    <div class="text-lg font-bold ${labelColor}">${displayValue.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalContent += '</div>';
        }
        
        // Add "View All Submissions" button at the bottom
        modalContent += `
            <div class="mt-6 flex justify-center border-t pt-4">
                <button onclick="event.stopPropagation(); closePODetailsModal(); viewPOSubmissions(${poId}, '${poNumber}', null);" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-colors">
                    üìã View All Submissions for this PO
                </button>
            </div>
        `;
        
        modalContent += `
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalDiv = document.createElement('div');
        modalDiv.id = 'po-details-modal';
        modalDiv.innerHTML = modalContent;
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        console.error('Error loading PO details:', error);
        showError('Failed to load PO details: ' + error.message);
    }
}

function closePODetailsModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('po-details-modal');
        if (modal) {
            modal.remove();
        }
    }
}

async function showOversPOCreationInfo(poId, poNumber) {
    try {
        const response = await fetch(`/api/create_overs_po_info/${poId}`);
        const data = await response.json();
        
        if (!data.success) {
            showError(data.error || 'Failed to get overs PO info');
            return;
        }
        
        // Create modal with overs PO creation info
        const modalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeOversPOModal(event)">
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold">üìã Create Overs PO for ${data.parent_po_number}</h3>
                                <p class="text-sm text-purple-100 mt-1">Total Overs: ${data.total_overs.toLocaleString()} tablets</p>
                            </div>
                            <button onclick="closeOversPOModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
                            <h4 class="font-semibold text-blue-900 mb-2">üìù Instructions:</h4>
                            <p class="text-sm text-blue-800">${data.instructions}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-900 mb-3">Overs PO Details:</h4>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-700">Overs PO Number:</span>
                                    <span class="font-bold text-purple-600">${data.overs_po_number}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-700">Tablet Type:</span>
                                    <span class="text-gray-900">${data.tablet_type || 'Same as parent'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-700">Total Overs Quantity:</span>
                                    <span class="font-bold text-purple-600">${data.total_overs.toLocaleString()} tablets</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-900 mb-3">Line Items for Overs PO:</h4>
                            <div class="space-y-2">
                                ${data.line_items.map(item => `
                                    <div class="border border-gray-200 rounded-lg p-3 bg-purple-50">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-medium text-gray-900">${item.line_item_name}</div>
                                                <div class="text-xs text-gray-500 mt-1">Inventory ID: ${item.inventory_item_id}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm text-gray-600">Overs: <span class="font-bold text-purple-600">${item.overs_quantity.toLocaleString()}</span></div>
                                                <div class="text-xs text-gray-500">Original: ${item.original_ordered.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-4">
                            <p class="text-sm text-yellow-800">
                                <strong>Note:</strong> After creating the overs PO in Zoho, click "SYNC ZOHO POs" on the dashboard to import it into the app.
                            </p>
                        </div>
                        
                        <div class="flex justify-end gap-2">
                            <button onclick="closeOversPOModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                Close
                            </button>
                            <button onclick="copyOversPOInfo('${data.overs_po_number}', '${JSON.stringify(data).replace(/'/g, "\\'")}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                üìã Copy Details (Manual)
                            </button>
                            <button onclick="createOversPOInZoho(${poId}, '${data.overs_po_number}')" 
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                                ‚ú® Create in Zoho
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add to modal container
        const modalContainer = document.getElementById('po-details-modal-container') || document.body;
        const oversModal = document.createElement('div');
        oversModal.id = 'overs-po-modal';
        oversModal.innerHTML = modalContent;
        modalContainer.appendChild(oversModal);
        
    } catch (error) {
        console.error('Error getting overs PO info:', error);
        showError('Failed to get overs PO information: ' + error.message);
    }
}

function closeOversPOModal(event) {
    if (event && event.target !== event.currentTarget) {
        return;
    }
    const modal = document.getElementById('overs-po-modal');
    if (modal) {
        modal.remove();
    }
}

function copyOversPOInfo(oversPONumber, dataJson) {
    try {
        const data = JSON.parse(dataJson);
        const textToCopy = `Overs PO Number: ${oversPONumber}
Tablet Type: ${data.tablet_type}
Total Overs: ${data.total_overs.toLocaleString()} tablets

Line Items:
${data.line_items.map(item => `- ${item.line_item_name} (ID: ${item.inventory_item_id}): ${item.overs_quantity.toLocaleString()} tablets`).join('\\n')}

Instructions: Create this PO in Zoho and mark it with the tablets custom field, then sync POs.`;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            showSuccess('Overs PO details copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showError('Failed to copy to clipboard');
        });
    } catch (error) {
        console.error('Error parsing data:', error);
        showError('Failed to copy details');
    }
}

async function createOversPOInZoho(poId, oversPONumber) {
    if (!confirm(`Create overs PO "${oversPONumber}" in Zoho?\n\nThis will create a draft PO in Zoho with the overs quantities. You can review and issue it from Zoho.`)) {
        return;
    }
    
    try {
        showSuccess('Creating overs PO in Zoho...');
        
        const response = await fetch(`/api/create_overs_po/${poId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message + ' You can now sync POs to import it into the app.');
            closeOversPOModal();
            // Optionally reload or refresh
            setTimeout(() => {
                if (confirm('Would you like to sync POs now to import the newly created overs PO?')) {
                    if (typeof syncZohoPOs === 'function') {
                        syncZohoPOs();
                    } else {
                        alert('Sync function not available. Please refresh the page.');
                    }
                }
            }, 2000);
        } else {
            showError(result.error || 'Failed to create overs PO in Zoho');
        }
    } catch (error) {
        console.error('Error creating overs PO:', error);
        showError('Failed to create overs PO: ' + error.message);
    }
}

// Approval function
async function approveSubmission(submissionId) {
    if (!confirm('Approve this PO assignment? Once approved, it cannot be changed.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/submission/${submissionId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(data.error || 'Failed to approve submission');
        }
    } catch (error) {
        console.error('Error approving submission:', error);
        showError('Failed to approve submission: ' + error.message);
    }
}

// Reassignment functions
async function openReassignModal(submissionId, currentPO, productName) {
    try {
        const currentText = currentPO ? `Current: ${currentPO}` : 'Currently Unassigned';
        document.getElementById('reassign-modal-subtitle').textContent = `Product: ${productName} | ${currentText}`;
        document.getElementById('reassign-modal').classList.remove('hidden');
        
        // Fetch available POs for this submission
        const response = await fetch(`/api/submission/${submissionId}/available_pos`);
        const data = await response.json();
        
        if (!data.success) {
            showError(data.error || 'Failed to load available POs');
            return;
        }
        
        // Build PO list
        const posList = document.getElementById('reassign-pos-list');
        posList.innerHTML = '';
        
        if (data.available_pos.length === 0) {
            posList.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No POs found for this product</p>
                </div>
            `;
            return;
        }
        
        data.available_pos.forEach(po => {
            const isCurrent = po.id === data.current_po_id;
            const statusColor = po.closed ? 'bg-gray-100 text-gray-700' : 'bg-green-100 text-green-700';
            const statusLabel = po.closed ? 'üîí Closed' : '‚úì Open';
            
            const poDiv = document.createElement('div');
            poDiv.className = `border rounded-lg p-4 hover:bg-blue-50 cursor-pointer transition-colors ${isCurrent ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}`;
            poDiv.onclick = () => reassignSubmission(submissionId, po.id);
            
            poDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-bold text-lg text-gray-900">${po.po_number}</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusColor}">
                                ${statusLabel}
                            </span>
                            ${isCurrent ? '<span class="text-xs text-blue-600 font-bold">CURRENT</span>' : ''}
                        </div>
                        <div class="grid grid-cols-4 gap-3 text-sm">
                            <div>
                                <div class="text-xs text-gray-500">Ordered</div>
                                <div class="font-medium">${po.ordered.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-green-600">Good</div>
                                <div class="font-medium text-green-600">${po.good.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-red-600">Damaged</div>
                                <div class="font-medium text-red-600">${po.damaged.toLocaleString()}</div>
                            </div>
                            <div>
                                ${(() => {
                                    const isOver = po.remaining < 0;
                                    const displayValue = Math.abs(po.remaining);
                                    const labelText = isOver ? 'Overs' : 'Remaining';
                                    const labelColor = isOver ? 'text-purple-600' : 'text-blue-600';
                                    return `
                                        <div class="text-xs ${labelColor}">${labelText}</div>
                                        <div class="font-medium ${labelColor}">${displayValue.toLocaleString()}</div>
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>
                    ${!isCurrent ? '<div class="text-2xl">‚Üí</div>' : ''}
                </div>
            `;
            
            posList.appendChild(poDiv);
        });
        
    } catch (error) {
        console.error('Error loading available POs:', error);
        showError('Failed to load available POs: ' + error.message);
    }
}

function closeReassignModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('reassign-modal').classList.add('hidden');
    }
}

async function reassignSubmission(submissionId, newPoId) {
    if (!confirm('Are you sure you want to reassign this submission to a different PO? Counts will be automatically updated.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/submission/${submissionId}/reassign`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_po_id: newPoId})
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(data.error || 'Failed to reassign submission');
        }
    } catch (error) {
        console.error('Error reassigning submission:', error);
        showError('Failed to reassign submission: ' + error.message);
    }
}
</script>

<!-- Reassign Modal -->
<div id="reassign-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeReassignModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold">üîÑ Reassign Submission to PO</h3>
                    <p class="text-sm text-blue-100 mt-1" id="reassign-modal-subtitle"></p>
                </div>
                <button onclick="closeReassignModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        
        <!-- Content -->
        <div class="p-6">
            <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <p class="text-sm text-yellow-800">
                    <strong>‚ö†Ô∏è Manager Verification:</strong> Select the correct PO for this submission. 
                    Only POs containing this product are shown. Counts will be automatically updated.
                </p>
            </div>
            
            <div id="reassign-pos-list" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- PO list will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Submission Modal is now in base.html - available on all pages -->
<script>
// Use shared edit modal from base.html - just provide wrapper function
async function openEditSubmissionFromPO(submissionId, poId, inventoryItemId) {
    // Check if user is admin or manager (admins and managers can edit)
    const canEdit = {% if session.get('employee_role') in ['admin', 'manager'] or session.get('admin_authenticated') %}true{% else %}false{% endif %};
    
    if (!canEdit) {
        alert('Only administrators and managers can edit submissions.');
        return;
    }
    
    // Use the shared modal function from base.html
    if (typeof openEditSubmissionModal === 'function') {
        await openEditSubmissionModal(submissionId, poId, inventoryItemId);
    } else {
        alert('Edit functionality not available. Please refresh the page.');
    }
}

// Ensure syncZohoPOs is available globally (in case of script loading issues)
if (typeof syncZohoPOs === 'undefined') {
    console.error('syncZohoPOs function is not defined. Check for JavaScript syntax errors.');
    // Define a fallback function
    window.syncZohoPOs = syncZohoPOs = function() {
        alert('Sync function not loaded. Please refresh the page to reload scripts.');
    };
}
</script>

{% endblock %}
