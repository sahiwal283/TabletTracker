{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
    <!-- Summary Stats -->
    <div class="card hover-lift p-8">
        <div class="flex items-center mb-6">
            <svg class="w-8 h-8 mr-4" aria-hidden="true"><use href="#icon-chart" /></svg>
            <h3 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Overview</h3>
        </div>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-600">üîÑ Active POs:</span>
                <span class="font-medium text-blue-600">{{ active_pos|length }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">üìù Draft POs:</span>
                <span class="font-medium text-yellow-600">{{ stats.draft_pos }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">‚õî Closed POs:</span>
                <span class="font-medium text-gray-600">{{ stats.closed_pos }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">üìä Total Remaining:</span>
                <span class="font-medium text-blue-600">{{ "{:,}".format(stats.total_remaining) }}</span>
            </div>
        </div>
    </div>
    
    <!-- Data Management -->
    <div class="card hover-lift p-8">
        <div class="flex items-center mb-6">
            <svg class="w-8 h-8 mr-4" aria-hidden="true"><use href="#icon-bolt" /></svg>
            <h3 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">Data Management</h3>
        </div>
        
        <!-- Important Notice -->
        <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h4 class="text-sm font-bold text-blue-900 mb-1">üìã Important: Zoho PO Setup Required</h4>
                    <p class="text-sm text-blue-800">
                        For POs to appear in this app, they <strong>must be marked as "Tablets"</strong> in Zoho Books. 
                        Check the <strong class="bg-blue-100 px-2 py-0.5 rounded">‚òë Tablets?</strong> checkbox on each Purchase Order in Zoho before syncing.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="space-y-4">
            <button id="sync-pos-btn" onclick="syncZohoPOs()" 
                    class="btn-success w-full py-4 text-lg font-bold shadow-2xl transform transition-all duration-500 hover:scale-105">
                <span class="flex items-center justify-center">
                    <span class="text-2xl mr-3">üîÑ</span>
                    SYNC ZOHO POs
                </span>
            </button>
            <button onclick="resyncUnassignedSubmissions()" 
                    class="btn-primary w-full py-3 text-sm font-semibold transform transition-all duration-300 hover:scale-105"
                    title="Re-match unassigned submissions to POs after updating item IDs">
                <span class="flex items-center justify-center">
                    <span class="text-lg mr-2">üîó</span>
                    Resync Unassigned Submissions
                </span>
            </button>
            <button onclick="clearPOData()" 
                    class="btn-warning w-full py-3 text-sm font-semibold transform transition-all duration-300 hover:scale-105"
                    title="Deletes all synced PO data and resets counts to zero. Use this to start fresh or fix sync issues.">
                <span class="flex items-center justify-center">
                    <span class="text-lg mr-2">üóëÔ∏è</span>
                    Clear PO Data
                </span>
            </button>
            <p class="text-xs text-gray-500 mt-1">
                <strong>Clear PO Data use cases:</strong><br>
                ‚Ä¢ Start fresh testing<br>
                ‚Ä¢ Fix corrupted sync data<br>
                ‚Ä¢ Reset all counts to zero
            </p>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="card hover-lift p-8">
        <div class="flex items-center mb-6">
            <svg class="w-8 h-8 mr-4" aria-hidden="true"><use href="#icon-clock" /></svg>
            <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Recent Activity</h3>
        </div>
        <div class="text-sm space-y-2">
            {% for submission in submissions[:5] %}
                <div class="border-l-2 border-blue-200 pl-3">
                    <div class="font-medium">{{ submission.product_name }}</div>
                    <div class="text-gray-600">{{ submission.employee_name }}</div>
                    <div class="text-xs text-gray-500">
                        {{ submission.created_at.split('.')[0] if submission.created_at else 'Unknown time' }}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Production Report Section -->
<div class="card hover-lift p-8 mb-8">
    <div class="flex items-center mb-6">
        <svg class="w-8 h-8 mr-4" aria-hidden="true"><use href="#icon-document" /></svg>
        <h3 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Production Reports</h3>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Report Controls -->
        <div class="space-y-4">
            <div>
                <label for="po_selector" class="block text-sm font-medium text-gray-700 mb-1">Select Purchase Order</label>
                <select id="po_selector" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Loading POs...</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Select a PO to generate its detailed production report</p>
            </div>
            
            <div id="po_preview" class="hidden bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="font-bold text-gray-800 mb-2">PO Preview:</h4>
                <div id="po_preview_content" class="text-sm text-gray-600 space-y-1">
                    <!-- Preview content will be populated here -->
                </div>
            </div>
            
            <button onclick="generatePOReport()" id="generate-report-btn" disabled
                    class="btn-primary w-full py-3 text-lg font-bold shadow-2xl transform transition-all duration-500 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="flex items-center justify-center">
                    <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-download" /></svg>
                    Generate PO Report
                </span>
            </button>
            
            <div class="text-center">
                <button onclick="generateAllPOsReport()" id="generate-all-btn"
                        class="btn-secondary text-sm px-4 py-2 transform transition-all duration-300 hover:scale-105">
                    <span class="flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-list" /></svg>
                        Generate All POs Report
                    </span>
                </button>
            </div>
        </div>
        
        <!-- Report Preview Info -->
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 p-6 rounded-lg">
            <h4 class="font-bold text-gray-800 mb-3">Report Includes:</h4>
            <ul class="text-sm text-gray-700 space-y-2">
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-600" aria-hidden="true"><use href="#icon-check" /></svg>
                    Detailed PO breakdown with quantities ordered vs produced
                </li>
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-600" aria-hidden="true"><use href="#icon-check" /></svg>
                    Production timeline from delivery to completion
                </li>
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-600" aria-hidden="true"><use href="#icon-check" /></svg>
                    Average pack time calculations
                </li>
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-600" aria-hidden="true"><use href="#icon-check" /></svg>
                    Packaging breakdown (displays, packages, singles)
                </li>
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-600" aria-hidden="true"><use href="#icon-check" /></svg>
                    Damage analysis and efficiency metrics
                </li>
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-600" aria-hidden="true"><use href="#icon-check" /></svg>
                    Employee performance summary
                </li>
                <li class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-600" aria-hidden="true"><use href="#icon-check" /></svg>
                    Shipment tracking and delivery information
                </li>
            </ul>
            
            <div class="mt-4 p-3 bg-white rounded border-l-4 border-blue-500">
                <p class="text-sm font-medium text-blue-800">Perfect for Production Cycle Proof Points</p>
                <p class="text-xs text-blue-600 mt-1">Use these comprehensive reports to demonstrate efficiency and track performance metrics across your entire production workflow.</p>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Orders Table -->
<div class="card hover-lift">
    <div class="px-8 py-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <span class="text-3xl mr-4">üìã</span>
                <h3 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Active Purchase Orders</h3>
            </div>
        </div>
    </div>
    <div class="max-h-96 overflow-y-auto overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        PO Number
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Tablet Type
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Ordered
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Good
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Damaged
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Remaining
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Progress
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for po in active_pos %}
                <tr class="hover:bg-gray-50 po-row" data-po-index="{{ loop.index }}" data-po-id="{{ po.id }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ po.po_number }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ po.tablet_type or 'N/A' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ "{:,}".format(po.ordered_quantity) if po.ordered_quantity else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">
                        {{ "{:,}".format(po.current_good_count) if po.current_good_count else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">
                        {{ "{:,}".format(po.current_damaged_count) if po.current_damaged_count else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                        {{ "{:,}".format(po.remaining_quantity) if po.remaining_quantity else '0' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% set total_received = (po.current_good_count or 0) + (po.current_damaged_count or 0) %}
                        {% set ordered = po.ordered_quantity or 0 %}
                        {% if ordered > 0 %}
                            {% set progress_percent = ((total_received / ordered) * 100) | round(1) %}
                            <div class="flex items-center">
                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ progress_percent }}%"></div>
                                </div>
                                <span class="text-xs font-medium text-gray-700">{{ progress_percent }}%</span>
                            </div>
                        {% else %}
                            <span class="text-xs text-gray-400">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if po.status_display == 'Complete' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold status-complete shadow-lg transform transition-all duration-300 hover:scale-105">
                                ‚úÖ Complete
                            </span>
                        {% elif po.status_display == 'Closed' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-gray-400 to-gray-500 text-white shadow-lg">
                                üîí Closed
                            </span>
                        {% elif po.status_display == 'Reconciled' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-purple-400 to-purple-600 text-white shadow-lg">
                                üìã Reconciled
                            </span>
                        {% elif po.status_display == 'Ready for Payment' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-orange-400 to-orange-600 text-white shadow-lg">
                                üí∞ Ready for Payment
                            </span>
                        {% elif po.status_display == 'Processing' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold status-processing shadow-lg transform transition-all duration-300 hover:scale-105">
                                ‚öôÔ∏è Processing
                            </span>
                        {% elif po.status_display == 'Received' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-teal-400 to-cyan-500 text-white shadow-lg">
                                üì¶ Received
                            </span>
                        {% elif po.status_display == 'Partially Received' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-amber-400 to-yellow-500 text-white shadow-lg">
                                üì¶ Partial
                            </span>
                        {% elif po.status_display == 'Shipped' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold status-shipped shadow-lg transform transition-all duration-300 hover:scale-105">
                                üöö Shipped
                            </span>
                        {% elif po.status_display == 'Draft' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold status-draft shadow-lg transform transition-all duration-300 hover:scale-105">
                                üìù Draft
                            </span>
                        {% elif po.status_display == 'Issued' %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-blue-400 to-blue-600 text-white shadow-lg">
                                üì§ Issued
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-gray-400 to-gray-500 text-white shadow-lg">
                                {{ po.status_display }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="togglePODetails({{ po.id }}, this)" 
                                class="text-blue-600 hover:text-blue-900 font-medium">
                            ‚ñº View Details
                        </button>
                    </td>
                </tr>
                <!-- Expandable details row -->
                <tr id="details-{{ po.id }}" class="hidden bg-gray-50 po-details-row" data-po-index="{{ loop.index }}">
                    <td colspan="9" class="px-6 py-4">
                        <div id="details-content-{{ po.id }}" class="text-sm">
                            <div class="animate-pulse">Loading line items...</div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Recent Submissions Table -->
<div class="card hover-lift mt-10">
    <div class="px-8 py-6 border-b border-gray-200 cursor-pointer hover:bg-gray-50" onclick="toggleRecentSubmissions()">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <span class="text-3xl mr-4">üìù</span>
                <h3 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">Recent Submissions</h3>
                <span class="ml-3 text-sm text-gray-500">({{ submissions|length }} total)</span>
            </div>
            <span id="submissions-toggle-icon" class="text-gray-500 transform transition-transform rotate-90">‚ñ∂</span>
        </div>
    </div>
    <div id="recent-submissions-content" class="overflow-x-auto max-h-96 overflow-y-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Time (click to edit date)
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Employee
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Product
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Box/Bag
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Displays
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Packs
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Loose
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Damaged
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Count Check
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        PO
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for sub in submissions %}
                <tr class="submissions-row {% if sub.has_discrepancy %}bg-yellow-50 border-l-4 border-yellow-400{% else %}hover:bg-gray-50{% endif %}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 group cursor-pointer" onclick="toggleDateEdit({{ sub.id }})">
                        <span id="time-display-{{ sub.id }}" class="group-hover:text-blue-600">
                            {{ sub.created_at.split('.')[0] if sub.created_at else 'N/A' }}
                        </span>
                        <input type="date" 
                               id="time-edit-{{ sub.id }}"
                               value="{{ sub.submission_date or sub.created_at.split(' ')[0] if sub.created_at else '' }}"
                               onchange="updateSubmissionDate({{ sub.id }}, this.value)"
                               onblur="hideDateEdit({{ sub.id }})"
                               class="hidden text-sm border border-blue-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               title="Edit submission date">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ sub.employee_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub.product_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub.box_number }}/{{ sub.bag_number }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub.displays_made }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub.packs_remaining }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub.loose_tablets }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">
                        {{ sub.damaged_tablets }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if sub.has_discrepancy %}
                            <div class="text-orange-600 font-medium">
                                <div class="text-xs">Calc: {{ sub.calculated_total }}</div>
                                <div class="text-xs">Bag: {{ sub.bag_label_count }}</div>
                                <div class="text-xs font-bold">‚ö†Ô∏è Mismatch</div>
                            </div>
                        {% else %}
                            <span class="text-green-600 text-xs">‚úÖ Match</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub.po_number or 'Unassigned' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Closed Purchase Orders (Historical) -->
{% if closed_pos %}
<div class="bg-white rounded-lg shadow mt-8">
    <div class="px-6 py-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50" onclick="toggleClosedPOs()">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">üîí Closed Purchase Orders ({{ closed_pos|length }})</h3>
            <span id="closed-po-toggle-icon" class="text-gray-500 transform transition-transform">‚ñ∂</span>
        </div>
    </div>
    <div id="closed-pos-content" class="hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PO Number</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tablet Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ordered</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for po in closed_pos %}
                    <tr class="hover:bg-gray-50 opacity-75">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ po.po_number }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ po.tablet_type or 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "{:,}".format(po.ordered_quantity) if po.ordered_quantity else '0' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "{:,}".format((po.current_good_count or 0) + (po.current_damaged_count or 0)) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                üîí Closed
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button onclick="togglePODetails({{ po.id }}, this)" 
                                    class="text-blue-600 hover:text-blue-900 font-medium">
                                ‚ñº View Details
                            </button>
                        </td>
                    </tr>
                    <!-- Expandable details row for closed POs -->
                    <tr id="details-{{ po.id }}" class="hidden bg-gray-50">
                        <td colspan="6" class="px-6 py-4">
                            <div id="details-content-{{ po.id }}" class="text-sm">
                                <div class="animate-pulse">Loading line items...</div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Small Shipments Link -->
<div class="mt-6 text-center">
    <a href="/admin/shipments" class="text-xs text-gray-500 hover:text-gray-700 underline">
        Manage All Shipments
    </a>
</div>

<script>
async function findOrgId() {
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'üîç Searching...';
        
        const response = await fetch('/api/find_org_id');
        const result = await response.json();
        
        if (result.success) {
            let message = 'Found organizations:\n\n';
            result.organizations.forEach(org => {
                message += `Name: ${org.name}\n`;
                message += `ID: ${org.organization_id}\n`;
                message += `Currency: ${org.currency_code || 'N/A'}\n\n`;
            });
            message += 'Copy the organization_id you want to use into your .env file!';
            alert(message);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Org ID search failed: ' + error.message);
        event.target.disabled = false;
        event.target.textContent = 'üîç Find Correct Org ID';
    }
}

async function clearPOData() {
    if (!confirm('Are you sure you want to clear all PO data? This will remove all synced POs and line items.')) {
        return;
    }
    
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'üóëÔ∏è Clearing...';
        
        const response = await fetch('/api/clear_po_data', {method: 'POST'});
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Clear failed: ' + error.message);
        event.target.disabled = false;
        event.target.textContent = 'üóëÔ∏è Clear PO Data';
    }
}

async function testZohoConnection() {
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Testing...';
        
        const response = await fetch('/api/test_zoho_connection');
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Connection test failed: ' + error.message);
        event.target.disabled = false;
        event.target.textContent = 'Test Zoho Connection';
    }
}

async function syncZohoPOs() {
    try {
        const button = document.getElementById('sync-pos-btn');
        const originalText = button.textContent;
        button.disabled = true;
        button.style.opacity = '0.7';
        button.textContent = 'üîÑ SYNCING...';
        
        const response = await fetch('/api/sync_zoho_pos');
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            // Reload page to show new data
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error || 'Sync failed - check terminal for details');
        }
        
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    } catch (error) {
        showError('Sync failed: ' + error.message);
        const button = document.getElementById('sync-pos-btn');
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = 'üîÑ SYNC ZOHO POs';
    }
}

async function togglePODetails(poId, button) {
    const detailsRow = document.getElementById(`details-${poId}`);
    const detailsContent = document.getElementById(`details-content-${poId}`);
    
    if (detailsRow.classList.contains('hidden')) {
        // Show details
        button.textContent = '‚ñ≤ Hide Details';
        detailsRow.classList.remove('hidden');
        
        try {
            const response = await fetch(`/api/po_lines/${poId}`);
            const lines = await response.json();
            
            if (lines.length === 0) {
                detailsContent.innerHTML = '<div class="text-gray-500 italic">No line items found</div>';
            } else {
                let html = '<div class="space-y-2">';
                html += '<h4 class="font-medium text-gray-900 mb-3">üì¶ Line Items:</h4>';
                
                lines.forEach(line => {
                    const remaining = line.quantity_ordered - line.good_count - line.damaged_count;
                    const received = line.good_count + line.damaged_count;
                    const progressPercent = line.quantity_ordered > 0 ? ((received / line.quantity_ordered) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg p-3">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${line.line_item_name}</div>
                                    <div class="text-xs text-gray-500 font-mono">ID: ${line.inventory_item_id}</div>
                                    
                                    <!-- Progress bar for this line item -->
                                    <div class="mt-2 flex items-center">
                                        <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${progressPercent}%"></div>
                                        </div>
                                        <span class="text-xs font-medium text-gray-700">${progressPercent}%</span>
                                    </div>
                                </div>
                                
                                <div class="text-right ml-4">
                                    <div class="text-sm">
                                        <span class="text-gray-600">Ordered:</span> 
                                        <span class="font-medium">${line.quantity_ordered.toLocaleString()}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-green-600">Good:</span> ${line.good_count.toLocaleString()} | 
                                        <span class="text-red-600">Damaged:</span> ${line.damaged_count.toLocaleString()}
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-blue-600">Remaining:</span> 
                                        <span class="font-medium">${remaining.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                                                                </div>
                                    `;
                                });
                                
                                                // Add inline tracking info section
                html += `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <button onclick="toggleShippingDetails(${poId})" class="font-medium text-gray-900 hover:text-blue-600 cursor-pointer">üöö Shipping</button>
                            <div id="tracking-header-${poId}" class="text-sm">Loading...</div>
                        </div>
                        
                        <!-- Detailed shipping info (hidden by default) -->
                        <div id="shipping-details-${poId}" class="hidden mt-3 bg-white rounded border p-3 space-y-2 text-sm">
                            <div id="shipping-details-content-${poId}">Loading detailed shipping info...</div>
                        </div>
                        
                        <!-- Tracking edit form (hidden by default) -->
                        <div id="tracking-edit-${poId}" class="hidden mt-3 bg-gray-50 rounded-lg p-3 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="tracking-num-${poId}" placeholder="Tracking Number" class="text-sm px-3 py-2 border border-gray-300 rounded">
                                <select id="carrier-${poId}" class="text-sm px-3 py-2 border border-gray-300 rounded">
                                    <option value="">Select Carrier</option>
                                    <option value="FedEx">FedEx</option>
                                    <option value="UPS">UPS</option>
                                    <option value="USPS">USPS</option>
                                    <option value="DHL">DHL</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="date" id="shipped-date-${poId}" placeholder="Ship Date" class="text-sm px-3 py-2 border border-gray-300 rounded">
                                <input type="date" id="delivery-date-${poId}" placeholder="Expected Delivery" class="text-sm px-3 py-2 border border-gray-300 rounded">
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button onclick="saveTrackingInline(${poId})" class="text-green-600 hover:text-green-800 text-sm font-medium">Save</button>
                                <button onclick="cancelTrackingEdit(${poId})" class="text-gray-600 hover:text-gray-800 text-sm">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                                
                                html += '</div>';
                                detailsContent.innerHTML = html;
                                
                                // Load tracking info
                                loadTrackingInfo(poId);
            }
        } catch (error) {
            detailsContent.innerHTML = '<div class="text-red-500">Failed to load line items</div>';
        }
    } else {
        // Hide details
        button.textContent = '‚ñº View Details';
        detailsRow.classList.add('hidden');
    }
}

function exportData() {
    // This would export CSV data - implement as needed
    showSuccess('Export feature coming soon');
}

async function syncZohoPOs() {
    try {
        const button = document.getElementById('sync-pos-btn');
        const originalText = button.textContent;
        button.disabled = true;
        button.style.opacity = '0.7';
        button.textContent = 'üîÑ SYNCING...';
        
        const response = await fetch('/api/sync_zoho_pos');
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error || 'Sync failed - check terminal for details');
        }
        
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    } catch (error) {
        showError('Sync failed: ' + error.message);
        const button = document.getElementById('sync-pos-btn');
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = 'üîÑ SYNC ZOHO POs';
    }
}

async function clearPOData() {
    if (!confirm('This will delete all synced PO data. Are you sure?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/clear_po_data', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(result.error);
        }
    } catch (error) {
        showError('Failed to clear data: ' + error.message);
    }
}

async function resyncUnassignedSubmissions() {
    if (!confirm('This will re-match unassigned submissions to POs based on current item IDs. Continue?')) {
        return;
    }
    
    try {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'üîó Resyncing...';
        
        const response = await fetch('/api/resync_unassigned_submissions', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Resync failed: ' + error.message);
        if (event.target) {
            event.target.disabled = false;
            event.target.textContent = 'üîó Resync Unassigned Submissions';
        }
    }
}

function toggleDateEdit(submissionId) {
    const display = document.getElementById(`time-display-${submissionId}`);
    const input = document.getElementById(`time-edit-${submissionId}`);
    
    display.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus();
}

function hideDateEdit(submissionId) {
    setTimeout(() => {
        const display = document.getElementById(`time-display-${submissionId}`);
        const input = document.getElementById(`time-edit-${submissionId}`);
        
        display.classList.remove('hidden');
        input.classList.add('hidden');
    }, 200); // Small delay to allow onchange to fire first
}

async function updateSubmissionDate(submissionId, newDate) {
    try {
        const response = await fetch('/api/update_submission_date', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                submission_id: submissionId,
                submission_date: newDate
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Submission date updated successfully');
            // Update the display text to reflect the new date
            const display = document.getElementById(`time-display-${submissionId}`);
            if (display) {
                const currentTime = display.textContent.split(' ')[1] || '';
                display.textContent = `${newDate} ${currentTime}`;
            }
        } else {
            showError(result.error || 'Failed to update submission date');
        }
    } catch (error) {
        showError('Failed to update submission date: ' + error.message);
    }
}

async function refreshProducts() {
    if (!confirm('This will refresh all products with the updated configuration. Continue?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/refresh_products', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(result.error);
        }
    } catch (error) {
        showError('Failed to refresh products: ' + error.message);
    }
}

// toggleAllPurchaseOrders function removed - Active Purchase Orders now uses scrolling instead of expand/collapse

function getTrackingUrl(trackingNumber, carrier) {
    const tracking = trackingNumber.trim();
    
    switch(carrier) {
        case 'FedEx':
            return `https://www.fedex.com/fedextrack/?trknbr=${tracking}`;
        case 'UPS':
            return `https://www.ups.com/track?loc=en_US&tracknum=${tracking}`;
        case 'USPS':
            return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${tracking}`;
        case 'DHL':
            return `https://www.dhl.com/en/express/tracking.html?AWB=${tracking}`;
        default:
            // Google search fallback
            return `https://www.google.com/search?q=track+package+${encodeURIComponent(tracking)}`;
    }
}

async function loadTrackingInfo(poId) {
    try {
        const response = await fetch(`/api/po_tracking/${poId}`);
        const data = await response.json();
        
        const trackingHeader = document.getElementById(`tracking-header-${poId}`);
        const shippingDetails = document.getElementById(`shipping-details-content-${poId}`);
        
        if (data.has_tracking && data.shipments.length > 0) {
            // Show primary tracking number in header (most recent)
            const primaryShipment = data.shipments[0];
            const trackingUrl = getTrackingUrl(primaryShipment.tracking_number, primaryShipment.carrier);
            
            if (data.shipments.length === 1) {
                // Single shipment - show tracking # and delivery
                trackingHeader.innerHTML = `
                    <a href="${trackingUrl}" target="_blank" 
                       class="font-mono text-blue-600 hover:text-blue-800 underline">
                        ${primaryShipment.tracking_number}
                    </a>
                    ${primaryShipment.estimated_delivery ? ` | <span class="text-green-600 font-medium">Due: ${primaryShipment.estimated_delivery}</span>` : ''}
                `;
            } else {
                // Multiple shipments - show count
                trackingHeader.innerHTML = `
                    <span class="text-blue-600 font-medium">${data.shipments.length} Shipments</span>
                    ${primaryShipment.estimated_delivery ? ` | <span class="text-green-600 font-medium">Next: ${primaryShipment.estimated_delivery}</span>` : ''}
                `;
            }
            
            // Populate detailed shipping info (all shipments)
            let detailsHtml = '';
            data.shipments.forEach((shipment, index) => {
                const url = getTrackingUrl(shipment.tracking_number, shipment.carrier);
                detailsHtml += `
                    <div class="border-b border-gray-200 pb-2 ${index < data.shipments.length - 1 ? 'mb-2' : ''}">
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">Tracking #:</span> 
                                <a href="${url}" target="_blank" class="font-mono text-blue-600 hover:text-blue-800 underline">${shipment.tracking_number}</a>
                            </div>
                            <div><span class="text-gray-600">Carrier:</span> ${shipment.carrier || 'Not Set'}</div>
                            <div><span class="text-gray-600">Shipped:</span> ${shipment.shipped_date || 'Not Set'}</div>
                            <div><span class="text-gray-600">Est. Delivery:</span> ${shipment.estimated_delivery || 'Not Set'}</div>
                            ${shipment.actual_delivery ? `<div><span class="text-gray-600">Actual Delivery:</span> ${shipment.actual_delivery}</div>` : ''}
                            ${shipment.notes ? `<div class="col-span-2"><span class="text-gray-600">Notes:</span> ${shipment.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            detailsHtml += `
                <div class="mt-3 text-center">
                    <button onclick="editTrackingInline(${poId})" class="text-blue-600 hover:text-blue-800 text-sm mr-3">Add Another Shipment</button>
                </div>
            `;
            
            shippingDetails.innerHTML = detailsHtml;
        } else {
            // No tracking yet
            trackingHeader.innerHTML = `
                <button onclick="editTrackingInline(${poId})" 
                        class="text-blue-600 hover:text-blue-800 text-sm">
                    Add Tracking
                </button>
            `;
            
            shippingDetails.innerHTML = `
                <div class="text-center text-gray-500">
                    <p>No shipping information yet</p>
                    <button onclick="editTrackingInline(${poId})" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">Add Tracking Info</button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load tracking info:', error);
        const trackingHeader = document.getElementById(`tracking-header-${poId}`);
        if (trackingHeader) {
            trackingHeader.innerHTML = '<span class="text-red-500 text-sm">Error loading tracking</span>';
        }
    }
}

function editTrackingInline(poId) {
    document.getElementById(`tracking-edit-${poId}`).classList.remove('hidden');
}

function cancelTrackingEdit(poId) {
    document.getElementById(`tracking-edit-${poId}`).classList.add('hidden');
}

async function saveTrackingInline(poId) {
    const data = {
        po_id: poId,
        tracking_number: document.getElementById(`tracking-num-${poId}`).value,
        carrier: document.getElementById(`carrier-${poId}`).value,
        shipped_date: document.getElementById(`shipped-date-${poId}`).value,
        estimated_delivery: document.getElementById(`delivery-date-${poId}`).value
    };
    
    try {
        const response = await fetch('/api/save_shipment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            showSuccess('Tracking info saved!');
            // Reload tracking info and hide edit form
            await loadTrackingInfo(poId);
            cancelTrackingEdit(poId);
            // Reload page to update status if it changed to "Shipped"
            setTimeout(() => location.reload(), 1000);
        } else {
            showError(result.error);
        }
    } catch (error) {
        showError('Failed to save tracking: ' + error.message);
    }
}

function toggleClosedPOs() {
    const content = document.getElementById('closed-pos-content');
    const icon = document.getElementById('closed-po-toggle-icon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '‚ñº';
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.classList.add('hidden');
        icon.textContent = '‚ñ∂';
        icon.style.transform = 'rotate(-90deg)';
    }
}

function toggleRecentSubmissions() {
    const content = document.getElementById('recent-submissions-content');
    const icon = document.getElementById('submissions-toggle-icon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-90');
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-90');
    }
}

// toggleAllSubmissions function removed - Recent Submissions now uses scrolling instead of expand/collapse

function toggleShippingDetails(poId) {
    const details = document.getElementById(`shipping-details-${poId}`);
    details.classList.toggle('hidden');
}

// Load available POs on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAvailablePOs();
});

async function loadAvailablePOs() {
    try {
        const response = await fetch('/api/reports/po-summary');
        const data = await response.json();
        
        const selector = document.getElementById('po_selector');
        selector.innerHTML = '<option value="">Select a PO...</option>';
        
        if (data.success && data.pos) {
            data.pos.forEach(po => {
                const option = document.createElement('option');
                option.value = po.po_number;
                option.textContent = `${po.po_number} - ${po.tablet_type || 'N/A'} (${po.ordered || 0} tablets)`;
                option.dataset.poData = JSON.stringify(po);
                selector.appendChild(option);
            });
        }
        
        // Add change listener
        selector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const button = document.getElementById('generate-report-btn');
            const preview = document.getElementById('po_preview');
            const previewContent = document.getElementById('po_preview_content');
            
            if (this.value && selectedOption.dataset.poData) {
                const poData = JSON.parse(selectedOption.dataset.poData);
                button.disabled = false;
                preview.classList.remove('hidden');
                
                previewContent.innerHTML = `
                    <div><strong>PO Number:</strong> ${poData.po_number}</div>
                    <div><strong>Tablet Type:</strong> ${poData.tablet_type || 'N/A'}</div>
                    <div><strong>Status:</strong> ${poData.status || 'Unknown'}</div>
                    <div><strong>Ordered:</strong> ${poData.ordered || 0} tablets</div>
                    <div><strong>Produced:</strong> ${poData.produced || 0} tablets</div>
                    <div><strong>Damaged:</strong> ${poData.damaged || 0} tablets</div>
                    <div><strong>Submissions:</strong> ${poData.submissions || 0}</div>
                    ${poData.pack_time_days ? `<div><strong>Pack Time:</strong> ${poData.pack_time_days} days</div>` : ''}
                `;
            } else {
                button.disabled = true;
                preview.classList.add('hidden');
            }
        });
        
    } catch (error) {
        console.error('Failed to load POs:', error);
        const selector = document.getElementById('po_selector');
        selector.innerHTML = '<option value="">Error loading POs</option>';
    }
}

async function generatePOReport() {
    const selector = document.getElementById('po_selector');
    const button = document.getElementById('generate-report-btn');
    const originalText = button.innerHTML;
    
    if (!selector.value) {
        showError('Please select a PO first');
        return;
    }
    
    try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = `
            <span class="flex items-center justify-center">
                <svg class="animate-spin w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-spinner" /></svg>
                Generating Report...
            </span>
        `;
        
        // Prepare request data for single PO
        const requestData = {
            po_numbers: [selector.value]
        };
        
        // Make API request
        const response = await fetch('/api/reports/production', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Generate filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        a.download = `${selector.value}_production_report_${timestamp}.pdf`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showSuccess(`Report for ${selector.value} generated successfully!`);
        
    } catch (error) {
        console.error('Report generation error:', error);
        showError('Failed to generate report: ' + error.message);
    } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

async function generateAllPOsReport() {
    const button = document.getElementById('generate-all-btn');
    const originalText = button.innerHTML;
    
    try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = `
            <span class="flex items-center justify-center">
                <svg class="animate-spin w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-spinner" /></svg>
                Generating...
            </span>
        `;
        
        // Generate report with no filters (all POs)
        const requestData = {};
        
        // Make API request
        const response = await fetch('/api/reports/production', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Generate filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        a.download = `all_pos_production_report_${timestamp}.pdf`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showSuccess('All POs report generated successfully!');
        
    } catch (error) {
        console.error('Report generation error:', error);
        showError('Failed to generate report: ' + error.message);
    } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    }
}
</script>
{% endblock %}
