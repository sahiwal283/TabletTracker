{% extends "base.html" %}

{% block title %}Production{% endblock %}

{% block content %}
<div class="max-w-md mx-auto px-3 sm:px-0">
    <!-- Form Toggle Buttons -->
    <div class="flex justify-center mb-4 sm:mb-6 gap-1 sm:gap-2">
        <button id="toggle-machine-count" onclick="switchForm('machine-count')" 
                class="flex-1 px-3 sm:px-6 py-3 sm:py-3 rounded-lg font-semibold text-xs sm:text-base transition-all duration-300 bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg hover:shadow-xl">
            Machine Count
        </button>
        <button id="toggle-production-submission" onclick="switchForm('submission')" 
                class="flex-1 px-3 sm:px-6 py-3 sm:py-3 rounded-lg font-semibold text-xs sm:text-base transition-all duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300">
            Packaged
        </button>
        <button id="toggle-bag-count" onclick="switchForm('bag-count')" 
                class="flex-1 px-3 sm:px-6 py-3 sm:py-3 rounded-lg font-semibold text-xs sm:text-base transition-all duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300">
            Bag Count
        </button>
    </div>

    <!-- Machine Count Form (Default/First) -->
    <div id="machine-count-form" class="card hover-lift p-4 sm:p-8">
        <div class="text-center mb-6 sm:mb-8">
            <div class="mb-3 sm:mb-4 flex justify-center"><svg class="w-10 h-10 sm:w-12 sm:h-12" aria-hidden="true"><use href="#icon-gear" /></svg></div>
            <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">Machine Count</h2>
            {% if employee %}
            <div class="bg-gradient-to-r from-green-100 to-emerald-100 border border-green-200 rounded-xl p-3 sm:p-4 mb-3 sm:mb-4">
                <p class="text-green-800 font-semibold flex items-center justify-center text-base sm:text-lg">
                    <span class="text-xl sm:text-2xl mr-2 sm:mr-3">üë∑</span>
                    {{ gettext('Logged in as') }}: {{ employee.full_name }}
                </p>
            </div>
            {% endif %}
            <p class="text-sm sm:text-base text-gray-600">Enter the counter number on the machine for that particular flavor</p>
        </div>
        
        <form id="machine-count-form-submit" class="space-y-4">
            <!-- Tablet Type Selection -->
            <div>
                <label for="machine_tablet_type" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">
                    Tablet Type *
                </label>
                <select id="machine_tablet_type" name="tablet_type_id" required class="form-input">
                    <option value="">Select tablet type...</option>
                    {% for tablet_type in tablet_types %}
                        <option value="{{ tablet_type.id }}">{{ tablet_type.tablet_type_name }}</option>
                    {% endfor %}
                </select>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const select = document.getElementById('machine_tablet_type');
                        if (select && typeof convertToTwoLevelDropdown === 'function') {
                            convertToTwoLevelDropdown(select);
                        }
                    });
                </script>
            </div>
            
            <!-- Machine Selection -->
            <div>
                <label for="machine_id" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">
                    Machine *
                </label>
                <select id="machine_id" name="machine_id" required class="form-input text-base">
                    <option value="">Select machine...</option>
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>
            
            <!-- Box Number -->
            <div>
                <label for="machine_box_number" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">
                    Box Number *
                </label>
                <input type="text" id="machine_box_number" name="box_number" required
                       class="form-input text-base" placeholder="Enter box number">
            </div>
            
            <!-- Bag Number -->
            <div>
                <label for="machine_bag_number" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">
                    Bag Number *
                </label>
                <input type="text" id="machine_bag_number" name="bag_number" required
                       class="form-input text-base" placeholder="Enter bag number">
            </div>
            
            <!-- Machine Count -->
            <div>
                <label for="machine_count" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">
                    Machine Count *
                </label>
                <input type="number" id="machine_count" name="machine_count" required
                       class="form-input text-base" min="0" placeholder="Enter counter number">
            </div>
            
            <!-- Receipt Number -->
            <div>
                <label for="machine_receipt_number" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">
                    Receipt # *
                </label>
                <input type="text" id="machine_receipt_number" name="receipt_number" required
                       class="form-input text-base" placeholder="Enter receipt number">
                <p class="text-xs text-gray-500 mt-1">üí° This receipt number will be used by the packaging team</p>
            </div>
            
            <!-- Admin Notes (optional) -->
            <div>
                <label for="machine_admin_notes" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">
                    Admin Notes (Optional)
                </label>
                <textarea id="machine_admin_notes" name="admin_notes" rows="3"
                          class="form-input text-base" placeholder="Add notes..."></textarea>
                <p class="text-xs sm:text-xs text-gray-500 mt-1">üîí Admins/managers only</p>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="w-full py-4 px-6 text-base sm:text-lg font-bold btn-primary mt-6 sm:mt-8 transform transition-all duration-300 active:scale-95 sm:hover:scale-105 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-send" /></svg>
                Submit Machine Count
            </button>
        </form>
        
        <!-- Success/Error Messages -->
        <div id="machine-count-form-messages" class="mt-4"></div>
    </div>

    <!-- Packaged Form (Previously Production Submission) -->
    <div id="production-submission-form" class="card hover-lift p-8 hidden">
        <div class="text-center mb-8">
            <div class="mb-4 flex justify-center"><svg class="w-12 h-12" aria-hidden="true"><use href="#icon-box" /></svg></div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">{{ gettext('Packaged') }}</h2>
            {% if employee %}
            <div class="bg-gradient-to-r from-green-100 to-emerald-100 border border-green-200 rounded-xl p-4 mb-4">
                <p class="text-green-800 font-semibold flex items-center justify-center">
                    <span class="text-2xl mr-3">üë∑</span>
                    {{ gettext('Logged in as') }}: {{ employee.full_name }}
                </p>
            </div>
            {% endif %}
            <p class="text-gray-600">{{ gettext('Enter your production counts below') }}</p>
            
            <!-- Logout button -->
            <div class="mt-4">
                <a href="/logout" class="text-sm text-red-600 hover:text-red-800 underline inline-flex items-center">
                    <svg class="w-4 h-4 mr-1" aria-hidden="true"><use href="#icon-logout" /></svg>
                    {{ gettext('Logout') }}
                </a>
            </div>
        </div>
        
        <form id="warehouse-form" class="space-y-4">
            
            <!-- Receipt Number (Primary Identifier) -->
            <div>
                <label for="receipt_number" class="block text-sm font-medium text-gray-700 mb-1">
                    Receipt # *
                </label>
                <input type="text" id="receipt_number" name="receipt_number" required
                       class="form-input" placeholder="Enter receipt number from production">
                <p class="text-xs text-gray-500 mt-1">üí° This will auto-fill box, bag, and tablet type</p>
            </div>
            
            <!-- Receipt Lookup Status Message -->
            <div id="receipt-lookup-status" class="hidden"></div>
            
            <!-- Hidden fields for box/bag (populated via JavaScript) -->
            <input type="hidden" id="box_number" name="box_number">
            <input type="hidden" id="bag_number" name="bag_number">
            
            <!-- Product Selection with Count -->
            <div class="grid grid-cols-1 gap-3">
                <div>
                    <label for="product_base" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ gettext('Product Type') }} *
                    </label>
                    <select id="product_base" name="product_base" class="form-input" disabled>
                        <option value="">{{ gettext('Select product type...') }}</option>
                    </select>
                </div>
                
                <div id="count-selection" class="hidden">
                    <label for="product_count" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ gettext('Count') }} *
                    </label>
                    <select id="product_count" name="product_count" class="form-input" disabled>
                        <option value="">{{ gettext('Select count...') }}</option>
                    </select>
                </div>
                
                <!-- Hidden field for the actual product name -->
                <input type="hidden" id="product_name" name="product_name">
            </div>
            
            <!-- Fallback Section (shown when receipt not found) -->
            <div id="fallback-section" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 space-y-3">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-yellow-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <div class="flex-1">
                        <h4 class="text-sm font-medium text-yellow-800">Manual Entry Required</h4>
                        <p class="text-xs text-yellow-700 mt-1">No machine count found for this receipt. Please enter box and bag numbers manually.</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <!-- Fallback Box Number -->
                    <div>
                        <label for="fallback_box_number" class="block text-xs font-medium text-gray-700 mb-1">
                            Box # *
                        </label>
                        <input type="number" id="fallback_box_number" 
                               class="form-input text-sm" min="1" max="999" placeholder="Box #">
                    </div>
                    
                    <!-- Fallback Bag Number -->
                    <div>
                        <label for="fallback_bag_number" class="block text-xs font-medium text-gray-700 mb-1">
                            Bag # *
                        </label>
                        <input type="number" id="fallback_bag_number"
                               class="form-input text-sm" min="1" max="999" placeholder="Bag #">
                    </div>
                </div>
            </div>
            
            <!-- Production Counts -->
            <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-6 rounded-xl border border-indigo-100 space-y-4">
                <div class="flex items-center mb-4">
                    <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-gear" /></svg>
                    <h3 class="text-lg font-semibold bg-gradient-to-r from-indigo-700 to-purple-700 bg-clip-text text-transparent">{{ gettext('Production Details') }}</h3>
                </div>
                
                <div>
                    <label for="displays_made" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ gettext('Displays Made') }} *
                    </label>
                    <input type="number" id="displays_made" name="displays_made" required
                           class="form-input" min="0" value="0">
                </div>
                
                <div>
                    <label for="packs_remaining" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ gettext('Cards Remaining') }} *
                    </label>
                    <input type="number" id="packs_remaining" name="packs_remaining" required
                           class="form-input" min="0" value="0">
                </div>
            </div>
            
            <!-- Admin Notes (Admin Only) -->
            {% if is_admin %}
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <label for="admin_notes" class="block text-sm font-medium text-purple-800 mb-1">
                    üîí Admin Notes (Optional)
                </label>
                <textarea id="admin_notes" name="admin_notes" rows="3"
                          class="form-input w-full" 
                          placeholder="Add internal notes visible to admins and managers..."></textarea>
                <p class="text-xs text-purple-600 mt-1">These notes are visible to administrators and managers</p>
            </div>
            {% endif %}
            
            <!-- Submit Button -->
            <button type="submit" class="w-full py-4 px-6 text-lg font-bold btn-primary mt-8 transform transition-all duration-300 hover:scale-105 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-send" /></svg>
                {{ gettext('Submit Production Count') }}
            </button>
        </form>
        
        <!-- Success/Error Messages -->
        <div id="form-messages" class="mt-4"></div>
    </div>

    <!-- Bag Count Form (Hidden by default) -->
    <div id="bag-count-form" class="card hover-lift p-8 hidden">
        <div class="text-center mb-8">
            <div class="mb-4 flex justify-center"><svg class="w-12 h-12" aria-hidden="true"><use href="#icon-clipboard" /></svg></div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">Bag Count</h2>
            {% if employee %}
            <div class="bg-gradient-to-r from-green-100 to-emerald-100 border border-green-200 rounded-xl p-4 mb-4">
                <p class="text-green-800 font-semibold flex items-center justify-center">
                    <span class="text-2xl mr-3">üë∑</span>
                    {{ gettext('Logged in as') }}: {{ employee.full_name }}
                </p>
            </div>
            {% endif %}
            <p class="text-gray-600">For end-of-period PO close-outs with vendors</p>
        </div>
        
        <form id="count-form" class="space-y-4">
            <!-- Tablet Type Selection -->
            <div>
                <label for="tablet_type" class="block text-sm font-medium text-gray-700 mb-1">
                    Tablet Type *
                </label>
                <select id="tablet_type" name="tablet_type" required class="form-input">
                    <option value="">Select category...</option>
                    {% for tablet_type in tablet_types %}
                        <option value="{{ tablet_type.tablet_type_name }}">
                            {{ tablet_type.tablet_type_name }}
                        </option>
                    {% endfor %}
                </select>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const select = document.getElementById('tablet_type');
                        if (select && typeof convertToTwoLevelDropdown === 'function') {
                            convertToTwoLevelDropdown(select);
                        }
                    });
                </script>
            </div>
            
            <!-- Box Number -->
            <div>
                <label for="count_box_number" class="block text-sm font-medium text-gray-700 mb-1">
                    Box # *
                </label>
                <input type="number" id="count_box_number" name="box_number" required
                       class="form-input" min="1" max="999" placeholder="Box #">
            </div>
            
            <!-- Bag Number -->
            <div>
                <label for="count_bag_number" class="block text-sm font-medium text-gray-700 mb-1">
                    Bag # *
                </label>
                <input type="number" id="count_bag_number" name="bag_number" required
                       class="form-input" min="1" max="999" placeholder="Bag #">
            </div>
            
            <!-- Manual Count -->
            <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-6 rounded-xl border border-indigo-100 space-y-4">
                <div class="flex items-center mb-4">
                    <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-clipboard" /></svg>
                    <h3 class="text-lg font-semibold bg-gradient-to-r from-indigo-700 to-purple-700 bg-clip-text text-transparent">Manual Count</h3>
                </div>
                
                <div>
                    <label for="actual_count" class="block text-sm font-medium text-gray-700 mb-1">
                        Actual Count *
                    </label>
                    <input type="number" id="actual_count" name="actual_count" required
                           class="form-input" min="0" placeholder="Enter the actual count of tablets you counted">
                </div>
            </div>
            
            <!-- Count Comparison -->
            <div id="count-comparison" class="bg-gray-50 p-4 rounded-md hidden">
                <h3 class="font-medium text-gray-900 mb-2">Count Comparison</h3>
                <div class="text-sm space-y-1">
                    <div>Bag Label: <span id="label-display" class="font-medium">0</span></div>
                    <div>Actual Count: <span id="actual-display" class="font-medium">0</span></div>
                    <div id="variance-display" class="font-medium"></div>
                </div>
            </div>
            
            <!-- Admin Notes (Admin Only) -->
            {% if is_admin %}
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <label for="count_admin_notes" class="block text-sm font-medium text-purple-800 mb-1">
                    üîí Admin Notes (Optional)
                </label>
                <textarea id="count_admin_notes" name="admin_notes" rows="3"
                          class="form-input w-full" 
                          placeholder="Add internal notes visible to admins and managers..."></textarea>
                <p class="text-xs text-purple-600 mt-1">These notes are visible to administrators and managers</p>
            </div>
            {% endif %}
            
            <!-- Submit Button -->
            <button type="submit" class="w-full py-4 px-6 text-lg font-bold btn-primary mt-8 transform transition-all duration-300 hover:scale-105 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-send" /></svg>
                Submit Bag Count
            </button>
        </form>
        
        <!-- Success/Error Messages -->
        <div id="count-form-messages" class="mt-4"></div>
    </div>

</div>

<script>
// Form switching function
function switchForm(formType) {
    const submissionForm = document.getElementById('production-submission-form');
    const bagCountForm = document.getElementById('bag-count-form');
    const machineCountForm = document.getElementById('machine-count-form');
    const submissionBtn = document.getElementById('toggle-production-submission');
    const bagCountBtn = document.getElementById('toggle-bag-count');
    const machineCountBtn = document.getElementById('toggle-machine-count');
    
    // Hide all forms
    submissionForm.classList.add('hidden');
    bagCountForm.classList.add('hidden');
    machineCountForm.classList.add('hidden');
    
    // Reset all buttons
    [submissionBtn, bagCountBtn, machineCountBtn].forEach(btn => {
        btn.classList.remove('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'text-white', 'shadow-lg');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    // Show selected form and highlight button
    if (formType === 'machine-count') {
        machineCountForm.classList.remove('hidden');
        machineCountBtn.classList.remove('bg-gray-200', 'text-gray-700');
        machineCountBtn.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'text-white', 'shadow-lg');
    } else if (formType === 'submission') {
        submissionForm.classList.remove('hidden');
        submissionBtn.classList.remove('bg-gray-200', 'text-gray-700');
        submissionBtn.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'text-white', 'shadow-lg');
    } else if (formType === 'bag-count') {
        bagCountForm.classList.remove('hidden');
        bagCountBtn.classList.remove('bg-gray-200', 'text-gray-700');
        bagCountBtn.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'text-white', 'shadow-lg');
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    // Production Submission Form
    const warehouseForm = document.getElementById('warehouse-form');
    const productBaseSelect = document.getElementById('product_base');
    const productCountSelect = document.getElementById('product_count');
    const countSelection = document.getElementById('count-selection');
    const productNameHidden = document.getElementById('product_name');
    
    // Receipt lookup elements
    const receiptInput = document.getElementById('receipt_number');
    const receiptStatus = document.getElementById('receipt-lookup-status');
    const hiddenBoxField = document.getElementById('box_number');
    const hiddenBagField = document.getElementById('bag_number');
    const fallbackSection = document.getElementById('fallback-section');
    const fallbackBoxInput = document.getElementById('fallback_box_number');
    const fallbackBagInput = document.getElementById('fallback_bag_number');
    
    // Track if receipt lookup was successful
    let receiptLookupSuccess = false;
    let autoSelectedTabletTypeId = null;
    
    // Product data from server
    const products = [
        {% for product in products %}
        {
            name: "{{ product.product_name }}",
            ppd: {{ product.packages_per_display }},
            tpp: {{ product.tablets_per_package }},
            tabletType: "{{ product.tablet_type_name }}"
        },
        {% endfor %}
    ];
    
    // Group products by base type (remove count suffix)
    const productGroups = {};
    products.forEach(product => {
        const baseName = product.name.replace(/\s+(1ct|4ct|5ct|7ct|12ct)$/i, '');
        const countMatch = product.name.match(/(\d+)ct$/i);
        const count = countMatch ? countMatch[1] : null;
        
        if (!productGroups[baseName]) {
            productGroups[baseName] = [];
        }
        productGroups[baseName].push({
            ...product,
            count: count
        });
    });
    
    // Fetch tablet type categories from API to group products
    let categoryGroups = {};
    let categoryOrder = ['FIX Energy', 'FIX Focus', 'FIX Relax', 'FIX MAX', '18mg', 'XL', 'Hyroxi', 'Other'];
    
    try {
        const response = await fetch('/api/tablet_types/categories');
        const data = await response.json();
        
        if (data.success && data.categories) {
            categoryOrder = data.category_order || categoryOrder;
            
            // Initialize category groups
            categoryOrder.forEach(cat => {
                categoryGroups[cat] = [];
            });
            
            // Group product bases by their tablet type's category
            Object.keys(productGroups).forEach(baseName => {
                // Find the tablet type for products in this base group
                const firstProduct = productGroups[baseName][0];
                const tabletTypeName = firstProduct.tabletType;
                
                // Find which category this tablet type belongs to
                let found = false;
                for (const [category, items] of Object.entries(data.categories)) {
                    const matchingItem = items.find(item => item.name === tabletTypeName);
                    if (matchingItem) {
                        if (!categoryGroups[category]) {
                            categoryGroups[category] = [];
                        }
                        categoryGroups[category].push(baseName);
                        found = true;
                        break;
                    }
                }
                
                // Fallback to pattern matching if not found in configured categories
                if (!found) {
                    let categorized = false;
                    
                    // FIX Energy variants
                    if (baseName.match(/^FIX\s+Energy/i) || baseName.match(/Energy/i)) {
                        if (!categoryGroups['FIX Energy']) categoryGroups['FIX Energy'] = [];
                        categoryGroups['FIX Energy'].push(baseName);
                        categorized = true;
                    }
                    // FIX Focus variants
                    else if (baseName.match(/^FIX\s+Focus/i) || baseName.match(/Focus/i)) {
                        if (!categoryGroups['FIX Focus']) categoryGroups['FIX Focus'] = [];
                        categoryGroups['FIX Focus'].push(baseName);
                        categorized = true;
                    }
                    // FIX Relax variants
                    else if (baseName.match(/^FIX\s+Relax/i) || baseName.match(/Relax/i)) {
                        if (!categoryGroups['FIX Relax']) categoryGroups['FIX Relax'] = [];
                        categoryGroups['FIX Relax'].push(baseName);
                        categorized = true;
                    }
                    // FIX MAX variants
                    else if (baseName.match(/^FIX\s+MAX/i)) {
                        if (!categoryGroups['FIX MAX']) categoryGroups['FIX MAX'] = [];
                        categoryGroups['FIX MAX'].push(baseName);
                        categorized = true;
                    }
                    // 18mg variants
                    else if (baseName.match(/^18mg/i) || baseName.match(/^7OH$/i) || baseName.match(/^Hybrid$/i) || baseName.match(/^Pseudo$/i)) {
                        if (!categoryGroups['18mg']) categoryGroups['18mg'] = [];
                        categoryGroups['18mg'].push(baseName);
                        categorized = true;
                    }
                    // XL variants
                    else if (baseName.match(/^XL/i)) {
                        if (!categoryGroups['XL']) categoryGroups['XL'] = [];
                        categoryGroups['XL'].push(baseName);
                        categorized = true;
                    }
                    // Hyroxi variants
                    else if (baseName.match(/^Hyroxi/i)) {
                        if (!categoryGroups['Hyroxi']) categoryGroups['Hyroxi'] = [];
                        categoryGroups['Hyroxi'].push(baseName);
                        categorized = true;
                    }
                    
                    if (!categorized) {
                        if (!categoryGroups['Other']) categoryGroups['Other'] = [];
                        categoryGroups['Other'].push(baseName);
                    }
                }
            });
        } else {
            throw new Error('Failed to load categories');
        }
    } catch (error) {
        // Fallback to hardcoded logic if API fails
        console.warn('Failed to load configured categories, using fallback:', error);
        categoryGroups = {
            'FIX Energy': [],
            'FIX Focus': [],
            'FIX Relax': [],
            'FIX MAX': [],
            '18mg': [],
            'XL': [],
            'Hyroxi': [],
            'Other': []
        };
        
        Object.keys(productGroups).forEach(baseName => {
            let categorized = false;
            
            // FIX Energy variants
            if (baseName.match(/^FIX\s+Energy/i) || baseName.match(/Energy/i)) {
                categoryGroups['FIX Energy'].push(baseName);
                categorized = true;
            }
            // FIX Focus variants
            else if (baseName.match(/^FIX\s+Focus/i) || baseName.match(/Focus/i)) {
                categoryGroups['FIX Focus'].push(baseName);
                categorized = true;
            }
            // FIX Relax variants
            else if (baseName.match(/^FIX\s+Relax/i) || baseName.match(/Relax/i)) {
                categoryGroups['FIX Relax'].push(baseName);
                categorized = true;
            }
            // FIX MAX variants
            else if (baseName.match(/^FIX\s+MAX/i)) {
                categoryGroups['FIX MAX'].push(baseName);
                categorized = true;
            }
            // 18mg variants
            else if (baseName.match(/^18mg/i) || baseName.match(/^7OH$/i) || baseName.match(/^Hybrid$/i) || baseName.match(/^Pseudo$/i)) {
                categoryGroups['18mg'].push(baseName);
                categorized = true;
            }
            // XL variants
            else if (baseName.match(/^XL/i)) {
                categoryGroups['XL'].push(baseName);
                categorized = true;
            }
            // Hyroxi variants
            else if (baseName.match(/^Hyroxi/i)) {
                categoryGroups['Hyroxi'].push(baseName);
                categorized = true;
            }
            
            if (!categorized) {
                categoryGroups['Other'].push(baseName);
            }
        });
    }
    
    // Convert product_base dropdown to two-level system
    const originalProductBase = productBaseSelect;
    originalProductBase.style.display = 'none';
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'space-y-2';
    
    // Create category dropdown
    const categorySelect = document.createElement('select');
    categorySelect.className = originalProductBase.className;
    categorySelect.id = 'product_category';
    categorySelect.name = 'product_category';
    categorySelect.required = originalProductBase.required;
    categorySelect.innerHTML = '<option value="">Select category...</option>';
    
    // Create base product dropdown
    const baseSelect = document.createElement('select');
    baseSelect.className = originalProductBase.className;
    baseSelect.id = 'product_base_item';
    baseSelect.name = originalProductBase.name;
    baseSelect.required = originalProductBase.required;
    baseSelect.innerHTML = '<option value="">Select product type...</option>';
    baseSelect.style.display = 'none';
    
    // Add categories to category dropdown
    categoryOrder.forEach(categoryName => {
        if (!categoryGroups[categoryName] || categoryGroups[categoryName].length === 0) return;
        const option = document.createElement('option');
        option.value = categoryName;
        option.textContent = categoryName;
        categorySelect.appendChild(option);
    });
    
    // Store category groups data
    categorySelect.dataset.categoryGroups = JSON.stringify(categoryGroups);
    categorySelect.dataset.productGroups = JSON.stringify(productGroups);
    
    // Handle category selection
    categorySelect.addEventListener('change', function() {
        const selectedCategory = this.value;
        baseSelect.innerHTML = '<option value="">Select product type...</option>';
        baseSelect.style.display = 'none';
        originalProductBase.value = '';
        productCountSelect.innerHTML = '<option value="">Select count...</option>';
        countSelection.classList.add('hidden');
        productNameHidden.value = '';
        
        if (selectedCategory && categoryGroups[selectedCategory]) {
            // Populate base product dropdown with case-insensitive alphabetical sorting
            categoryGroups[selectedCategory]
                .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }))
                .forEach(baseName => {
                    const option = document.createElement('option');
                    option.value = baseName;
                    option.textContent = baseName;
                    baseSelect.appendChild(option);
                });
            baseSelect.style.display = '';
        }
    });
    
    // Handle base product selection (reuse existing logic)
    baseSelect.addEventListener('change', function() {
        originalProductBase.value = this.value;
        productCountSelect.innerHTML = '<option value="">Select count...</option>';
        countSelection.classList.add('hidden');
        productNameHidden.value = '';
        
        if (this.value) {
            const availableCounts = productGroups[this.value] || [];
            availableCounts.sort((a, b) => parseInt(a.count || 0) - parseInt(b.count || 0));
            
            availableCounts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.textContent = product.count ? `${product.count}ct` : product.name;
                option.dataset.ppd = product.ppd;
                option.dataset.tpp = product.tpp;
                option.dataset.tabletType = product.tabletType;
                productCountSelect.appendChild(option);
            });
            
            countSelection.classList.remove('hidden');
        }
    });
    
    // Insert wrapper before original select
    const parent = originalProductBase.parentNode;
    parent.insertBefore(wrapper, originalProductBase);
    wrapper.appendChild(categorySelect);
    wrapper.appendChild(baseSelect);
    wrapper.appendChild(originalProductBase); // Keep original for form submission
    
    // Handle count selection
    productCountSelect.addEventListener('change', function() {
        productNameHidden.value = this.value;
    });
    
    // Receipt lookup functionality
    if (receiptInput) {
        receiptInput.addEventListener('blur', async function() {
            const receiptNum = this.value.trim();
            if (!receiptNum) {
                // Reset everything if receipt is cleared
                resetToManualEntry();
                return;
            }
            
            try {
                // Show loading state
                receiptStatus.innerHTML = '<p class="text-sm text-blue-600">üîÑ Looking up receipt...</p>';
                receiptStatus.classList.remove('hidden');
                
                // Call API to lookup machine count
                const response = await fetch(`/api/machine-count/by-receipt?receipt=${encodeURIComponent(receiptNum)}`);
                const data = await response.json();
                
                if (data.success && data.machine_count) {
                    // Success - auto-fill everything
                    const mc = data.machine_count;
                    receiptLookupSuccess = true;
                    autoSelectedTabletTypeId = mc.tablet_type_id;
                    
                    // Auto-fill hidden box/bag fields
                    hiddenBoxField.value = mc.box_number;
                    hiddenBagField.value = mc.bag_number;
                    
                    // Hide fallback section
                    fallbackSection.classList.add('hidden');
                    
                    // Find the category for this tablet type
                    const tabletTypeName = mc.tablet_type_name;
                    let matchedCategory = null;
                    
                    // Search in category groups
                    for (const [category, baseNames] of Object.entries(categoryGroups)) {
                        for (const baseName of baseNames) {
                            const productsInBase = productGroups[baseName] || [];
                            if (productsInBase.some(p => p.tabletType === tabletTypeName)) {
                                matchedCategory = category;
                                break;
                            }
                        }
                        if (matchedCategory) break;
                    }
                    
                    if (matchedCategory) {
                        // Set category (trigger change to populate base products)
                        categorySelect.value = matchedCategory;
                        categorySelect.dispatchEvent(new Event('change'));
                        categorySelect.disabled = true;
                        
                        // Wait a tick for the change event to process
                        setTimeout(() => {
                            // Find matching base name and products for this tablet type
                            let matchedBaseName = null;
                            let matchingProducts = [];
                            
                            for (const [baseName, productsInBase] of Object.entries(productGroups)) {
                                const matches = productsInBase.filter(p => p.tabletType === tabletTypeName);
                                if (matches.length > 0) {
                                    matchedBaseName = baseName;
                                    matchingProducts = matches;
                                    break;
                                }
                            }
                            
                            if (matchedBaseName && matchingProducts.length > 0) {
                                // Set base product
                                baseSelect.value = matchedBaseName;
                                baseSelect.dispatchEvent(new Event('change'));
                                baseSelect.disabled = true;
                                
                                // Show count selection
                                countSelection.classList.remove('hidden');
                                
                                if (matchingProducts.length === 1) {
                                    // Auto-select the only product
                                    productCountSelect.value = matchingProducts[0].name;
                                    productCountSelect.disabled = true;
                                    productNameHidden.value = matchingProducts[0].name;
                                    
                                    receiptStatus.innerHTML = `<p class="text-sm text-green-600">‚úì Receipt matched! Tablet: ${tabletTypeName} - ${matchingProducts[0].name} auto-selected.</p>`;
                                } else {
                                    // Multiple products - user needs to select
                                    productCountSelect.disabled = false;
                                    receiptStatus.innerHTML = `<p class="text-sm text-green-600">‚úì Receipt matched! Tablet: ${tabletTypeName}. Please select product variant.</p>`;
                                }
                            }
                        }, 100);
                    } else {
                        // Category not found - show warning but still hide fallback
                        receiptStatus.innerHTML = `<p class="text-sm text-yellow-600">‚ö†Ô∏è Receipt matched but couldn't auto-select tablet type. Please select manually.</p>`;
                        enableProductSelection();
                    }
                    
                } else if (data.multiple_matches) {
                    // Multiple matches - show error
                    receiptLookupSuccess = false;
                    let matchesHtml = '<div class="bg-red-50 border border-red-200 rounded p-3">';
                    matchesHtml += '<p class="text-sm font-medium text-red-800 mb-2">‚ö†Ô∏è Multiple machine counts found for this receipt:</p>';
                    matchesHtml += '<ul class="text-xs text-red-700 space-y-1 ml-4">';
                    data.matches.forEach(match => {
                        matchesHtml += `<li>‚Ä¢ ${match.tablet_type_name} - ${match.employee_name} on ${match.submission_date}</li>`;
                    });
                    matchesHtml += '</ul>';
                    matchesHtml += '<p class="text-xs text-red-600 mt-2">Please contact your manager to resolve this conflict.</p>';
                    matchesHtml += '</div>';
                    
                    receiptStatus.innerHTML = matchesHtml;
                    receiptStatus.classList.remove('hidden');
                    showFallbackFields();
                    
                } else {
                    // No match found - show fallback
                    receiptLookupSuccess = false;
                    receiptStatus.innerHTML = `<p class="text-sm text-yellow-600">‚ö†Ô∏è No machine count found for receipt #${receiptNum}.</p>`;
                    receiptStatus.classList.remove('hidden');
                    showFallbackFields();
                }
                
            } catch (error) {
                console.error('Receipt lookup error:', error);
                receiptStatus.innerHTML = `<p class="text-sm text-red-600">‚ùå Error looking up receipt: ${error.message}</p>`;
                receiptStatus.classList.remove('hidden');
                showFallbackFields();
            }
        });
    }
    
    // Helper functions for receipt lookup
    function showFallbackFields() {
        fallbackSection.classList.remove('hidden');
        enableProductSelection();
    }
    
    function enableProductSelection() {
        categorySelect.disabled = false;
        baseSelect.disabled = false;
        productCountSelect.disabled = false;
    }
    
    function resetToManualEntry() {
        receiptLookupSuccess = false;
        autoSelectedTabletTypeId = null;
        receiptStatus.classList.add('hidden');
        receiptStatus.innerHTML = '';
        fallbackSection.classList.add('hidden');
        hiddenBoxField.value = '';
        hiddenBagField.value = '';
        fallbackBoxInput.value = '';
        fallbackBagInput.value = '';
        
        // Reset product selection
        categorySelect.disabled = false;
        categorySelect.value = '';
        baseSelect.disabled = false;
        baseSelect.value = '';
        baseSelect.style.display = 'none';
        productCountSelect.disabled = false;
        productCountSelect.value = '';
        countSelection.classList.add('hidden');
        productNameHidden.value = '';
    }
    
    // Sync fallback fields to hidden fields when changed
    if (fallbackBoxInput) {
        fallbackBoxInput.addEventListener('input', function() {
            hiddenBoxField.value = this.value;
        });
    }
    if (fallbackBagInput) {
        fallbackBagInput.addEventListener('input', function() {
            hiddenBagField.value = this.value;
        });
    }
    
    // Production Submission Form submission
    if (warehouseForm) warehouseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate that product_name is populated (set by two-level dropdown)
        const productNameField = document.getElementById('product_name');
        if (!productNameField || !productNameField.value) {
            showError('Please select a product');
            return;
        }
        
        // Validate box/bag numbers (either from hidden fields or fallback)
        if (!hiddenBoxField.value && !fallbackBoxInput.value) {
            showError('Box number is required. Please enter receipt number or fill fallback fields.');
            return;
        }
        if (!hiddenBagField.value && !fallbackBagInput.value) {
            showError('Bag number is required. Please enter receipt number or fill fallback fields.');
            return;
        }
        
        // Ensure hidden fields have values from fallback if needed
        if (!receiptLookupSuccess && fallbackBoxInput.value && fallbackBagInput.value) {
            hiddenBoxField.value = fallbackBoxInput.value;
            hiddenBagField.value = fallbackBagInput.value;
        }
        
        const formData = new FormData(warehouseForm);
        const data = Object.fromEntries(formData.entries());
        
        const submitBtn = warehouseForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        try {
            const response = await csrfFetch('/submit_warehouse', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccess(result.message || 'Packaged count submitted successfully!');
                warehouseForm.reset();
                resetToManualEntry(); // Reset all receipt lookup state
                countSelection.classList.add('hidden');
            } else {
                showError(result.error || 'Submission failed');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    // Bag Count Form
    const countForm = document.getElementById('count-form');
    const bagLabelInput = document.getElementById('count_bag_label_count');
    const actualCountInput = document.getElementById('actual_count');
    const countComparison = document.getElementById('count-comparison');
    
    // Update comparison when counts change
    function updateComparison() {
        if (!bagLabelInput || !actualCountInput) return;
        
        const bagLabel = parseInt(bagLabelInput.value) || 0;
        const actualCount = parseInt(actualCountInput.value) || 0;
        
        if (bagLabel > 0 || actualCount > 0) {
            document.getElementById('label-display').textContent = bagLabel;
            document.getElementById('actual-display').textContent = actualCount;
            
            const variance = actualCount - bagLabel;
            const varianceDisplay = document.getElementById('variance-display');
            
            if (variance === 0) {
                varianceDisplay.textContent = 'Variance: Perfect match ‚úÖ';
                varianceDisplay.className = 'font-medium text-green-600';
            } else if (variance > 0) {
                varianceDisplay.textContent = `Variance: +${variance} (over count)`;
                varianceDisplay.className = 'font-medium text-orange-600';
            } else {
                varianceDisplay.textContent = `Variance: ${variance} (under count)`;
                varianceDisplay.className = 'font-medium text-red-600';
            }
            
            if (countComparison) countComparison.classList.remove('hidden');
        } else {
            if (countComparison) countComparison.classList.add('hidden');
        }
    }
    
    // Only add event listeners if elements exist
    if (bagLabelInput) bagLabelInput.addEventListener('input', updateComparison);
    if (actualCountInput) actualCountInput.addEventListener('input', updateComparison);
    
    // Bag Count Form submission
    if (countForm) countForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(countForm);
        const data = Object.fromEntries(formData.entries());
        
        const submitBtn = countForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        try {
            const response = await csrfFetch('/submit_count', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccess(result.message || result.warning || 'Count submitted successfully!');
                countForm.reset();
                countComparison.classList.add('hidden');
            } else {
                showError(result.error || 'Submission failed');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    // Machine Count Form
    const machineCountForm = document.getElementById('machine-count-form-submit');
    
    if (machineCountForm) machineCountForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(machineCountForm);
        const data = Object.fromEntries(formData.entries());
        
        // Automatically set today's date if not provided
        if (!data.count_date) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            data.count_date = `${year}-${month}-${day}`;
        }
        
        // Convert to integers
        data.tablet_type_id = parseInt(data.tablet_type_id);
        data.machine_id = parseInt(data.machine_id);
        data.machine_count = parseInt(data.machine_count);
        
        const submitBtn = machineCountForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        try {
            const response = await csrfFetch('/submit_machine_count', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccess(result.message || 'Machine count submitted successfully!');
                machineCountForm.reset();
            } else {
                showError(result.error || 'Submission failed');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
    
    // Load machines for machine count form
    async function loadMachines() {
        try {
            console.log('Loading machines from API...');
            const response = await fetch('/api/machines');
            const data = await response.json();
            
            console.log('Machines API response:', data);
            
            if (data.success && data.machines) {
                const select = document.getElementById('machine_id');
                if (!select) {
                    console.error('Machine select element not found');
                    return;
                }
                
                console.log(`Found ${data.machines.length} machines`);
                
                // Keep the "Select machine..." option
                select.innerHTML = '<option value="">Select machine...</option>';
                
                // Add each machine as an option
                data.machines.forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine.id;
                    option.textContent = `${machine.machine_name} (${machine.cards_per_turn} cards/turn)`;
                    select.appendChild(option);
                    console.log(`Added machine: ${machine.machine_name}`);
                });
            } else {
                console.error('API call unsuccessful or no machines:', data);
            }
        } catch (error) {
            console.error('Failed to load machines:', error);
        }
    }
    
    // Load machines on page load
    loadMachines();
    
    // Initialize with Machine Count form as default
    switchForm('machine-count');
});
</script>
{% endblock %}

