{% extends "base.html" %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Admin Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900"><svg class="inline w-8 h-8 mr-2 align-[-4px]" aria-hidden="true"><use href="#icon-gear" /></svg> Admin Panel</h1>
        <p class="text-gray-600 mt-2">System configuration and management tools</p>
        
        <!-- Logout button -->
        <div class="mt-4">
            <a href="/admin/logout" class="text-sm text-red-600 hover:text-red-800 underline flex items-center justify-center">
                <svg class="w-4 h-4 mr-1" aria-hidden="true"><use href="#icon-logout" /></svg>
                Admin Logout
            </a>
        </div>
    </div>

    <!-- Configuration Grid -->
    <div class="flex flex-wrap justify-center gap-6 mb-8 max-w-4xl mx-auto">
        <!-- Employee Management Card -->
        <div class="card hover-lift w-full sm:w-80">
            <div class="p-6">
                <div class="flex items-center justify-center w-12 h-12 bg-green-100 rounded-lg mx-auto mb-4">
                    <svg class="w-7 h-7 text-primary" aria-hidden="true"><use href="#icon-users" /></svg>
                </div>
                <h3 class="text-lg font-semibold text-center text-gray-900 mb-2">Employee Management</h3>
                <p class="text-sm text-gray-600 text-center mb-4">Add and manage employee accounts</p>
                <a href="/admin/employees" 
                   class="block w-full text-center btn-primary text-sm py-2 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-users" /></svg>
                    Manage Employees
                </a>
            </div>
        </div>
        
        <!-- Product Configuration Card -->
        <div class="card hover-lift w-full sm:w-80">
            <div class="p-6">
                <div class="flex items-center justify-center w-12 h-12 bg-orange-100 rounded-lg mx-auto mb-4">
                    <svg class="w-7 h-7 text-primary" aria-hidden="true"><use href="#icon-chart" /></svg>
                </div>
                <h3 class="text-lg font-semibold text-center text-gray-900 mb-2">Product Configuration</h3>
                <p class="text-sm text-gray-600 text-center mb-4">Manage tablet types, products, and calculations</p>
                <div class="space-y-2">
                    <a href="/admin/tablet_types" 
                       class="block w-full text-center btn-secondary text-sm py-2 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-lab" /></svg>
                        Tablet Types & IDs
                    </a>
                    <a href="/admin/products" 
                       class="block w-full text-center btn-warning text-sm py-2 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-edit" /></svg>
                        Product Config
                    </a>
                </div>
            </div>
        </div>

        <!-- Machine Configuration Card -->
        <div class="card hover-lift w-full sm:w-80">
            <div class="p-6">
                <div class="flex items-center justify-center w-12 h-12 bg-blue-100 rounded-lg mx-auto mb-4">
                    <svg class="w-7 h-7 text-primary" aria-hidden="true"><use href="#icon-gear" /></svg>
                </div>
                <h3 class="text-lg font-semibold text-center text-gray-900 mb-2">Machine Configuration</h3>
                <p class="text-sm text-gray-600 text-center mb-4">Configure machine production settings</p>
                
                <!-- Machines List -->
                <div id="machines-list" class="space-y-2 mb-3">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <!-- Add Machine Button -->
                <button onclick="openAddMachineModal()" 
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-2 rounded-lg font-medium hover:from-green-600 hover:to-emerald-600 transition-all shadow-md text-sm">
                    ‚ûï Add Machine
                </button>
            </div>
        </div>

    </div>

    <!-- System Tools -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">üîß System Tools</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
            <button onclick="testZohoConnection()" 
                    class="btn-primary flex items-center justify-center py-2.5">
                <svg class="w-4 h-4 mr-2" aria-hidden="true"><use href="#icon-plug" /></svg>
                Test Zoho Connection
            </button>
            <button id="sync-pos-btn" 
                    class="btn-success py-2.5 text-sm font-semibold transform transition-all duration-300 hover:scale-105">
                <span class="flex items-center justify-center">
                    <span class="text-lg mr-2">üîÑ</span>
                    SYNC ZOHO POs
                </span>
            </button>
            <button onclick="syncCategories()" 
                    class="bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white py-2.5 text-sm font-semibold rounded-lg transform transition-all duration-300 hover:scale-105"
                    title="Sync categories from tablet types to categories table">
                <span class="flex items-center justify-center">
                    <span class="text-base mr-1">üîÑ</span>
                    Sync Categories
                </span>
            </button>
            <button onclick="viewFlaggedSubmissions()" 
                    class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white py-2.5 text-sm font-semibold rounded-lg transform transition-all duration-300 hover:scale-105"
                    title="View submissions flagged for review (duplicates, unassigned legacy data)">
                <span class="flex items-center justify-center">
                    <span class="text-base mr-1">üö©</span>
                    View Flagged
                </span>
            </button>
            <button onclick="clearPOData()" 
                    class="btn-warning py-2.5 text-sm font-semibold transform transition-all duration-300 hover:scale-105"
                    title="Deletes all synced PO data and resets counts to zero. Use this to start fresh or fix sync issues.">
                <span class="flex items-center justify-center">
                    <span class="text-base mr-1">üóëÔ∏è</span>
                    Clear PO Data
                </span>
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-3 text-center">
            <strong>Clear PO Data:</strong> Start fresh testing ‚Ä¢ Fix corrupted sync data ‚Ä¢ Reset all counts to zero
        </p>
    </div>
</div>

<!-- Status Messages -->
<div id="admin-messages" class="mt-6"></div>

<script>
// Admin panel functions

async function testZohoConnection() {
    const button = event.target;
    const originalText = button.textContent;
    
    try {
        button.disabled = true;
        button.textContent = 'üîå Testing Connection...';
        
        const response = await fetch('/api/test_zoho_connection');
        const result = await response.json();
        
        if (result.success) {
            showSuccess('‚úÖ Connection successful!');
        } else {
            showError('‚ùå Connection failed: ' + result.error);
        }
        
        button.disabled = false;
        button.textContent = originalText;
    } catch (error) {
        showError('Connection test failed: ' + error.message);
        button.disabled = false;
        button.textContent = originalText;
    }
}

// Sync Zoho POs function
async function syncZohoPOs() {
    const button = document.getElementById('sync-pos-btn');
    if (!button) {
        console.error('Sync button not found');
        return;
    }
    const originalText = button.textContent;
    try {
        button.disabled = true;
        button.style.opacity = '0.7';
        button.textContent = 'üîÑ SYNCING...';
        
        const response = await fetch('/api/sync_zoho_pos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message || '‚úÖ PO sync completed successfully!');
        } else {
            showError('‚ùå Sync failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        showError('Sync failed: ' + error.message);
    } finally {
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    }
}

// View flagged submissions
function viewFlaggedSubmissions() {
    window.location.href = '/submissions/flagged';
}

// Sync categories from tablet_types to categories table
async function syncCategories() {
    if (!confirm('Sync categories from tablet types to categories table?\n\nThis will add any categories currently in use (like custom categories) to the categories table so they appear in all dropdowns.')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    try {
        button.disabled = true;
        button.style.opacity = '0.6';
        button.innerHTML = '<span class="flex items-center justify-center"><span class="text-base mr-1">üîÑ</span>Syncing...</span>';
        
        const response = await fetch('/api/categories/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message || '‚úÖ Categories synced successfully!');
        } else {
            showError('‚ùå Sync failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        showError('Sync failed: ' + error.message);
    } finally {
        button.disabled = false;
        button.style.opacity = '1';
        button.innerHTML = originalText;
    }
}

// Clear PO data
async function clearPOData() {
    if (!confirm('Are you sure you want to clear all PO data? This will remove all synced POs and line items.')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.textContent;
    
    try {
        button.disabled = true;
        button.style.opacity = '0.6';
        button.textContent = 'üóëÔ∏è Clearing...';
        
        const response = await fetch('/api/clear_po_data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message || '‚úÖ PO data cleared successfully!');
        } else {
            showError('‚ùå Clear failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        showError('Clear failed: ' + error.message);
    } finally {
        button.disabled = false;
        button.style.opacity = '1';
        button.textContent = originalText;
    }
}

// Machine Management Functions
let machines = [];
let editingMachineId = null;

async function loadMachines() {
    try {
        const response = await fetch('/api/machines');
        const data = await response.json();
        
        if (data.success) {
            machines = data.machines;
            displayMachines();
        } else {
            showError('Failed to load machines');
        }
    } catch (error) {
        console.error('Error loading machines:', error);
    }
}

function displayMachines() {
    const container = document.getElementById('machines-list');
    if (!container) return;
    
    if (machines.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No machines configured</p>';
        return;
    }
    
    container.innerHTML = machines.map(machine => `
        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="font-medium text-sm text-gray-900">${machine.machine_name}</div>
                    <div class="text-xs text-gray-500">${machine.cards_per_turn} cards per turn</div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openEditMachineModal(${machine.id})" 
                            class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                        ‚úèÔ∏è Edit
                    </button>
                    <button onclick="deleteMachine(${machine.id}, '${machine.machine_name}')" 
                            class="text-red-600 hover:text-red-800 text-xs font-medium">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddMachineModal() {
    editingMachineId = null;
    document.getElementById('machine-modal-title').textContent = 'Add Machine';
    document.getElementById('machine-name-input').value = '';
    document.getElementById('machine-cards-input').value = '1';
    document.getElementById('machine-modal').classList.remove('hidden');
}

function openEditMachineModal(machineId) {
    editingMachineId = machineId;
    const machine = machines.find(m => m.id === machineId);
    if (!machine) return;
    
    document.getElementById('machine-modal-title').textContent = 'Edit Machine';
    document.getElementById('machine-name-input').value = machine.machine_name;
    document.getElementById('machine-cards-input').value = machine.cards_per_turn;
    document.getElementById('machine-modal').classList.remove('hidden');
}

function closeMachineModal() {
    document.getElementById('machine-modal').classList.add('hidden');
    editingMachineId = null;
}

async function saveMachine() {
    const name = document.getElementById('machine-name-input').value.trim();
    const cardsPerTurn = parseInt(document.getElementById('machine-cards-input').value);
    
    if (!name) {
        showError('Machine name is required');
        return;
    }
    
    if (!cardsPerTurn || cardsPerTurn < 1) {
        showError('Cards per turn must be at least 1');
        return;
    }
    
    try {
        const url = editingMachineId ? `/api/machines/${editingMachineId}` : '/api/machines';
        const method = editingMachineId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                machine_name: name,
                cards_per_turn: cardsPerTurn
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            closeMachineModal();
            loadMachines();
        } else {
            showError(result.error || 'Failed to save machine');
        }
    } catch (error) {
        showError('Failed to save: ' + error.message);
    }
}

async function deleteMachine(machineId, machineName) {
    if (!confirm(`Delete machine "${machineName}"?\n\nThis will hide the machine from future selections but won't affect historical data.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/machines/${machineId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            loadMachines();
        } else {
            showError(result.error || 'Failed to delete machine');
        }
    } catch (error) {
        showError('Failed to delete: ' + error.message);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadMachines();
    
    const syncBtn = document.getElementById('sync-pos-btn');
    if (syncBtn) {
        syncBtn.addEventListener('click', syncZohoPOs);
    }
});









function showSuccess(message) {
    showMessage(message, 'success');
}

function showError(message) {
    showMessage(message, 'error');
}

function showMessage(message, type) {
    const container = document.getElementById('admin-messages');
    const alertClass = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700';
    
    const alert = document.createElement('div');
    alert.className = `border-l-4 p-4 rounded ${alertClass} mb-4`;
    alert.innerHTML = `
        <div class="flex">
            <div class="flex-shrink-0">
                <span class="text-lg">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
            </div>
            <div class="ml-3">
                <p class="text-sm">${message}</p>
            </div>
        </div>
    `;
    
    container.appendChild(alert);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>

<!-- Machine Add/Edit Modal -->
<div id="machine-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeMachineModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4 rounded-t-lg">
            <div class="flex justify-between items-center">
                <h3 id="machine-modal-title" class="text-xl font-bold">Add Machine</h3>
                <button onclick="closeMachineModal()" class="text-white hover:text-gray-200 text-2xl font-bold">
                    ‚úï
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Machine Name <span class="text-red-600">*</span>
                    </label>
                    <input type="text" id="machine-name-input" 
                           placeholder="e.g., Machine 1, Production Line A"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Cards Per Turn <span class="text-red-600">*</span>
                    </label>
                    <input type="number" id="machine-cards-input" 
                           min="1" 
                           value="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Number of cards produced in one machine turn</p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeMachineModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveMachine()" 
                        class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
