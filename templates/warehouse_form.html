{% extends "base.html" %}

{% block title %}Warehouse Submission{% endblock %}

{% block content %}
<div class="max-w-md mx-auto card hover-lift p-8">
    <div class="text-center mb-8">
        <div class="mb-4 flex justify-center"><svg class="w-12 h-12" aria-hidden="true"><use href="#icon-box" /></svg></div>
        <h2 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">{{ gettext('Production Submission') }}</h2>
        {% if employee %}
        <div class="bg-gradient-to-r from-green-100 to-emerald-100 border border-green-200 rounded-xl p-4 mb-4">
            <p class="text-green-800 font-semibold flex items-center justify-center">
                <span class="text-2xl mr-3">ðŸ‘·</span>
                {{ gettext('Logged in as') }}: {{ employee.full_name }}
            </p>
        </div>
        {% endif %}
        <p class="text-gray-600">{{ gettext('Enter your production counts below') }}</p>
        
        <!-- Logout button -->
        <div class="mt-4">
            <a href="/logout" class="text-sm text-red-600 hover:text-red-800 underline inline-flex items-center">
                <svg class="w-4 h-4 mr-1" aria-hidden="true"><use href="#icon-logout" /></svg>
                {{ gettext('Logout') }}
            </a>
        </div>
    </div>
    
    <form id="warehouse-form" class="space-y-4">
        
        <!-- Product Selection with Count -->
        <div class="grid grid-cols-1 gap-3">
            <div>
                <label for="product_base" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ gettext('Product Type') }} *
                </label>
                <select id="product_base" name="product_base" required class="form-input">
                    <option value="">{{ gettext('Select product type...') }}</option>
                </select>
            </div>
            
            <div id="count-selection" class="hidden">
                <label for="product_count" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ gettext('Count') }} *
                </label>
                <select id="product_count" name="product_count" class="form-input">
                    <option value="">{{ gettext('Select count...') }}</option>
                </select>
            </div>
            
            <!-- Hidden field for the actual product name -->
            <input type="hidden" id="product_name" name="product_name">
        </div>
        
        <!-- Box Number -->
        <div>
            <label for="box_number" class="block text-sm font-medium text-gray-700 mb-1">
                {{ gettext('Box #') }} *
            </label>
            <input type="number" id="box_number" name="box_number" required
                   class="form-input" min="1" max="999" placeholder="{{ gettext('Box #') }}">
        </div>
        
        <!-- Bag Number -->
        <div>
            <label for="bag_number" class="block text-sm font-medium text-gray-700 mb-1">
                {{ gettext('Bag #') }} *
            </label>
            <input type="number" id="bag_number" name="bag_number" required
                   class="form-input" min="1" max="999" placeholder="{{ gettext('Bag #') }}">
        </div>
        
        <!-- Bag Label Count -->
        <div>
            <label for="bag_label_count" class="block text-sm font-medium text-gray-700 mb-1">
                {{ gettext('Bag Label Count') }} *
            </label>
            <input type="number" id="bag_label_count" name="bag_label_count" required
                   class="form-input" min="0" placeholder="{{ gettext('Count on the bag label') }}">
        </div>
        
        <!-- Production Counts -->
        <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-6 rounded-xl border border-indigo-100 space-y-4">
            <div class="flex items-center mb-4">
                <svg class="w-6 h-6 mr-3" aria-hidden="true"><use href="#icon-gear" /></svg>
                <h3 class="text-lg font-semibold bg-gradient-to-r from-indigo-700 to-purple-700 bg-clip-text text-transparent">{{ gettext('Production Details') }}</h3>
            </div>
            
            <div>
                <label for="displays_made" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ gettext('Displays Made') }} *
                </label>
                <input type="number" id="displays_made" name="displays_made" required
                       class="form-input" min="0" value="0">
            </div>
            
            <div>
                <label for="packs_remaining" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ gettext('Cards Remaining') }} *
                </label>
                <input type="number" id="packs_remaining" name="packs_remaining" required
                       class="form-input" min="0" value="0">
            </div>
            
            <div>
                <label for="loose_tablets" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ gettext('Loose Tablets') }} *
                </label>
                <input type="number" id="loose_tablets" name="loose_tablets" required
                       class="form-input" min="0" value="0">
            </div>
            
            <div>
                <label for="damaged_tablets" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ gettext('Damaged Tablets') }} *
                </label>
                <input type="number" id="damaged_tablets" name="damaged_tablets" required
                       class="form-input" min="0" value="0">
            </div>
        </div>
        
        <!-- Submission Date -->
        <div>
            <label for="submission_date" class="block text-sm font-medium text-gray-700 mb-1">
                {{ gettext('Submission Date') }} *
            </label>
            <input type="date" id="submission_date" name="submission_date" required
                   class="form-input" value="{{ today_date }}">
            <p class="text-xs text-gray-500 mt-1">{{ gettext('Change this if submitting for a different date') }}</p>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" class="w-full py-4 px-6 text-lg font-bold btn-primary mt-8 transform transition-all duration-300 hover:scale-105 flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" aria-hidden="true"><use href="#icon-send" /></svg>
            {{ gettext('Submit Production Count') }}
        </button>
    </form>
    
    <!-- Success/Error Messages -->
    <div id="form-messages" class="mt-4"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('warehouse-form');
    const productBaseSelect = document.getElementById('product_base');
    const productCountSelect = document.getElementById('product_count');
    const countSelection = document.getElementById('count-selection');
    const productNameHidden = document.getElementById('product_name');
    
    // Product data from server
    const products = [
        {% for product in products %}
        {
            name: "{{ product.product_name }}",
            ppd: {{ product.packages_per_display }},
            tpp: {{ product.tablets_per_package }},
            tabletType: "{{ product.tablet_type_name }}"
        },
        {% endfor %}
    ];
    
    // Group products by base type (remove count suffix)
    const productGroups = {};
    products.forEach(product => {
        const baseName = product.name.replace(/\s+(1ct|4ct|5ct|7ct|12ct)$/i, '');
        const countMatch = product.name.match(/(\d+)ct$/i);
        const count = countMatch ? countMatch[1] : null;
        
        if (!productGroups[baseName]) {
            productGroups[baseName] = [];
        }
        productGroups[baseName].push({
            ...product,
            count: count
        });
    });
    
    // Populate base product dropdown
    Object.keys(productGroups).sort().forEach(baseName => {
        const option = document.createElement('option');
        option.value = baseName;
        option.textContent = baseName;
        productBaseSelect.appendChild(option);
    });
    
    // Handle base product selection
    productBaseSelect.addEventListener('change', function() {
        productCountSelect.innerHTML = '<option value="">Select count...</option>';
        countSelection.classList.add('hidden');
        productNameHidden.value = '';
        
        if (this.value) {
            const availableCounts = productGroups[this.value] || [];
            availableCounts.sort((a, b) => parseInt(a.count || 0) - parseInt(b.count || 0));
            
            availableCounts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.textContent = product.count ? `${product.count}ct` : product.name;
                option.dataset.ppd = product.ppd;
                option.dataset.tpp = product.tpp;
                option.dataset.tabletType = product.tabletType;
                productCountSelect.appendChild(option);
            });
            
            countSelection.classList.remove('hidden');
        }
    });
    
    // Handle count selection
    productCountSelect.addEventListener('change', function() {
        productNameHidden.value = this.value;
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        try {
            const response = await fetch('/submit_warehouse', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccess(result.message || 'Packaged count submitted successfully!');
                form.reset();
                countSelection.classList.add('hidden');
            } else {
                showError(result.error || 'Submission failed');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
});
</script>
{% endblock %}
